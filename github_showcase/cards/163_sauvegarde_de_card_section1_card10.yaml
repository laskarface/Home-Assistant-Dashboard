type: custom:button-card
show_name: false
show_icon: false
show_state: false
styles:
  card:
  - padding: 0
  - background: rgba(20, 27, 38, 0.6)
  - backdrop-filter: blur(10px)
  - -webkit-backdrop-filter: blur(10px)
  - border-radius: 20px
  - border: 1px solid rgba(126, 87, 194, 0.4)
  - box-shadow: 0 8px 32px rgba(0,0,0,0.4)
  - height: 110px
  grid:
  - grid-template-areas: '"icon details"'
  - grid-template-columns: 130px minmax(0, 1fr)
  - grid-template-rows: 110px
  custom_fields:
    icon:
    - justify-self: stretch
    - align-self: stretch
    - border-right: 2px solid rgba(255,255,255,0.6)
    - border-top-left-radius: 20px
    - border-bottom-left-radius: 20px
    - display: flex
    - align-items: center
    - justify-content: center
    details:
    - justify-self: stretch
    - align-self: stretch
    - display: flex
    - flex-direction: column
    - justify-content: center
    - align-items: center
    - padding: 0 10px
custom_fields:
  icon: "[[[\n  const purple = \"#7E57C2\";\n  return `\n    <div style=\"width:100%;height:100%;display:flex;flex-direction:column;\n\
    \    align-items:center;justify-content:center;\n    background:linear-gradient(135deg,${purple}33\
    \ 0%,${purple}0D 100%);\n    border-top-left-radius:20px;border-bottom-left-radius:20px;\"\
    >\n\n      <ha-icon icon=\"mdi:white-balance-sunny\"\n      style=\"width:42px;height:42px;color:#FFD54F;\n\
    \      filter:drop-shadow(0 4px 8px rgba(0,0,0,0.5));\"></ha-icon>\n\n      <div\
    \ style=\"font-size:10px;font-weight:900;color:white;\n      text-transform:uppercase;letter-spacing:1px;margin-top:-4px;\"\
    >\n      UV\n      </div>\n\n    </div>\n  `;\n]]]\n"
  details: "[[[\n  const sunState = states['sun.sun']?.state;\n\n  const uvReal =\n\
    \    parseFloat(states['sensor.openuv_maison_indice_uv_actuel']?.state ?? 'NaN');\n\
    \n  // ✅ FORÇAGE À 0 APRÈS COUCHER\n  const uv = (sunState === 'below_horizon')\
    \ ? 0.0 : uvReal;\n  const uvTxt = Number.isFinite(uv) ? uv.toFixed(1) : '?';\n\
    \n  const count =\n    parseInt(states['counter.openuv_updates_today']?.state\
    \ ?? '0');\n\n  const intervalS =\n    parseInt(states['input_number.openuv_interval_seconds']?.state\
    \ ?? '0');\n\n  const intervalMin = intervalS ? Math.round(intervalS / 60) : 0;\n\
    \n  const remaining = Math.max(0, 50 - count);\n\n  // ✅ jauge visible dès la\
    \ 1ère MAJ\n  const pctRaw = Math.round((count / 50) * 100);\n  const pct = (count\
    \ > 0 && pctRaw < 8) ? 8 : pctRaw;\n\n  // ✅ Format FR: DD/MM/YYYY HH:MM\n  const\
    \ pad2 = (n) => String(n).padStart(2, '0');\n  const fmtFR = (d) =>\n    `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}\
    \ ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;\n\n  // Dernière MAJ (depuis\
    \ input_datetime si présent, sinon depuis ts)\n  const lastDtStr = states['input_datetime.openuv_last_update']?.state\
    \ || '';\n  let lastFR = '—';\n\n  // Timestamp fiable\n  const lastTs = parseInt(states['input_number.openuv_last_update_ts']?.state\
    \ ?? '0');\n\n  if (lastTs > 0) {\n    lastFR = fmtFR(new Date(lastTs * 1000));\n\
    \  } else if (lastDtStr) {\n    // fallback si jamais le ts n'est pas encore renseigné\n\
    \    const d = new Date(lastDtStr.replace(' ', 'T'));\n    if (!isNaN(d.getTime()))\
    \ lastFR = fmtFR(d);\n  }\n\n  // Prochaine MAJ (uniquement le jour)\n  let nextFR\
    \ = '—';\n  if (sunState === 'above_horizon' && lastTs > 0 && intervalS > 0) {\n\
    \    nextFR = fmtFR(new Date((lastTs + intervalS) * 1000));\n  }\n\n  const uvColor\
    \ = (v) => {\n    if (v < 3) return \"#00C853\";\n    if (v < 6) return \"#FFEB3B\"\
    ;\n    if (v < 8) return \"#FF9800\";\n    if (v < 11) return \"#F44336\";\n \
    \   return \"#9C27B0\";\n  };\n\n  return `\n  <div style=\"display:flex;flex-direction:column;width:100%;\n\
    \  align-items:center;justify-content:center;text-align:center;\">\n\n    <div\
    \ style=\"display:flex;align-items:baseline;gap:10px;margin-bottom:6px;\">\n \
    \     <div style=\"font-size:12px;font-weight:800;\n      color:rgba(255,255,255,0.65);\n\
    \      text-transform:uppercase;\">Indice UV</div>\n\n      <div style=\"font-size:28px;font-weight:900;\n\
    \      color:${uvColor(uv)};\n      text-shadow:0 6px 16px rgba(0,0,0,0.45);\"\
    >\n      ${uvTxt}\n      </div>\n    </div>\n\n    <div style=\"display:flex;gap:14px;flex-wrap:wrap;\n\
    \    justify-content:center;margin-bottom:8px;\">\n\n      <div style=\"font-size:10px;color:rgba(255,255,255,0.6);\n\
    \      font-weight:700;\">\n      DERNIÈRE MAJ:\n      <span style=\"color:white;font-weight:800;\"\
    >\n      ${lastFR}\n      </span>\n      </div>\n\n      <div style=\"font-size:10px;color:rgba(255,255,255,0.6);\n\
    \      font-weight:700;\">\n      PROCHAINE:\n      <span style=\"color:white;font-weight:800;\"\
    >\n      ${nextFR}\n      </span>\n      </div>\n\n      <div style=\"font-size:10px;color:rgba(255,255,255,0.6);\n\
    \      font-weight:700;\">\n      INTERVALLE:\n      <span style=\"color:white;font-weight:800;\"\
    >\n      ${intervalS}s (~${intervalMin}m)\n      </span>\n      </div>\n\n   \
    \ </div>\n\n    <!-- ✅ bloc jauge remonté + marge bas -->\n    <div style=\"width:92%;\
    \ margin-top:-6px; padding-bottom:6px;\">\n      <div style=\"display:flex;justify-content:space-between;\n\
    \      font-size:10px;color:rgba(255,255,255,0.6);\n      font-weight:800;margin-bottom:4px;\"\
    >\n        <div>MAJ ${count}/50</div>\n        <div>RESTE ${remaining}</div>\n\
    \      </div>\n\n      <div style=\"width:100%;height:8px;\n      background:rgba(255,255,255,0.1);\n\
    \      border-radius:999px;overflow:hidden;\">\n\n        <div style=\"height:100%;\n\
    \        width:${pct}%;\n        background:rgba(126,87,194,0.9);\n        box-shadow:0\
    \ 0 16px rgba(126,87,194,0.5);\">\n        </div>\n\n      </div>\n    </div>\n\
    \n  </div>\n  `;\n]]]\n"
tap_action:
  action: more-info
  entity: sensor.openuv_maison_indice_uv_actuel
card_mod:
  style: "ha-card {\n  margin: 0 !important;\n}\n"
