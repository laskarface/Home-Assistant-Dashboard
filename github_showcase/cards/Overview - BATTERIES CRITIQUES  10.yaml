# CARD: Overview - BATTERIES CRITIQUES  10
# PREREQUISITES:
#   ENTITIES:
#     - sensor.batteries_faibles_count
#     - sensor.ci_tesla_battery
#   HACS / UI COMPONENTS:
#     - auto-entities
#     - button-card
#     - fold-entity-row
#----------------------------------------

type: conditional
conditions:
- entity: sensor.batteries_faibles_count
  state_not: '0'
card:
  type: custom:fold-entity-row
  padding: 0
  clickable: true
  card_mod:
    style: "div#head {\n  display: block !important;\n  width: 100% !important;\n\
      \  padding: 0 !important;\n  margin: 0 !important;\n  --toggle-icon-width: 0px\
      \ !important;\n}\n#head {\n  padding: 0 !important;\n  margin: 0 !important;\n\
      \  width: 100% !important;\n  cursor: pointer !important;\n  pointer-events:\
      \ auto !important;\n}\n#head ha-icon {\n  display: none !important;\n  width:\
      \ 0px !important;\n}\ndiv#items {\n  padding: 0 !important;\n  margin: 0 !important;\n\
      }\n"
  head:
    type: custom:button-card
    entity: sensor.batteries_faibles_count
    show_name: false
    show_icon: false
    show_state: false
    tap_action:
      action: none
    variables:
      color: '#ff4444'
    styles:
      card:
      - padding: 0
      - background: rgba(20, 27, 38, 0.6)
      - backdrop-filter: blur(10px)
      - -webkit-backdrop-filter: blur(10px)
      - border-radius: 20px
      - border: '[[[ return `1px solid ${variables.color}80`; ]]]'
      - box-shadow: '[[[ return `0 0 20px ${variables.color}80, 0 8px 32px rgba(0,0,0,0.4)`;
          ]]]'
      - overflow: hidden
      - margin: 0px
      - box-sizing: border-box
      - position: relative
      - height: 85px
      - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
      grid:
      - grid-template-areas: '"icon details" "footer footer"'
      - grid-template-columns: 130px minmax(0, 1fr)
      - grid-template-rows: 60px 25px
      - gap: 0px
      - width: 100%
      - margin: 0
      custom_fields:
        icon:
        - justify-self: stretch
        - align-self: stretch
        - border-right: 2px solid rgba(255,255,255,0.6)
        - border-top-left-radius: 20px
        - display: flex
        - align-items: center
        - justify-content: center
        - padding: 0
        details:
        - justify-self: stretch
        - align-self: stretch
        - display: flex
        - flex-direction: column
        - justify-content: center
        - align-items: center
        - padding: 0
        - overflow: hidden
        - position: relative
        footer:
        - justify-self: stretch
        - align-self: stretch
        - background: rgba(0,0,0,0.2)
        - border-top: 1px solid rgba(255,255,255,0.05)
        - display: flex
        - align-items: center
        - justify-content: center
        - border-radius: 0 0 20px 20px
    extra_styles: "@keyframes blink {\n  0% { opacity: 1; text-shadow: 0 0 10px var(--glow-color);\
      \ }\n  50% { opacity: 0.35; text-shadow: 0 0 2px var(--glow-color); } \n  100%\
      \ { opacity: 1; text-shadow: 0 0 10px var(--glow-color); }\n}\n"
    custom_fields:
      icon: "[[[\n  const color = variables.color;\n  return `\n    <div style=\"\
        width: 100%; height: 100%; display: flex; flex-direction: column; align-items:\
        \ center; justify-content: center; background: linear-gradient(135deg, ${color}33\
        \ 0%, ${color}0D 100%); border-top-left-radius: 20px; box-sizing: border-box;\
        \ position: relative;\">\n      <div style=\"position: absolute; width: 50px;\
        \ height: 50px; background: ${color}; border-radius: 50%; filter: blur(20px);\
        \ opacity: 0.3; animation: pulseGlow 4s infinite alternate ease-in-out;\"\
        ></div>\n      <div style=\"font-size: 32px; line-height: 1; filter: drop-shadow(0\
        \ 0 10px ${color}80); display: flex; align-items: center; justify-content:\
        \ center; z-index: 1;\">\U0001FAAB</div>\n      <div style=\"font-size: 10px;\
        \ font-weight: 900; color: white; text-transform: uppercase; letter-spacing:\
        \ 0.8px; margin-top: 2px; z-index: 1;\">Batteries</div>\n      <style>@keyframes\
        \ pulseGlow { from { opacity: 0.2; transform: scale(0.9); } to { opacity:\
        \ 0.4; transform: scale(1.1); } }</style>\n    </div>\n  `;\n]]]\n"
      details: "[[[\n  const count = parseInt(entity.state) || 0;\n  const label =\
        \ count > 1 ? 'BATTERIES Ã€ CHANGER' : 'BATTERIE Ã€ CHANGER';\n  const color\
        \ = variables.color;\n  return `\n    <div style=\"width: 100%; height: 100%;\
        \ display: flex; flex-direction: row; justify-content: center; align-items:\
        \ center; padding: 0 15px; position: relative; gap: 15px;\">\n      <div style=\"\
        font-size: 38px; font-weight: 900; color: ${color}; line-height: 1; text-shadow:\
        \ 0 0 15px ${color}80; animation: blink 2s ease infinite;\">${count}</div>\n\
        \      <div style=\"display: flex; flex-direction: column; align-items: flex-start;\
        \ justify-content: center;\">\n        <div style=\"font-size: 13px; font-weight:\
        \ 800; color: white; text-transform: uppercase; letter-spacing: 1px;\">${label}</div>\n\
        \        <div style=\"font-size: 11px; color: rgba(255,255,255,0.6); margin-top:\
        \ 4px; display: flex; align-items: center; font-weight: 600;\">\n        \
        \  NIVEAU CRITIQUE\n        </div>\n      </div>\n    </div>\n  `;\n]]]\n"
      footer: "[[[\n   setTimeout(() => {\n     const isEditMode = window.location.search.includes('edit=1')\
        \ || window.location.pathname.includes('edit');\n     if (isEditMode) {\n\
        \        const el = document.querySelector(\"hui-conditional-card\"); \n \
        \       if (el) el.style.display = 'block';\n     }\n   }, 1000);\n\n   return\
        \ `\n     <div style=\"display:flex; width:100%; justify-content:center; align-items:center;\"\
        >\n       <ha-icon icon=\"mdi:chevron-down\" style=\"color: rgba(255,255,255,0.7);\
        \ width: 18px; height: 18px;\"></ha-icon>\n     </div>\n   `;\n]]]\n"
  entities:
  - type: custom:auto-entities
    show_empty: false
    card:
      type: markdown
      content: ðŸŽ‰ Toutes vos batteries sont en bon Ã©tat !
      card_mod:
        style: "ha-card {\n  background: transparent !important;\n  box-shadow: none\
          \ !important;\n  border: none !important;\n  padding: 20px 0 !important;\n\
          \  text-align: center !important;\n  color: rgba(255,255,255,0.7) !important;\n\
          \  font-size: 14px !important;\n  font-weight: 500 !important;\n}\n"
    filter:
      template: "{% set ns = namespace(count=0) %}\n{% for s in states.sensor if s.attributes.device_class\
        \ == 'battery' and not 'iphone' in (s.entity_id | lower) and s.entity_id !=\
        \ 'sensor.ci_tesla_battery' %}\n  {% set val = s.state | float(-1) %}\n  {%\
        \ if 0 <= val <= 50 %}\n    {% set ns.count = ns.count + 1 %}\n  {% endif\
        \ %}\n{% endfor %}\n{% if ns.count == 0 %}\n  {{ {} }}\n{% endif %}\n"
  - type: custom:auto-entities
    show_empty: false
    card:
      type: entities
      title: BATTERIES CRITIQUES (<= 10%)
      card_mod:
        style: "ha-card {\n  background: rgba(220, 20, 60, 0.2) !important;\n  backdrop-filter:\
          \ blur(10px) !important;\n  -webkit-backdrop-filter: blur(10px) !important;\n\
          \  border-radius: 20px !important;\n  border: 1px solid rgba(255, 50, 50,\
          \ 0.4) !important;\n  margin-bottom: 20px !important;\n  margin-top: 10px\
          \ !important;\n  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;\n} .card-header\
          \ { \n  color: #ff4444 !important; \n  font-weight: 800 !important; \n \
          \ font-size: 13px !important; \n  letter-spacing: 1px !important; \n  padding:\
          \ 16px 16px 8px 16px !important; \n  text-transform: uppercase !important;\n\
          }\n"
    filter:
      template: "{%- set sensors = states.sensor \n  | selectattr('attributes.device_class',\
        \ 'defined')\n  | selectattr('attributes.device_class', 'eq', 'battery')\n\
        \  | selectattr('state', 'is_number')\n  | rejectattr('entity_id', 'search',\
        \ 'iphone', ignorecase=true)\n  | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')\n\
        \  | list -%}\n{%- for s in sensors if s.state | int <= 10 -%}\n  {{ {\n \
        \   'entity': s.entity_id,\n    'name': s.attributes.friendly_name,\n    'secondary_info':\
        \ area_name(s.entity_id) or 'PiÃ¨ce non dÃ©finie',\n    'card_mod': {\n    \
        \  'style': ':host { --paper-item-icon-color: #ff4444; color: white; }'\n\
        \    }\n  } }},\n{%- endfor -%}\n"
    sort:
      method: state
      numeric: true
  - type: custom:auto-entities
    show_empty: false
    card:
      type: entities
      title: Ã€ SURVEILLER (11% - 30%)
      card_mod:
        style: "ha-card {\n  background: rgba(20, 27, 38, 0.6) !important;\n  backdrop-filter:\
          \ blur(10px) !important;\n  -webkit-backdrop-filter: blur(10px) !important;\n\
          \  border-radius: 20px !important;\n  border: 1px solid rgba(255, 152, 0,\
          \ 0.4) !important;\n  margin-bottom: 20px !important;\n  margin-top: 10px\
          \ !important;\n  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;\n} .card-header\
          \ { \n  color: #ff9800 !important; \n  font-weight: 800 !important; \n \
          \ font-size: 13px !important; \n  letter-spacing: 1px !important; \n  padding:\
          \ 16px 16px 8px 16px !important; \n  text-transform: uppercase !important;\n\
          }\n"
    filter:
      template: "{%- set sensors = states.sensor \n  | selectattr('attributes.device_class',\
        \ 'defined')\n  | selectattr('attributes.device_class', 'eq', 'battery')\n\
        \  | selectattr('state', 'is_number')\n  | rejectattr('entity_id', 'search',\
        \ 'iphone', ignorecase=true)\n  | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')\n\
        \  | list -%}\n{%- for s in sensors if s.state | int > 10 and s.state | int\
        \ <= 30 -%}\n  {{ {\n    'entity': s.entity_id,\n    'name': s.attributes.friendly_name,\n\
        \    'secondary_info': area_name(s.entity_id) or 'PiÃ¨ce non dÃ©finie',\n  \
        \  'card_mod': {\n      'style': ':host { --paper-item-icon-color: #ff9800;\
        \ color: white; }'\n    }\n  } }},\n{%- endfor -%}\n"
    sort:
      method: state
      numeric: true
  - type: custom:auto-entities
    show_empty: false
    card:
      type: entities
      title: Ã‰TAT MOYEN (31% - 50%)
      card_mod:
        style: "ha-card {\n  background: rgba(20, 27, 38, 0.6) !important;\n  backdrop-filter:\
          \ blur(10px) !important;\n  -webkit-backdrop-filter: blur(10px) !important;\n\
          \  border-radius: 20px !important;\n  border: 1px solid rgba(255, 235, 59,\
          \ 0.4) !important;\n  margin-bottom: 20px !important;\n  margin-top: 10px\
          \ !important;\n  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;\n} .card-header\
          \ { \n  color: #ffeb3b !important; \n  font-weight: 800 !important; \n \
          \ font-size: 13px !important; \n  letter-spacing: 1px !important; \n  padding:\
          \ 16px 16px 8px 16px !important; \n  text-transform: uppercase !important;\n\
          }\n"
    filter:
      template: "{%- set sensors = states.sensor \n  | selectattr('attributes.device_class',\
        \ 'defined')\n  | selectattr('attributes.device_class', 'eq', 'battery')\n\
        \  | selectattr('state', 'is_number')\n  | rejectattr('entity_id', 'search',\
        \ 'iphone', ignorecase=true)\n  | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')\n\
        \  | list -%}\n{%- for s in sensors if s.state | int > 30 and s.state | int\
        \ <= 50 -%}\n  {{ {\n    'entity': s.entity_id,\n    'name': s.attributes.friendly_name,\n\
        \    'secondary_info': area_name(s.entity_id) or 'PiÃ¨ce non dÃ©finie',\n  \
        \  'card_mod': {\n      'style': ':host { --paper-item-icon-color: #ffeb3b;\
        \ color: white; }'\n    }\n  } }},\n{%- endfor -%}\n"
    sort:
      method: state
      numeric: true
