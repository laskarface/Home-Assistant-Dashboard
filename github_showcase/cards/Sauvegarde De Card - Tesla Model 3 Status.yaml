type: custom:button-card
entity: binary_sensor.tesla_model_3_status
show_icon: false
show_name: false
show_state: false
tap_action:
  action: navigate
  navigation_path: /lovelace/tesla_modele_3
styles:
  card:
  - padding: 16px
  - border-radius: 20px
  - background: rgba(20, 27, 38, 0.6)
  - backdrop-filter: blur(10px)
  - -webkit-backdrop-filter: blur(10px)
  - overflow: hidden
  - position: relative
  - transition: box-shadow 0.5s ease-in-out, border 0.5s ease-in-out
  - border: "[[[\n  // 1. Récupération des états (avec sécurité si indisponible)\n\
      \  var chargeState = states['binary_sensor.tesla_model_3_charging'] ? states['binary_sensor.tesla_model_3_charging'].state\
      \ : 'off';\n  // Si tu as un sensor.tesla_charging_state à la place, décommente\
      \ ci-dessous:\n  // var chargeState = states['sensor.tesla_model_3_charging_state']?.state\
      \ === 'Charging' ? 'on' : 'off';\n  \n  var batteryState = states['sensor.tesla_model_3_niveau_de_batterie']\
      \ ? parseFloat(states['sensor.tesla_model_3_niveau_de_batterie'].state) : 0;\n\
      \  // 2. Logique Halo\n  if (chargeState == 'on') return '1px solid rgba(0,\
      \ 210, 255, 0.6)'; // BLEU CLAIR (Charge)\n  if (!isNaN(batteryState)) {\n \
      \    if (batteryState <= 20) return '1px solid rgba(255, 0, 0, 0.6)';   // ROUGE\
      \ (0-20%)\n     if (batteryState <= 30) return '1px solid rgba(255, 140, 0,\
      \ 0.6)'; // ORANGE (20-30%)\n  }\n  // Sinon (Normal)\n  return '1px solid rgba(255,255,255,0.1)';\n\
      ]]]\n"
  - box-shadow: "[[[\n  var chargeState = states['binary_sensor.tesla_model_3_charging']\
      \ ? states['binary_sensor.tesla_model_3_charging'].state : 'off';\n  var batteryState\
      \ = states['sensor.tesla_model_3_niveau_de_batterie'] ? parseFloat(states['sensor.tesla_model_3_niveau_de_batterie'].state)\
      \ : 0;\n  if (chargeState == 'on') \n    return '0 0 25px rgba(0, 210, 255,\
      \ 0.4), 0 8px 32px rgba(0,0,0,0.3)'; // Glow BLEU\n  \n  if (!isNaN(batteryState))\
      \ {\n     if (batteryState <= 20) \n       return '0 0 25px rgba(255, 0, 0,\
      \ 0.4), 0 8px 32px rgba(0,0,0,0.3)';   // Glow ROUGE\n     if (batteryState\
      \ <= 30) \n       return '0 0 25px rgba(255, 140, 0, 0.4), 0 8px 32px rgba(0,0,0,0.3)';\
      \ // Glow ORANGE\n  }\n  return '0 8px 32px rgba(0,0,0,0.3)';\n]]]\n"
  grid:
  - grid-template-areas: '"img info"'
  - grid-template-columns: 140px 1fr
  - column-gap: 16px
  custom_fields:
    img:
    - align-self: center
    info:
    - align-self: center
    wake:
    - position: absolute
    - right: 12px
    - bottom: 12px
    - z-index: 2
custom_fields:
  img: "[[[\n  return `<img src=\"/local/tesla-car-image.png\"\n    style=\"width:145px;\
    \ height:auto; border-radius:12px; display:block; box-shadow: 0 4px 8px rgba(0,0,0,0.3);\"\
    \ />`;\n]]]\n"
  info: "[[[\n  // --- LOGIQUE \"MÉMOIRE\" (Simplifiée pour l'affichage) ---\n  //\
    \ Si l'état est \"unavailable\", on essaie de ne pas afficher \"NaN\" ou on garde\
    \ le style précédent si possible\n  \n  const isOn = states['binary_sensor.tesla_model_3_status']?.state\
    \ === 'on';\n  const isCharging = states['binary_sensor.tesla_model_3_charging']?.state\
    \ === 'on';\n  \n  const rawBattery = states['sensor.tesla_model_3_niveau_de_batterie']?.state;\n\
    \  const rawRange   = states['sensor.tesla_model_3_autonomie_de_batterie']?.state;\n\
    \  
    \  let autonomie = Math.round(Number(rawRange));\n  \n  // Textes d'état\n  let\
    \ statusText = isOn ? 'Connectée' : 'Endormie (Veille)';\n  if (isCharging) statusText\
    \ = 'En Charge ⚡';\n  \n  // Barre de progression (Reste visible même si NaN,\
    \ à 0%)\n  const pct = Number.isFinite(batterie) ? Math.max(0, Math.min(100, batterie))\
    \ : 0;\n  \n  // Couleur Barre (Logique demandée incluse)\n  let fillColor = '#28a745';\
    \ // Vert par défaut\n  if (isCharging) fillColor = '#00D2FF'; // Bleu Charge\n\
    \  else if (pct <= 20) fillColor = '#dc3545'; // Rouge\n  else if (pct <= 30)\
    \ fillColor = '#ffc107'; // Orange\n  const glow = `0 0 8px ${fillColor}80`; //\
    \ 50% opacity\n  \n  const bar = `\n    <div style=\"height:10px; border-radius:999px;\n\
    \                background: rgba(255,255,255,0.1);\n                overflow:hidden;\
    \ box-shadow: inset 0 0 2px rgba(0,0,0,0.3);\">\n      <div style=\"\n       \
    \ height:100%;\n        width:${pct}%;\n        background:${fillColor};\n   \
    \     box-shadow: ${glow};\n        border-radius:999px;\n        transition:\
    \ width 300ms ease, background 300ms ease;\">\n      </div>\n    </div>\n  `;\n\
    \  \n  // Affichage Conditionnel \"NiN\" -> \"--\"\n  const displayBat = Number.isFinite(batterie)\
    \ ? batterie + \" %\" : \"-- %\";\n  const displayRange = Number.isFinite(autonomie)\
    \ ? autonomie + \" km\" : \"-- km\";\n  return `\n    <div style=\"padding-right:52px;\"\
    >\n      <div style=\"display:flex; align-items:center; gap:8px;\">\n        <ha-icon\
    \ icon=\"${isCharging ? 'mdi:ev-station' : (isOn ? 'mdi:car-connected' : 'mdi:sleep')}\"\
    \n          style=\"--mdc-icon-size:22px; color: ${isOn ? '#4caf50' : 'rgba(255,255,255,0.7)'};\"\
    ></ha-icon>\n        <div style=\"font-size:15px; font-weight:700; color: white;\"\
    >\n          Tesla Model 3\n        </div>\n      </div>\n      <div style=\"\
    font-size:12px; color: rgba(255,255,255,0.7); margin-top:2px;\">\n        ${statusText}\n\
    \      </div>\n      <div style=\"margin-top:14px;\">\n        <div style=\"display:flex;\
    \ justify-content:space-between;\n                    font-size:12px; color: rgba(255,255,255,0.9);\
    \ margin-bottom:6px;\">\n          <span>Batterie</span>\n          <span>${displayBat}\
    \ <span style=\"opacity:0.6\">|</span> ${displayRange}</span>\n        </div>\n\
    \        ${bar}\n      </div>\n    </div>\n  `;\n]]]\n"
  wake:
    card:
      type: custom:button-card
      entity: button.tesla_model_3_wake
      icon: mdi:power
      show_name: false
      show_state: false
      size: 18px
      styles:
        card:
        - width: 36px
        - height: 36px
        - border-radius: 12px
        - padding: 0
        - background: rgba(255,255,255,0.1)
        - border: 1px solid rgba(255,255,255,0.1)
        - backdrop-filter: blur(6px)
        - box-shadow: 0 4px 8px rgba(0,0,0,0.2)
        icon:
        - color: white
        - opacity: 0.9
      tap_action:
        action: call-service
        service: button.press
        service_data:
          entity_id: button.tesla_model_3_wake
