button_card_templates:
  inkwell:
    show_name: false
    show_state: true
    extra_styles: |
      [[[
        return `
          @keyframes pulse {
            5% {
              background-color: ${variables.color};
            }
          }
        `;
      ]]]
    styles:
      icon:
        - opacity: 1
        - color: '[[[ return variables.color ]]]'
        - filter: |
            [[[
              const glow = 'drop-shadow(0 0 3px rgba(255,255,255,0.95))';
              const edge = 'drop-shadow(0 0 1px rgba(0,0,0,0.7))';
              return glow + ' ' + edge;
            ]]]
      state:
        - font-size: 0.8em
        - font-weight: bold
        - text-shadow: 0 0 3px black
        - overflow: visible
      card:
        - border: none
        - border-radius: 4px
        - box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6)
        - background: |
            [[[
              let level = parseFloat(entity.state);
              if (isNaN(level)) level = 0;
              level = Math.max(0, Math.min(100, level));

              // couleur d'encre avec 70% de transparence
              const c = variables.color;

              const fillColor = (c.startsWith('#'))
                ? `${c}B3`     // HEX → alpha "B3" ≈ 70%
                : `rgba(${{
                    cyan: '0,255,255',
                    magenta: '255,0,255',
                    yellow: '255,255,0',
                    black: '0,0,0'
                  }[c] || '255,255,255'}, 0.3)`;   // 0.3 = 70% de transparence

              const fill = `linear-gradient(
                to top,
                ${fillColor},
                ${fillColor} ${level}%,
                rgba(255,255,255,0.10) ${level}%
              )`;

              const gloss = `linear-gradient(
                to bottom,
                rgba(255,255,255,0.45),
                rgba(255,255,255,0.10) 0%,
                transparent 0%
              )`;

              return `${gloss}, ${fill}`;
            ]]]
        - animation: |
            [[[
              let level = parseFloat(entity.state);
              if (isNaN(level)) level = 0;
              return level < 2 ? 'pulse ease-in-out 1s infinite' : 'none';
            ]]]
  energy_half:
    show_name: true
    show_state: true
    state_display: |
      [[[
        if (!entity || entity.state === 'unavailable' || entity.state === 'unknown') return '0.00 kWh';
        const val = parseFloat(entity.state);
        // On n'affiche que 2 décimales pour la propreté
        return isNaN(val) ? '0.00 kWh' : val.toFixed(2) + ' kWh';
      ]]]
    styles:
      card:
        - background: rgba(20, 27, 38, 0.6)
        - backdrop-filter: blur(10px)
        - '-webkit-backdrop-filter': blur(10px)
        - border-radius: 20px
        - border: 1px solid rgba(255,255,255,0.1)
        - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
        - padding: 12px
        - height: 110px
      grid:
        - grid-template-areas: '"n" "s" "graph"'
        - grid-template-rows: auto auto 1fr
      name:
        - font-size: 13px
        - font-weight: 600
        - color: rgba(255,255,255,0.8)
        - justify-self: start
      state:
        - font-size: 18px
        - font-weight: 700
        - color: '#FFFFFF'
        - justify-self: start
        - margin-top: 5px
    custom_fields:
      graph:
        card:
          type: sensor
          entity: '[[[ return entity.entity_id ]]]'
          graph: line
          detail: 1
          card_mod:
            style: >
              ha-card { background: transparent !important; border: none
              !important; }

              .header, .value, .name, .measurement { display: none !important; }

              .graph { padding: 0 !important; }
  greffe_task_glossy:
    show_name: true
    show_icon: true
    show_state: false
    layout: vertical
    tap_action:
      action: none
    hidden: |
      [[[
        if (!entity) return true;

        const attr = variables.attr;
        if (attr) {
          const v = entity.attributes?.[attr];
          return !(v === true || v === 'true' || v === 'True' || v === 1);
        }

        // fallback = ne montrer la carte que si l'entité est "on"
        return entity.state !== 'on';
      ]]]
    styles:
      card:
        - border: none
        - border-radius: 4px
        - box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6)
        - height: 64px
        - padding: 6px 10px
        - background: |
            [[[
              const c = variables.color || '#4CAF50';
              const fill = `linear-gradient(to bottom, ${c}DD, ${c}AA)`;
              const gloss =
                'linear-gradient(to bottom,' +
                'rgba(255,255,255,0.45),' +
                'rgba(255,255,255,0.10) 0%,' +
                'transparent 0%)';
              return `${gloss}, ${fill}`;
            ]]]
      grid:
        - grid-template-areas: '"i" "n"'
        - grid-template-rows: auto auto
        - grid-template-columns: 1fr
        - row-gap: 2px
        - align-items: center
        - justify-items: center
      icon:
        - width: 26px
        - height: 26px
        - color: white
        - filter: drop-shadow(0 0 4px rgba(0,0,0,0.9))
      name:
        - font-size: 0.8rem
        - font-weight: 500
        - text-overflow: ellipsis
        - white-space: nowrap
        - overflow: hidden
  notif_glossy:
    show_icon: false
    show_state: false
    show_name: true
    layout: vertical
    tap_action:
      action: more-info
    variables:
      color: '#ff3b30'
    styles:
      card:
        - border-radius: 4px
        - border: none
        - padding: 6px 10px
        - height: 54px
        - box-shadow: 0 4px 10px rgba(0,0,0,0.6)
        - overflow: hidden
        - background: |
            [[[
              const c = variables.color || '#ff3b30';
              const fill = `linear-gradient(to bottom, ${c}DD, ${c}AA)`;
              const gloss =
                'linear-gradient(to bottom,' +
                'rgba(255,255,255,0.45),' +
                'rgba(255,255,255,0.10) 0%,' +
                'transparent 0%)';
              return `${gloss}, ${fill}`;
            ]]]
      name:
        - font-size: 0.9rem
        - font-weight: 600
        - text-align: center
        - white-space: normal
        - overflow: visible
        - text-overflow: unset
        - line-height: 1.1rem
        - padding: 0 4px
        - color: white
  nav_glossy:
    show_icon: true
    show_name: true
    color_type: card
    aspect_ratio: 2/1
    variables:
      accent_color: rgba(0, 160, 255, 1)
    styles:
      card:
        - border-radius: 18px
        - padding: 10px
        - border: 1px solid rgba(255,255,255,0.10)
        - box-shadow: 0 6px 14px rgba(0,0,0,0.55)
        - background: |
            [[[
              const c = variables.accent_color || 'rgba(0,160,255,1)';
              return `linear-gradient(145deg,
                        rgba(0,0,0,0.75),
                        rgba(15,15,15,0.95) 40%,
                        ${c} 140%)`;
            ]]]
      icon:
        - width: 48%
        - color: '[[[ return variables.accent_color || "var(--primary-color)" ]]]'
        - filter: drop-shadow(0 0 6px rgba(0,0,0,0.9))
      name:
        - padding-top: 6px
        - font-weight: 700
        - font-size: 0.95em
        - text-align: center
        - color: '#ffffff'
        - text-shadow: 0 0 4px rgba(0,0,0,0.9)
  nav_minimal:
    show_icon: true
    show_name: true
    color_type: icon
    aspect_ratio: 2/1
    variables:
      accent_color: rgba(0, 160, 255, 1)
    styles:
      card:
        - border-radius: 4px
        - padding: 8px 12px
        - background: |
            var(--ha-card-background, rgba(18, 22, 33, 0.98))
        - box-shadow: 0 4px 8px rgba(0,0,0,0.35)
        - border: 1px solid rgba(255,255,255,0.04)
      icon:
        - color: |
            [[[
              return variables.accent_color || 'rgba(0,160,255,1)';
            ]]]
        - width: 32px
        - height: 32px
      name:
        - color: var(--primary-text-color)
        - font-weight: 500
        - font-size: 14px
  weather_forecast_row:
    show_icon: false
    show_state: false
    show_name: false
    custom_fields:
      day: |
        [[[
          return states['weather.home'].attributes.forecast[variables.index].datetime
            ? new Date(states['weather.home'].attributes.forecast[variables.index].datetime).toLocaleDateString('fr-FR', { weekday: 'short' })
            : '-';
        ]]]
      icon: |
        [[[
          return states['weather.home'].attributes.forecast[variables.index].condition;
        ]]]
      temp_min: |
        [[[
          return Math.round(states['weather.home'].attributes.forecast[variables.index].templow) + "°C";
        ]]]
      temp_max: |
        [[[
          return Math.round(states['weather.home'].attributes.forecast[variables.index].temperature) + "°C";
        ]]]
      bar: |
        [[[
          const f = states['weather.home'].attributes.forecast;
          const min = Math.min(...f.map(x => x.templow));
          const max = Math.max(...f.map(x => x.temperature));
          const tmin = f[variables.index].templow;
          const tmax = f[variables.index].temperature;

          const total = max - min;
          const start = ((tmin - min) / total) * 100;
          const end = ((tmax - min) / total) * 100;

          return `
            <div style="width:100%;height:10px;background:#dfeffa;border-radius:20px;position:relative;">
              <div style="
                position:absolute;
                left:${start}%;
                width:${end - start}%;
                height:10px;
                background:linear-gradient(90deg,#7dd3fc,#86efac);
                border-radius:20px;">
              </div>
            </div>
          `;
        ]]]
    styles:
      card:
        - padding: 2px 0
        - background: transparent
        - box-shadow: none
        - height: 28px
      grid:
        - grid-template-columns: 30px 1fr 30px 50px
      custom_fields:
        day:
          - justify-self: start
          - font-size: 14px
          - color: white
        icon:
          - justify-self: start
          - font-size: 18px
        temp_min:
          - justify-self: end
          - font-size: 14px
          - color: white
        temp_max:
          - justify-self: start
          - font-size: 14px
          - color: white
  button_card_templates:
    modern_task_glass:
      show_state: false
      show_name: true
      show_icon: true
      styles:
        card:
          - padding: 12px
          - height: 100px
          - border-radius: 20px
          - border: 1px solid rgba(255,255,255,0.1)
          - background: rgba(20, 27, 38, 0.6)
          - backdrop-filter: blur(10px)
          - '-webkit-backdrop-filter': blur(10px)
          - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
          - transition: transform 0.1s ease
        icon:
          - width: 32px
          - height: 32px
          - margin-bottom: 8px
          - color: |
              [[[ return variables.color; ]]]
          - filter: |
              [[[ return `drop-shadow(0 0 8px ${variables.color}aa)`; ]]]
        name:
          - font-size: 13px
          - font-weight: 600
          - color: white
        custom_fields:
          status:
            - font-size: 11px
            - opacity: 0.7
            - padding-top: 4px
      grid:
        - grid-template-areas: '"i" "n" "status"'
        - grid-template-rows: 1fr min-content min-content
      custom_fields:
        status: |
          [[[
            return entity.attributes[variables.attr] || '—';
          ]]]
views:
  - type: sections
    max_columns: 3
    title: dashboard
    path: dashboard
    icon: mdi:tablet-dashboard
    theme: noctis
    subview: false
    sections:
      - type: grid
        cards:
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:button-card
                name: Lumières
                icon: mdi:home-lightbulb-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/lumieres
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#ffd54a'
                    - filter: drop-shadow(0 0 8px rgba(255, 213, 74, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Températures
                icon: mdi:home-thermometer-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/temperatures-et-consommations
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#FA007D'
                    - filter: drop-shadow(0 0 8px rgba(250, 0, 125, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Energies
                icon: mdi:home-lightning-bolt-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/energies
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#0080ff'
                    - filter: drop-shadow(0 0 8px rgba(0, 128, 255, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
          - type: grid
            columns: 5
            square: false
            cards:
              - type: custom:button-card
                entity: person.user_1
                name: User 1
                show_entity_picture: true
                show_name: true
                show_icon: false
                styles:
                  card:
                    - padding: 10px 4px
                    - height: 140px
                    - border-radius: 20px
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - overflow: visible
                    - box-shadow: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158'; // Gris par défaut
                          if (state === 'home') color = '0, 200, 83';       // Vert (#00c853)
                          else if (state === 'not_home') color = '255, 61, 0'; // Rouge/Orange (#ff3d00)
                          else color = '255, 145, 0';                       // Orange Zone (#ff9100)
                          return `0 0 20px rgba(${color}, 0.5), 0 4px 15px rgba(0,0,0,0.2)`;
                        ]]]
                    - border: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158';
                          if (state === 'home') color = '0, 200, 83';
                          else if (state === 'not_home') color = '255, 61, 0';
                          else color = '255, 145, 0';
                          return `1px solid rgba(${color}, 0.5)`;
                        ]]]
                    - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                  entity_picture:
                    - width: 68px
                    - height: 68px
                    - border-radius: 50%
                    - border: 2px solid rgba(255,255,255,0.2)
                    - box-shadow: 0 4px 8px rgba(0,0,0,0.3)
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: white
                    - margin-top: 8px
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
                  custom_fields:
                    badge:
                      - position: absolute
                      - top: 10px
                      - right: 10px
                      - width: 22px
                      - height: 22px
                      - border-radius: 50%
                      - border: 2px solid rgba(30, 30, 40, 0.8)
                      - box-shadow: 0 2px 5px rgba(0,0,0,0.4)
                      - z-index: 2
                custom_fields:
                  badge: |
                    [[[
                      const state = entity.state;
                      let color = '#9e9e9e';
                      let icon = 'mdi:help';
                      if (state === 'home') { color = '#00c853'; icon = 'mdi:home'; }
                      else if (state === 'not_home') { color = '#ff3d00'; icon = 'mdi:exit-to-app'; }
                      else { color = '#ff9100'; icon = 'mdi:map-marker'; }
                      return `<div style="background-color: ${color}; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><ha-icon icon="${icon}" style="width: 14px; height: 14px; color: white;"></ha-icon></div>`;
                    ]]]
              - type: custom:button-card
                entity: person.user_2
                show_entity_picture: true
                show_name: true
                show_icon: false
                styles:
                  card:
                    - padding: 10px 4px
                    - height: 140px
                    - border-radius: 20px
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - overflow: visible
                    - box-shadow: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158'; 
                          if (state === 'home') color = '0, 200, 83'; 
                          else if (state === 'not_home') color = '255, 61, 0'; 
                          else color = '255, 145, 0'; 
                          return `0 0 20px rgba(${color}, 0.5), 0 4px 15px rgba(0,0,0,0.2)`;
                        ]]]
                    - border: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158';
                          if (state === 'home') color = '0, 200, 83';
                          else if (state === 'not_home') color = '255, 61, 0';
                          else color = '255, 145, 0';
                          return `1px solid rgba(${color}, 0.5)`;
                        ]]]
                    - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                  entity_picture:
                    - width: 68px
                    - height: 68px
                    - border-radius: 50%
                    - border: 2px solid rgba(255,255,255,0.2)
                    - box-shadow: 0 4px 8px rgba(0,0,0,0.3)
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: white
                    - margin-top: 8px
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
                  custom_fields:
                    badge:
                      - position: absolute
                      - top: 10px
                      - right: 10px
                      - width: 22px
                      - height: 22px
                      - border-radius: 50%
                      - border: 2px solid rgba(30, 30, 40, 0.8)
                      - box-shadow: 0 2px 5px rgba(0,0,0,0.4)
                      - z-index: 2
                custom_fields:
                  badge: |
                    [[[
                      const state = entity.state;
                      let color = '#9e9e9e';
                      let icon = 'mdi:help';
                      if (state === 'home') { color = '#00c853'; icon = 'mdi:home'; }
                      else if (state === 'not_home') { color = '#ff3d00'; icon = 'mdi:exit-to-app'; }
                      else { color = '#ff9100'; icon = 'mdi:map-marker'; }
                      return `<div style="background-color: ${color}; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><ha-icon icon="${icon}" style="width: 14px; height: 14px; color: white;"></ha-icon></div>`;
                    ]]]
              - type: custom:button-card
                entity: person.user_3
                name: User 3
                show_entity_picture: true
                show_name: true
                show_icon: false
                styles:
                  card:
                    - padding: 10px 4px
                    - height: 140px
                    - border-radius: 20px
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - overflow: visible
                    - box-shadow: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158'; 
                          if (state === 'home') color = '0, 200, 83'; 
                          else if (state === 'not_home') color = '255, 61, 0'; 
                          else color = '255, 145, 0'; 
                          return `0 0 20px rgba(${color}, 0.5), 0 4px 15px rgba(0,0,0,0.2)`;
                        ]]]
                    - border: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158';
                          if (state === 'home') color = '0, 200, 83';
                          else if (state === 'not_home') color = '255, 61, 0';
                          else color = '255, 145, 0';
                          return `1px solid rgba(${color}, 0.5)`;
                        ]]]
                    - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                  entity_picture:
                    - width: 68px
                    - height: 68px
                    - border-radius: 50%
                    - border: 2px solid rgba(255,255,255,0.2)
                    - box-shadow: 0 4px 8px rgba(0,0,0,0.3)
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: white
                    - margin-top: 8px
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
                  custom_fields:
                    badge:
                      - position: absolute
                      - top: 10px
                      - right: 10px
                      - width: 22px
                      - height: 22px
                      - border-radius: 50%
                      - border: 2px solid rgba(30, 30, 40, 0.8)
                      - box-shadow: 0 2px 5px rgba(0,0,0,0.4)
                      - z-index: 2
                custom_fields:
                  badge: |
                    [[[
                      const state = entity.state;
                      let color = '#9e9e9e';
                      let icon = 'mdi:help';
                      if (state === 'home') { color = '#00c853'; icon = 'mdi:home'; }
                      else if (state === 'not_home') { color = '#ff3d00'; icon = 'mdi:exit-to-app'; }
                      else { color = '#ff9100'; icon = 'mdi:map-marker'; }
                      return `<div style="background-color: ${color}; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><ha-icon icon="${icon}" style="width: 14px; height: 14px; color: white;"></ha-icon></div>`;
                    ]]]
              - type: custom:button-card
                entity: person.user_4
                name: User 4
                show_entity_picture: true
                show_name: true
                show_icon: false
                styles:
                  card:
                    - padding: 10px 4px
                    - height: 140px
                    - border-radius: 20px
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - overflow: visible
                    - box-shadow: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158'; 
                          if (state === 'home') color = '0, 200, 83'; 
                          else if (state === 'not_home') color = '255, 61, 0'; 
                          else color = '255, 145, 0'; 
                          return `0 0 20px rgba(${color}, 0.5), 0 4px 15px rgba(0,0,0,0.2)`;
                        ]]]
                    - border: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158';
                          if (state === 'home') color = '0, 200, 83';
                          else if (state === 'not_home') color = '255, 61, 0';
                          else color = '255, 145, 0';
                          return `1px solid rgba(${color}, 0.5)`;
                        ]]]
                    - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                  entity_picture:
                    - width: 68px
                    - height: 68px
                    - border-radius: 50%
                    - border: 2px solid rgba(255,255,255,0.2)
                    - box-shadow: 0 4px 8px rgba(0,0,0,0.3)
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: white
                    - margin-top: 8px
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
                  custom_fields:
                    badge:
                      - position: absolute
                      - top: 10px
                      - right: 10px
                      - width: 22px
                      - height: 22px
                      - border-radius: 50%
                      - border: 2px solid rgba(30, 30, 40, 0.8)
                      - box-shadow: 0 2px 5px rgba(0,0,0,0.4)
                      - z-index: 2
                custom_fields:
                  badge: |
                    [[[
                      const state = entity.state;
                      let color = '#9e9e9e';
                      let icon = 'mdi:help';
                      if (state === 'home') { color = '#00c853'; icon = 'mdi:home'; }
                      else if (state === 'not_home') { color = '#ff3d00'; icon = 'mdi:exit-to-app'; }
                      else { color = '#ff9100'; icon = 'mdi:map-marker'; }
                      return `<div style="background-color: ${color}; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><ha-icon icon="${icon}" style="width: 14px; height: 14px; color: white;"></ha-icon></div>`;
                    ]]]
              - type: custom:button-card
                entity: person.user_5
                show_entity_picture: true
                show_name: true
                show_icon: false
                styles:
                  card:
                    - padding: 10px 4px
                    - height: 140px
                    - border-radius: 20px
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - overflow: visible
                    - box-shadow: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158'; 
                          if (state === 'home') color = '0, 200, 83'; 
                          else if (state === 'not_home') color = '255, 61, 0'; 
                          else color = '255, 145, 0'; 
                          return `0 0 20px rgba(${color}, 0.5), 0 4px 15px rgba(0,0,0,0.2)`;
                        ]]]
                    - border: |
                        [[[
                          const state = entity.state;
                          let color = '158, 158, 158';
                          if (state === 'home') color = '0, 200, 83';
                          else if (state === 'not_home') color = '255, 61, 0';
                          else color = '255, 145, 0';
                          return `1px solid rgba(${color}, 0.5)`;
                        ]]]
                    - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                  entity_picture:
                    - width: 68px
                    - height: 68px
                    - border-radius: 50%
                    - border: 2px solid rgba(255,255,255,0.2)
                    - box-shadow: 0 4px 8px rgba(0,0,0,0.3)
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: white
                    - margin-top: 8px
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
                  custom_fields:
                    badge:
                      - position: absolute
                      - top: 10px
                      - right: 10px
                      - width: 22px
                      - height: 22px
                      - border-radius: 50%
                      - border: 2px solid rgba(30, 30, 40, 0.8)
                      - box-shadow: 0 2px 5px rgba(0,0,0,0.4)
                      - z-index: 2
                custom_fields:
                  badge: |
                    [[[
                      const state = entity.state;
                      let color = '#9e9e9e';
                      let icon = 'mdi:help';
                      if (state === 'home') { color = '#00c853'; icon = 'mdi:home'; }
                      else if (state === 'not_home') { color = '#ff3d00'; icon = 'mdi:exit-to-app'; }
                      else { color = '#ff9100'; icon = 'mdi:map-marker'; }
                      return `<div style="background-color: ${color}; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><ha-icon icon="${icon}" style="width: 14px; height: 14px; color: white;"></ha-icon></div>`;
                    ]]]
          - type: conditional
            conditions:
              - condition: state
                entity: binary_sensor.commute_workday
                state: 'on'
            card:
              type: custom:fold-entity-row
              padding: 0
              clickable: true
              card_mod:
                style: |
                  div#head {
                    display: block !important;
                    width: 100% !important;
                    padding: 0 !important;
                    margin: 0 !important;
                    --toggle-icon-width: 0px !important;
                  }
                  #head {
                    padding: 0 !important;
                    margin: 0 !important;
                    width: 100% !important;
                    cursor: pointer !important;
                    pointer-events: auto !important;
                  }
                  #head ha-icon {
                    display: none !important;
                    width: 0px !important;
                  }
                  div#items {
                    padding: 0 !important;
                    margin: 0 !important;
                  }
              head:
                type: custom:button-card
                entity: input_boolean.commute_card_flip
                show_name: false
                show_icon: false
                show_state: false
                tap_action:
                  action: none
                variables:
                  is_home: |
                    [[[
                      const flip = states['input_boolean.commute_card_flip'] && states['input_boolean.commute_card_flip'].state === 'on';
                      const is_pm = new Date().getHours() >= 12;
                      return (is_pm && !flip) || (!is_pm && flip);
                    ]]]
                styles:
                  card:
                    - padding: 0
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - border-radius: 20px
                    - border: |
                        [[[ 
                          const is_home = variables.is_home;
                          return is_home ? '1px solid rgba(255, 165, 0, 0.5)' : '1px solid rgba(61, 219, 184, 0.5)';
                        ]]]
                    - box-shadow: |
                        [[[ 
                          return '0 8px 32px rgba(0,0,0,0.4)';
                        ]]]
                    - overflow: hidden
                    - margin: 0px
                    - box-sizing: border-box
                    - position: relative
                    - transition: box-shadow 0.4s ease-in-out, border 0.4s ease-in-out
                  grid:
                    - grid-template-areas: '"icon details switch" "footer footer footer"'
                    - grid-template-columns: 130px 1fr 60px
                    - grid-template-rows: |
                        [[[ 
                          return "80px 30px";
                        ]]]
                    - gap: 0px
                    - width: 100%
                    - margin: 0
                  custom_fields:
                    icon:
                      - justify-self: stretch
                      - align-self: stretch
                      - border-right: 2px solid rgba(255,255,255,0.6)
                      - border-top-left-radius: 20px
                      - display: flex
                      - align-items: center
                      - justify-content: center
                      - padding: 0
                    details:
                      - justify-self: stretch
                      - align-self: stretch
                      - display: flex
                      - flex-direction: column
                      - justify-content: center
                      - align-items: center
                      - padding-right: 15px
                      - overflow: hidden
                      - position: relative
                    switch:
                      - justify-self: stretch
                      - align-self: stretch
                      - display: flex
                      - justify-content: center
                      - align-items: center
                      - border-left: 1px solid rgba(255,255,255,0.1)
                      - cursor: pointer
                      - pointer-events: auto
                    footer:
                      - justify-self: stretch
                      - align-self: stretch
                      - background: rgba(0,0,0,0.2)
                      - border-top: 1px solid rgba(255,255,255,0.05)
                      - display: flex
                      - align-items: center
                      - justify-content: center
                      - border-radius: 0 0 20px 20px
                custom_fields:
                  icon: |
                    [[[
                      const is_home = variables.is_home;
                      const color = is_home ? '#FFA500' : '#3DDBB8';
                      
                      const svg = `
                        <svg viewBox="0 0 100 100" width="70" height="70">
                          <defs>
                            <linearGradient id="roadGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                              <stop offset="0%" style="stop-color:#2c3e50;stop-opacity:1" />
                              <stop offset="100%" style="stop-color:#000000;stop-opacity:1" />
                            </linearGradient>
                            <filter id="roadInnerShadow">
                               <feOffset dx="0" dy="2"/>
                               <feGaussianBlur stdDeviation="2" result="offset-blur"/>
                               <feComposite operator="out" in="SourceGraphic" in2="offset-blur" result="inverse"/>
                               <feFlood flood-color="black" flood-opacity="0.8" result="color"/>
                               <feComposite operator="in" in="color" in2="inverse" result="shadow"/>
                               <feComponentTransfer in="shadow" result="shadow">
                                 <feFuncA type="linear" slope="0.5"/>
                               </feComponentTransfer>
                               <feComposite operator="over" in="shadow" in2="SourceGraphic"/>
                            </filter>
                          </defs>
                          
                          <!-- Road Shape with Perspective -->
                          <path d="M20,90 L40,15 L60,15 L80,90 Z" fill="url(#roadGradient)" filter="url(#roadInnerShadow)" />
                          
                          <!-- Lane Markings (Dashed) -->
                          <line x1="50" y1="20" x2="50" y2="85" stroke="white" stroke-width="2" stroke-dasharray="8,8" opacity="0.8" />
                          
                          <!-- Horizon / Depth Line -->
                          <line x1="40" y1="15" x2="60" y2="15" stroke="white" stroke-width="1" opacity="0.3" />
                          
                          <!-- Gloss Overlays -->
                          <path d="M20,90 L40,15 L45,15 L25,90 Z" fill="white" opacity="0.05" />
                          <path d="M75,90 L55,15 L60,15 L80,90 Z" fill="white" opacity="0.03" />
                        </svg>
                      `;
                      
                      return `
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}44 0%, rgba(20, 27, 38, 0) 100%); border-top-left-radius: 20px; box-sizing: border-box; position: relative;">
                           <!-- Pulsing Glow -->
                           <div style="position: absolute; width: 60px; height: 60px; background: ${color}; border-radius: 50%; filter: blur(25px); opacity: 0.3; animation: pulseGlow 3s infinite alternate ease-in-out;"></div>
                           <div style="position: relative; z-index: 1; filter: drop-shadow(0 0 12px ${color}80); display: flex; flex-direction: column; align-items: center; justify-content: center;">
                             ${svg}
                             <div style="font-size: 9px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 1px; margin-top: -5px;">Trajets</div>
                           </div>
                           <style>
                             @keyframes pulseGlow {
                               0% { transform: scale(0.8); opacity: 0.2; }
                               100% { transform: scale(1.2); opacity: 0.4; }
                             }
                           </style>
                        </div>
                      `;
                    ]]]
                  details: |
                    [[[
                      const is_home = variables.is_home;
                      const color = is_home ? '#FFA500' : '#3DDBB8';
                      const text = is_home ? 'RETOUR MAISON' : 'ALLER TRAVAIL';
                      const icon = is_home ? 'mdi:home' : 'mdi:office-building';
                      
                      const a_sid = is_home ? 'sensor.aline_travail_maison' : 'sensor.trajet_maison_travail_aline';
                      const c_sid = is_home ? 'sensor.chris_travail_maison' : 'sensor.trajet_maison_travail_chris';
                      
                      const a_val = states[a_sid] ? Math.round(states[a_sid].state) : '?';
                      const c_val = states[c_sid] ? Math.round(states[c_sid].state) : '?';

                      const getTrafficColor = (val, normal_id) => {
                        const normal = Math.round(parseFloat(states[normal_id]?.state) || val);
                        const delay = val - normal;
                        if (delay > 25) return '#DC5050';
                        if (delay > 10) return '#FFA500';
                        if (delay > 5) return 'white';
                        return '#3DDBB8';
                      };

                      const a_pic = states['person.user_2']?.attributes.entity_picture;
                      const c_pic = states['person.user_1']?.attributes.entity_picture;
                      const a_color = getTrafficColor(a_val, 'input_number.aline_commute_normal');
                      const c_color = getTrafficColor(c_val, 'input_number.chris_commute_normal');
                      
                      return `
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; padding-right: 5px;">
                          <div style="display: flex; flex-direction: row; align-items: center; gap: 6px; margin-bottom: 2px;">
                            <ha-icon icon="${icon}" style="width: 14px; height: 14px; color: ${color}; opacity: 0.8;"></ha-icon>
                            <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">${text}</div>
                          </div>
                          <div style="display: flex; flex-direction: row; justify-content: center; gap: 12px; width: 100%;">
                            <div style="display: flex; flex-direction: row; align-items: center; gap: 8px; background: rgba(255,255,255,0.03); padding: 4px 10px 4px 4px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                              <img src="${a_pic}" style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid ${a_color}; flex-shrink: 0; filter: drop-shadow(0 0 5px ${a_color}60);" />
                              <div style="display: flex; flex-direction: column; align-items: flex-start; line-height: 1;">
                                <div style="font-size: 13px; font-weight: 900; color: white;">${a_val}</div>
                                <div style="font-size: 8px; font-weight: 700; opacity: 0.6; text-transform: uppercase;">MIN</div>
                              </div>
                            </div>
                            <div style="display: flex; flex-direction: row; align-items: center; gap: 8px; background: rgba(255,255,255,0.03); padding: 4px 10px 4px 4px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                              <img src="${c_pic}" style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid ${c_color}; flex-shrink: 0; filter: drop-shadow(0 0 5px ${c_color}60);" />
                              <div style="display: flex; flex-direction: column; align-items: flex-start; line-height: 1;">
                                <div style="font-size: 13px; font-weight: 900; color: white;">${c_val}</div>
                                <div style="font-size: 8px; font-weight: 700; opacity: 0.6; text-transform: uppercase;">MIN</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      `;
                    ]]]
                  switch: |
                    [[[
                      const is_home = variables.is_home;
                      const color = is_home ? '#FFA500' : '#3DDBB8';
                      return `
                        <div onclick="event.stopPropagation(); window.event && window.event.preventDefault(); this.style.transform='scale(0.8)'; setTimeout(()=>this.style.transform='scale(1)', 150); document.querySelector('home-assistant').hass.callService('input_boolean', 'toggle', {entity_id: 'input_boolean.commute_card_flip'});" 
                             onpointerdown="event.stopPropagation();"
                             ontouchstart="event.stopPropagation();"
                             ontouchend="event.stopPropagation();"
                             style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); transition: all 0.2s ease;">
                          <ha-icon icon="mdi:swap-horizontal" style="width: 24px; height: 24px; color: ${color}; filter: drop-shadow(0 0 8px ${color}aa); pointer-events: none;"></ha-icon>
                        </div>
                      `;
                    ]]]
                  footer: |
                    [[[
                       setTimeout(() => {
                         const isEditMode = window.location.search.includes('edit=1') || window.location.pathname.includes('edit');
                         if (isEditMode) {
                            const el = document.querySelector("hui-conditional-card"); 
                            if (el) el.style.display = 'block';
                         }
                       }, 1000);

                       return (function() {
                         return `
                           <div style="display:flex; width:100%; justify-content:center; align-items:center;">
                             <ha-icon icon="mdi:chevron-down" style="color: rgba(255,255,255,0.7); width: 18px; height: 18px;"></ha-icon>
                           </div>
                         `;
                       })();
                    ]]]
              entities:
                - type: custom:button-card
                  show_name: false
                  show_icon: false
                  styles:
                    card:
                      - background: transparent
                      - border: none
                      - box-shadow: none
                      - padding: 0
                      - margin-top: 15px
                    grid:
                      - grid-template-areas: '"content"'
                      - grid-template-columns: 100%
                  custom_fields:
                    content:
                      card:
                        type: horizontal-stack
                        cards:
                          - type: custom:button-card
                            entity: |
                              [[[
                                const flip = states['input_boolean.commute_card_flip'] && states['input_boolean.commute_card_flip'].state === 'on';
                                const is_pm = new Date().getHours() >= 12;
                                const is_home = (is_pm && !flip) || (!is_pm && flip);
                                return is_home ? 'sensor.aline_travail_maison' : 'sensor.trajet_maison_travail_aline';
                              ]]]
                            name: |
                              [[[
                                // --- RESPONSIVE ---
                                const isMobile = window.innerWidth < 500;
                                const carSize = isMobile ? '30px' : '38px';
                                const titleSize = isMobile ? '12px' : '14px';
                                const journeyScale = isMobile ? '1.05' : '1.2';
                                const timeSize = isMobile ? '18px' : '20px';
                                const statusSize = isMobile ? '12px' : '14px';
                                const metricSize = isMobile ? '10px' : '11px';
                                const topMargin = isMobile ? '-4px' : '-6px';
                                const titleLeftShift = isMobile ? '-10px' : '-14px'; 
                                // --- LOGIC ---
                                const t_red = 25; const t_orange = 10; const t_white = 5;
                                const flip = states['input_boolean.commute_card_flip'] && states['input_boolean.commute_card_flip'].state === 'on';
                                const is_pm = new Date().getHours() >= 12;
                                const is_home = (is_pm && !flip) || (!is_pm && flip);
                                const sid = is_home ? 'sensor.aline_travail_maison' : 'sensor.trajet_maison_travail_aline';
                                const s1_sid = is_home ? 'sensor.trajet_aline_retour_semaine_derniere' : 'sensor.trajet_aline_semaine_derniere';
                                const avg_sid = is_home ? 'sensor.trajet_aline_retour_moyenne' : 'sensor.trajet_aline_moyenne';
                                const normal_sid = 'input_number.aline_commute_normal';
                                const main_entity = states[sid];
                                if (!main_entity) return 'Chargement...';
                                
                                const current = Math.round(parseFloat(main_entity.state) || 0);
                                const normal = Math.round(parseFloat(states[normal_sid]?.state) || 0);
                                const delay = current - normal;
                                
                                let status = 'Fluide'; let statusColor = '#3DDBB8';
                                if (delay > t_red) { status = 'Bouché'; statusColor = '#DC5050'; }
                                else if (delay > t_orange) { status = 'Dense'; statusColor = '#FFA500'; }
                                else if (delay > t_white) { status = 'Normal'; statusColor = 'white'; }
                                
                                const arrow = is_home ? 'mdi:arrow-left-bold' : 'mdi:arrow-right-bold';
                                const green = '#3DDBB8';
                                const homeColor = is_home ? 'white' : green;
                                const workColor = is_home ? green : 'white';
                                const delayNotice = delay > 0 ? ` (+${Math.abs(delay)} min)` : '';
                                const deadline = new Date('2026-02-01T07:20:00');
                                const isLearning = new Date() < deadline;
                                
                                const getStatDisplay = (sid, isLearn) => {
                                  const state = states[sid]?.state;
                                  if (!state || state === 'unavailable' || state === 'unknown') return 'Indisp.';
                                  const val = parseFloat(state);
                                  if (isNaN(val) || val <= 0) return isLearn ? 'Appre.' : 'Indisp.';
                                  return `${Math.round(val)} min`;
                                };

                                const avg7d_display = getStatDisplay(avg_sid, isLearning);
                                const s1_display = getStatDisplay(s1_sid, isLearning);
                                
                                const avatar = states['person.user_2']?.attributes.entity_picture;
                                const avatar_html = avatar 
                                  ? `<img src="${avatar}" style="width: ${carSize}; height: ${carSize}; border-radius: 50%; border: 2px solid ${statusColor}; flex-shrink: 0; filter: drop-shadow(0 0 5px ${statusColor}80);" />`
                                  : `<ha-icon icon="mdi:car" style="width: ${carSize}; height: ${carSize}; color: ${statusColor}; flex-shrink: 0;"></ha-icon>`;

                                return `
                                  <div style="display: flex; flex-direction: column; align-items: flex-start; width: 100%; overflow: visible;">
                                    <div style="display: flex; align-items: center; justify-content: flex-start; gap: 8px; margin-bottom: 2px; margin-top: ${topMargin}; margin-left: ${titleLeftShift}; width: 100%; overflow: visible;">
                                      ${avatar_html}
                                      <span style="font-weight: 900; font-size: ${titleSize}; color: white; flex-shrink: 0; margin-left: -2px;">Trajet User 2</span>
                                      <div style="display: flex; align-items: center; gap: 2px; transform: scale(${journeyScale}); transform-origin: left center; margin-left: 6px; flex-shrink: 0; overflow: visible;">
                                        <ha-icon icon="mdi:home-variant" style="width: 14px; height: 14px; color: ${homeColor};"></ha-icon>
                                        <ha-icon icon="${arrow}" style="width: 16px; height: 16px; color: #FFA500;"></ha-icon>
                                        <ha-icon icon="mdi:office-building" style="width: 14px; height: 14px; color: ${workColor};"></ha-icon>
                                      </div>
                                    </div>
                                    <div style="line-height: 0.85em; text-align: left; width: 100%; margin-top: 4px; overflow: visible;">
                                      <div style="font-weight: 800; color: white; font-size: ${statusSize}; margin-bottom: 3px; white-space: nowrap;">
                                        <span style="font-size: ${timeSize};">${current} min</span> • <span style="color: ${statusColor}">${status}</span>${delayNotice}
                                      </div>
                                      <div style="font-weight: 700; color: white; font-size: ${metricSize}; opacity: 0.9;">Même heure (S-1) : ${s1_display}</div>
                                      <div style="font-weight: 700; color: white; font-size: ${metricSize}; opacity: 0.9; margin-top: 1px;">Moyenne 7j : ${avg7d_display}</div>
                                      <div style="font-weight: 800; color: white; font-size: ${metricSize}; opacity: 0.9; margin-top: 4px;">Sans bouchon : ${normal} min</div>
                                    </div>
                                  </div>
                                `;
                              ]]]
                            show_state: false
                            show_label: false
                            show_icon: false
                            styles:
                              card:
                                - padding: >
                                    [[[ return window.innerWidth < 500 ? '12px
                                    10px' : '15px 15px'; ]]]
                                - border-radius: 20px
                                - border: |
                                    [[[
                                      const t_red = 25; const t_orange = 10; const t_white = 5;
                                      const flip = states['input_boolean.commute_card_flip'] && states['input_boolean.commute_card_flip'].state === 'on';
                                      const is_pm = new Date().getHours() >= 12;
                                      const is_home = (is_pm && !flip) || (!is_pm && flip);
                                      const sid = is_home ? 'sensor.aline_travail_maison' : 'sensor.trajet_maison_travail_aline';
                                      const duration = Math.round(parseFloat(states[sid]?.state) || 0);
                                      const normal = Math.round(parseFloat(states['input_number.aline_commute_normal']?.state) || duration);
                                      const delay = duration - normal;
                                      if (delay > t_red) return '1px solid rgba(220, 80, 80, 0.5)';
                                      if (delay > t_orange) return '1px solid rgba(255, 165, 0, 0.5)';
                                      if (delay > t_white) return '1px solid rgba(255, 255, 255, 0.2)';
                                      return '1px solid rgba(61, 219, 184, 0.5)';
                                    ]]]
                                - background: |
                                    [[[
                                      const t_red = 25; const t_orange = 10; const t_white = 5;
                                      const flip = states['input_boolean.commute_card_flip'] && states['input_boolean.commute_card_flip'].state === 'on';
                                      const is_pm = new Date().getHours() >= 12;
                                      const is_home = (is_pm && !flip) || (!is_pm && flip);
                                      const sid = is_home ? 'sensor.aline_travail_maison' : 'sensor.trajet_maison_travail_aline';
                                      const duration = Math.round(parseFloat(states[sid]?.state) || 0);
                                      const normal = Math.round(parseFloat(states['input_number.aline_commute_normal']?.state) || duration);
                                      const delay = duration - normal;
                                      if (delay > t_red) return 'linear-gradient(145deg, rgba(220, 80, 80, 0.3), rgba(20, 27, 38, 0.8))';
                                      if (delay > t_orange) return 'linear-gradient(145deg, rgba(255, 165, 0, 0.3), rgba(20, 27, 38, 0.8))';
                                      if (delay > t_white) return 'linear-gradient(145deg, rgba(255, 255, 255, 0.08), rgba(20, 27, 38, 0.8))';
                                      return 'linear-gradient(145deg, rgba(61, 219, 184, 0.2), rgba(20, 27, 38, 0.8))';
                                    ]]]
                                - backdrop-filter: blur(20px)
                                - '-webkit-backdrop-filter': blur(20px)
                                - box-shadow: 0 4px 15px rgba(0,0,0,0.3)
                                - margin-top: 15px
                                - transition: all 0.3s ease
                              grid:
                                - grid-template-areas: '"n"'
                                - grid-template-columns: 100%
                              name:
                                - justify-self: start
                                - width: 100%
                                - overflow: visible
                            tap_action:
                              action: more-info
                          - type: custom:button-card
                            entity: |
                              [[[
                                const flip = states['input_boolean.commute_card_flip'] && states['input_boolean.commute_card_flip'].state === 'on';
                                const is_pm = new Date().getHours() >= 12;
                                const is_home = (is_pm && !flip) || (!is_pm && flip);
                                return is_home ? 'sensor.chris_travail_maison' : 'sensor.trajet_maison_travail_chris';
                              ]]]
                            name: |
                              [[[
                                // --- RESPONSIVE ---
                                const isMobile = window.innerWidth < 500;
                                const carSize = isMobile ? '30px' : '38px';
                                const titleSize = isMobile ? '12px' : '14px';
                                const journeyScale = isMobile ? '1.05' : '1.2';
                                const timeSize = isMobile ? '18px' : '20px';
                                const statusSize = isMobile ? '12px' : '14px';
                                const metricSize = isMobile ? '10px' : '11px';
                                const topMargin = isMobile ? '-4px' : '-6px';
                                const titleLeftShift = isMobile ? '-10px' : '-14px'; 
                                // --- LOGIC ---
                                const t_red = 25; const t_orange = 10; const t_white = 5;
                                const flip = states['input_boolean.commute_card_flip'] && states['input_boolean.commute_card_flip'].state === 'on';
                                const is_pm = new Date().getHours() >= 12;
                                const is_home = (is_pm && !flip) || (!is_pm && flip);
                                const sid = is_home ? 'sensor.chris_travail_maison' : 'sensor.trajet_maison_travail_chris';
                                const s1_sid = is_home ? 'sensor.trajet_chris_retour_semaine_derniere' : 'sensor.trajet_chris_semaine_derniere';
                                const avg_sid = is_home ? 'sensor.trajet_chris_retour_moyenne' : 'sensor.trajet_chris_moyenne';
                                const normal_sid = 'input_number.chris_commute_normal';
                                const main_entity = states[sid];
                                if (!main_entity) return 'Chargement...';
                                
                                const current = Math.round(parseFloat(main_entity.state) || 0);
                                const normal = Math.round(parseFloat(states[normal_sid]?.state) || 0);
                                const delay = current - normal;
                                
                                let status = 'Fluide'; let statusColor = '#3DDBB8';
                                if (delay > t_red) { status = 'Bouché'; statusColor = '#DC5050'; }
                                else if (delay > t_orange) { status = 'Dense'; statusColor = '#FFA500'; }
                                else if (delay > t_white) { status = 'Normal'; statusColor = 'white'; }
                                
                                const arrow = is_home ? 'mdi:arrow-left-bold' : 'mdi:arrow-right-bold';
                                const green = '#3DDBB8';
                                const homeColor = is_home ? 'white' : green;
                                const workColor = is_home ? green : 'white';
                                const delayNotice = delay > 0 ? ` (+${Math.abs(delay)} min)` : '';
                                const deadline = new Date('2026-02-01T07:20:00');
                                const isLearning = new Date() < deadline;

                                const getStatDisplay = (sid, isLearn) => {
                                  const state = states[sid]?.state;
                                  if (!state || state === 'unavailable' || state === 'unknown') return 'Indisp.';
                                  const val = parseFloat(state);
                                  if (isNaN(val) || val <= 0) return isLearn ? 'Appre.' : 'Indisp.';
                                  return `${Math.round(val)} min`;
                                };

                                const avg7d_display = getStatDisplay(avg_sid, isLearning);
                                const s1_display = getStatDisplay(s1_sid, isLearning);
                                
                                const avatar = states['person.user_1']?.attributes.entity_picture;
                                const avatar_html = avatar 
                                  ? `<img src="${avatar}" style="width: ${carSize}; height: ${carSize}; border-radius: 50%; border: 2px solid ${statusColor}; flex-shrink: 0; filter: drop-shadow(0 0 5px ${statusColor}80);" />`
                                  : `<ha-icon icon="mdi:car" style="width: ${carSize}; height: ${carSize}; color: ${statusColor}; flex-shrink: 0;"></ha-icon>`;

                                return `
                                  <div style="display: flex; flex-direction: column; align-items: flex-start; width: 100%; overflow: visible;">
                                    <div style="display: flex; align-items: center; justify-content: flex-start; gap: 8px; margin-bottom: 2px; margin-top: ${topMargin}; margin-left: ${titleLeftShift}; width: 100%; overflow: visible;">
                                      ${avatar_html}
                                      <span style="font-weight: 900; font-size: ${titleSize}; color: white; flex-shrink: 0; margin-left: -2px;">Trajet User 1</span>
                                      <div style="display: flex; align-items: center; gap: 2px; transform: scale(${journeyScale}); transform-origin: left center; margin-left: 6px; flex-shrink: 0; overflow: visible;">
                                        <ha-icon icon="mdi:home-variant" style="width: 14px; height: 14px; color: ${homeColor};"></ha-icon>
                                        <ha-icon icon="${arrow}" style="width: 16px; height: 16px; color: #FFA500;"></ha-icon>
                                        <ha-icon icon="mdi:office-building" style="width: 14px; height: 14px; color: ${workColor};"></ha-icon>
                                      </div>
                                    </div>
                                    <div style="line-height: 0.85em; text-align: left; width: 100%; margin-top: 4px; overflow: visible;">
                                      <div style="font-weight: 800; color: white; font-size: ${statusSize}; margin-bottom: 3px; white-space: normal;">
                                        <span style="font-size: ${timeSize};">${current} min</span> • <span style="color: ${statusColor}">${status}</span>${delayNotice}
                                      </div>
                                      <div style="font-weight: 700; color: white; font-size: ${metricSize}; opacity: 0.9; white-space: normal; word-wrap: break-word;">Même heure (S-1) : ${s1_display}</div>
                                      <div style="font-weight: 700; color: white; font-size: ${metricSize}; opacity: 0.9; margin-top: 1px; white-space: normal; word-wrap: break-word;">Moyenne 7j : ${avg7d_display}</div>
                                      <div style="font-weight: 800; color: white; font-size: ${metricSize}; opacity: 0.9; margin-top: 4px; white-space: normal; word-wrap: break-word;">Sans bouchon : ${normal} min</div>
                                    </div>
                                  </div>
                                `;
                              ]]]
                            show_state: false
                            show_label: false
                            show_icon: false
                            styles:
                              card:
                                - padding: >
                                    [[[ return window.innerWidth < 500 ? '12px
                                    10px' : '15px 15px'; ]]]
                                - border-radius: 20px
                                - border: |
                                    [[[
                                      const t_red = 25; const t_orange = 10; const t_white = 5;
                                      const flip = states['input_boolean.commute_card_flip'] && states['input_boolean.commute_card_flip'].state === 'on';
                                      const is_pm = new Date().getHours() >= 12;
                                      const is_home = (is_pm && !flip) || (!is_pm && flip);
                                      const sid = is_home ? 'sensor.chris_travail_maison' : 'sensor.trajet_maison_travail_chris';
                                      const duration = Math.round(parseFloat(states[sid]?.state) || 0);
                                      const normal = Math.round(parseFloat(states['input_number.chris_commute_normal']?.state) || duration);
                                      const delay = duration - normal;
                                      if (delay > t_red) return '1px solid rgba(220, 80, 80, 0.5)';
                                      if (delay > t_orange) return '1px solid rgba(255, 165, 0, 0.5)';
                                      if (delay > t_white) return '1px solid rgba(255, 255, 255, 0.2)';
                                      return '1px solid rgba(61, 219, 184, 0.5)';
                                    ]]]
                                - background: |
                                    [[[
                                      const t_red = 25; const t_orange = 10; const t_white = 5;
                                      const flip = states['input_boolean.commute_card_flip'] && states['input_boolean.commute_card_flip'].state === 'on';
                                      const is_pm = new Date().getHours() >= 12;
                                      const is_home = (is_pm && !flip) || (!is_pm && flip);
                                      const sid = is_home ? 'sensor.chris_travail_maison' : 'sensor.trajet_maison_travail_chris';
                                      const duration = Math.round(parseFloat(states[sid]?.state) || 0);
                                      const normal = Math.round(parseFloat(states['input_number.chris_commute_normal']?.state) || duration);
                                      const delay = duration - normal;
                                      if (delay > t_red) return 'linear-gradient(145deg, rgba(220, 80, 80, 0.3), rgba(20, 27, 38, 0.8))';
                                      if (delay > t_orange) return 'linear-gradient(145deg, rgba(255, 165, 0, 0.3), rgba(20, 27, 38, 0.8))';
                                      if (delay > t_white) return 'linear-gradient(145deg, rgba(255, 255, 255, 0.08), rgba(20, 27, 38, 0.8))';
                                      return 'linear-gradient(145deg, rgba(61, 219, 184, 0.2), rgba(20, 27, 38, 0.8))';
                                    ]]]
                                - backdrop-filter: blur(20px)
                                - '-webkit-backdrop-filter': blur(20px)
                                - box-shadow: 0 4px 15px rgba(0,0,0,0.3)
                                - margin-top: 15px
                                - transition: all 0.3s ease
                              grid:
                                - grid-template-areas: '"n"'
                                - grid-template-columns: 100%
                              name:
                                - justify-self: start
                                - width: 100%
                                - overflow: visible
                            tap_action:
                              action: more-info
          - type: custom:fold-entity-row
            padding: 0
            clickable: true
            card_mod:
              style: >
                div#head { display: block !important; width: 100% !important;
                padding: 0 !important; margin: 0 !important;
                --toggle-icon-width: 0px !important; }

                #head { padding: 0 !important; margin: 0 !important; width: 100%
                !important; cursor: pointer !important; }

                #head ha-icon { display: none !important; }

                div#items { padding: 0 !important; margin: 0 !important; }
            head:
              type: custom:button-card
              show_name: false
              show_icon: false
              show_state: false
              styles:
                card:
                  - padding: 0
                  - background: rgba(20, 27, 38, 0.6)
                  - backdrop-filter: blur(10px)
                  - '-webkit-backdrop-filter': blur(10px)
                  - border-radius: 20px
                  - border: |
                      [[[ 
                        const heating = states['binary_sensor.dhwp_actuator_energy_demand_status']?.state === 'on';
                        const color = heating ? '#FFA500' : '#46D278';
                        return `1px solid ${color}80`;
                      ]]]
                  - box-shadow: |
                      [[[ 
                        const heating = states['binary_sensor.dhwp_actuator_energy_demand_status']?.state === 'on';
                        return heating ? '0 0 20px rgba(255, 165, 0, 0.3), 0 8px 32px rgba(0,0,0,0.4)' : '0 8px 32px rgba(0,0,0,0.4)';
                      ]]]
                  - height: 85px
                grid:
                  - grid-template-areas: '"icon details" "footer footer"'
                  - grid-template-columns: 130px 1fr
                  - grid-template-rows: 60px 25px
                custom_fields:
                  icon:
                    - justify-self: stretch
                    - align-self: stretch
                    - border-right: 2px solid rgba(255,255,255,0.6)
                    - border-top-left-radius: 20px
                    - display: flex
                    - align-items: center
                    - justify-content: center
                  details:
                    - justify-self: stretch
                    - align-self: stretch
                    - display: flex
                    - align-items: center
                    - justify-content: center
                    - padding: 0 10px
              custom_fields:
                icon: |
                  [[[
                    const heating = states['binary_sensor.dhwp_actuator_energy_demand_status']?.state === 'on';
                    const color = heating ? '#FFA500' : '#46D278';
                    const fanAnim = heating ? 'animation: rotateFan 2s linear infinite;' : '';
                    
                    const svg = `
                      <svg viewBox="0 0 100 100" width="55" height="55" style="filter: drop-shadow(0 6px 12px rgba(0,0,0,0.5));">
                        <defs>
                          <linearGradient id="pacBody" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#f0f0f0;stop-opacity:1" />
                          </linearGradient>
                          <radialGradient id="fanGlow" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:${color};stop-opacity:0" />
                          </radialGradient>
                        </defs>
                        <rect x="30" y="20" width="40" height="60" rx="8" ry="8" fill="url(#pacBody)" />
                        <circle cx="50" cy="45" r="14" fill="rgba(0,0,0,0.05)" stroke="rgba(0,0,0,0.1)" stroke-width="1" />
                        <g style="transform-origin: 50px 45px; ${fanAnim}">
                          <path d="M50,45 L50,33 A1.5,1.5 0 0,1 51.5,33 L51.5,45 Z" fill="${color}" />
                          <path d="M50,45 L62,45 A1.5,1.5 0 0,1 62,46.5 L50,46.5 Z" fill="${color}" />
                          <path d="M50,45 L50,57 A1.5,1.5 0 0,1 48.5,57 L48.5,45 Z" fill="${color}" />
                          <path d="M50,45 L38,45 A1.5,1.5 0 0,1 38,43.5 L50,43.5 Z" fill="${color}" />
                          <circle cx="50" cy="45" r="3" fill="${color}" />
                        </g>
                        <rect x="38" y="65" width="24" height="4" rx="1.5" fill="rgba(0,0,0,0.1)" />
                        <circle cx="50" cy="45" r="18" fill="url(#fanGlow)" />
                      </svg>
                      <style>@keyframes rotateFan { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
                    `;

                    return `
                      <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, rgba(20, 27, 38, 0) 100%); border-top-left-radius: 20px; box-sizing: border-box; position: relative;">
                        <div style="position: absolute; width: 50px; height: 50px; background: ${color}; border-radius: 50%; filter: blur(25px); opacity: 0.3; animation: pulseGlow 3s infinite alternate ease-in-out;"></div>
                        <div style="position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                          ${svg}
                          <div style="font-size: 8px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; margin-top: -2px;">PAC & Eau Chaude</div>
                        </div>
                        <style>@keyframes pulseGlow { 0% { transform: scale(0.8); opacity: 0.2; } 100% { transform: scale(1.2); opacity: 0.4; } }</style>
                      </div>
                    `;
                  ]]]
                details: |
                  [[[
                    const t_maison = (parseFloat(states['sensor.hp_actuator_io_5470820_9_temperature']?.state) || 0).toFixed(1);
                    const t_ext = (parseFloat(states['sensor.hp_actuator_io_5470820_3_temperature']?.state) || 0).toFixed(1);
                    const s3 = states['water_heater.temperature_ballon'];
                    const t_ballon = (parseFloat(s3?.attributes?.current_temperature || s3?.attributes?.temperature) || 0).toFixed(1);
                    const conso = (parseFloat(states['sensor.eau_chaude_du_jour_calculee']?.state) || 0).toFixed(0);

                    const isMobile = window.innerWidth < 500;
                    const mainGap = isMobile ? "10px" : "25px";
                    const valSize = isMobile ? "14px" : "18px";
                    const labelSize = isMobile ? "9px" : "10px";
                    const iconSize = isMobile ? "16px" : "20px";

                    return `
                      <div style="display: flex; flex-direction: row; align-items: center; justify-content: center; gap: ${mainGap}; height: 100%; width: 100%;">
                        <!-- Groupe 1: Maison & Ext -->
                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                          <div style="display: flex; align-items: baseline; gap: 4px;">
                            <ha-icon icon="mdi:home" style="width: ${iconSize}; height: ${iconSize}; color: #FFA500;"></ha-icon>
                            <span style="font-size: ${valSize}; font-weight: 900; color: white;">${t_maison}°</span>
                          </div>
                          <div style="font-size: ${labelSize}; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px;">Ext. <span style="color: #3DDBB8;">${t_ext}°</span></div>
                        </div>

                        <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.1);"></div>

                        <!-- Groupe 2: Eau Chaude -->
                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                          <div style="display: flex; align-items: baseline; gap: 4px;">
                            <ha-icon icon="mdi:water-boiler" style="width: ${iconSize}; height: ${iconSize}; color: #008CFF;"></ha-icon>
                            <span style="font-size: ${valSize}; font-weight: 900; color: white;">${t_ballon}°</span>
                          </div>
                          <div style="font-size: ${labelSize}; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px;">Conso. <span style="color: #78EBFF;">${conso}L</span></div>
                        </div>
                      </div>
                    `;
                  ]]]
                footer: >
                  [[[ return `<div style="display:flex; width:100%;
                  justify-content:center; align-items:center; padding-bottom:
                  5px;"><ha-icon icon="mdi:chevron-down" style="color:
                  rgba(255,255,255,0.5); width: 16px; height:
                  16px;"></ha-icon></div>`; ]]]
            entities:
              - type: custom:button-card
                show_name: false
                show_icon: false
                styles:
                  card:
                    - background: transparent
                    - border: none
                    - box-shadow: none
                    - padding: 0
                    - margin-top: 15px
                  grid:
                    - grid-template-areas: '"content"'
                    - grid-template-columns: 100%
                custom_fields:
                  content:
                    card:
                      type: horizontal-stack
                      cards:
                        - type: custom:button-card
                          entity: climate.hp_actuator_thermostat
                          name: Pompe à Chaleur
                          show_state: true
                          show_icon: false
                          aspect_ratio: 16/9
                          styles:
                            card:
                              - padding: 0
                              - border-radius: 20px
                              - border: |
                                  [[[
                                    const stateObj = states['binary_sensor.dhwp_actuator_energy_demand_status'];
                                    const heating = stateObj && stateObj.state === 'on';
                                    return heating ? '1px solid rgba(255, 165, 0, 0.5)' : '1px solid rgba(255,255,255,0.1)';
                                  ]]]
                              - background: rgba(20, 27, 38, 0.6)
                              - backdrop-filter: blur(20px)
                              - '-webkit-backdrop-filter': blur(20px)
                              - box-shadow: |
                                  [[[
                                    const stateObj = states['binary_sensor.dhwp_actuator_energy_demand_status'];
                                    const heating = stateObj && stateObj.state === 'on';
                                    return heating 
                                      ? '0 0 20px rgba(255, 165, 0, 0.3), 0 8px 32px rgba(0,0,0,0.3)' 
                                      : '0 8px 32px rgba(0,0,0,0.3)';
                                  ]]]
                              - overflow: hidden
                              - min-height: 220px
                              - transition: all 0.5s ease
                            name:
                              - position: absolute
                              - z-index: 2
                              - top: 12px
                              - left: 0
                              - right: 0
                              - text-align: center
                              - font-size: 16px
                              - font-weight: 700
                              - letter-spacing: 0.5px
                              - color: white
                              - text-shadow: 0 2px 4px rgba(0,0,0,0.8)
                            state:
                              - position: absolute
                              - z-index: 2
                              - top: 34px
                              - left: 0
                              - right: 0
                              - text-align: center
                              - font-size: 13px
                              - opacity: 0.8
                              - font-weight: 500
                              - color: rgba(255,255,255,0.9)
                              - text-shadow: 0 2px 4px rgba(0,0,0,0.8)
                            custom_fields:
                              bg:
                                - position: absolute
                                - inset: 0
                                - z-index: 0
                                - opacity: 0.9
                                - pointer-events: none
                              overlay:
                                - position: absolute
                                - inset: 0
                                - z-index: 1
                                - background: >-
                                    linear-gradient(to bottom, rgba(0,0,0,0.6)
                                    0%, rgba(0,0,0,0) 30%, rgba(0,0,0,0) 70%,
                                    rgba(0,0,0,0.8) 100%)
                                - pointer-events: none
                              gauge_pac:
                                - position: absolute
                                - z-index: 3
                                - left: 16px
                                - top: 60px
                                - bottom: 40px
                                - width: 14px
                                - border-radius: 10px
                                - background: rgba(0,0,0,0.3)
                                - border: 1px solid rgba(255,255,255,0.1)
                                - box-shadow: 0 4px 10px rgba(0,0,0,0.3)
                              gauge_ext:
                                - position: absolute
                                - z-index: 3
                                - right: 16px
                                - top: 60px
                                - bottom: 40px
                                - width: 14px
                                - border-radius: 10px
                                - background: rgba(0,0,0,0.3)
                                - border: 1px solid rgba(255,255,255,0.1)
                                - box-shadow: 0 4px 10px rgba(0,0,0,0.3)
                              ext_label:
                                - position: absolute
                                - z-index: 4
                                - right: 16px
                                - bottom: 20px
                                - font-size: 11px
                                - font-weight: 600
                                - color: rgba(255,255,255,0.8)
                                - text-shadow: 0 1px 2px rgba(0,0,0,0.8)
                                - text-align: center
                                - width: 40px
                                - margin-right: '-13px'
                              temp:
                                - position: absolute
                                - z-index: 4
                                - left: 50%
                                - bottom: 35px
                                - transform: translateX(-50%)
                                - font-size: 28px
                                - font-weight: 800
                                - color: white
                                - text-shadow: 0 4px 12px rgba(0,0,0,0.5)
                                - letter-spacing: '-0.5px'
                              consigne_inline:
                                - position: absolute
                                - z-index: 4
                                - left: 50%
                                - bottom: 15px
                                - transform: translateX(-50%)
                                - font-size: 12px
                                - font-weight: 600
                                - color: rgba(255,255,255,0.7)
                                - background: rgba(0,0,0,0.3)
                                - padding: 2px 8px
                                - border-radius: 10px
                                - border: 1px solid rgba(255,255,255,0.05)
                          custom_fields:
                            overlay: ''
                            bg: |
                              [[[
                                const demand = states['binary_sensor.dhwp_actuator_energy_demand_status'];
                                const heating = demand && demand.state === 'on';
                                const bust = (demand && demand.last_changed ? demand.last_changed : Date.now()).toString().replace(/\D/g,'');
                                const src = heating
                                  ? `/local/pac_atlantic_heating_16_9_nostretch2.png?v=${bust}`
                                  : `/local/pac_atlantic_idle_16_9_nostretch.png?v=${bust}`;
                                const zoom = heating ? 1.4 : 1.6;
                                const anim = heating ? 'animation: pulse_img_anim 1.2s infinite alternate ease-in-out;' : '';
                                return `
                                  <style>
                                    @keyframes pulse_img_anim {
                                      0% { opacity: 0.35; filter: brightness(0.85); }
                                      100% { opacity: 1; filter: brightness(1.15); }
                                    }
                                  </style>
                                  <div style="
                                    width:100%; height:100%;
                                    background: url('${src}') center/contain no-repeat;
                                    transform: scale(${zoom});
                                    transform-origin: center;
                                    transition: transform 0.5s ease;
                                    ${anim}
                                  "></div>
                                `;
                              ]]]
                            temp: |
                              [[[
                                var s = states['sensor.hp_actuator_io_5470820_9_temperature'];
                                var tRaw = s ? s.state : '—';
                                var t = parseFloat(tRaw.toString().replace(',', '.'));
                                return (isFinite(t) ? t.toFixed(1) : '—') + '°';
                              ]]]
                            consigne_inline: |
                              [[[
                                const stateObj = states['climate.hp_actuator_thermostat'];
                                if (!stateObj || !stateObj.attributes) return 'Cible —°';
                                let raw = stateObj.attributes.temperature;
                                if (raw === undefined || raw === null) {
                                  raw = stateObj.attributes.target_temp_high;
                                }
                                const s = parseFloat(raw);
                                return 'Cible ' + (isFinite(s) ? s.toFixed(1) : '—') + '°';
                              ]]]
                            ext_label: |
                              [[[
                                var s = states['sensor.hp_actuator_io_5470820_3_temperature'];
                                var eRaw = s ? s.state : '—';
                                var e = parseFloat(eRaw.toString().replace(',', '.'));
                                return 'Ext\n' + (isFinite(e) ? e.toFixed(1) : '—') + '°';
                              ]]]
                            gauge_pac: |
                              [[[
                                var s = states['sensor.hp_actuator_io_5470820_9_temperature'];
                                var tRaw = s ? s.state : '—';
                                var t = parseFloat(tRaw.toString().replace(',', '.'));
                                var min = -10, max = 38;
                                var safeT = isFinite(t) ? t : min;
                                var pct = Math.max(0, Math.min(100, ((safeT - min) / (max - min)) * 100));
                                var color = 'rgba(255,255,255,0.9)';
                                if (safeT <= 7) color = '#78EBFF';
                                else if (safeT < 19) color = '#008CFF';
                                else if (safeT <= 25) color = '#46D278';
                                else if (safeT <= 31) color = '#FFDC78';
                                else color = '#DC5050';
                                return '<div style="width:100%; height:100%; position:relative; border-radius:10px; overflow:hidden;"><div style="position:absolute; bottom:0; left:0; right:0; height:' + pct + '%; background:' + color + '; transition: all 1s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 0 10px ' + color + ';"></div></div>';
                              ]]]
                            gauge_ext: |
                              [[[
                                var s = states['sensor.hp_actuator_io_5470820_3_temperature'];
                                var eRaw = s ? s.state : '—';
                                var e = parseFloat(eRaw.toString().replace(',', '.'));
                                var min = -10, max = 38;
                                var safeT = isFinite(e) ? e : min;
                                var pct = Math.max(0, Math.min(100, ((safeT - min) / (max - min)) * 100));
                                var color = '#ffffff';
                                if (safeT <= 5) color = '#78EBFF';
                                else if (safeT <= 15) color = '#008CFF';
                                else if (safeT <= 25) color = '#46D278';
                                else if (safeT <= 30) color = '#FFDC78';
                                else color = '#DC5050';
                                return '<div style="width:100%; height:100%; position:relative; border-radius:10px; overflow:hidden;"><div style="position:absolute; bottom:0; left:0; right:0; height:' + pct + '%; background:' + color + '; transition: all 1s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 0 10px ' + color + ';"></div></div>';
                              ]]]
                          extra_styles: |
                            @keyframes pulse_img_anim {
                              0% { opacity: 0.4; filter: brightness(0.8); }
                              100% { opacity: 1; filter: brightness(1.2); }
                            }
                        - type: custom:button-card
                          entity: water_heater.temperature_ballon
                          name: Ballon Thermor
                          show_state: true
                          show_icon: false
                          styles:
                            card:
                              - padding: 0
                              - border-radius: 20px
                              - border: |
                                  [[[
                                    const stateObj = states['binary_sensor.dhwp_actuator_energy_demand_status'];
                                    const heating = stateObj && stateObj.state === 'on';
                                    return heating ? '1px solid rgba(255, 165, 0, 0.5)' : '1px solid rgba(255,255,255,0.1)';
                                  ]]]
                              - background: rgba(20, 27, 38, 0.6)
                              - backdrop-filter: blur(20px)
                              - '-webkit-backdrop-filter': blur(20px)
                              - box-shadow: |
                                  [[[
                                    const stateObj = states['binary_sensor.dhwp_actuator_energy_demand_status'];
                                    const heating = stateObj && stateObj.state === 'on';
                                    return heating 
                                      ? '0 0 20px rgba(255, 165, 0, 0.3), 0 8px 32px rgba(0,0,0,0.3)' 
                                      : '0 8px 32px rgba(0,0,0,0.3)';
                                  ]]]
                              - overflow: hidden
                              - min-height: 220px
                              - transition: all 0.5s ease
                            name:
                              - position: absolute
                              - z-index: 2
                              - top: 12px
                              - left: 0
                              - right: 0
                              - text-align: center
                              - font-size: 16px
                              - font-weight: 700
                              - letter-spacing: 0.5px
                              - color: white
                              - text-shadow: 0 2px 4px rgba(0,0,0,0.8)
                            state:
                              - position: absolute
                              - z-index: 2
                              - top: 34px
                              - left: 0
                              - right: 0
                              - text-align: center
                              - font-size: 13px
                              - opacity: 0.8
                              - font-weight: 500
                              - color: rgba(255,255,255,0.9)
                              - text-shadow: 0 2px 4px rgba(0,0,0,0.8)
                            custom_fields:
                              bg:
                                - position: absolute
                                - inset: 0
                                - z-index: 0
                              overlay:
                                - position: absolute
                                - inset: 0
                                - z-index: 1
                                - background: >-
                                    linear-gradient(to bottom, rgba(0,0,0,0.6)
                                    0%, rgba(0,0,0,0) 30%, rgba(0,0,0,0) 70%,
                                    rgba(0,0,0,0.8) 100%)
                              gauge_temp_ballon:
                                - position: absolute
                                - z-index: 3
                                - left: 16px
                                - top: 60px
                                - bottom: 40px
                                - width: 14px
                                - border-radius: 10px
                                - background: rgba(0,0,0,0.3)
                                - border: 1px solid rgba(255,255,255,0.1)
                                - box-shadow: 0 4px 10px rgba(0,0,0,0.3)
                              gauge:
                                - position: absolute
                                - z-index: 3
                                - right: 16px
                                - top: 60px
                                - bottom: 40px
                                - width: auto
                                - display: flex
                                - gap: 4px
                                - align-items: flex-end
                              max_label:
                                - position: absolute
                                - z-index: 4
                                - right: 6px
                                - top: 56%
                                - transform: translateY(-50%) rotate(-90deg)
                                - font-size: 12px
                                - font-weight: 600
                                - color: rgba(255,255,255,0.6)
                                - text-align: center
                                - width: 80px
                                - opacity: 0.8
                              temp:
                                - position: absolute
                                - z-index: 4
                                - left: 50%
                                - bottom: 35px
                                - transform: translateX(-50%)
                                - font-size: 28px
                                - font-weight: 800
                                - color: white
                                - text-shadow: 0 4px 12px rgba(0,0,0,0.5)
                                - letter-spacing: '-0.5px'
                              conso_inline:
                                - position: absolute
                                - z-index: 4
                                - left: 50%
                                - bottom: 15px
                                - transform: translateX(-50%)
                                - font-size: 12px
                                - font-weight: 600
                                - color: rgba(255,255,255,0.7)
                                - background: rgba(0,0,0,0.4)
                                - padding: 2px 8px
                                - border-radius: 10px
                                - border: 1px solid rgba(255,255,255,0.05)
                          custom_fields:
                            overlay: ''
                            bg: |
                              [[[
                                const stateObj = states['binary_sensor.dhwp_actuator_energy_demand_status'];
                                const heating = stateObj && stateObj.state === 'on';
                                const bust = (stateObj && stateObj.last_changed ? stateObj.last_changed : Date.now()).toString().replace(/\D/g,'');
                                const src = heating 
                                  ? `/local/ballon_thermore_200l_heating.png?v=${bust}` 
                                  : `/local/ballon_thermore_200l.png?v=${bust}`;
                                const anim = heating ? 'animation: pulse_ballon 1.2s infinite alternate ease-in-out;' : '';
                                return `
                                  <style>
                                    @keyframes pulse_ballon {
                                      0% { opacity: 0.35; filter: brightness(0.85); }
                                      100% { opacity: 1; filter: brightness(1.15); }
                                    }
                                  </style>
                                  <div style="
                                    width:100%; height:100%;
                                    background:url('${src}') center/contain no-repeat;
                                    transform: scale(0.85);
                                    transform-origin: center;
                                    ${anim}
                                  "></div>
                                `;
                              ]]]
                            temp: |
                              [[[
                                const stateObj = states['water_heater.temperature_ballon'];
                                const tRaw = stateObj && stateObj.attributes ? (stateObj.attributes.current_temperature || stateObj.attributes.temperature) : '—';
                                const t = parseFloat(tRaw);
                                return `${(isFinite(t) ? t.toFixed(1) : '—')}°`;
                              ]]]
                            conso_inline: |
                              [[[
                                const sensorObj = states['sensor.eau_chaude_du_jour_calculee'];
                                const raw = (sensorObj && sensorObj.state) ? sensorObj.state.toString().replace(',', '.') : '0';
                                const v = parseFloat(raw) || 0;
                                return `${v.toFixed(0)} L / jour`;
                              ]]]
                            max_label: |
                              [[[
                                const sensorObj = states['sensor.eau_chaude_du_jour_calculee'];
                                const raw = (sensorObj && sensorObj.state) ? sensorObj.state.toString().replace(',', '.') : '0';
                                const v = parseFloat(raw) || 0;
                                let max = 200;
                                let color = 'rgba(255,255,255,0.6)';
                                if (v >= 400) {
                                  max = 600;
                                  color = '#DC4646'; // Red
                                } else if (v >= 200) {
                                  max = 400;
                                  color = '#FFA500'; // Orange
                                }
                                return `<span style="color: ${color}; transition: color 0.5s ease;">Max ${max} L</span>`;
                              ]]]
                            gauge_temp_ballon: |
                              [[[
                                const stateObj = states['water_heater.temperature_ballon'];
                                const tRaw = stateObj && stateObj.attributes ? (stateObj.attributes.current_temperature || stateObj.attributes.temperature) : '—';
                                const t = parseFloat(tRaw);
                                const min = 20, max = 65;
                                const safeT = isFinite(t) ? t : min;
                                const pct = Math.max(0, Math.min(100, ((safeT - min) / (max - min)) * 100));
                                
                                let color = '#ffffff';
                                if (safeT <= 35) color = '#008CFF';
                                else if (safeT <= 45) color = '#FFD700';
                                else if (safeT <= 55) color = '#FF8C00';
                                else color = '#DC4646';
                                return `
                                  <div style="width:100%; height:100%; position:relative; border-radius:10px; overflow:hidden;">
                                    <div style="position:absolute; bottom:0; left:0; right:0; height:${pct}%; background:${color}; box-shadow: 0 0 12px ${color}; transition: height 1s ease;"></div>
                                  </div>
                                `;
                              ]]]
                            gauge: |
                              [[[
                                var sensorObj = states['sensor.eau_chaude_du_jour_calculee'];
                                var raw = (sensorObj && sensorObj.state) ? sensorObj.state.toString().replace(',', '.') : '0';
                                var v = parseFloat(raw) || 0;
                                
                                var color1 = '#00B4FF'; // Light blue
                                
                                var barStyle = function() { return `
                                  width: 14px; 
                                  height: 100%; 
                                  position: relative; 
                                  border-radius: 10px; 
                                  background: rgba(0,0,0,0.3); 
                                  border: 1px solid rgba(255,255,255,0.1);
                                  overflow: hidden;
                                `; };
                                
                                var innerStyle = function(pct, clr) { return `
                                  position: absolute; 
                                  bottom: 0; left: 0; right: 0; 
                                  height: ${pct}%; 
                                  background: ${clr}; 
                                  box-shadow: 0 0 10px ${clr}; 
                                  transition: height 0.8s ease;
                                `; };
                                
                                var gaugeOutput = '';
                                
                                // Jauge 1 (0-200)
                                var p1 = Math.max(0, Math.min(100, (v / 200) * 100));
                                gaugeOutput += `<div style="${barStyle()}"><div style="${innerStyle(p1, color1)}"></div></div>`;
                                
                                // Jauge 2 (200-400)
                                if (v >= 200) {
                                  var p2 = Math.max(0, Math.min(100, ((v - 200) / 200) * 100));
                                  gaugeOutput += `<div style="${barStyle()}"><div style="${innerStyle(p2, color1)}"></div></div>`;
                                }
                                
                                // Jauge 3 (400-600)
                                if (v >= 400) {
                                  var p3 = Math.max(0, Math.min(100, ((v - 400) / 200) * 100));
                                  gaugeOutput += `<div style="${barStyle()}"><div style="${innerStyle(p3, color1)}"></div></div>`;
                                }
                                
                                return gaugeOutput;
                              ]]]
                          extra_styles: |
                            @keyframes pulse {
                              0% { opacity: 0.3; }
                              100% { opacity: 1; }
                            }
          - type: entities
            card_mod:
              style: |
                ha-card {
                  background: transparent !important;
                  box-shadow: none !important;
                  border: none !important;
                  padding: 0 !important;
                  margin: 0 !important;
                  width: 100% !important;
                }
                .card-content {
                  padding: 0 !important;
                  margin: 0 !important;
                  width: 100% !important;
                }
            entities:
              - type: custom:fold-entity-row
                full_row: true
                padding: 0
                clickable: true
                card_mod:
                  style: |
                    :host { 
                      --toggle-icon-width: 0px !important;
                    }
                    #head ha-icon, #head ha-icon-button { 
                      display: none !important; 
                      width: 0px !important; 
                      visibility: hidden !important; 
                    }
                    div#head { 
                      display: block !important; 
                      width: 100% !important; 
                      padding: 0 !important; 
                      margin: 0 !important; 
                    }
                    #head { 
                      padding: 0 !important; 
                      margin: 0 !important; 
                      width: 100% !important; 
                      cursor: pointer !important; 
                    }
                    #head > * {
                      width: 100% !important;
                      max-width: 100% !important;
                    }
                head:
                  type: custom:button-card
                  entity: weather.home
                  show_name: false
                  show_icon: false
                  show_state: false
                  tap_action:
                    action: none
                  styles:
                    card:
                      - padding: 0
                      - background: rgba(20, 27, 38, 0.6)
                      - backdrop-filter: blur(10px)
                      - '-webkit-backdrop-filter': blur(10px)
                      - border-radius: 20px
                      - overflow: hidden
                      - transition: all 0.5s ease-in-out
                      - border: |
                          [[[
                            const alert = states['sensor.91_weather_alert'];
                            if (alert && alert.state !== 'Vert' && alert.state !== 'unknown') {
                              const s = String(alert.state).toLowerCase();
                              if (s === 'rouge' || s === '4' || s === 'red') return '1px solid rgba(244, 67, 54, 0.8)';
                              if (s === 'orange' || s === '3') return '1px solid rgba(255, 152, 0, 0.8)';
                              if (s === 'jaune' || s === '2' || s === 'yellow') return '1px solid rgba(255, 235, 59, 0.6)';
                            }
                            return '1px solid rgba(255,255,255,0.1)';
                          ]]]
                      - box-shadow: 0 8px 32px rgba(0,0,0,0.4)
                      - height: auto
                      - pointer-events: none
                    grid:
                      - grid-template-areas: '"img details" "footer footer"'
                      - grid-template-columns: 130px 1fr
                      - grid-template-rows: auto 25px
                      - align-items: stretch
                    custom_fields:
                      img:
                        - justify-self: stretch
                        - align-self: stretch
                        - border-right: 2px solid rgba(255,255,255,0.6)
                        - pointer-events: auto
                      details:
                        - justify-self: stretch
                        - align-self: stretch
                        - padding: 15px 18px
                        - display: flex
                        - flex-direction: column
                        - justify-content: center
                        - gap: 12px
                        - pointer-events: auto
                      footer:
                        - justify-self: stretch
                        - align-self: stretch
                        - background: rgba(0,0,0,0.2)
                        - border-top: 1px solid rgba(255,255,255,0.05)
                        - display: flex
                        - align-items: center
                        - justify-content: center
                        - border-radius: 0 0 20px 20px
                        - pointer-events: none
                  custom_fields:
                    img: |
                      [[[
                        if (!entity) return '...';
                        const state = entity.state;
                        const trans = {
                          'sunny': 'Ensoleillé', 'clear-night': 'Nuit claire', 'cloudy': 'Nuageux',
                          'fog': 'Brouillard', 'hail': 'Grêle', 'lightning': 'Orages',
                          'lightning-rain': 'Pluie orageuse', 'partlycloudy': 'Éclaircies',
                          'pouring': 'Pluie forte', 'rainy': 'Pluvieux', 'snowy': 'Neige',
                          'snowy-rainy': 'Pluie et neige', 'windy': 'Venteux', 'windy-variant': 'Venteux'
                        };
                        const map = {
                          'sunny': { icon: '☀️', color: '#FFD600' }, 'clear-night': { icon: '🌙', color: '#7E57C2' },
                          'cloudy': { icon: '☁️', color: '#90A4AE' }, 'fog': { icon: '🌫️', color: '#B0BEC5' },
                          'hail': { icon: '🌨️', color: '#4FC3F7' }, 'lightning': { icon: '⚡', color: '#FFEB3B' },
                          'lightning-rain': { icon: '⛈️', color: '#FFD600' }, 'partlycloudy': { icon: '⛅', color: '#FFB74D' },
                          'pouring': { icon: '🌧️', color: '#448AFF' }, 'rainy': { icon: '🌦️', color: '#29B6F6' },
                          'snowy': { icon: '❄️', color: '#E1F5FE' }, 'snowy-rainy': { icon: '🌨️', color: '#B3E5FC' },
                          'windy': { icon: '💨', color: '#81C784' }, 'windy-variant': { icon: '🍃', color: '#A5D6A7' }
                        };
                        const theme = map[state] || { icon: '🌡️', color: '#00BFFF' };
                        return `
                          <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${theme.color}33 0%, ${theme.color}0D 100%); cursor: pointer;" 
                               onclick="event.stopPropagation(); const e = new CustomEvent('hass-more-info', { detail: { entityId: 'weather.home' }, bubbles: true, composed: true }); this.dispatchEvent(e);">
                            <div style="font-size: 50px; filter: drop-shadow(0 4px 10px ${theme.color}80);">${theme.icon}</div>
                            <div style="font-size: 11px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${trans[state] || state}</div>
                          </div>
                        `;
                      ]]]
                    details: |
                      [[[
                        if (!entity || !entity.attributes) return '...';
                        const cur = parseFloat(entity.attributes.temperature || 0);
                        const low = parseFloat(entity.attributes.forecast?.[0]?.templow || cur - 3);
                        const high = parseFloat(entity.attributes.forecast?.[0]?.temperature || cur + 4);
                        const range = Math.max(high - low, 1);
                        const pos = Math.min(Math.max(((cur - low) / range) * 100, 0), 100);
                        
                        const alert_ent = states['sensor.91_weather_alert'];
                        let alerts_html = '';
                        if (alert_ent && alert_ent.state !== 'Vert' && alert_ent.state !== 'unknown') {
                          const risks_map = {'inondation': 'mdi:home-flood', 'vent': 'mdi:weather-windy','pluie': 'mdi:weather-pouring', 'orage': 'mdi:weather-lightning','neige': 'mdi:weather-snowy-heavy', 'verglas': 'mdi:weather-snowy-heavy', 'canicule': 'mdi:weather-sunny-alert', 'froid': 'mdi:snowflake-alert', 'avalanche': 'mdi:terrain', 'vague': 'mdi:waves'};
                          const severity_labels = {'1': 'Vert', '2': 'Jaune', '3': 'Orange', '4': 'Rouge','vert': 'Vert', 'jaune': 'Jaune', 'orange': 'Orange', 'rouge': 'Rouge','yellow': 'Jaune', 'red': 'Rouge'};
                          let active_alerts = [];
                          const risk_levels = ['2', '3', '4', 'jaune', 'orange', 'rouge', 'yellow', 'red'];
                          for (const [key, val] of Object.entries(alert_ent.attributes)) {
                            const vs = String(val).toLowerCase();
                            if (risk_levels.includes(vs)) {
                              let icon = 'mdi:alert-decagram';
                              const klow = key.toLowerCase();
                              for (const [kw, ic] of Object.entries(risks_map)) { if (klow.includes(kw)) { icon = ic; break; } }
                              active_alerts.push({name: key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),level: severity_labels[vs] || vs.toUpperCase(),icon: icon});
                            }
                          }
                          const order = { 'Rouge': 1, 'Orange': 2, 'Jaune': 3 };
                          active_alerts.sort((a, b) => (order[a.level] || 99) - (order[b.level] || 99));
                          alerts_html = '<div style="display: flex; flex-direction: column; gap: 8px; margin-top: 5px;">' + active_alerts.map(a => {
                            const l = a.level.toLowerCase();
                            const color = l.includes('rouge') || l.includes('red') ? '#F44336' : (l.includes('orange') ? '#FF9800' : '#FFEB3B');
                            return `<div style="display: flex; justify-content: space-between; align-items: center; background: ${color}20; padding: 10px 15px; border-radius: 12px; border: 1px solid ${color}40;"><div style="display: flex; align-items: center; gap: 10px;"><ha-icon icon="${a.icon}" style="width: 20px; height: 20px; color: ${color}; filter: drop-shadow(0 0 5px ${color}80);"></ha-icon><span style="font-size: 13px; font-weight: 800; color: white;">${a.name}</span></div><span style="font-size: 10px; font-weight: 900; color: ${color}; text-transform: uppercase;">Vigilance ${a.level}</span></div>`;
                          }).join('') + '</div>';
                        }

                        const uv_ent = states['sensor.openuv_maison_indice_uv_actuel'];
                        const sun = states['sun.sun'];
                        const isNight = sun?.state === 'below_horizon' || entity.state === 'clear-night';
                        let uv_val = parseFloat(uv_ent?.state || 0);
                        if (isNight) uv_val = 0;
                        const uv_pct = Math.min((uv_val / 12) * 100, 100);
                        let uv_color = '#4CAF50';
                        if (uv_val >= 3) uv_color = '#FDD835';
                        if (uv_val >= 6) uv_color = '#FB8C00';
                        if (uv_val >= 8) uv_color = '#F44336';
                        if (uv_val >= 11) uv_color = '#9C27B0';

                        return `
                          <div style="cursor: pointer;" 
                               onclick="event.stopPropagation(); const e = new CustomEvent('hass-more-info', { detail: { entityId: 'weather.home' }, bubbles: true, composed: true }); this.dispatchEvent(e);">
                            <div style="display: flex; align-items: center; gap: 10px; width: 100%; margin-bottom: 2px;">
                              <span style="font-size: 12px; font-weight: 900; color: white; min-width: 25px;">${Math.round(low)}°</span>
                              <div style="flex: 1; height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; position: relative;">
                                <div style="position: absolute; width: 100%; height: 100%; background: linear-gradient(90deg, #4FC3F7, #FFA726); border-radius: 6px; opacity: 0.8;"></div>
                                <div style="position: absolute; left: ${pos}%; top: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.5); z-index: 2; border: 2px solid #29B6F6; display: flex; align-items: center; justify-content: center;">
                                  <span style="color: #141B26; font-size: 11px; font-weight: 900;">${Math.round(cur)}°</span>
                                </div>
                              </div>
                              <span style="font-size: 12px; font-weight: 900; color: white; min-width: 25px; text-align: right;">${Math.round(high)}°</span>
                            </div>
                            ${alerts_html}
                            <div style="display: flex; flex-direction: column; gap: 8px; width: 100%; margin-top: 8px;">
                              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                                 <span style="font-size: 11px; font-weight: 950; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px;">Indice UV</span>
                              </div>
                              <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                <span style="font-size: 12px; font-weight: 900; color: white; min-width: 25px;">0</span>
                                <div style="flex: 1; height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; position: relative; border: 1px solid rgba(255,255,255,0.05);">
                                  <div style="position: absolute; width: 100%; height: 100%; background: linear-gradient(90deg, #4CAF50 0%, #FDD835 25%, #FB8C00 50%, #F44336 75%, #9C27B0 100%); border-radius: 6px; opacity: 0.8;"></div>
                                  <div style="position: absolute; left: ${uv_pct}%; top: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.5); z-index: 2; border: 2px solid ${uv_color}; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: #141B26; font-size: 11px; font-weight: 900;">${uv_val.toFixed(1)}</span>
                                  </div>
                                </div>
                                <span style="font-size: 12px; font-weight: 900; color: white; min-width: 30px; text-align: right;">12</span>
                              </div>
                            </div>
                          </div>
                        `;
                      ]]]
                    footer: |
                      [[[
                        return `<div style="display:flex; width:100%; justify-content:center; align-items:center;"><ha-icon icon="mdi:chevron-down" style="color: rgba(255,255,255,0.7); width: 18px; height: 18px;"></ha-icon></div>`;
                      ]]]
                entities:
                  - type: custom:button-card
                    color_type: blank-card
                    styles:
                      card:
                        - height: 14px
                  - type: custom:button-card
                    show_name: false
                    show_icon: false
                    show_state: false
                    tap_action:
                      action: more-info
                      entity: sensor.openuv_maison_indice_uv_actuel
                    styles:
                      card:
                        - padding: 0
                        - background: rgba(20, 27, 38, 0.6)
                        - backdrop-filter: blur(10px)
                        - '-webkit-backdrop-filter': blur(10px)
                        - border-radius: 20px
                        - border: 1px solid rgba(126, 87, 194, 0.4)
                        - box-shadow: 0 8px 32px rgba(0,0,0,0.4)
                        - min-height: 110px
                        - height: auto
                      grid:
                        - grid-template-areas: '"icon details"'
                        - grid-template-columns: 130px minmax(0, 1fr)
                        - grid-template-rows: 1fr
                      custom_fields:
                        icon:
                          - justify-self: stretch
                          - align-self: stretch
                          - border-right: 2px solid rgba(255,255,255,0.6)
                          - border-top-left-radius: 20px
                          - border-bottom-left-radius: 20px
                          - display: flex
                          - align-items: center
                          - justify-content: center
                        details:
                          - justify-self: stretch
                          - align-self: stretch
                          - display: flex
                          - flex-direction: column
                          - justify-content: center
                          - align-items: center
                          - padding: 12px 10px
                    custom_fields:
                      icon: |
                        [[[
                          const purple = "#7E57C2";
                          return `
                            <div style="width:100%;height:100%;display:flex;flex-direction:column;
                            align-items:center;justify-content:center;
                            background:linear-gradient(135deg,${purple}33 0%,${purple}0D 100%);
                            border-top-left-radius:20px;border-bottom-left-radius:20px;">
                              <ha-icon icon="mdi:white-balance-sunny"
                              style="width:42px;height:42px;color:#FFD54F;
                              filter:drop-shadow(0 4px 8px rgba(0,0,0,0.5));"></ha-icon>
                              <div style="font-size:10px;font-weight:900;color:white;
                              text-transform:uppercase;letter-spacing:1px;margin-top:-4px;">
                              UV
                              </div>
                            </div>
                          `;
                        ]]]
                      details: |
                        [[[
                          const sunState = states['sun.sun']?.state;
                          const uvReal = parseFloat(states['sensor.openuv_maison_indice_uv_actuel']?.state ?? 'NaN');
                          const uv = (sunState === 'below_horizon') ? 0.0 : uvReal;
                          const uvTxt = Number.isFinite(uv) ? uv.toFixed(1) : '?';
                          const count = parseInt(states['counter.openuv_updates_today']?.state ?? '0');
                          const intervalS = parseInt(states['input_number.openuv_interval_seconds']?.state ?? '0');
                          const intervalMin = intervalS ? Math.round(intervalS / 60) : 0;
                          const remaining = Math.max(0, 50 - count);
                          const pctRaw = Math.round((count / 50) * 100);
                          const pct = (count > 0 && pctRaw < 8) ? 8 : pctRaw;
                          const pad2 = (n) => String(n).padStart(2, '0');
                          const fmtFR = (d) => `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
                          const lastDtStr = states['input_datetime.openuv_last_update']?.state || '';
                          let lastFR = '—';
                          const lastTs = parseInt(states['input_number.openuv_last_update_ts']?.state ?? '0');
                          if (lastTs > 0) { lastFR = fmtFR(new Date(lastTs * 1000)); }
                          else if (lastDtStr) { const d = new Date(lastDtStr.replace(' ', 'T')); if (!isNaN(d.getTime())) lastFR = fmtFR(d); }
                          let nextFR = '—';
                          if (sunState === 'above_horizon' && lastTs > 0 && intervalS > 0) { nextFR = fmtFR(new Date((lastTs + intervalS) * 1000)); }
                          const uvColor = (v) => {
                            if (v < 3) return "#00C853";
                            if (v < 6) return "#FFEB3B";
                            if (v < 8) return "#FF9800";
                            if (v < 11) return "#F44336";
                            return "#9C27B0";
                          };
                          return `
                          <div style="display:flex;flex-direction:column;width:100%;
                          align-items:center;justify-content:center;text-align:center;">
                            <div style="display:flex;align-items:baseline;gap:10px;margin-bottom:6px;">
                              <div style="font-size:12px;font-weight:800;color:rgba(255,255,255,0.65);text-transform:uppercase;">Indice UV</div>
                              <div style="font-size:28px;font-weight:900;color:${uvColor(uv)};text-shadow:0 6px 16px rgba(0,0,0,0.45);">${uvTxt}</div>
                            </div>
                            <div style="display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-bottom:8px;">
                              <div style="font-size:10px;color:rgba(255,255,255,0.6);font-weight:700;">DERNIÈRE: <span style="color:white;font-weight:800;">${lastFR}</span></div>
                              <div style="font-size:10px;color:rgba(255,255,255,0.6);font-weight:700;">PROCHAINE: <span style="color:white;font-weight:800;">${nextFR}</span></div>
                              <div style="font-size:10px;color:rgba(255,255,255,0.6);font-weight:700;">INTERVALLE: <span style="color:white;font-weight:800;">${intervalMin}min</span></div>
                            </div>
                            <div style="width:92%; margin-top:-6px; padding-bottom:6px;">
                              <div style="display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,0.6);font-weight:800;margin-bottom:4px;">
                                <div>MAJ ${count}/50</div>
                                <div>RESTE ${remaining}</div>
                              </div>
                              <div style="width:100%;height:8px;background:rgba(255,255,255,0.1);border-radius:999px;overflow:hidden;">
                                <div style="height:100%;width:${pct}%;background:rgba(126,87,194,0.9);box-shadow:0 0 16px rgba(126,87,194,0.5);"></div>
                              </div>
                            </div>
                          </div>
                          `;
                        ]]]
      - type: grid
        cards:
          - type: entities
            card_mod:
              style: |
                ha-card {
                  background: none !important;
                  border: none !important;
                  box-shadow: none !important;
                  padding: 0 !important;
                  margin: 0 !important;
                }
                #states {
                  padding: 0 !important;
                  margin: 0 !important;
                }
                .card-content {
                  padding: 0 !important;
                  margin: 0 !important;
                }
            entities:
              - type: custom:fold-entity-row
                padding: 0
                clickable: true
                card_mod:
                  style: |
                    div#head {
                      display: block !important;
                      width: 100% !important;
                      padding: 0 !important;
                      margin: 0 !important;
                      --toggle-icon-width: 0px !important;
                    }
                    #head {
                      padding: 0 !important;
                      margin: 0 !important;
                      width: 100% !important;
                      cursor: pointer !important;
                      pointer-events: auto !important;
                    }
                    #head ha-icon {
                      display: none !important;
                      width: 0px !important;
                    }
                    div#items {
                      padding: 0 !important;
                      margin: 0 !important;
                    }
                head:
                  type: custom:button-card
                  entity: sensor.suivi_greffe_jour
                  show_name: false
                  show_icon: false
                  tap_action:
                    action: none
                  styles:
                    card:
                      - padding: 0
                      - background: rgba(20, 27, 38, 0.6)
                      - backdrop-filter: blur(10px)
                      - '-webkit-backdrop-filter': blur(10px)
                      - border-radius: 20px
                      - border: 1px solid rgba(79, 195, 247, 0.4)
                      - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                      - overflow: hidden
                      - margin: 0px
                      - box-sizing: border-box
                      - cursor: pointer
                      - pointer-events: none
                    grid:
                      - grid-template-areas: '"icon details" "footer footer"'
                      - grid-template-columns: 130px minmax(0, 1fr)
                      - grid-template-rows: 95px 30px
                      - gap: 0px
                      - width: 100%
                      - margin: 0
                    custom_fields:
                      icon:
                        - justify-self: stretch
                        - align-self: stretch
                        - border-right: 2px solid rgba(255,255,255,0.6)
                        - border-top-left-radius: 20px
                        - display: flex
                        - align-items: center
                        - justify-content: center
                        - padding: 0
                      details:
                        - justify-self: stretch
                        - align-self: stretch
                        - display: flex
                        - flex-direction: column
                        - justify-content: center
                        - align-items: center
                        - padding: 0
                        - overflow: hidden
                        - position: relative
                      footer:
                        - justify-self: stretch
                        - align-self: stretch
                        - background: rgba(0,0,0,0.2)
                        - border-top: 1px solid rgba(255,255,255,0.05)
                        - display: flex
                        - align-items: center
                        - justify-content: center
                        - border-radius: 0 0 20px 20px
                  custom_fields:
                    icon: |
                      [[[
                        const svg = `
                          <svg viewBox="0 0 100 100" width="65" height="65" style="filter: drop-shadow(0 6px 12px rgba(0,0,0,0.5));">
                            <defs>
                              <linearGradient id="kitBody" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#f0f0f0;stop-opacity:1" />
                              </linearGradient>
                              <linearGradient id="handleGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#d0d0d0;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#a0a0a0;stop-opacity:1" />
                              </linearGradient>
                              <radialGradient id="crossGlow" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" style="stop-color:#4fc3f7;stop-opacity:0.4" />
                                <stop offset="100%" style="stop-color:#4fc3f7;stop-opacity:0" />
                              </radialGradient>
                            </defs>
                            <!-- Handle -->
                            <path d="M35,25 Q35,15 50,15 Q65,15 65,25" fill="none" stroke="url(#handleGrad)" stroke-width="6" stroke-linecap="round" />
                            <!-- Main Body -->
                            <rect x="20" y="25" width="60" height="50" rx="12" ry="12" fill="url(#kitBody)" />
                            <!-- Reflection/Gloss -->
                            <rect x="25" y="30" width="50" height="15" rx="8" ry="8" fill="white" opacity="0.4" />
                            <!-- The Cross -->
                            <rect x="46" y="40" width="8" height="20" rx="2" fill="#4fc3f7" />
                            <rect x="40" y="46" width="20" height="8" rx="2" fill="#4fc3f7" />
                            <!-- Glow behind cross -->
                            <circle cx="50" cy="50" r="18" fill="url(#crossGlow)" />
                          </svg>
                        `;
                        return `
                          <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(79, 195, 247, 0.15) 0%, rgba(20, 27, 38, 0) 100%); border-top-left-radius: 20px; box-sizing: border-box; padding: 10px;">
                            <div style="width: 75px; height: 75px; display: flex; align-items: center; justify-content: center; position: relative;">
                              <div style="position: absolute; width: 50px; height: 50px; background: #4fc3f7; border-radius: 50%; filter: blur(25px); opacity: 0.5;"></div>
                              <div style="position: relative; z-index: 1;">${svg}</div>
                            </div>
                            <div style="font-size: 11px; font-weight: 900; color: white; text-align: center; line-height: 1.1; letter-spacing: 0.8px; text-transform: uppercase;">
                              SUIVI<br/>POST-GREFFE
                            </div>
                          </div>
                        `;
                      ]]]
                    details: |
                      [[[
                        const start = new Date('2025-10-24T00:00:00');
                        const now = new Date();
                        let months = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
                        let days = now.getDate() - start.getDate();
                        if (days < 0) {
                          months--;
                          const prevMonthLastDay = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
                          days += prevMonthLastDay;
                        }
                        
                        // Calcul J+ Global
                        const timeDiff = now.getTime() - start.getTime();
                        const jPlus = Math.floor(timeDiff / (1000 * 3600 * 24));
                        
                        // Calcul "Cela fera x mois dans x jours"
                        let nextMonthMilestone = new Date(start.getFullYear(), start.getMonth() + months + 1, start.getDate());
                        
                        // Corriger si le jour de greffe (ex: 24) n'existe pas dans le mois cible (ex: février)
                        if (nextMonthMilestone.getDate() !== start.getDate()) {
                           nextMonthMilestone = new Date(nextMonthMilestone.getFullYear(), nextMonthMilestone.getMonth(), 0);
                        }
                        
                        let daysUntilNextMonth = Math.ceil((nextMonthMilestone.getTime() - now.getTime()) / (1000 * 3600 * 24));
                        
                        // Si c'est aujourd'hui le jour milestone
                        let futureText = "";
                        if (now.getDate() === start.getDate()) {
                          futureText = `Cela fait ${months} mois pile aujourd'hui !`;
                        } else {
                          futureText = `Cela fera ${months + 1} mois dans ${daysUntilNextMonth} jours`;
                        }

                        let confettis = "";
                        if (now.getDate() === 24) {
                          confettis = '<div style="position:absolute; width:100%; height:100%; overflow:hidden; pointer-events:none; z-index:0;">';
                          for (let i = 0; i < 15; i++) {
                            const color = ["#FFD700", "#FF4500", "#ADFF2F", "#00BFFF", "#FF1493"][i % 5];
                            const left = Math.floor(Math.random() * 100);
                            const delay = (Math.random() * 2).toFixed(1);
                            confettis += `<div style="position:absolute; width:4px; height:10px; background:${color}; left:${left}%; top:-20px; border-radius:2px; animation: confetti-fall 3s linear infinite; animation-delay:${delay}s; opacity:0.8;"></div>`;
                          }
                          confettis += `
                            <style>
                              @keyframes confetti-fall {
                                0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                                100% { transform: translateY(120px) rotate(360deg); opacity: 0; }
                              }
                            </style></div>
                          `;
                        }

                        return `
                          ${confettis}
                          <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0 15px; position: relative; z-index: 1;">
                            <div style="font-size: 32px; font-weight: 900; color: white; line-height: 1; text-shadow: 0 0 10px rgba(255,255,255,0.2);">J+${jPlus}</div>
                            <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.7); margin-top:2px; text-transform:uppercase; letter-spacing:0.5px;">${months} mois et ${days} ${days > 1 ? "jours" : "jour"}</div>
                            
                            <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); width: 80%; display: flex; justify-content: center;">
                              <span style="font-size: 10px; font-weight: 700; color: #4fc3f7; text-transform: uppercase; letter-spacing: 0.5px;">${futureText}</span>
                            </div>
                          </div>
                        `;
                      ]]]
                    footer: |
                      [[[
                         return `
                           <div style="display:flex; width:100%; justify-content:center; align-items:center;">
                             <ha-icon icon="mdi:chevron-down" style="color: rgba(255,255,255,0.4); width: 24px; height: 24px; transition: all 0.3s ease;"></ha-icon>
                           </div>
                         `;
                      ]]]
                entities:
                  - type: custom:button-card
                    entity: sensor.suivi_greffe_jour
                    show_name: false
                    show_icon: false
                    styles:
                      card:
                        - background: none
                        - box-shadow: none
                        - border: none
                        - padding: 0
                        - margin-top: 10px
                      grid:
                        - grid-template-areas: '"tasks"'
                        - grid-template-columns: 1fr
                        - grid-template-rows: auto
                      custom_fields:
                        tasks:
                          - width: 100%
                    custom_fields:
                      tasks: |
                        [[[
                          if (!entity || !entity.attributes) return `<div style="padding:20px;color:rgba(255,255,255,0.5); text-align:center;">Chargement...</div>`;
                          var tasks = [
                            { key: 'shampoing_aujourdhui', name: 'Shampoing', icon: 'mdi:shower', color: '#1e88e5' },
                            { key: 'vitamine_aujourdhui', name: 'Vitamines', icon: 'mdi:pill-multiple', color: '#2e7d32' },
                            { key: 'serum_ozone_aujourdhui', name: 'Sérum ozonée', icon: 'mdi:beaker-outline', color: '#8e24aa' },
                            { key: 'dermaroller_serum_aujourdhui', name: 'Dermaroller', icon: 'mdi:needle', color: '#fb8c00' },
                            { key: 'huile_capillaire_aujourdhui', name: 'Huile', icon: 'mdi:eyedropper-variant', color: '#6d4c41' },
                            { key: 'massage_cuir_chevelu_aujourdhui', name: 'Massage', icon: 'mdi:hand-back-right', color: '#00897b' },
                            { key: 'prp_aujourdhui', name: 'PRP', icon: 'mdi:hospital-marker', color: '#e91e63' }
                          ];
                          
                          var titleHtml = `
                            <div style="width: 100%; text-align: left; margin-bottom: 12px; padding-left: 4px;">
                              <span style="font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1.5px;">À FAIRE AUJOURD'HUI :</span>
                            </div>
                          `;
                          
                          var html = '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
                          var count = 0;
                          for (var i = 0; i < tasks.length; i++) {
                            var t = tasks[i];
                            var val = entity.attributes[t.key];
                            if (val) {
                              count++;
                              var displayVal = (val === true) ? 'À faire' : val;
                              html += '<div style="flex: 1 1 30%; min-width: 100px; height: 100px; box-sizing: border-box; padding: 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); background: rgba(20, 27, 38, 0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center;">'
                                  + '<ha-icon icon="' + t.icon + '" style="--mdc-icon-size: 32px; color: ' + t.color + '; filter: drop-shadow(0 0 8px ' + t.color + 'aa); margin-bottom: 8px;"></ha-icon>'
                                  + '<div style="font-size: 13px; font-weight: 700; color: white;">' + t.name + '</div>'
                                  + '<div style="font-size: 11px; font-weight: 500; opacity: 0.7; margin-top: 4px; color: white;">' + displayVal + '</div>'
                                + '</div>';
                            }
                          }
                          html += '</div>';
                          if (count === 0) return '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.7); font-weight: 500;">Rien à faire aujourd\'hui ! 🎉</div>';
                          return titleHtml + html;
                        ]]]
          - type: custom:fold-entity-row
            padding: 0
            clickable: true
            card_mod:
              style: >
                div#head { display: block !important; width: 100% !important;
                padding: 0 !important; margin: 0 !important;
                --toggle-icon-width: 0px !important; }

                #head { padding: 0 !important; margin: 0 !important; width: 100%
                !important; cursor: pointer !important; }

                #head ha-icon { display: none !important; }

                div#items { padding: 0 !important; margin: 0 !important; }
            head:
              type: custom:button-card
              show_name: false
              show_icon: false
              show_state: false
              styles:
                card:
                  - padding: 0
                  - background: rgba(20, 27, 38, 0.6)
                  - backdrop-filter: blur(10px)
                  - '-webkit-backdrop-filter': blur(10px)
                  - border-radius: 20px
                  - border: 1px solid rgba(126, 87, 194, 0.4)
                  - box-shadow: 0 8px 32px rgba(0,0,0,0.4)
                  - height: 85px
                grid:
                  - grid-template-areas: '"icon details" "footer footer"'
                  - grid-template-columns: 130px minmax(0, 1fr)
                  - grid-template-rows: 58px 27px
                custom_fields:
                  icon:
                    - justify-self: stretch
                    - align-self: stretch
                    - border-right: 2px solid rgba(255,255,255,0.6)
                    - border-top-left-radius: 20px
                    - display: flex
                    - align-items: center
                    - justify-content: center
                  details:
                    - justify-self: stretch
                    - align-self: stretch
                    - display: flex
                    - flex-direction: column
                    - justify-content: center
                    - align-items: center
                    - padding: 0 10px
              custom_fields:
                icon: |
                  [[[
                    const purple = "#7E57C2";
                    const svg = `
                      <svg viewBox="0 0 100 100" width="42" height="42" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));">
                        <defs>
                          <linearGradient id="camBody" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#e0e0e0;stop-opacity:1" />
                          </linearGradient>
                          <linearGradient id="lensGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#1a1a1a;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#000000;stop-opacity:1" />
                          </linearGradient>
                        </defs>
                        <!-- Bracket -->
                        <path d="M50,65 L50,80 M40,80 L60,80" stroke="#ccc" stroke-width="4" stroke-linecap="round" />
                        <!-- Camera Body -->
                        <rect x="25" y="25" width="50" height="40" rx="10" ry="10" fill="url(#camBody)" />
                        <!-- Lens Glass -->
                        <circle cx="50" cy="45" r="15" fill="#222" />
                        <circle cx="50" cy="45" r="10" fill="url(#lensGrad)" />
                        <!-- Reflections -->
                        <circle cx="46" cy="41" r="3" fill="#4dabf7" opacity="0.3" filter="blur(1px)" />
                        <!-- LED -->
                        <circle cx="68" cy="33" r="1.5" fill="#00E676" style="animation: blinkLED 2s infinite;" />
                        <style>@keyframes blinkLED { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }</style>
                      </svg>
                    `;
                    return `
                      <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${purple}33 0%, ${purple}0D 100%); border-top-left-radius: 20px; position: relative;">
                        <div style="position: absolute; width: 50px; height: 50px; background: ${purple}; border-radius: 50%; filter: blur(20px); opacity: 0.3; animation: pulseGlow 4s infinite alternate ease-in-out;"></div>
                        <div style="position: relative; z-index: 1;">${svg}</div>
                        <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; margin-top: -8px; z-index: 1;">Caméras</div>
                        <style>@keyframes pulseGlow { from { opacity: 0.2; transform: scale(0.9); } to { opacity: 0.4; transform: scale(1.1); } }</style>
                      </div>
                    `;
                  ]]]
                details: |
                  [[[
                    const batPortail = states['sensor.camera_portail_batterie']?.state || '?';
                    const batBal = states['sensor.camera_boite_a_lettre_batterie']?.state || '?';
                    const getCol = (s) => (parseInt(s) > 20 ? "#00C853" : "#E53935");

                    return `
                      <div style="display: flex; flex-direction: column; width: 100%; height: 100%; align-items: center; justify-content: center; text-align: center;">
                        <div style="font-size: 13px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Extérieures</div>
                        <div style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                          <div style="font-size: 10px; color: rgba(255,255,255,0.6); font-weight: 600;">PORTAIL: <span style="color: ${getCol(batPortail)}; font-weight: 800;">${batPortail}%</span></div>
                          <div style="font-size: 10px; color: rgba(255,255,255,0.6); font-weight: 600;">BAL: <span style="color: ${getCol(batBal)}; font-weight: 800;">${batBal}%</span></div>
                        </div>
                      </div>
                    `;
                  ]]]
                footer: >
                  [[[ return `<div style="display:flex; width:100%;
                  justify-content:center; padding: 5px;"><ha-icon
                  icon="mdi:chevron-down" style="color:rgba(255,255,255,0.5);
                  width:18px;"></ha-icon></div>`; ]]]
            entities:
              - type: custom:mod-card
                card_mod:
                  style: >
                    ha-card { margin: 15px 10px; background: transparent;
                    border: none; }
                card:
                  type: grid
                  columns: 2
                  square: false
                  cards:
                    - type: vertical-stack
                      cards:
                        - type: custom:button-card
                          name: ACTIVER
                          icon: mdi:play
                          show_icon: true
                          tap_action:
                            action: call-service
                            service: button.press
                            target:
                              entity_id: button.portail_start_rtsp_stream
                          styles:
                            card:
                              - background: rgba(0, 200, 83, 0.2)
                              - border: 1px solid rgba(0, 200, 83, 0.4)
                              - border-radius: 8px
                              - height: 40px
                              - margin-bottom: 8px
                            name:
                              - font-size: 11px
                              - font-weight: 800
                              - color: white
                            icon:
                              - color: '#00C853'
                              - width: 18px
                        - type: custom:button-card
                          entity: image.portail_event_image
                          show_entity_picture: true
                          show_name: false
                          tap_action:
                            action: more-info
                            entity: camera.camera_portail
                          styles:
                            card:
                              - height: 120px
                              - border-radius: 12px
                              - border: 1px solid rgba(255, 255, 255, 0.1)
                              - overflow: hidden
                            entity_picture:
                              - width: 100%
                              - height: 100%
                              - object-fit: cover
                    - type: vertical-stack
                      cards:
                        - type: custom:button-card
                          name: ACTIVER
                          icon: mdi:play
                          show_icon: true
                          tap_action:
                            action: call-service
                            service: button.press
                            target:
                              entity_id: button.boite_a_lettres_start_rtsp_stream
                          styles:
                            card:
                              - background: rgba(0, 200, 83, 0.2)
                              - border: 1px solid rgba(0, 200, 83, 0.4)
                              - border-radius: 8px
                              - height: 40px
                              - margin-bottom: 8px
                            name:
                              - font-size: 11px
                              - font-weight: 800
                              - color: white
                            icon:
                              - color: '#00C853'
                              - width: 18px
                        - type: custom:button-card
                          entity: image.boite_a_lettres_event_image
                          show_entity_picture: true
                          show_name: false
                          tap_action:
                            action: more-info
                            entity: camera.camera_boite_a_lettres
                          styles:
                            card:
                              - height: 120px
                              - border-radius: 12px
                              - border: 1px solid rgba(255, 255, 255, 0.1)
                              - overflow: hidden
                            entity_picture:
                              - width: 100%
                              - height: 100%
                              - object-fit: cover
          - type: custom:fold-entity-row
            padding: 0
            clickable: true
            card_mod:
              style: >
                div#head { display: block !important; width: 100% !important;
                padding: 0 !important; margin: 0 !important;
                --toggle-icon-width: 0px !important; }

                #head { padding: 0 !important; margin: 0 !important; width: 100%
                !important; cursor: pointer !important; }

                #head ha-icon { display: none !important; }

                div#items { padding: 0 !important; margin: 0 !important; }
            head:
              type: custom:button-card
              show_name: false
              show_icon: false
              show_state: false
              styles:
                card:
                  - padding: 0
                  - background: rgba(20, 27, 38, 0.6)
                  - backdrop-filter: blur(10px)
                  - '-webkit-backdrop-filter': blur(10px)
                  - border-radius: 20px
                  - border: 1px solid rgba(0, 191, 255, 0.4)
                  - box-shadow: 0 8px 32px rgba(0,0,0,0.4)
                  - height: 85px
                grid:
                  - grid-template-areas: '"icon details" "footer footer"'
                  - grid-template-columns: 130px minmax(0, 1fr)
                  - grid-template-rows: 58px 27px
                custom_fields:
                  icon:
                    - justify-self: stretch
                    - align-self: stretch
                    - border-right: 2px solid rgba(255,255,255,0.6)
                    - border-top-left-radius: 20px
                    - display: flex
                    - align-items: center
                    - justify-content: center
                  details:
                    - justify-self: stretch
                    - align-self: stretch
                    - display: flex
                    - flex-direction: column
                    - justify-content: center
                    - align-items: center
                    - padding: 0 10px
              custom_fields:
                icon: |
                  [[[
                    const blue = "#00BFFF";
                    const svg = `
                      <svg viewBox="0 0 100 100" width="42" height="42" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));">
                        <defs>
                          <linearGradient id="camHead" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#f0f0f0;stop-opacity:1" />
                          </linearGradient>
                          <linearGradient id="lensReflect" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#1a1a1a;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#000000;stop-opacity:1" />
                          </linearGradient>
                        </defs>
                        <!-- Camera Base -->
                        <path d="M35,80 L65,80 L60,70 L40,70 Z" fill="#e0e0e0" />
                        <!-- Neck -->
                        <rect x="45" y="65" width="10" height="8" fill="#d0d0d0" />
                        <!-- Camera Head (Spherical) -->
                        <circle cx="50" cy="45" r="25" fill="url(#camHead)" stroke="#eee" stroke-width="0.5" />
                        <!-- Lens Black Area -->
                        <circle cx="50" cy="45" r="18" fill="#111" />
                        <circle cx="50" cy="45" r="12" fill="url(#lensReflect)" />
                        <!-- Reflections -->
                        <ellipse cx="46" cy="40" rx="4" ry="2" fill="white" opacity="0.15" transform="rotate(-30 46 40)" />
                        <circle cx="48" cy="42" r="3" fill="#00BFFF" opacity="0.3" filter="blur(1px)" />
                        <!-- LED -->
                        <circle cx="50" cy="28" r="1.5" fill="#00E676" style="animation: blinkLED 2.5s infinite;" />
                        <style>@keyframes blinkLED { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }</style>
                      </svg>
                    `;
                    return `
                      <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${blue}33 0%, ${blue}0D 100%); border-top-left-radius: 20px; position: relative;">
                        <div style="position: absolute; width: 50px; height: 50px; background: ${blue}; border-radius: 50%; filter: blur(20px); opacity: 0.3; animation: pulseGlow 4s infinite alternate ease-in-out;"></div>
                        <div style="position: relative; z-index: 1;">${svg}</div>
                        <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; margin-top: -8px; z-index: 1;">Caméras</div>
                        <style>@keyframes pulseGlow { from { opacity: 0.2; transform: scale(0.9); } to { opacity: 0.4; transform: scale(1.1); } }</style>
                      </div>
                    `;
                  ]]]
                details: |
                  [[[
                    return `
                      <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center;">
                        <div style="font-size: 13px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px;">INTÉRIEURES</div>
                        <div style="font-size: 10px; color: #46D278; font-weight: 700; display: flex; align-items: center; gap: 5px; justify-content: center;">
                          <span style="width: 6px; height: 6px; background: #46D278; border-radius: 50%; display: inline-block; animation: pulseLED 2s infinite;"></span>
                          SALON, CHAMBRE & BUREAU EN LIGNE
                        </div>
                      </div>
                      <style>@keyframes pulseLED { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }</style>
                    `;
                  ]]]
                footer: >
                  [[[ return `<div style="display:flex; width:100%;
                  justify-content:center; padding: 5px;"><ha-icon
                  icon="mdi:chevron-down" style="color:rgba(255,255,255,0.5);
                  width:18px;"></ha-icon></div>`; ]]]
            entities:
              - type: custom:button-card
                name: CAMÉRA SALON
                styles:
                  card:
                    - background: none
                    - border: none
                    - padding: 10px 15px 5px 15px
                  name:
                    - color: rgba(255,255,255,0.4)
                    - font-size: 10px
                    - font-weight: 800
                    - text-transform: uppercase
                    - justify-self: start
              - type: custom:button-card
                tap_action:
                  action: fire-dom-event
                  browser_mod:
                    service: browser_mod.popup
                    data:
                      title: Live Salon
                      content:
                        type: custom:webrtc-camera
                        url: >-
                          rtsp://[USER]:[PASSWORD]@192.168.1.77/stream1
                styles:
                  card:
                    - margin: 0 10px 15px 10px
                    - border-radius: 12px
                    - overflow: hidden
                    - border: 1px solid rgba(255,255,255,0.1)
                    - padding: 0
                    - background: black
                  grid:
                    - grid-template-areas: '"cam"'
                    - grid-template-columns: 1fr
                  custom_fields:
                    cam:
                      - pointer-events: none
                      - width: 100%
                custom_fields:
                  cam:
                    card:
                      type: custom:webrtc-camera
                      url: >-
                        rtsp://[USER]:[PASSWORD]@192.168.1.77/stream1
                      ui: false
              - type: custom:button-card
                name: CAMÉRA CHAMBRE
                styles:
                  card:
                    - background: none
                    - border: none
                    - padding: 10px 15px 5px 15px
                  name:
                    - color: rgba(255,255,255,0.4)
                    - font-size: 10px
                    - font-weight: 800
                    - text-transform: uppercase
                    - justify-self: start
              - type: custom:button-card
                tap_action:
                  action: fire-dom-event
                  browser_mod:
                    service: browser_mod.popup
                    data:
                      title: Live Chambre
                      content:
                        type: custom:webrtc-camera
                        url: >-
                          rtsp://[USER]:[PASSWORD]@192.168.1.79/stream1
                styles:
                  card:
                    - margin: 0 10px 15px 10px
                    - border-radius: 12px
                    - overflow: hidden
                    - border: 1px solid rgba(255,255,255,0.1)
                    - padding: 0
                    - background: black
                  grid:
                    - grid-template-areas: '"cam"'
                    - grid-template-columns: 1fr
                  custom_fields:
                    cam:
                      - pointer-events: none
                      - width: 100%
                custom_fields:
                  cam:
                    card:
                      type: custom:webrtc-camera
                      url: >-
                        rtsp://[USER]:[PASSWORD]@192.168.1.79/stream1
                      ui: false
              - type: custom:button-card
                name: CAMÉRA BUREAU
                styles:
                  card:
                    - background: none
                    - border: none
                    - padding: 10px 15px 5px 15px
                  name:
                    - color: rgba(255,255,255,0.4)
                    - font-size: 10px
                    - font-weight: 800
                    - text-transform: uppercase
                    - justify-self: start
              - type: custom:button-card
                tap_action:
                  action: fire-dom-event
                  browser_mod:
                    service: browser_mod.popup
                    data:
                      title: Live Bureau
                      content:
                        type: custom:webrtc-camera
                        url: >-
                          rtsp://[USER]:[PASSWORD]@192.168.1.70/stream1
                styles:
                  card:
                    - margin: 0 10px 15px 10px
                    - border-radius: 12px
                    - overflow: hidden
                    - border: 1px solid rgba(255,255,255,0.1)
                    - padding: 0
                    - background: black
                  grid:
                    - grid-template-areas: '"cam"'
                    - grid-template-columns: 1fr
                  custom_fields:
                    cam:
                      - pointer-events: none
                      - width: 100%
                custom_fields:
                  cam:
                    card:
                      type: custom:webrtc-camera
                      url: >-
                        rtsp://[USER]:[PASSWORD]@192.168.1.70/stream1
                      ui: false
          - type: custom:button-card
            entity: binary_sensor.tesla_model_3_status
            show_icon: false
            show_name: false
            show_state: false
            tap_action:
              action: navigate
              navigation_path: /lovelace/tesla_modele_3
            variables:
              color: |
                [[[
                  const isCharging = states['binary_sensor.tesla_model_3_charging']?.state === 'on';
                  const batteryState = parseFloat(states['sensor.tesla_model_3_niveau_de_batterie']?.state || 0);
                  if (isCharging) return '#00D2FF';
                  if (batteryState <= 20) return '#FF3232';
                  if (batteryState <= 30) return '#FFAA00';
                  return '#00E676';
                ]]]
            styles:
              card:
                - padding: 0
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - border-radius: 20px
                - border: |
                    [[[
                      return `1px solid ${variables.color}80`;
                    ]]]
                - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                - overflow: hidden
                - margin: 0px
                - box-sizing: border-box
                - position: relative
              grid:
                - grid-template-areas: '"img info"'
                - grid-template-columns: 130px minmax(0, 1fr)
                - grid-template-rows: 100px
                - gap: 0px
                - width: 100%
                - margin: 0
              custom_fields:
                img:
                  - justify-self: stretch
                  - align-self: stretch
                  - border-right: 2px solid rgba(255,255,255,0.6)
                  - display: flex
                  - align-items: center
                  - justify-content: center
                  - padding: 0
                info:
                  - justify-self: stretch
                  - align-self: stretch
                  - display: flex
                  - flex-direction: column
                  - justify-content: center
                  - align-items: flex-start
                  - text-align: left
                  - padding: 12px 15px
                  - overflow: hidden
                  - position: relative
                wake:
                  - position: absolute
                  - left: 145px
                  - top: 12px
                  - z-index: 2
            custom_fields:
              img: |
                [[[
                  const color = variables.color;
                  const isOn = states['binary_sensor.tesla_model_3_status']?.state === 'on';
                  const isCharging = states['binary_sensor.tesla_model_3_charging']?.state === 'on';
                  
                  let statusText = isOn ? 'CONNECTÉE' : 'VEILLE';
                  if (isCharging) statusText = 'EN CHARGE ⚡';

                  return `
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px; border-bottom-left-radius: 20px; box-sizing: border-box; padding: 10px;">
                      <img src="/local/tesla-car-image.png" style="width: 100%; max-width: 100px; height: auto; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); object-fit: contain; margin-bottom: 8px;" />
                      <div style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px;">
                        ${statusText}
                      </div>
                    </div>
                  `;
                ]]]
              info: |
                [[[
                  const isCharging = states['binary_sensor.tesla_model_3_charging']?.state === 'on';
                  const rawBattery = states['sensor.tesla_model_3_niveau_de_batterie']?.state;
                  const rawRange   = states['sensor.tesla_model_3_autonomie_de_batterie']?.state;
                  
                  let batterie = Math.round(Number(rawBattery));
                  let autonomie = Math.round(Number(rawRange));
                  
                  const pct = Number.isFinite(batterie) ? Math.max(0, Math.min(100, batterie)) : 0;
                  const fillColor = variables.color;
                  const glow = `0 0 10px ${fillColor}99`;
                  
                  const bar = `
                    <div style="height:8px; border-radius:4px;
                                background: rgba(0,0,0,0.3);
                                overflow:hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.4); margin-top: 6px;">
                      <div style="
                        height:100%;
                        width:${pct}%;
                        background:${fillColor};
                        box-shadow: ${glow};
                        border-radius:4px;
                        transition: width 0.5s ease, background 0.5s ease;">
                      </div>
                    </div>
                  `;
                  
                  const displayBat = Number.isFinite(batterie) ? batterie + "%" : "--%";
                  const displayRange = Number.isFinite(autonomie) ? autonomie + " km" : "-- km";
                  
                  return `
                    <div style="width: 100%;">
                      <div style="display:flex; align-items:center; justify-content: flex-end; gap:6px; margin-bottom: 2px; padding-left: 42px;">
                        <div style="font-size: 16px; font-weight: 700; color: white; letter-spacing: 0.5px; text-align: right; width: 100%;">
                          TESLA MODEL 3
                        </div>
                      </div>
                      
                      <div style="width: 100%; margin-top: 15px;">
                        <div style="display:flex; justify-content:space-between; align-items: flex-end;">
                          <span style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600;">BATTERIE</span>
                          <span style="font-size: 13px; font-weight: 800; color: white;">${displayBat} <span style="font-size: 11px; color: rgba(255,255,255,0.4); margin: 0 4px;">|</span> ${displayRange}</span>
                        </div>
                        ${bar}
                      </div>
                    </div>
                  `;
                ]]]
              wake:
                card:
                  type: custom:button-card
                  entity: button.tesla_model_3_wake
                  icon: mdi:power
                  show_name: false
                  show_state: false
                  size: 18px
                  styles:
                    card:
                      - width: 32px
                      - height: 32px
                      - border-radius: 10px
                      - padding: 0
                      - background: rgba(0,0,0,0.3)
                      - border: 1px solid rgba(255,255,255,0.1)
                      - backdrop-filter: blur(6px)
                      - box-shadow: 0 4px 8px rgba(0,0,0,0.2)
                      - margin: 0
                    icon:
                      - color: rgba(255,255,255,0.8)
                      - width: 18px
                      - transition: all 0.3s ease
                  tap_action:
                    action: call-service
                    service: button.press
                    service_data:
                      entity_id: button.tesla_model_3_wake
          - type: custom:fold-entity-row
            padding: 0
            clickable: true
            card_mod:
              style: >
                div#head { display: block !important; width: 100% !important;
                padding: 0 !important; margin: 0 !important;
                --toggle-icon-width: 0px !important; }

                #head { padding: 0 !important; margin: 0 !important; width: 100%
                !important; cursor: pointer !important; pointer-events: auto
                !important; }

                #head ha-icon { display: none !important; }

                div#items { padding: 0 !important; margin: 0 !important; }
            head:
              type: custom:button-card
              entity: sensor.brother_mfc_l3750cdw_series
              show_name: false
              show_icon: false
              tap_action:
                action: none
              variables:
                color: |
                  [[[
                    const state = entity.state.toLowerCase();
                    if (state === 'idle' || state === 'prêt' || state.includes('sleep') || state.includes('veille')) return '#00E676';
                    if (state === 'printing' || state === 'impression') return '#00E5FF';
                    if (state.includes('error') || state.includes('erreur') || state.includes('jam')) return '#FF3232';
                    if (state.includes('warning') || state.includes('attention')) return '#FFAA00';
                    return '#9E9E9E'; // Offline/Indisponible
                  ]]]
              styles:
                card:
                  - padding: 0
                  - background: rgba(20, 27, 38, 0.6)
                  - backdrop-filter: blur(10px)
                  - '-webkit-backdrop-filter': blur(10px)
                  - border-radius: 20px
                  - border: |
                      [[[
                        return `1px solid ${variables.color}80`;
                      ]]]
                  - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                  - overflow: hidden
                  - margin: 0px
                  - box-sizing: border-box
                  - cursor: pointer
                  - pointer-events: none
                  - height: 125px
                grid:
                  - grid-template-areas: |
                      "icon title title title title"
                      "icon c     m     y     k"
                      "icon ref   ref   ref   ref"
                      "footer footer footer footer footer"
                  - grid-template-columns: >-
                      130px minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr)
                      minmax(0, 1fr)
                  - grid-template-rows: 35px 35px 20px 35px
                  - gap: 0px
                  - width: 100%
                  - margin: 0
                custom_fields:
                  icon:
                    - justify-self: stretch
                    - align-self: stretch
                    - border-right: 2px solid rgba(255,255,255,0.6)
                    - border-top-left-radius: 20px
                    - border-bottom-left-radius: 0px
                    - display: flex
                    - align-items: center
                    - justify-content: center
                    - padding: 0
                  title:
                    - justify-self: stretch
                    - align-self: start
                    - display: flex
                    - flex-direction: column
                    - justify-content: flex-start
                    - align-items: flex-start
                    - text-align: left
                    - padding: 10px 10px 0 10px
                    - overflow: hidden
                  c:
                    - width: 100%
                    - justify-self: center
                    - align-self: center
                    - margin-top: 5px
                  m:
                    - width: 100%
                    - justify-self: center
                    - align-self: center
                    - margin-top: 5px
                  'y':
                    - width: 100%
                    - justify-self: center
                    - align-self: center
                    - margin-top: 5px
                  k:
                    - width: 100%
                    - justify-self: center
                    - align-self: center
                    - margin-top: 5px
                  ref:
                    - justify-self: center
                    - align-self: start
                    - font-size: 10px
                    - color: rgba(255,255,255,0.4)
                    - font-weight: 600
                    - text-transform: uppercase
                    - letter-spacing: 1px
                    - margin-top: 5px
                  footer:
                    - justify-self: stretch
                    - align-self: stretch
                    - background: rgba(0,0,0,0.2)
                    - border-top: 1px solid rgba(255,255,255,0.05)
                    - display: flex
                    - align-items: center
                    - justify-content: center
                    - border-radius: 0 0 20px 20px
              custom_fields:
                ref: Toners TN243 CMYK
                icon: |
                  [[[
                    const color = variables.color;
                    return `
                      <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px; border-bottom-left-radius: 0px; box-sizing: border-box; padding: 10px; transform: translateY(-5px);">
                        <img src="/local/brother.png" style="width: 100%; max-width: 75px; height: auto; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)); object-fit: contain; margin-bottom: 2px;" />
                        <div style="font-size: 10px; font-weight: 950; color: white; text-transform: uppercase; letter-spacing: 1.5px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin-top: -4px;">Imprimante</div>
                      </div>
                    `;
                  ]]]
                title: |
                  [[[
                    return `
                       <div style="color: white; font-size: 16px; font-weight: 700; letter-spacing: 0.5px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                         BROTHER <span style="color: rgba(255,255,255,0.5); font-size: 11px; font-weight: 500; margin-left: 4px;">MFC-L3750CDW</span>
                       </div>
                    `;
                  ]]]
                c: |
                  [[[
                    const s = states['sensor.mfc_l3750cdw_toner_cyan_restant'];
                    let v = parseFloat(s?.state ?? '0'); if (isNaN(v)) v = 0; v = Math.max(0, Math.min(100, v));
                    const color = '#00E5FF';
                    let borderStyle = '1px solid rgba(255,255,255,0.1)';
                    let shadowStyle = 'inset 0 0 5px rgba(0,0,0,0.3)';
                    if (v < 10) { borderStyle = '1px solid rgba(255, 50, 50, 0.8)'; shadowStyle = '0 0 10px rgba(255, 50, 50, 0.5), inset 0 0 5px rgba(0,0,0,0.3)'; }
                    return `
                      <div style="display:flex;flex-direction:column;align-items:center;width:90%;margin:auto;">
                         <div style="width:100%;height:32px;border-radius:6px;
                                    background:rgba(0,0,0,0.2);position:relative;overflow:hidden;
                                    border:${borderStyle}; box-shadow:${shadowStyle}; transition: box-shadow 0.3s ease;">
                          <div style="position:absolute;bottom:0;left:0;width:100%;height:${v}%;background:linear-gradient(to top, ${color}99, ${color});transition:height 0.5s ease;"></div>
                          <div style="position:absolute;bottom:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;
                                      font-size:11px;color:${v > 30 ? 'black' : 'white'};font-weight:800;text-shadow:${v > 30 ? 'none' : '0 1px 2px rgba(0,0,0,0.8)'};">
                            ${v}%
                          </div>
                        </div>
                      </div>`;
                  ]]]
                m: |
                  [[[
                    const s = states['sensor.mfc_l3750cdw_toner_magenta_restant'];
                    let v = parseFloat(s?.state ?? '0'); if (isNaN(v)) v = 0; v = Math.max(0, Math.min(100, v));
                    const color = '#FF00FF';
                    let borderStyle = '1px solid rgba(255,255,255,0.1)';
                    let shadowStyle = 'inset 0 0 5px rgba(0,0,0,0.3)';
                    if (v < 10) { borderStyle = '1px solid rgba(255, 50, 50, 0.8)'; shadowStyle = '0 0 10px rgba(255, 50, 50, 0.5), inset 0 0 5px rgba(0,0,0,0.3)'; }
                    return `
                      <div style="display:flex;flex-direction:column;align-items:center;width:90%;margin:auto;">
                         <div style="width:100%;height:32px;border-radius:6px;
                                    background:rgba(0,0,0,0.2);position:relative;overflow:hidden;
                                    border:${borderStyle}; box-shadow:${shadowStyle}; transition: box-shadow 0.3s ease;">
                          <div style="position:absolute;bottom:0;left:0;width:100%;height:${v}%;background:linear-gradient(to top, ${color}99, ${color});transition:height 0.5s ease;"></div>
                          <div style="position:absolute;bottom:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;
                                      font-size:11px;color:white;font-weight:800;text-shadow:0 1px 2px rgba(0,0,0,0.8);">
                            ${v}%
                          </div>
                        </div>
                      </div>`;
                  ]]]
                'y': |
                  [[[
                    const s = states['sensor.mfc_l3750cdw_toner_jaune_restant'];
                    let v = parseFloat(s?.state ?? '0'); if (isNaN(v)) v = 0; v = Math.max(0, Math.min(100, v));
                    const color = '#FFD700';
                    let borderStyle = '1px solid rgba(255,255,255,0.1)';
                    let shadowStyle = 'inset 0 0 5px rgba(0,0,0,0.3)';
                    if (v < 10) { borderStyle = '1px solid rgba(255, 50, 50, 0.8)'; shadowStyle = '0 0 10px rgba(255, 50, 50, 0.5), inset 0 0 5px rgba(0,0,0,0.3)'; }
                    return `
                      <div style="display:flex;flex-direction:column;align-items:center;width:90%;margin:auto;">
                         <div style="width:100%;height:32px;border-radius:6px;
                                    background:rgba(0,0,0,0.2);position:relative;overflow:hidden;
                                    border:${borderStyle}; box-shadow:${shadowStyle}; transition: box-shadow 0.3s ease;">
                          <div style="position:absolute;bottom:0;left:0;width:100%;height:${v}%;background:linear-gradient(to top, ${color}99, ${color});transition:height 0.5s ease;"></div>
                          <div style="position:absolute;bottom:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;
                                      font-size:11px;color:${v > 30 ? 'black' : 'white'};font-weight:800;text-shadow:${v > 30 ? 'none' : '0 1px 2px rgba(0,0,0,0.8)'};">
                            ${v}%
                          </div>
                        </div>
                      </div>`;
                  ]]]
                k: |
                  [[[
                    const s = states['sensor.mfc_l3750cdw_toner_noir_restant'];
                    let v = parseFloat(s?.state ?? '0'); if (isNaN(v)) v = 0; v = Math.max(0, Math.min(100, v));
                    const color = '#444444';
                    let borderStyle = '1px solid rgba(255,255,255,0.1)';
                    let shadowStyle = 'inset 0 0 5px rgba(0,0,0,0.3)';
                    if (v < 10) { borderStyle = '1px solid rgba(255, 50, 50, 0.8)'; shadowStyle = '0 0 10px rgba(255, 50, 50, 0.5), inset 0 0 5px rgba(0,0,0,0.3)'; }
                    return `
                      <div style="display:flex;flex-direction:column;align-items:center;width:90%;margin:auto;">
                         <div style="width:100%;height:32px;border-radius:6px;
                                    background:rgba(0,0,0,0.2);position:relative;overflow:hidden;
                                    border:${borderStyle}; box-shadow:${shadowStyle}; transition: box-shadow 0.3s ease;">
                          <div style="position:absolute;bottom:0;left:0;width:100%;height:${v}%;background:linear-gradient(to top, rgba(0,0,0,0.6), ${color});transition:height 0.5s ease;"></div>
                          <div style="position:absolute;bottom:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;
                                      font-size:11px;color:white;font-weight:800;text-shadow:0 1px 2px rgba(0,0,0,0.8);">
                            ${v}%
                          </div>
                        </div>
                      </div>`;
                  ]]]
                footer: |
                  [[[
                     return `<ha-icon icon="mdi:chevron-down" style="color: rgba(255,255,255,0.5); width: 20px; height: 20px; transition: all 0.3s ease;"></ha-icon>`;
                  ]]]
            entities:
              - type: custom:button-card
                name: TAMBOURS CL
                styles:
                  card:
                    - background: none
                    - border: none
                    - padding: 15px 15px 5px 15px
                  name:
                    - color: rgba(255,255,255,0.4)
                    - font-size: 10px
                    - font-weight: 800
                    - text-transform: uppercase
                    - justify-self: start
                    - letter-spacing: 1.5px
              - type: custom:button-card
                styles:
                  card:
                    - background: rgba(0,0,0,0.2)
                    - border-radius: 15px
                    - border: 1px solid rgba(255,255,255,0.05)
                    - margin: 0 10px 15px 10px
                    - padding: 12px
                  grid:
                    - grid-template-areas: '"c m y k" "ref ref ref ref"'
                    - grid-template-columns: repeat(4, 1fr)
                  custom_fields:
                    ref:
                      - justify-self: center
                      - font-size: 10px
                      - color: rgba(255,255,255,0.3)
                      - margin-top: 10px
                      - font-weight: 600
                      - text-transform: uppercase
                custom_fields:
                  ref: MODÈLES DR243CL
                  c: |
                    [[[
                      const s = states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_tambour_cyan'];
                      let v = Math.round(parseFloat(s?.state ?? '0')); v = Math.max(0, Math.min(100, v));
                      const color = '#00FFFF';
                      return `<div style="display:flex;flex-direction:column;align-items:center;">
                        <ha-icon icon="mdi:record-circle-outline" style="width:20px;height:20px;color:${color};margin-bottom:6px;filter:drop-shadow(0 0 5px ${color}80);"></ha-icon>
                        <div style="width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                          <div style="width:${v}%;height:100%;background:${color};"></div>
                        </div>
                        <div style="font-size:10px;font-weight:700;color:white;margin-top:4px;">${v}%</div>
                      </div>`;
                    ]]]
                  m: |
                    [[[
                      const s = states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_tambour_magenta'];
                      let v = Math.round(parseFloat(s?.state ?? '0')); v = Math.max(0, Math.min(100, v));
                      const color = '#FF00FF';
                      return `<div style="display:flex;flex-direction:column;align-items:center;">
                        <ha-icon icon="mdi:record-circle-outline" style="width:20px;height:20px;color:${color};margin-bottom:6px;filter:drop-shadow(0 0 5px ${color}80);"></ha-icon>
                        <div style="width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                          <div style="width:${v}%;height:100%;background:${color};"></div>
                        </div>
                        <div style="font-size:10px;font-weight:700;color:white;margin-top:4px;">${v}%</div>
                      </div>`;
                    ]]]
                  'y': |
                    [[[
                      const s = states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_tambour_jaune'];
                      let v = Math.round(parseFloat(s?.state ?? '0')); v = Math.max(0, Math.min(100, v));
                      const color = '#FFFF00';
                      return `<div style="display:flex;flex-direction:column;align-items:center;">
                        <ha-icon icon="mdi:record-circle-outline" style="width:20px;height:20px;color:${color};margin-bottom:6px;filter:drop-shadow(0 0 5px ${color}80);"></ha-icon>
                        <div style="width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                          <div style="width:${v}%;height:100%;background:${color};"></div>
                        </div>
                        <div style="font-size:10px;font-weight:700;color:white;margin-top:4px;">${v}%</div>
                      </div>`;
                    ]]]
                  k: |
                    [[[
                      const s = states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_tambour_noir'];
                      let v = Math.round(parseFloat(s?.state ?? '0')); v = Math.max(0, Math.min(100, v));
                      const color = '#888888';
                      return `<div style="display:flex;flex-direction:column;align-items:center;">
                        <ha-icon icon="mdi:record-circle-outline" style="width:20px;height:20px;color:${color};margin-bottom:6px;filter:drop-shadow(0 0 5px ${color}80);"></ha-icon>
                        <div style="width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                          <div style="width:${v}%;height:100%;background:${color};"></div>
                        </div>
                        <div style="font-size:10px;font-weight:700;color:white;margin-top:4px;">${v}%</div>
                      </div>`;
                    ]]]
              - type: custom:button-card
                name: UNITÉS DE MAINTENANCE
                styles:
                  card:
                    - background: none
                    - border: none
                    - padding: 5px 15px 5px 15px
                  name:
                    - color: rgba(255,255,255,0.4)
                    - font-size: 10px
                    - font-weight: 800
                    - text-transform: uppercase
                    - justify-self: start
                    - letter-spacing: 1.5px
              - type: custom:button-card
                styles:
                  card:
                    - background: rgba(0,0,0,0.2)
                    - border-radius: 15px
                    - border: 1px solid rgba(255,255,255,0.05)
                    - margin: 0 10px 15px 10px
                    - padding: 15px
                  grid:
                    - grid-template-areas: '"belt" "fusion" "pf"'
                    - grid-template-rows: repeat(3, 1fr)
                custom_fields:
                  fusion: |
                    [[[
                      const v = Math.round(parseFloat(states['sensor.mfc_l3750cdw_duree_de_vie_restante_de_l_unite_de_fusion']?.state ?? '0'));
                      const color = '#FF9800'; // Orange
                      return `<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                        <ha-icon icon="mdi:printer-3d-nozzle-heat" style="color:${color};width:18px;filter:drop-shadow(0 0 5px ${color}60);"></ha-icon>
                        <div style="flex:1;">
                          <div style="display:flex;justify-content:space-between;font-size:11px;font-weight:700;color:white;margin-bottom:4px;">
                            <span>UNITÉ DE FUSION</span><span>${v}%</span>
                          </div>
                          <div style="width:100%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;">
                            <div style="width:${v}%;height:100%;background:${color};box-shadow: 0 0 10px ${color}80;"></div>
                          </div>
                        </div>
                      </div>`;
                    ]]]
                  belt: |
                    [[[
                      const v = Math.round(parseFloat(states['sensor.mfc_l3750cdw_duree_de_vie_restante_de_l_unite_de_courroie']?.state ?? '0'));
                      const color = '#4CAF50'; // Green
                      return `<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                        <div style="width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:${color};filter:drop-shadow(0 0 5px ${color}60);">
                           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%;">
                            <circle cx="6" cy="7" r="2.5" />
                            <circle cx="17" cy="16" r="4.5" />
                            <path d="M4 9 L13 20 M8.5 4.5 L21 14" />
                          </svg>
                        </div>
                        <div style="flex:1;">
                          <div style="display:flex;justify-content:space-between;font-size:11px;font-weight:700;color:white;margin-bottom:4px;">
                            <span>UNITÉ DE COURROIE</span><span>${v}%</span>
                          </div>
                          <div style="width:100%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;">
                            <div style="width:${v}%;height:100%;background:${color};box-shadow: 0 0 10px ${color}80;"></div>
                          </div>
                        </div>
                      </div>`;
                    ]]]
                  pf: |
                    [[[
                      const v = Math.round(parseFloat(states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_kit_pf_1']?.state ?? '0'));
                      const color = '#F44336'; // Red
                      return `<div style="display:flex;align-items:center;gap:12px;">
                        <ha-icon icon="mdi:tray-arrow-up" style="color:${color};width:18px;filter:drop-shadow(0 0 5px ${color}60);"></ha-icon>
                        <div style="flex:1;">
                          <div style="display:flex;justify-content:space-between;font-size:11px;font-weight:700;color:white;margin-bottom:4px;">
                            <span>KIT PF (CHARGEUR)</span><span>${v}%</span>
                          </div>
                          <div style="width:100%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;">
                            <div style="width:${v}%;height:100%;background:${color};box-shadow: 0 0 10px ${color}80;"></div>
                          </div>
                        </div>
                      </div>`;
                    ]]]
      - type: grid
        cards:
          - type: entities
            card_mod:
              style: |
                ha-card {
                  background: none !important;
                  border: none !important;
                  box-shadow: none !important;
                  padding: 0 !important;
                  margin-top: 0px !important;
                  margin-bottom: 0px !important;
                }
                .card-content {
                  padding: 0px !important;
                  margin: 0px !important;
                }
                #states {
                  padding: 0px !important;
                  margin: 0px !important;
                }
                :host {
                  margin: 0px !important;
                }
            entities:
              - type: custom:fold-entity-row
                padding: 0
                clickable: true
                card_mod:
                  style: |
                    div#head {
                      display: block !important;
                      width: 100% !important;
                      padding: 0 !important;
                      margin: 0 !important;
                      --toggle-icon-width: 0px !important;
                    }
                    #head {
                      padding: 0 !important;
                      margin: 0 !important;
                      width: 100% !important;
                      cursor: pointer !important;
                      pointer-events: auto !important;
                    }
                    #head ha-icon { display: none !important; }
                head:
                  type: custom:button-card
                  entity: calendar.chris_billet_gmail_com
                  show_name: false
                  show_icon: false
                  tap_action:
                    action: none
                  hold_action:
                    action: none
                  styles:
                    card:
                      - padding: 0
                      - background: rgba(20, 27, 38, 0.6)
                      - backdrop-filter: blur(10px)
                      - '-webkit-backdrop-filter': blur(10px)
                      - border-radius: 20px
                      - border: 1px solid rgba(255,255,255,0.15)
                      - box-shadow: 0 4px 20px rgba(0,0,0,0.4)
                      - margin: 0px
                      - pointer-events: none
                    grid:
                      - grid-template-areas: '"date details" "footer footer"'
                      - grid-template-columns: 130px minmax(0, 1fr)
                      - grid-template-rows: auto 30px
                      - min-height: 110px
                      - width: 100%
                    custom_fields:
                      date:
                        - justify-self: stretch
                        - align-self: stretch
                        - background: >-
                            linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%,
                            rgba(255, 215, 0, 0.08) 100%)
                        - border-right: 2px solid rgba(255,255,255,0.6)
                        - display: flex
                        - flex-direction: column
                        - align-items: center
                        - justify-content: center
                        - padding: 12px 4px
                      details:
                        - justify-self: stretch
                        - align-self: stretch
                        - padding: 10px 15px 10px 0px
                        - display: flex
                        - align-items: center
                      footer:
                        - justify-self: stretch
                        - align-self: stretch
                        - background: rgba(0,0,0,0.2)
                        - display: flex
                        - align-items: center
                        - justify-content: center
                        - border-radius: 0 0 20px 20px
                  custom_fields:
                    date: |
                      [[[
                        return `
                          <svg viewBox="0 0 200 200" style="width: 55px; height: 55px; margin-bottom: 5px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));">
                            <defs>
                              <linearGradient id="glass" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:rgba(255,255,255,0.3)"/>
                                <stop offset="50%" style="stop-color:rgba(255,255,255,0.1)"/>
                                <stop offset="100%" style="stop-color:rgba(255,255,255,0.05)"/>
                              </linearGradient>
                              <linearGradient id="gold-bar" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#FFD700"/>
                                <stop offset="40%" style="stop-color:#FFD700"/>
                                <stop offset="100%" style="stop-color:#ff9800"/>
                              </linearGradient>
                              <filter id="glow">
                                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                <feMerge>
                                  <feMergeNode in="coloredBlur"/>
                                  <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                              </filter>
                            </defs>
                            <rect x="25" y="45" width="150" height="130" rx="25" fill="url(#glass)" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                            <path d="M25 70 V55 a25 25 0 0 1 25 -25 h100 a25 25 0 0 1 25 25 v15 z" fill="url(#gold-bar)" filter="url(#glow)"/>
                            <rect x="35" y="33" width="130" height="3" rx="1.5" fill="rgba(255,255,255,0.7)"/>
                            <rect x="60" y="15" width="12" height="30" rx="6" fill="#F0F0F0" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
                            <rect x="128" y="15" width="12" height="30" rx="6" fill="#F0F0F0" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
                            <circle cx="100" cy="120" r="25" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4" stroke-dasharray="2,6"/>
                          </svg>
                          <div style="color: #FFFFFF; font-size: 13px; font-weight: 900; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.4);">
                            Aujourd'hui
                          </div>
                        `;
                      ]]]
                    details:
                      card:
                        type: custom:atomic-calendar-revive
                        maxDaysToShow: 1
                        maxEventCount: 3
                        showDate: false
                        showMonth: false
                        showWeekDay: true
                        showLocation: true
                        showDescription: false
                        showCurrentEvent: true
                        showNoEventsForToday: true
                        noEventText: Aucun RDV aujourd'hui
                        showHiddenText: false
                        showFinishedEvents: false
                        hideFinishedEvents: true
                        entities:
                          - entity: calendar.chris_billet_gmail_com
                            blocklist: poubelle|Sortir|VERTE|JAUNE
                            blacklist: poubelle|Sortir|VERTE|JAUNE
                          - entity: calendar.icloud
                            blocklist: poubelle|Sortir|VERTE|JAUNE
                            blacklist: poubelle|Sortir|VERTE|JAUNE
                          - calendar.paris_saint_germain
                          - calendar.jours_feries_et_autres_fetes_en_france
                          - calendar.anniversaires
                        card_mod:
                          style: >
                            ha-card { background: none !important; border: none
                            !important; box-shadow: none !important; padding: 0
                            !important; margin: 0 !important; } .day-header {
                            display: none !important; } .cal-table { border:
                            none !important; width: 100% !important; margin: 0
                            !important; border-collapse: collapse !important;
                            display: table !important; } .event-container {
                            padding: 0 !important; margin-bottom: 8px
                            !important; } .event-left { 
                              width: 65px !important; 
                              text-align: center !important; 
                              font-size: 18px !important; 
                              font-weight: 900 !important;
                              color: rgba(255,255,255,0.95) !important;
                              padding: 0 !important;
                              vertical-align: middle !important;
                              line-height: normal !important;
                            } .event-left > div { display: flex !important;
                            flex-direction: column !important; align-items:
                            center !important; justify-content: center
                            !important; height: 100% !important; width: 100%
                            !important; margin: 0 !important; } .event-right {
                            padding: 0 !important; text-align: left !important;
                            vertical-align: middle !important; } .event-title {
                            color: white !important; font-size: 13px !important;
                            font-weight: 900 !important; line-height: 1.1
                            !important; } .event-location, .event-location-icon,
                            a, .event-progressBar { color: #ff9800 !important;
                            font-size: 10px !important; text-decoration: none
                            !important; } .event-time { color:
                            rgba(255,255,255,0.4) !important; font-size: 7px
                            !important; } .event-right span { font-size: 7px
                            !important; color: rgba(255,255,255,0.3) !important;
                            } .event-progressBar { background-color: #ff9800
                            !important; height: 2px !important; margin-top: 4px
                            !important; }
                    footer: >
                      [[[ return `<ha-icon icon="mdi:chevron-down" style="color:
                      rgba(255,255,255,0.4); width: 24px; height:
                      24px;"></ha-icon>`; ]]]
                entities:
                  - type: custom:atomic-calendar-revive
                    name: ' '
                    entities:
                      - calendar.chris_billet_gmail_com
                      - calendar.icloud
                      - calendar.paris_saint_germain
                      - calendar.jours_feries_et_autres_fetes_en_france
                      - calendar.anniversaires
                    maxDaysToShow: 8
                    maxEventCount: 6
                    showMonth: false
                    showWeekDay: true
                    showDate: false
                    sortByStartTime: true
                    showLocation: true
                    showDescription: false
                    showNoEventsForToday: false
                    showCurrentEvent: false
                    showHiddenText: false
                    showFinishedEvents: false
                    hideFinishedEvents: true
                    card_mod:
                      style: >
                        ha-card {
                          margin-top: 0px !important;
                          background: rgba(20, 27, 38, 0.4) !important;
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                          border-radius: 20px !important;
                          border: 1px solid rgba(255,255,255,0.05) !important;
                          box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                          margin: 0 !important;
                          width: 100% !important;
                        } .card-header { display: none !important; } .day-header
                        { color: rgba(255,255,255,0.7) !important; }
                        .event-title { color: rgba(255,255,255,0.9) !important;
                        font-weight: bold !important; font-size: 13px
                        !important; } .event-location, .event-location-icon, a,
                        .event-progressBar { color: #ff9800 !important;
                        text-decoration: none !important; } .event-progressBar {
                        background-color: #ff9800 !important; } .cal-table tbody
                        tr:nth-of-type(1), .cal-table tbody tr:nth-of-type(2) {
                        display: none !important; }
          - type: conditional
            conditions:
              - condition: state
                entity: light.lumieres_maison
                state: 'on'
            card:
              type: custom:fold-entity-row
              padding: 0
              clickable: true
              card_mod:
                style: |
                  div#head {
                    display: block !important;
                    width: 100% !important;
                    padding: 0 !important;
                    margin: 0 !important;
                    --toggle-icon-width: 0px !important;
                  }
                  #head {
                    padding: 0 !important;
                    margin: 0 !important;
                    width: 100% !important;
                    cursor: pointer !important;
                    pointer-events: auto !important;
                  }
                  #head ha-icon {
                    display: none !important;
                    width: 0px !important;
                  }
                  div#items {
                    padding: 0 !important;
                    margin: 0 !important;
                  }
              head:
                type: custom:button-card
                entity: light.lumieres_maison
                show_name: false
                show_icon: false
                show_state: false
                tap_action:
                  action: none
                variables:
                  color: '#FFB300'
                styles:
                  card:
                    - padding: 0
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - border-radius: 20px
                    - border: '[[[ return `1px solid ${variables.color}80`; ]]]'
                    - box-shadow: >-
                        [[[ return `0 0 20px ${variables.color}40, 0 8px 32px
                        rgba(0,0,0,0.4)`; ]]]
                    - overflow: hidden
                    - margin: 0px
                    - box-sizing: border-box
                    - position: relative
                    - height: 85px
                    - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                  grid:
                    - grid-template-areas: '"icon details" "footer footer"'
                    - grid-template-columns: 130px minmax(0, 1fr)
                    - grid-template-rows: 60px 25px
                    - gap: 0px
                    - width: 100%
                    - margin: 0
                  custom_fields:
                    icon:
                      - justify-self: stretch
                      - align-self: stretch
                      - border-right: 2px solid rgba(255,255,255,0.6)
                      - border-top-left-radius: 20px
                      - display: flex
                      - align-items: center
                      - justify-content: center
                      - padding: 0
                    details:
                      - justify-self: stretch
                      - align-self: stretch
                      - display: flex
                      - flex-direction: column
                      - justify-content: center
                      - align-items: center
                      - padding: 0
                      - overflow: hidden
                      - position: relative
                    footer:
                      - justify-self: stretch
                      - align-self: stretch
                      - background: rgba(0,0,0,0.2)
                      - border-top: 1px solid rgba(255,255,255,0.05)
                      - display: flex
                      - align-items: center
                      - justify-content: center
                      - border-radius: 0 0 20px 20px
                custom_fields:
                  icon: |
                    [[[
                      const color = variables.color;
                      return `
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px; box-sizing: border-box; position: relative;">
                          <div style="position: absolute; width: 50px; height: 50px; background: ${color}; border-radius: 50%; filter: blur(20px); opacity: 0.3; animation: pulseGlow 4s infinite alternate ease-in-out;"></div>
                          <div style="font-size: 32px; line-height: 1; filter: drop-shadow(0 0 10px ${color}80); display: flex; align-items: center; justify-content: center; z-index: 1;">💡</div>
                          <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; z-index: 1;">Lumieres</div>
                          <style>@keyframes pulseGlow { from { opacity: 0.2; transform: scale(0.9); } to { opacity: 0.4; transform: scale(1.1); } }</style>
                        </div>
                      `;
                    ]]]
                  details: |
                    [[[
                      let count = 0;
                      if (entity && entity.attributes && entity.attributes.entity_id) {
                        const entities = entity.attributes.entity_id;
                        const on_entities = entities.filter(id => states[id] && states[id].state === 'on');
                        count = on_entities.length;
                      } else {
                         count = entity && entity.state === 'on' ? 1 : 0;
                      }
                      
                      const color = variables.color;
                      const titleText = count > 1 ? 'LUMIÈRES' : 'LUMIÈRE';
                      const subText = count > 1 ? 'ALLUMÉES DANS LA MAISON' : 'ALLUMÉE DANS LA MAISON';
                      
                      return `
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: row; justify-content: center; align-items: center; padding: 0 15px; position: relative; gap: 15px;">
                          <div style="font-size: 38px; font-weight: 900; color: ${color}; line-height: 1; text-shadow: 0 0 15px ${color}80;">${count}</div>
                          <div style="display: flex; flex-direction: column; align-items: flex-start; justify-content: center;">
                            <div style="font-size: 13px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px;">${titleText}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; display: flex; align-items: center; font-weight: 600;">
                              ${subText}
                            </div>
                          </div>
                        </div>
                      `;
                    ]]]
                  footer: |
                    [[[
                       setTimeout(() => {
                         const isEditMode = window.location.search.includes('edit=1') || window.location.pathname.includes('edit');
                         if (isEditMode) {
                            const el = document.querySelector("hui-conditional-card"); 
                            if (el) el.style.display = 'block';
                         }
                       }, 1000);

                       return `
                         <div style="display:flex; width:100%; justify-content:center; align-items:center;">
                           <ha-icon icon="mdi:chevron-down" style="color: rgba(255,255,255,0.7); width: 18px; height: 18px;"></ha-icon>
                         </div>
                       `;
                    ]]]
              entities:
                - type: custom:auto-entities
                  show_empty: false
                  unique: true
                  card:
                    type: grid
                    columns: 3
                    square: false
                    card_mod:
                      style: |
                        ha-card {
                          background: transparent !important;
                          box-shadow: none !important;
                          border: none !important;
                          padding: 0 !important;
                          margin-top: 20px !important;
                        }
                  card_param: cards
                  filter:
                    include:
                      - group: light.lumieres_maison
                        state: 'on'
                        options:
                          type: custom:mushroom-light-card
                          use_light_color: true
                          show_brightness_control: false
                          show_color_temp_control: false
                          show_color_control: false
                          card_mod:
                            style: |
                              ha-card {
                                background: rgba(20, 27, 38, 0.6) !important;
                                backdrop-filter: blur(10px) !important;
                                -webkit-backdrop-filter: blur(10px) !important;
                                border-radius: 15px !important;
                                border: 1px solid rgba(255, 179, 0, 0.4) !important;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                                transition: all 0.3s ease-in-out;
                              }
                    exclude:
                      - entity_id: light.lumieres_maison
          - type: custom:button-card
            show_name: false
            show_icon: false
            styles:
              card:
                - padding: 0
                - background: none
                - border: none
                - box-shadow: none
                - display: |
                    [[[
                      // --- VISIBILITY LOGIC ---
                      const isEditMode = window.location.search.includes('edit=1') || window.location.pathname.includes('edit');
                      
                      let count = 0;
                      const exclusions = /battery|voltage|signal|ecojoko|home|oil|diffus|chrisnas|dhwp|tesla|comfort|adjust|away|extérieure|exterieure|intérieure|interieure/;
                      
                      for (const s of Object.values(hass.states)) {
                        if (!s.entity_id.startsWith('sensor.')) continue;
                        const val = parseFloat(String(s.state).replace('°C','').replace(',','.'));
                        if (!isNaN(val) && (val > 25 || val < 19)) {
                          const name = (s.attributes.friendly_name || "").toLowerCase();
                          const eid = s.entity_id.toLowerCase();
                          if (s.attributes.device_class === 'temperature' || s.attributes.unit_of_measurement === '°C') {
                            if (!exclusions.test(eid) && !exclusions.test(name)) {
                              count++;
                            }
                          }
                        }
                      }
                      
                      return (isEditMode || count > 0) ? 'block' : 'none';
                    ]]]
              grid:
                - grid-template-areas: '"content"'
                - grid-template-columns: 100%
            custom_fields:
              content:
                card:
                  type: entities
                  card_mod:
                    style: |
                      ha-card {
                        background: transparent !important;
                        box-shadow: none !important;
                        border: none !important;
                        padding: 0 !important;
                        margin: 0 !important;
                        width: 100% !important;
                      }
                      .card-content {
                        padding: 0 !important;
                        margin: 0 !important;
                        width: 100% !important;
                      }
                  entities:
                    - type: custom:fold-entity-row
                      full_row: true
                      padding: 0
                      clickable: true
                      card_mod:
                        style: >
                          :host { --toggle-icon-width: 0px !important; }

                          #head ha-icon, #head ha-icon-button { display: none
                          !important; width: 0px !important; visibility: hidden
                          !important; }

                          div#head { display: block !important; width: 100%
                          !important; padding: 0 !important; margin: 0
                          !important; }

                          #head { padding: 0 !important; margin: 0 !important;
                          width: 100% !important; cursor: pointer !important; }

                          #head > * { width: 100% !important; max-width: 100%
                          !important; }

                          div#items { padding: 14px 0 0 0 !important; margin: 0
                          !important; width: 100% !important; box-sizing:
                          border-box !important; }
                      head:
                        type: custom:button-card
                        show_name: false
                        show_icon: false
                        show_state: false
                        tap_action:
                          action: none
                        variables:
                          color: '#FF5722'
                        styles:
                          card:
                            - padding: 0
                            - background: rgba(20, 27, 38, 0.6)
                            - backdrop-filter: blur(10px)
                            - '-webkit-backdrop-filter': blur(10px)
                            - border-radius: 20px
                            - border: '[[[ return `1px solid ${variables.color}80`; ]]]'
                            - box-shadow: >-
                                [[[ return `0 0 20px ${variables.color}40, 0 8px
                                32px rgba(0,0,0,0.4)`; ]]]
                            - overflow: hidden
                            - margin: 0px
                            - box-sizing: border-box
                            - position: relative
                            - height: 85px
                            - width: 100%
                          grid:
                            - grid-template-areas: '"icon details" "footer footer"'
                            - grid-template-columns: 130px minmax(0, 1fr)
                            - grid-template-rows: 60px 25px
                            - gap: 0px
                            - width: 100%
                            - margin: 0
                          custom_fields:
                            icon:
                              - justify-self: stretch
                              - align-self: stretch
                              - border-right: 2px solid rgba(255,255,255,0.6)
                              - border-top-left-radius: 20px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                              - padding: 0
                            details:
                              - justify-self: stretch
                              - align-self: stretch
                              - display: flex
                              - flex-direction: column
                              - justify-content: center
                              - align-items: center
                              - padding: 0
                              - overflow: hidden
                              - position: relative
                            footer:
                              - justify-self: stretch
                              - align-self: stretch
                              - background: rgba(0,0,0,0.2)
                              - border-top: 1px solid rgba(255,255,255,0.05)
                              - display: flex
                              - align-items: center
                              - justify-content: center
                              - border-radius: 0 0 20px 20px
                        custom_fields:
                          icon: |
                            [[[
                              const color = variables.color;
                              return `
                                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px; box-sizing: border-box; position: relative;">
                                  <div style="position: absolute; width: 50px; height: 50px; background: ${color}; border-radius: 50%; filter: blur(20px); opacity: 0.3; animation: pulseGlow 4s infinite alternate ease-in-out;"></div>
                                  <div style="font-size: 32px; line-height: 1; filter: drop-shadow(0 0 10px ${color}80); display: flex; align-items: center; justify-content: center; z-index: 1;">🌡️</div>
                                  <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; z-index: 1;">Température</div>
                                </div>
                              `;
                            ]]]
                          details: |
                            [[[
                              let count = 0;
                              const exclusions = /battery|voltage|signal|ecojoko|home|oil|diffus|chrisnas|dhwp|tesla|comfort|adjust|away|extérieure|exterieure|intérieure|interieure/;
                              for (const s of Object.values(hass.states)) {
                                if (!s.entity_id.startsWith('sensor.')) continue;
                                const val = parseFloat(String(s.state).replace('°C','').replace(',','.'));
                                if (!isNaN(val) && (val > 25 || val < 19)) {
                                  const name = (s.attributes.friendly_name || "").toLowerCase();
                                  const eid = s.entity_id.toLowerCase();
                                  if (s.attributes.device_class === 'temperature' || s.attributes.unit_of_measurement === '°C') {
                                    if (!exclusions.test(eid) && !exclusions.test(name)) {
                                      count++;
                                    }
                                  }
                                }
                              }
                              const label = count > 1 ? 'PIÈCES TEMP. ANORMALE' : 'PIÈCE TEMP. ANORMALE';
                              return `
                                <div style="width: 100%; height: 100%; display: flex; flex-direction: row; justify-content: center; align-items: center; padding: 0 15px; position: relative; gap: 15px;">
                                  <div style="font-size: 38px; font-weight: 900; color: ${variables.color}; line-height: 1; text-shadow: 0 0 15px ${variables.color}80;">${count}</div>
                                  <div style="display: flex; flex-direction: column; align-items: flex-start; justify-content: center;">
                                    <div style="font-size: 13px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px;">${label}</div>
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; display: flex; align-items: center; font-weight: 600;">ALERTE < 19°C OU > 25°C</div>
                                  </div>
                                </div>
                              `;
                            ]]]
                          footer: >
                            [[[ return `<div style="display:flex; width:100%;
                            justify-content:center;
                            align-items:center;"><ha-icon
                            icon="mdi:chevron-down" style="color:
                            rgba(255,255,255,0.7); width: 18px; height:
                            18px;"></ha-icon></div>`; ]]]
                      entities:
                        - type: custom:button-card
                          color_type: blank-card
                          styles:
                            card:
                              - height: 14px
                        - type: custom:auto-entities
                          show_empty: false
                          card:
                            type: grid
                            columns: 2
                            square: false
                            card_mod:
                              style: >
                                ha-card { background: transparent !important;
                                box-shadow: none !important; border: none
                                !important; padding: 0 !important; margin: 0
                                !important; width: 100% !important; }
                          card_param: cards
                          filter:
                            include:
                              - domain: sensor
                                attributes:
                                  device_class: temperature
                                state: '> 25'
                                options:
                                  type: custom:button-card
                                  layout: horizontal
                                  show_name: true
                                  show_state: true
                                  show_icon: true
                                  styles:
                                    card:
                                      - background: rgba(20, 27, 38, 0.6)
                                      - backdrop-filter: blur(10px)
                                      - '-webkit-backdrop-filter': blur(10px)
                                      - border-radius: 20px
                                      - border: 1px solid rgba(255, 87, 34, 0.4)
                                      - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                                      - height: 60px
                                    grid:
                                      - grid-template-areas: '"i n s"'
                                      - grid-template-columns: 45px 1fr 50px
                                    icon:
                                      - color: '#FF5722'
                                      - width: 22px
                                      - height: 22px
                                      - justify-self: center
                                    name:
                                      - color: white
                                      - font-weight: 800
                                      - font-size: 11px
                                      - justify-self: start
                                      - text-align: left
                                    state:
                                      - color: '#FF5722'
                                      - font-weight: 900
                                      - font-size: 13px
                                      - justify-self: end
                              - domain: sensor
                                attributes:
                                  device_class: temperature
                                state: < 19
                                options:
                                  type: custom:button-card
                                  layout: horizontal
                                  show_name: true
                                  show_state: true
                                  show_icon: true
                                  styles:
                                    card:
                                      - background: rgba(20, 27, 38, 0.6)
                                      - backdrop-filter: blur(10px)
                                      - '-webkit-backdrop-filter': blur(10px)
                                      - border-radius: 20px
                                      - border: 1px solid rgba(255, 87, 34, 0.4)
                                      - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                                      - height: 60px
                                    grid:
                                      - grid-template-areas: '"i n s"'
                                      - grid-template-columns: 45px 1fr 50px
                                    icon:
                                      - color: '#FF5722'
                                      - width: 22px
                                      - height: 22px
                                      - justify-self: center
                                    name:
                                      - color: white
                                      - font-weight: 800
                                      - font-size: 11px
                                      - justify-self: start
                                      - text-align: left
                                    state:
                                      - color: '#FF5722'
                                      - font-weight: 900
                                      - font-size: 13px
                                      - justify-self: end
                              - name: '*temp*'
                                state: '> 25'
                                options:
                                  type: custom:button-card
                                  layout: horizontal
                                  show_name: true
                                  show_state: true
                                  show_icon: true
                                  styles:
                                    card:
                                      - background: rgba(20, 27, 38, 0.6)
                                      - backdrop-filter: blur(10px)
                                      - '-webkit-backdrop-filter': blur(10px)
                                      - border-radius: 20px
                                      - border: 1px solid rgba(255, 87, 34, 0.4)
                                      - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                                      - height: 60px
                                    grid:
                                      - grid-template-areas: '"i n s"'
                                      - grid-template-columns: 45px 1fr 50px
                                    icon:
                                      - color: '#FF5722'
                                      - width: 22px
                                      - height: 22px
                                      - justify-self: center
                                    name:
                                      - color: white
                                      - font-weight: 800
                                      - font-size: 11px
                                      - justify-self: start
                                      - text-align: left
                                    state:
                                      - color: '#FF5722'
                                      - font-weight: 900
                                      - font-size: 13px
                                      - justify-self: end
                              - name: '*temp*'
                                state: < 19
                                options:
                                  type: custom:button-card
                                  layout: horizontal
                                  show_name: true
                                  show_state: true
                                  show_icon: true
                                  styles:
                                    card:
                                      - background: rgba(20, 27, 38, 0.6)
                                      - backdrop-filter: blur(10px)
                                      - '-webkit-backdrop-filter': blur(10px)
                                      - border-radius: 20px
                                      - border: 1px solid rgba(255, 87, 34, 0.4)
                                      - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                                      - height: 60px
                                    grid:
                                      - grid-template-areas: '"i n s"'
                                      - grid-template-columns: 45px 1fr 50px
                                    icon:
                                      - color: '#FF5722'
                                      - width: 22px
                                      - height: 22px
                                      - justify-self: center
                                    name:
                                      - color: white
                                      - font-weight: 800
                                      - font-size: 11px
                                      - justify-self: start
                                      - text-align: left
                                    state:
                                      - color: '#FF5722'
                                      - font-weight: 900
                                      - font-size: 13px
                                      - justify-self: end
                            exclude:
                              - entity_id: '*battery*'
                              - entity_id: '*voltage*'
                              - entity_id: '*signal*'
                              - entity_id: '*ecojoko*'
                              - entity_id: '*home*'
                              - entity_id: '*oil*'
                              - entity_id: '*diffus*'
                              - entity_id: '*chrisnas*'
                              - entity_id: '*dhwp*'
                              - entity_id: '*tesla*'
                              - entity_id: '*comfort*'
                              - entity_id: '*adjust*'
                              - entity_id: '*away*'
                              - name: '*home*'
                              - name: '*ecojoko*'
                              - name: '*oil*'
                              - name: '*diffus*'
                              - name: '*chrisnas*'
                              - name: '*dhwp*'
                              - name: '*tesla*'
                              - name: '*comfort*'
                              - name: '*adjust*'
                              - name: '*away*'
                              - name: '*extérieure*'
                              - name: '*exterieure*'
                              - name: '*intérieure*'
                              - name: '*interieure*'
          - type: entities
            card_mod:
              style: |
                ha-card {
                  background: transparent !important;
                  box-shadow: none !important;
                  border: none !important;
                  padding: 0 !important;
                  margin: 0 !important;
                  width: 100% !important;
                  display: {% set count = namespace(v=0) %}
                           {% for s in states.sensor if s.state | float(-1) >= 65 %}
                             {% set name = (s.attributes.friendly_name | default('') | lower) %}
                             {% set eid = s.entity_id | lower %}
                             {% if ('humid' in eid or 'humid' in name)
                                and not ('battery' in eid or 'voltage' in eid or 'signal' in eid or 'ecojoko' in eid or 'home' in eid or 'oil' in eid or 'diffus' in eid)
                                and not ('battery' in name or 'voltage' in name or 'signal' in name or 'ecojoko' in name or 'home' in name or 'oil' in name or 'diffus' in name) %}
                               {% set count.v = count.v + 1 %}
                             {% endif %}
                           {% endfor %}
                           {{ 'block' if count.v > 0 else 'none' }} !important;
                }
                .card-content {
                  padding: 0 !important;
                  margin: 0 !important;
                }
            entities:
              - type: custom:fold-entity-row
                full_row: true
                padding: 0
                clickable: true
                card_mod:
                  style: |
                    :host { 
                      --toggle-icon-width: 0px !important;
                    }
                    #head ha-icon, #head ha-icon-button { 
                      display: none !important; 
                      width: 0px !important; 
                      visibility: hidden !important; 
                    }
                    div#head { 
                      display: block !important; 
                      width: 100% !important; 
                      padding: 0 !important; 
                      margin: 0 !important; 
                    }
                    #head { 
                      padding: 0 !important; 
                      margin: 0 !important; 
                      width: 100% !important; 
                      cursor: pointer !important; 
                    }
                    #head > * {
                      width: 100% !important;
                      max-width: 100% !important;
                    }
                head:
                  type: custom:button-card
                  show_name: false
                  show_icon: false
                  show_state: false
                  tap_action:
                    action: none
                  variables:
                    color: '#00BCD4'
                  styles:
                    card:
                      - padding: 0
                      - background: rgba(20, 27, 38, 0.6)
                      - backdrop-filter: blur(10px)
                      - '-webkit-backdrop-filter': blur(10px)
                      - border-radius: 20px
                      - border: '[[[ return `1px solid ${variables.color}80`; ]]]'
                      - box-shadow: >-
                          [[[ return `0 0 20px ${variables.color}40, 0 8px 32px
                          rgba(0,0,0,0.4)`; ]]]
                      - overflow: hidden
                      - margin: 0px
                      - box-sizing: border-box
                      - position: relative
                      - height: 85px
                      - width: 100%
                    grid:
                      - grid-template-areas: '"icon details" "footer footer"'
                      - grid-template-columns: 130px minmax(0, 1fr)
                      - grid-template-rows: 60px 25px
                      - gap: 0px
                      - width: 100%
                      - margin: 0
                    custom_fields:
                      icon:
                        - justify-self: stretch
                        - align-self: stretch
                        - border-right: 2px solid rgba(255,255,255,0.6)
                        - border-top-left-radius: 20px
                        - display: flex
                        - align-items: center
                        - justify-content: center
                        - padding: 0
                      details:
                        - justify-self: stretch
                        - align-self: stretch
                        - display: flex
                        - flex-direction: column
                        - justify-content: center
                        - align-items: center
                        - padding: 0
                        - overflow: hidden
                        - position: relative
                      footer:
                        - justify-self: stretch
                        - align-self: stretch
                        - background: rgba(0,0,0,0.2)
                        - border-top: 1px solid rgba(255,255,255,0.05)
                        - display: flex
                        - align-items: center
                        - justify-content: center
                        - border-radius: 0 0 20px 20px
                  custom_fields:
                    icon: |
                      [[[
                        const color = variables.color;
                        return `
                          <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px; box-sizing: border-box; position: relative;">
                            <div style="position: absolute; width: 50px; height: 50px; background: ${color}; border-radius: 50%; filter: blur(20px); opacity: 0.3; animation: pulseGlow 4s infinite alternate ease-in-out;"></div>
                            <div style="font-size: 32px; line-height: 1; filter: drop-shadow(0 0 10px ${color}80); display: flex; align-items: center; justify-content: center; z-index: 1;">💧</div>
                            <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; z-index: 1;">Humidité</div>
                          </div>
                        `;
                      ]]]
                    details: |
                      [[[
                        let count = 0;
                        const exclusions = /battery|voltage|signal|ecojoko|home|oil|diffus/;
                        for (const key in states) {
                          if (!key.startsWith('sensor.')) continue;
                          const s = states[key];
                          const val = parseFloat(String(s.state).replace('%','').replace(',','.'));
                          if (val >= 65) {
                            const name = (s.attributes.friendly_name || "").toLowerCase();
                            const eid = key.toLowerCase();
                            if (s.attributes.device_class === 'humidity' || name.includes('humid') || eid.includes('humid')) {
                              if (!exclusions.test(eid) && !exclusions.test(name)) {
                                count++;
                              }
                            }
                          }
                        }
                        const label = count > 1 ? 'PIÈCES TROP HUMIDES' : 'PIÈCE TROP HUMIDE';
                        return `
                          <div style="width: 100%; height: 100%; display: flex; flex-direction: row; justify-content: center; align-items: center; padding: 0 15px; position: relative; gap: 15px;">
                            <div style="font-size: 38px; font-weight: 900; color: #00BCD4; line-height: 1; text-shadow: 0 0 15px #00BCD480;">${count}</div>
                            <div style="display: flex; flex-direction: column; align-items: flex-start; justify-content: center;">
                              <div style="font-size: 13px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px;">${label}</div>
                              <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; display: flex; align-items: center; font-weight: 600;">HUMIDITÉ > 65%</div>
                            </div>
                          </div>
                        `;
                      ]]]
                    footer: |
                      [[[
                        return `<div style="display:flex; width:100%; justify-content:center; align-items:center;"><ha-icon icon="mdi:chevron-down" style="color: rgba(255,255,255,0.7); width: 18px; height: 18px;"></ha-icon></div>`;
                      ]]]
                entities:
                  - type: custom:button-card
                    color_type: blank-card
                    styles:
                      card:
                        - height: 14px
                  - type: custom:auto-entities
                    show_empty: false
                    card:
                      type: grid
                      columns: 2
                      square: false
                      card_mod:
                        style: |
                          ha-card {
                            background: transparent !important;
                            box-shadow: none !important;
                            border: none !important;
                            padding: 0 !important;
                            margin: 0 !important;
                            width: 100% !important;
                          }
                    card_param: cards
                    filter:
                      include:
                        - domain: sensor
                          attributes:
                            device_class: humidity
                          state: '>= 65'
                          options:
                            type: custom:button-card
                            layout: horizontal
                            show_name: true
                            show_state: true
                            show_icon: true
                            styles:
                              card:
                                - background: rgba(20, 27, 38, 0.6)
                                - backdrop-filter: blur(10px)
                                - '-webkit-backdrop-filter': blur(10px)
                                - border-radius: 20px
                                - border: 1px solid rgba(0, 188, 212, 0.4)
                                - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                                - height: 60px
                              grid:
                                - grid-template-areas: '"i n s"'
                                - grid-template-columns: 45px 1fr 50px
                              icon:
                                - color: '#00BCD4'
                                - width: 22px
                                - height: 22px
                                - justify-self: center
                              name:
                                - color: white
                                - font-weight: 800
                                - font-size: 11px
                                - justify-self: start
                                - text-align: left
                              state:
                                - color: '#00BCD4'
                                - font-weight: 900
                                - font-size: 13px
                                - justify-self: end
                        - name: '*humid*'
                          state: '>= 65'
                          options:
                            type: custom:button-card
                            layout: horizontal
                            show_name: true
                            show_state: true
                            show_icon: true
                            styles:
                              card:
                                - background: rgba(20, 27, 38, 0.6)
                                - border-radius: 20px
                                - border: 1px solid rgba(0, 188, 212, 0.4)
                                - height: 60px
                              grid:
                                - grid-template-areas: '"i n s"'
                                - grid-template-columns: 45px 1fr 50px
                              icon:
                                - color: '#00BCD4'
                                - width: 22px
                              name:
                                - color: white
                                - font-weight: 800
                                - font-size: 11px
                                - justify-self: start
                              state:
                                - color: '#00BCD4'
                                - font-weight: 900
                                - font-size: 13px
                      exclude:
                        - entity_id: '*battery*'
                        - entity_id: '*voltage*'
                        - entity_id: '*signal*'
                        - entity_id: '*ecojoko*'
                        - entity_id: '*home*'
                        - entity_id: '*oil*'
                        - entity_id: '*diffus*'
                        - name: '*home*'
                        - name: '*ecojoko*'
                        - name: '*oil*'
                        - name: '*diffus*'
          - type: custom:button-card
            show_name: false
            show_icon: false
            show_state: false
            styles:
              card:
                - padding: 0
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - border-radius: 20px
                - box-shadow: 0 0 20px rgba(79, 195, 247, 0.4), 0 4px 15px rgba(0,0,0,0.2)
                - overflow: hidden
                - margin: 0px
                - box-sizing: border-box
                - position: relative
                - display: |
                    [[[
                      var isEditMode = window.location.search.includes('edit=1') || window.location.pathname.includes('edit');
                      var w_on = states['binary_sensor.machine_a_laver_en_cours']?.state === 'on';
                      var w_door = states['binary_sensor.capteur_ouverture_lave_linge_contact']?.state === 'on';
                      var w_done = (states['input_boolean.machine_a_laver_terminee']?.state === 'on') && !w_door;
                      var d_on = states['binary_sensor.seche_linge_en_cours']?.state === 'on';
                      var d_door = states['binary_sensor.seche_linge_door_status']?.state === 'on';
                      var d_done = (states['input_boolean.seche_linge_termine']?.state === 'on') && !d_door;
                      if (isEditMode || w_on || w_done || d_on || d_done) return 'flex';
                      return 'none !important';
                    ]]]
                - border: 1px solid rgba(79, 195, 247, 0.3)
              grid:
                - grid-template-areas: '"img info"'
                - grid-template-columns: 130px minmax(0, 1fr)
                - grid-template-rows: 80px
                - align-items: stretch
              custom_fields:
                img:
                  - justify-self: stretch
                  - align-self: stretch
                  - border-right: 2px solid rgba(255, 255, 255, 0.6)
                  - padding: 0
                info:
                  - justify-self: stretch
                  - align-self: stretch
                  - width: 100%
                  - box-sizing: border-box
            custom_fields:
              img: |
                [[[
                  const blue = "#4fc3f7";
                  const svg = `
                    <svg viewBox="0 0 100 100" width="55" height="55" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));">
                      <defs>
                        <linearGradient id="basketGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                          <stop offset="0%" style="stop-color:#eeeeee;stop-opacity:1" />
                          <stop offset="100%" style="stop-color:#bdbdbd;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="cloth1" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                          <stop offset="100%" style="stop-color:#e0e0e0;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="cloth2" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#b3e5fc;stop-opacity:1" />
                          <stop offset="100%" style="stop-color:#4fc3f7;stop-opacity:1" />
                        </linearGradient>
                      </defs>
                      
                      <!-- Clothes Inside -->
                      <path d="M30,50 Q40,35 55,45 Q70,35 75,55 L75,65 L25,65 Z" fill="url(#cloth1)" />
                      <path d="M40,55 Q55,40 70,50 L70,60 L35,60 Z" fill="url(#cloth2)" opacity="0.8" />
                      
                      <!-- Basket Body -->
                      <path d="M20,55 L80,55 L75,90 L25,90 Z" fill="url(#basketGrad)" stroke="#9e9e9e" stroke-width="1" />
                      <!-- Basket Holes/Pattern -->
                      <g opacity="0.3" fill="#616161">
                        <rect x="28" y="62" width="6" height="4" rx="1" />
                        <rect x="40" y="62" width="6" height="4" rx="1" />
                        <rect x="52" y="62" width="6" height="4" rx="1" />
                        <rect x="64" y="62" width="6" height="4" rx="1" />
                        
                        <rect x="30" y="70" width="6" height="4" rx="1" />
                        <rect x="42" y="70" width="6" height="4" rx="1" />
                        <rect x="54" y="70" width="6" height="4" rx="1" />
                        <rect x="66" y="70" width="6" height="4" rx="1" />

                        <rect x="32" y="78" width="6" height="4" rx="1" />
                        <rect x="44" y="78" width="6" height="4" rx="1" />
                        <rect x="56" y="78" width="6" height="4" rx="1" />
                        <rect x="68" y="78" width="6" height="4" rx="1" />
                      </g>
                      
                      <!-- Basket Rim -->
                      <rect x="18" y="52" width="64" height="6" rx="3" fill="#eeeeee" stroke="#bdbdbd" stroke-width="0.5" />
                      
                      <!-- Shine on Rim -->
                      <rect x="22" y="53.5" width="20" height="1.5" rx="1" fill="white" opacity="0.4" />
                    </svg>
                  `;

                  return `
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(79, 195, 247, 0.2) 0%, rgba(79, 195, 247, 0) 100%); border-top-left-radius: 20px; position: relative;">
                      <div style="position: absolute; width: 50px; height: 50px; background: ${blue}; border-radius: 50%; filter: blur(20px); opacity: 0.3; animation: pulseGlow 4s infinite alternate ease-in-out;"></div>
                      <div style="position: relative; z-index: 1;">${svg}</div>
                      <div style="font-size: 9px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; z-index: 1;">BUANDERIE</div>
                      <style>@keyframes pulseGlow { from { opacity: 0.2; transform: scale(0.9); } to { opacity: 0.4; transform: scale(1.1); } }</style>
                    </div>
                  `;
                ]]]
              info: |
                [[[
                  var isEditMode = window.location.search.includes('edit=1') || window.location.pathname.includes('edit');
                  var w_on = states['binary_sensor.machine_a_laver_en_cours']?.state === 'on';
                  var w_door = states['binary_sensor.capteur_ouverture_lave_linge_contact']?.state === 'on';
                  var w_done = (states['input_boolean.machine_a_laver_terminee']?.state === 'on') && !w_door;
                  var d_on = states['binary_sensor.seche_linge_en_cours']?.state === 'on';
                  var d_door = states['binary_sensor.seche_linge_door_status']?.state === 'on';
                  var d_done = (states['input_boolean.seche_linge_termine']?.state === 'on') && !d_door;

                  var items = [];
                  if (w_on) items.push({ name: 'Lave-linge', label: 'En cours', icon: 'mdi:washing-machine', color: '#fb8c00', blink: true });
                  if (w_done) items.push({ name: 'Lave-linge', label: 'Terminé', icon: 'mdi:washing-machine-alert', color: '#00897b', blink: false });
                  if (d_on) items.push({ name: 'Sèche-linge', label: 'En cours', icon: 'mdi:tumble-dryer', color: '#fb8c00', blink: true });
                  if (d_done) items.push({ name: 'Sèche-linge', label: 'Terminé', icon: 'mdi:tumble-dryer-alert', color: '#00897b', blink: false });

                  if (items.length === 0) return isEditMode ? '<div style="display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; color: rgba(255,255,255,0.4); font-size: 11px;">Mode Édition</div>' : '';

                  var html = '<style>@keyframes blink-machine { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }</style>';
                  html += '<div style="display: flex; gap: 8px; align-items: center; justify-content: center; height: 100%; padding: 0 10px;">';
                  for (var i = 0; i < items.length; i++) {
                    var c = items[i];
                    html += `<div style="flex: 1; height: 60px; border-radius: 12px; background: rgba(20, 27, 38, 0.4); border: 1px solid ${c.color}60; display: flex; flex-direction: column; justify-content: center; align-items: center; ${c.blink ? 'animation: blink-machine 2s ease infinite;' : ''}">`;
                    html += `<ha-icon icon="${c.icon}" style="--mdc-icon-size: 22px; color: ${c.color}; margin-bottom: 2px;"></ha-icon>`;
                    html += `<div style="font-size: 10px; font-weight: 700; color: white; line-height: 1.1;">${c.name}</div>`;
                    html += `<div style="font-size: 9px; color: white; opacity: 0.7; line-height: 1.1;">${c.label}</div>`;
                    html += '</div>';
                  }
                  return html + '</div>';
                ]]]
          - type: conditional
            conditions:
              - entity: sensor.poubelle_a_sortir
                state_not: none
            card:
              type: custom:button-card
              entity: sensor.poubelle_a_sortir
              show_name: false
              show_icon: false
              show_state: false
              variables:
                color: |
                  [[[
                    const type = entity.state.trim().toLowerCase();
                    if (type === 'jaune') return '#FFEB3B';   // Jaune
                    if (type === 'verre') return '#00BCD4';   // Bleu/Cyan (Verre)
                    return '#4CAF50';                         // Vert (Défaut/Verte)
                  ]]]
              styles:
                card:
                  - padding: 0
                  - background: rgba(20, 27, 38, 0.6)
                  - backdrop-filter: blur(10px)
                  - '-webkit-backdrop-filter': blur(10px)
                  - border-radius: 20px
                  - border: '[[[ return `1px solid ${variables.color}60`; ]]]'
                  - box-shadow: >-
                      [[[ return `0 0 20px ${variables.color}60, 0 8px 32px
                      rgba(0,0,0,0.4)`; ]]]
                  - overflow: hidden
                  - margin: 0px
                  - box-sizing: border-box
                  - position: relative
                  - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                  - height: 85px
                grid:
                  - grid-template-areas: '"img info"'
                  - grid-template-columns: 130px minmax(0, 1fr)
                  - grid-template-rows: 85px
                  - gap: 0px
                  - width: 100%
                  - margin: 0
                custom_fields:
                  img:
                    - justify-self: stretch
                    - align-self: stretch
                    - border-right: 2px solid rgba(255, 255, 255, 0.6)
                    - display: flex
                    - align-items: center
                    - justify-content: center
                    - padding: 0
                  info:
                    - justify-self: stretch
                    - align-self: stretch
                    - display: flex
                    - flex-direction: column
                    - justify-content: center
                    - align-items: center
                    - text-align: center
                    - padding: 0 15px
                    - overflow: hidden
                    - position: relative
              extra_styles: |
                @keyframes blink {
                  0% { opacity: 1; text-shadow: 0 0 10px var(--glow-color); }
                  50% { opacity: 0.35; text-shadow: 0 0 2px var(--glow-color); } 
                  100% { opacity: 1; text-shadow: 0 0 10px var(--glow-color); }
                }
              custom_fields:
                img: |
                  [[[
                    const type = entity.state.trim().toLowerCase();
                    const v = new Date().getTime();
                    let imgUrl = `/local/green_bin.png?v=${v}`;
                    let scale = 1.0;
                    
                    if (type === 'jaune') {
                      imgUrl = `/local/garbage/yellow_bin.png?v=${v}`;
                      scale = 0.85; // Reducing scale for the yellow bin image
                    }
                    if (type === 'verre') imgUrl = `/local/glass_bin.png?v=${v}`;
                    
                    const color = variables.color;
                    
                    return `
                      <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px; border-bottom-left-radius: 20px; box-sizing: border-box; padding: 10px;">
                        <img src="${imgUrl}" style="width: 100%; max-width: 60px; height: auto; transform: scale(${scale}); filter: drop-shadow(0 4px 10px ${color}66); object-fit: contain;" />
                        <div style="font-size: 8px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; margin-top: -5px;">Poubelles</div>
                      </div>
                    `;
                  ]]]
                info: |
                  [[[
                    const title = entity.attributes.original_title || "POUBELLE À SORTIR";
                    const color = variables.color;
                    
                    return `
                      <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; --glow-color: ${color}44; padding: 0 5px; text-align: center;">
                        <div style="font-size: 13px; font-weight: 800; color: ${color}; text-transform: uppercase; letter-spacing: 1.2px; text-align: center; line-height: 1.2; white-space: normal; animation: blink 2s ease infinite;">
                          ${title}
                        </div>
                      </div>
                    `;
                  ]]]
          - type: conditional
            conditions:
              - entity: sensor.batteries_faibles_count
                state_not: '0'
            card:
              type: custom:fold-entity-row
              padding: 0
              clickable: true
              card_mod:
                style: |
                  div#head {
                    display: block !important;
                    width: 100% !important;
                    padding: 0 !important;
                    margin: 0 !important;
                    --toggle-icon-width: 0px !important;
                  }
                  #head {
                    padding: 0 !important;
                    margin: 0 !important;
                    width: 100% !important;
                    cursor: pointer !important;
                    pointer-events: auto !important;
                  }
                  #head ha-icon {
                    display: none !important;
                    width: 0px !important;
                  }
                  div#items {
                    padding: 0 !important;
                    margin: 0 !important;
                  }
              head:
                type: custom:button-card
                entity: sensor.batteries_faibles_count
                show_name: false
                show_icon: false
                show_state: false
                tap_action:
                  action: none
                variables:
                  color: '#ff4444'
                styles:
                  card:
                    - padding: 0
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - border-radius: 20px
                    - border: '[[[ return `1px solid ${variables.color}80`; ]]]'
                    - box-shadow: >-
                        [[[ return `0 0 20px ${variables.color}80, 0 8px 32px
                        rgba(0,0,0,0.4)`; ]]]
                    - overflow: hidden
                    - margin: 0px
                    - box-sizing: border-box
                    - position: relative
                    - height: 85px
                    - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                  grid:
                    - grid-template-areas: '"icon details" "footer footer"'
                    - grid-template-columns: 130px minmax(0, 1fr)
                    - grid-template-rows: 60px 25px
                    - gap: 0px
                    - width: 100%
                    - margin: 0
                  custom_fields:
                    icon:
                      - justify-self: stretch
                      - align-self: stretch
                      - border-right: 2px solid rgba(255,255,255,0.6)
                      - border-top-left-radius: 20px
                      - display: flex
                      - align-items: center
                      - justify-content: center
                      - padding: 0
                    details:
                      - justify-self: stretch
                      - align-self: stretch
                      - display: flex
                      - flex-direction: column
                      - justify-content: center
                      - align-items: center
                      - padding: 0
                      - overflow: hidden
                      - position: relative
                    footer:
                      - justify-self: stretch
                      - align-self: stretch
                      - background: rgba(0,0,0,0.2)
                      - border-top: 1px solid rgba(255,255,255,0.05)
                      - display: flex
                      - align-items: center
                      - justify-content: center
                      - border-radius: 0 0 20px 20px
                extra_styles: |
                  @keyframes blink {
                    0% { opacity: 1; text-shadow: 0 0 10px var(--glow-color); }
                    50% { opacity: 0.35; text-shadow: 0 0 2px var(--glow-color); } 
                    100% { opacity: 1; text-shadow: 0 0 10px var(--glow-color); }
                  }
                custom_fields:
                  icon: |
                    [[[
                      const color = variables.color;
                      return `
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px; box-sizing: border-box; position: relative;">
                          <div style="position: absolute; width: 50px; height: 50px; background: ${color}; border-radius: 50%; filter: blur(20px); opacity: 0.3; animation: pulseGlow 4s infinite alternate ease-in-out;"></div>
                          <div style="font-size: 32px; line-height: 1; filter: drop-shadow(0 0 10px ${color}80); display: flex; align-items: center; justify-content: center; z-index: 1;">🪫</div>
                          <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; z-index: 1;">Batteries</div>
                          <style>@keyframes pulseGlow { from { opacity: 0.2; transform: scale(0.9); } to { opacity: 0.4; transform: scale(1.1); } }</style>
                        </div>
                      `;
                    ]]]
                  details: |
                    [[[
                      const count = parseInt(entity.state) || 0;
                      const label = count > 1 ? 'BATTERIES À CHANGER' : 'BATTERIE À CHANGER';
                      const color = variables.color;
                      return `
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: row; justify-content: center; align-items: center; padding: 0 15px; position: relative; gap: 15px;">
                          <div style="font-size: 38px; font-weight: 900; color: ${color}; line-height: 1; text-shadow: 0 0 15px ${color}80; animation: blink 2s ease infinite;">${count}</div>
                          <div style="display: flex; flex-direction: column; align-items: flex-start; justify-content: center;">
                            <div style="font-size: 13px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px;">${label}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; display: flex; align-items: center; font-weight: 600;">
                              NIVEAU CRITIQUE
                            </div>
                          </div>
                        </div>
                      `;
                    ]]]
                  footer: |
                    [[[
                       setTimeout(() => {
                         const isEditMode = window.location.search.includes('edit=1') || window.location.pathname.includes('edit');
                         if (isEditMode) {
                            const el = document.querySelector("hui-conditional-card"); 
                            if (el) el.style.display = 'block';
                         }
                       }, 1000);

                       return `
                         <div style="display:flex; width:100%; justify-content:center; align-items:center;">
                           <ha-icon icon="mdi:chevron-down" style="color: rgba(255,255,255,0.7); width: 18px; height: 18px;"></ha-icon>
                         </div>
                       `;
                    ]]]
              entities:
                - type: custom:auto-entities
                  show_empty: false
                  card:
                    type: markdown
                    content: 🎉 Toutes vos batteries sont en bon état !
                    card_mod:
                      style: |
                        ha-card {
                          background: transparent !important;
                          box-shadow: none !important;
                          border: none !important;
                          padding: 20px 0 !important;
                          text-align: center !important;
                          color: rgba(255,255,255,0.7) !important;
                          font-size: 14px !important;
                          font-weight: 500 !important;
                        }
                  filter:
                    template: >
                      {% set ns = namespace(count=0) %}

                      {% for s in states.sensor if s.attributes.device_class ==
                      'battery' and not 'iphone' in (s.entity_id | lower) and
                      s.entity_id != 'sensor.ci_tesla_battery' %}
                        {% set val = s.state | float(-1) %}
                        {% if 0 <= val <= 50 %}
                          {% set ns.count = ns.count + 1 %}
                        {% endif %}
                      {% endfor %}

                      {% if ns.count == 0 %}
                        {{ {} }}
                      {% endif %}
                - type: custom:auto-entities
                  show_empty: false
                  card:
                    type: entities
                    title: BATTERIES CRITIQUES (<= 10%)
                    card_mod:
                      style: |
                        ha-card {
                          background: rgba(220, 20, 60, 0.2) !important;
                          backdrop-filter: blur(10px) !important;
                          -webkit-backdrop-filter: blur(10px) !important;
                          border-radius: 20px !important;
                          border: 1px solid rgba(255, 50, 50, 0.4) !important;
                          margin-bottom: 20px !important;
                          margin-top: 10px !important;
                          box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                        } .card-header { 
                          color: #ff4444 !important; 
                          font-weight: 800 !important; 
                          font-size: 13px !important; 
                          letter-spacing: 1px !important; 
                          padding: 16px 16px 8px 16px !important; 
                          text-transform: uppercase !important;
                        }
                  filter:
                    template: |
                      {%- set sensors = states.sensor 
                        | selectattr('attributes.device_class', 'defined')
                        | selectattr('attributes.device_class', 'eq', 'battery')
                        | selectattr('state', 'is_number')
                        | rejectattr('entity_id', 'search', 'iphone', ignorecase=true)
                        | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')
                        | list -%}
                      {%- for s in sensors if s.state | int <= 10 -%}
                        {{ {
                          'entity': s.entity_id,
                          'name': s.attributes.friendly_name,
                          'secondary_info': area_name(s.entity_id) or 'Pièce non définie',
                          'card_mod': {
                            'style': ':host { --paper-item-icon-color: #ff4444; color: white; }'
                          }
                        } }},
                      {%- endfor -%}
                  sort:
                    method: state
                    numeric: true
                - type: custom:auto-entities
                  show_empty: false
                  card:
                    type: entities
                    title: À SURVEILLER (11% - 30%)
                    card_mod:
                      style: |
                        ha-card {
                          background: rgba(20, 27, 38, 0.6) !important;
                          backdrop-filter: blur(10px) !important;
                          -webkit-backdrop-filter: blur(10px) !important;
                          border-radius: 20px !important;
                          border: 1px solid rgba(255, 152, 0, 0.4) !important;
                          margin-bottom: 20px !important;
                          margin-top: 10px !important;
                          box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                        } .card-header { 
                          color: #ff9800 !important; 
                          font-weight: 800 !important; 
                          font-size: 13px !important; 
                          letter-spacing: 1px !important; 
                          padding: 16px 16px 8px 16px !important; 
                          text-transform: uppercase !important;
                        }
                  filter:
                    template: >
                      {%- set sensors = states.sensor 
                        | selectattr('attributes.device_class', 'defined')
                        | selectattr('attributes.device_class', 'eq', 'battery')
                        | selectattr('state', 'is_number')
                        | rejectattr('entity_id', 'search', 'iphone', ignorecase=true)
                        | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')
                        | list -%}
                      {%- for s in sensors if s.state | int > 10 and s.state |
                      int <= 30 -%}
                        {{ {
                          'entity': s.entity_id,
                          'name': s.attributes.friendly_name,
                          'secondary_info': area_name(s.entity_id) or 'Pièce non définie',
                          'card_mod': {
                            'style': ':host { --paper-item-icon-color: #ff9800; color: white; }'
                          }
                        } }},
                      {%- endfor -%}
                  sort:
                    method: state
                    numeric: true
                - type: custom:auto-entities
                  show_empty: false
                  card:
                    type: entities
                    title: ÉTAT MOYEN (31% - 50%)
                    card_mod:
                      style: |
                        ha-card {
                          background: rgba(20, 27, 38, 0.6) !important;
                          backdrop-filter: blur(10px) !important;
                          -webkit-backdrop-filter: blur(10px) !important;
                          border-radius: 20px !important;
                          border: 1px solid rgba(255, 235, 59, 0.4) !important;
                          margin-bottom: 20px !important;
                          margin-top: 10px !important;
                          box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                        } .card-header { 
                          color: #ffeb3b !important; 
                          font-weight: 800 !important; 
                          font-size: 13px !important; 
                          letter-spacing: 1px !important; 
                          padding: 16px 16px 8px 16px !important; 
                          text-transform: uppercase !important;
                        }
                  filter:
                    template: >
                      {%- set sensors = states.sensor 
                        | selectattr('attributes.device_class', 'defined')
                        | selectattr('attributes.device_class', 'eq', 'battery')
                        | selectattr('state', 'is_number')
                        | rejectattr('entity_id', 'search', 'iphone', ignorecase=true)
                        | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')
                        | list -%}
                      {%- for s in sensors if s.state | int > 30 and s.state |
                      int <= 50 -%}
                        {{ {
                          'entity': s.entity_id,
                          'name': s.attributes.friendly_name,
                          'secondary_info': area_name(s.entity_id) or 'Pièce non définie',
                          'card_mod': {
                            'style': ':host { --paper-item-icon-color: #ffeb3b; color: white; }'
                          }
                        } }},
                      {%- endfor -%}
                  sort:
                    method: state
                    numeric: true
          - type: conditional
            conditions:
              - condition: numeric_state
                entity: sensor.colis_17track_actifs
                above: 0
            card:
              type: custom:fold-entity-row
              padding: 0
              clickable: true
              card_mod:
                style: |
                  div#head {
                    display: block !important;
                    width: 100% !important;
                    padding: 0 !important;
                    margin: 0 !important;
                    --toggle-icon-width: 0px !important;
                  }
                  #head {
                    padding: 0 !important;
                    margin: 0 !important;
                    width: 100% !important;
                    cursor: pointer !important;
                    pointer-events: auto !important;
                  }
                  #head ha-icon {
                    display: none !important;
                    width: 0px !important;
                  }
                  div#items {
                    padding: 0 !important;
                    margin: 0 !important;
                  }
              head:
                type: custom:button-card
                entity: sensor.colis_17track_actifs
                show_name: false
                show_icon: false
                show_state: false
                tap_action:
                  action: none
                variables:
                  color: '#FF9800'
                styles:
                  card:
                    - padding: 0
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - border-radius: 20px
                    - border: '[[[ return `1px solid ${variables.color}80`; ]]]'
                    - box-shadow: >-
                        [[[ return `0 0 20px ${variables.color}80, 0 8px 32px
                        rgba(0,0,0,0.4)`; ]]]
                    - overflow: hidden
                    - margin: 0px
                    - box-sizing: border-box
                    - position: relative
                    - height: 85px
                    - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                  grid:
                    - grid-template-areas: '"icon details" "footer footer"'
                    - grid-template-columns: 130px minmax(0, 1fr)
                    - grid-template-rows: 60px 25px
                    - gap: 0px
                    - width: 100%
                    - margin: 0
                  custom_fields:
                    icon:
                      - justify-self: stretch
                      - align-self: stretch
                      - border-right: 2px solid rgba(255,255,255,0.6)
                      - border-top-left-radius: 20px
                      - display: flex
                      - align-items: center
                      - justify-content: center
                      - padding: 0
                    details:
                      - justify-self: stretch
                      - align-self: stretch
                      - display: flex
                      - flex-direction: column
                      - justify-content: center
                      - align-items: center
                      - padding: 0
                      - overflow: hidden
                      - position: relative
                    footer:
                      - justify-self: stretch
                      - align-self: stretch
                      - background: rgba(0,0,0,0.2)
                      - border-top: 1px solid rgba(255,255,255,0.05)
                      - display: flex
                      - align-items: center
                      - justify-content: center
                      - border-radius: 0 0 20px 20px
                custom_fields:
                  icon: |
                    [[[
                      const color = variables.color;
                      return `
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px; box-sizing: border-box; position: relative;">
                          <div style="position: absolute; width: 50px; height: 50px; background: ${color}; border-radius: 50%; filter: blur(20px); opacity: 0.3; animation: pulseGlow 4s infinite alternate ease-in-out;"></div>
                          <div style="font-size: 32px; line-height: 1; filter: drop-shadow(0 0 10px ${color}80); display: flex; align-items: center; justify-content: center; z-index: 1;">📦</div>
                          <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; z-index: 1;">Livraisons</div>
                          <style>@keyframes pulseGlow { from { opacity: 0.2; transform: scale(0.9); } to { opacity: 0.4; transform: scale(1.1); } }</style>
                        </div>
                      `;
                    ]]]
                  details: |
                    [[[
                      const count = entity.state;
                      const color = variables.color;
                      return `
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: row; justify-content: center; align-items: center; padding: 0 15px; position: relative; gap: 15px;">
                          <div style="font-size: 38px; font-weight: 900; color: ${color}; line-height: 1; text-shadow: 0 0 15px ${color}80;">${count}</div>
                          <div style="display: flex; flex-direction: column; align-items: flex-start; justify-content: center;">
                            <div style="font-size: 13px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px;">COLIS EN ATTENTE</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; display: flex; align-items: center; font-weight: 600;">
                              SUIVI 17TRACK
                            </div>
                          </div>
                        </div>
                      `;
                    ]]]
                  footer: |
                    [[[
                       setTimeout(() => {
                         const isEditMode = window.location.search.includes('edit=1') || window.location.pathname.includes('edit');
                         if (isEditMode) {
                            const el = document.querySelector("hui-conditional-card"); 
                            if (el) el.style.display = 'block';
                         }
                       }, 1000);

                       return `
                         <div style="display:flex; width:100%; justify-content:center; align-items:center;">
                           <ha-icon icon="mdi:chevron-down" style="color: rgba(255,255,255,0.7); width: 18px; height: 18px;"></ha-icon>
                         </div>
                       `;
                    ]]]
              entities:
                - type: custom:button-card
                  entity: sensor.colis_17track_actifs
                  show_name: false
                  show_icon: false
                  styles:
                    card:
                      - background: rgba(20, 27, 38, 0.6)
                      - backdrop-filter: blur(10px)
                      - '-webkit-backdrop-filter': blur(10px)
                      - border-radius: 20px
                      - border: 1px solid rgba(255, 152, 0, 0.4)
                      - margin-bottom: 20px
                      - margin-top: 10px
                      - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                      - padding: 0
                    grid:
                      - grid-template-areas: '"title" "details"'
                      - grid-template-columns: 1fr
                      - grid-template-rows: min-content 1fr
                    custom_fields:
                      title:
                        - justify-self: stretch
                        - text-align: left
                        - padding: 16px 16px 8px 16px
                      details:
                        - justify-self: stretch
                        - padding: 0 16px 16px 16px
                  custom_fields:
                    title: |
                      [[[
                        return `<div style="color: #FF9800; font-weight: 800; font-size: 13px; letter-spacing: 1px; text-transform: uppercase;">SUIVI DES COLIS</div>`;
                      ]]]
                    details: |
                      [[[
                        try {
                          if (!entity) return `<div style="color:red; padding:10px;">Entité en cours de chargement...</div>`;
                          
                          const attr = entity.attributes || {};
                          const packages = attr.packages;
                          
                          if (!packages || !Array.isArray(packages) || packages.length === 0) {
                             return `<div style="color: rgba(255,255,255,0.7); font-size: 13px; text-align: center; padding: 20px 0;">Aucun colis en attente.</div>`;
                          }
                          
                          const trad_status = {
                            "In Transit": "En transit",
                            "Not Found": "Introuvable",
                            "Expired": "Expiré",
                            "Ready to be picked up": "À retirer",
                            "Undelivered": "Non distribué",
                            "Alert": "Alerte",
                            "Delivered": "Livré",
                            "Pending": "En attente"
                          };
                          
                          const trad_phrases = {
                            "Departed from departure country/region": "Départ du pays d’origine",
                            "Left from departure country/region": "Colis parti du pays d’origine",
                            "Destination country/region arrived": "Arrivé dans le pays de destination",
                            "Arrived at sorting center": "Arrivé au centre de tri",
                            "Item dispatched": "Colis expédié",
                            "Out for delivery": "En cours de livraison",
                            "Shipment information received": "Informations d’expédition reçues",
                            "Handed over from linehaul office": "Pris en charge par le hub principal",
                            "At destination country/region": "dans le pays de destination"
                          };
                          
                          let html = '<div style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">';
                          
                          packages.forEach(pkg => {
                            const name = pkg.friendly_name || pkg.tracking_number || "Colis inconnu";
                            const status_en = pkg.status || "";
                            const status_fr = trad_status[status_en] || status_en || "Inconnu";
                            
                            let base_text = String(pkg.info_text || "").replace(/\n/g, ' ').replace('Carrier note:', '').trim();
                            
                            for (const eng in trad_phrases) {
                              base_text = base_text.split(eng).join(trad_phrases[eng]);
                            }
                            
                            html += `
                              <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.05);">
                                <div style="color: white; font-weight: 700; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                  📦 <span style="letter-spacing: 0.5px; white-space: normal; word-break: break-word;">${name}</span>
                                </div>
                                <div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px; line-height: 1.4;">
                                  <span>✈️</span> <span style="flex: 1; white-space: normal; word-break: break-word;">${base_text}</span>
                                </div>
                                <div style="color: #FF9800; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                  <span>📍</span> <span style="white-space: normal; word-break: break-word;">Statut : ${status_fr}</span>
                                </div>
                              </div>
                            `;
                          });
                          
                          html += '</div>';
                          return html;
                          
                        } catch (error) {
                          return `<div style="color: #ff4444; font-family: monospace; font-size: 11px; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 8px;">Erreur JS: ${error.message}</div>`;
                        }
                      ]]]
      - type: grid
        cards: []
    header:
      layout: responsive
      badges_position: bottom
      badges_wrap: wrap
      card_mod:
        style: |
          ha-card {
            position: relative;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 16px rgba(0,0,0,0.55);

            /* ↓↓↓ dégradé glossy, sans toucher aux couleurs de police ↓↓↓ */
            background: linear-gradient(
              145deg,
              rgba(0, 0, 0, 0.85) 0%,
              rgba(20, 20, 20, 0.95) 40%,
              rgba(0, 250, 200, 0.70) 120%
            );
          }
    badges:
      - type: custom:button-card
        entity: sensor.prix_du_kwh_2
        show_name: false
        show_icon: false
        show_state: false
        styles:
          card:
            - padding: 0
            - border-radius: 12px
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(10px)
            - '-webkit-backdrop-filter': blur(10px)
            - transition: all 0.3s ease
            - border: |
                [[[
                  const p = states['sensor.periode_tarifaire']?.state || "";
                  const isPleine = p.includes("Pleines");
                  return isPleine
                    ? "1px solid rgba(229, 57, 53, 0.5)"
                    : "1px solid rgba(0, 200, 83, 0.5)";
                ]]]
            - box-shadow: |
                [[[
                  const p = states['sensor.periode_tarifaire']?.state || "";
                  const isPleine = p.includes("Pleines");
                  return isPleine
                    ? "0 4px 15px rgba(229, 57, 53, 0.2)"
                    : "0 4px 15px rgba(0, 200, 83, 0.2)";
                ]]]
            - height: 38px
            - overflow: hidden
          grid:
            - grid-template-areas: '"gauche droite"'
            - grid-template-columns: 1fr auto
            - grid-template-rows: 38px
            - width: 100%
          custom_fields:
            gauche:
              - justify-self: stretch
              - align-self: stretch
              - padding-left: 6px
              - display: flex
              - align-items: center
              - justify-content: flex-start
              - gap: 4px
            droite:
              - justify-self: end
              - align-self: stretch
              - padding-right: 10px
              - padding-left: 8px
              - display: flex
              - align-items: center
              - border-left: 1px solid rgba(255,255,255,0.1)
        custom_fields:
          gauche: |
            [[[
              const p = states['sensor.periode_tarifaire']?.state || "";
              const isPleine = p.includes("Pleines");
              const color = isPleine ? "#E53935" : "#00C853";
              const status = isPleine ? "Pleines" : "Creuses";
              return `
                <ha-icon icon="mdi:lightning-bolt" style="display: flex; width: 16px; height: 16px; color: ${color}; filter: drop-shadow(0 0 8px ${color}80);"></ha-icon>
                <div style="font-size: 8px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.1px; line-height: 1;">Heures<br>${status}</div>
              `;
            ]]]
          droite: |
            [[[
              const state = entity.state;
              return `
                <div style="text-align: right;">
                  <div style="font-size: 12px; font-weight: 800; color: white; line-height: 1;">${state} <span style="font-size: 9px; color: #E53935;">€</span></div>
                  <div style="font-size: 7px; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; margin-top: 1px;">/ kWh</div>
                </div>
              `;
            ]]]
      - type: custom:button-card
        entity: binary_sensor.orange_livebox_etat_du_reseau_etendu_wan
        show_name: false
        show_icon: false
        show_state: false
        tap_action:
          action: navigate
          navigation_path: /lovelace/livebox
        styles:
          card:
            - padding: 0
            - border-radius: 12px
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(10px)
            - '-webkit-backdrop-filter': blur(10px)
            - transition: all 0.3s ease
            - border: |
                [[[
                  return (entity.state === 'on')
                    ? "1px solid rgba(0, 200, 83, 0.5)"
                    : "1px solid rgba(229, 57, 53, 0.5)";
                ]]]
            - box-shadow: |
                [[[
                  return (entity.state === 'on')
                    ? "0 4px 15px rgba(0, 200, 83, 0.2)"
                    : "0 4px 15px rgba(229, 57, 53, 0.2)";
                ]]]
            - height: 38px
            - overflow: hidden
          grid:
            - grid-template-areas: '"gauche droite"'
            - grid-template-columns: 1fr auto
            - grid-template-rows: 38px
            - width: 100%
          custom_fields:
            gauche:
              - justify-self: stretch
              - align-self: stretch
              - padding-left: 6px
              - display: flex
              - align-items: center
              - justify-content: flex-start
              - gap: 4px
            droite:
              - justify-self: end
              - align-self: stretch
              - padding-right: 10px
              - padding-left: 8px
              - display: flex
              - align-items: center
              - border-left: 1px solid rgba(255,255,255,0.1)
        custom_fields:
          gauche: |
            [[[
              const isOn = entity.state === 'on';
              const color = isOn ? "#00C853" : "#E53935";
              return `
                <ha-icon icon="mdi:web" style="display: flex; width: 16px; height: 16px; color: ${color}; filter: drop-shadow(0 0 8px ${color}80);"></ha-icon>
                <div style="font-size: 9px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1;">Internet</div>
              `;
            ]]]
          droite: |
            [[[
              const isOn = entity.state === 'on';
              const status = isOn ? 'CONNECTÉ' : 'DÉCONNECTÉ';
              return `
                <div style="font-size: 12px; font-weight: 800; color: white; text-transform: uppercase; line-height: 1.1;">${status}</div>
              `;
            ]]]
      - type: custom:button-card
        entity: light.smart_humidifier_24080828541213641101c4e7ae093c61
        show_name: false
        show_icon: false
        show_state: false
        tap_action:
          action: navigate
          navigation_path: /lovelace/diffuseur
        styles:
          card:
            - padding: 0
            - border-radius: 12px
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(10px)
            - '-webkit-backdrop-filter': blur(10px)
            - transition: all 0.3s ease
            - border: |
                [[[
                  const lightOn = (entity.state || '').toLowerCase() === 'on';
                  const spray = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off').toLowerCase();
                  const isOn = lightOn || spray !== 'off';
                  return isOn
                    ? "1px solid rgba(0, 200, 83, 0.5)"
                    : "1px solid rgba(229, 57, 53, 0.5)";
                ]]]
            - box-shadow: |
                [[[
                  const lightOn = (entity.state || '').toLowerCase() === 'on';
                  const spray = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off').toLowerCase();
                  const isOn = lightOn || spray !== 'off';
                  return isOn
                    ? "0 4px 15px rgba(0, 200, 83, 0.2)"
                    : "0 4px 15px rgba(229, 57, 53, 0.2)";
                ]]]
            - height: 38px
            - overflow: hidden
          grid:
            - grid-template-areas: '"gauche droite"'
            - grid-template-columns: 1fr auto
            - grid-template-rows: 38px
            - width: 100%
          custom_fields:
            gauche:
              - justify-self: stretch
              - align-self: stretch
              - padding-left: 6px
              - display: flex
              - align-items: center
              - justify-content: flex-start
              - gap: 4px
            droite:
              - justify-self: end
              - align-self: stretch
              - padding-right: 10px
              - padding-left: 8px
              - display: flex
              - align-items: center
              - border-left: 1px solid rgba(255,255,255,0.1)
        custom_fields:
          gauche: |
            [[[
              const lightOn = (entity.state || '').toLowerCase() === 'on';
              const spray = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off').toLowerCase();
              const isOn = lightOn || spray !== 'off';
              const color = isOn ? "#00C853" : "#E53935";
              return `
                <ha-icon icon="mdi:air-humidifier" style="display: flex; width: 16px; height: 16px; color: ${color}; filter: drop-shadow(0 0 8px ${color}80);"></ha-icon>
                <div style="font-size: 9px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1;">Diffuseur</div>
              `;
            ]]]
          droite: |
            [[[
              const lightOn = (entity.state || '').toLowerCase() === 'on';
              const spray = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off').toLowerCase();
              const isOn = lightOn || spray !== 'off';
              const status = isOn ? 'ON' : 'OFF';
              return `
                <div style="font-size: 12px; font-weight: 800; color: white; text-transform: uppercase; line-height: 1.1;">${status}</div>
              `;
            ]]]
      - type: custom:button-card
        entity: switch.prise_imprimante_3d
        show_name: false
        show_icon: false
        show_state: false
        tap_action:
          action: navigate
          navigation_path: /lovelace/imprimante
        styles:
          card:
            - padding: 0
            - border-radius: 12px
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(10px)
            - '-webkit-backdrop-filter': blur(10px)
            - transition: all 0.3s ease
            - border: |
                [[[
                  const isOn = entity.state === 'on';
                  return isOn
                    ? "1px solid rgba(0, 200, 83, 0.5)"
                    : "1px solid rgba(229, 57, 53, 0.5)";
                ]]]
            - box-shadow: |
                [[[
                  const isOn = entity.state === 'on';
                  return isOn
                    ? "0 4px 15px rgba(0, 200, 83, 0.2)"
                    : "0 4px 15px rgba(229, 57, 53, 0.2)";
                ]]]
            - height: 38px
            - overflow: hidden
          grid:
            - grid-template-areas: '"gauche droite"'
            - grid-template-columns: 1fr auto
            - grid-template-rows: 38px
            - width: 100%
          custom_fields:
            gauche:
              - justify-self: stretch
              - align-self: stretch
              - padding-left: 6px
              - display: flex
              - align-items: center
              - justify-content: flex-start
              - gap: 4px
            droite:
              - justify-self: end
              - align-self: stretch
              - padding-right: 10px
              - padding-left: 8px
              - display: flex
              - align-items: center
              - border-left: 1px solid rgba(255,255,255,0.1)
        custom_fields:
          gauche: |
            [[[
              const isOn = entity.state === 'on';
              const color = isOn ? "#00C853" : "#E53935";
              return `
                <ha-icon icon="mdi:printer-3d" style="display: flex; width: 16px; height: 16px; color: ${color}; filter: drop-shadow(0 0 8px ${color}80);"></ha-icon>
                <div style="font-size: 9px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1;">Imprimante 3D</div>
              `;
            ]]]
          droite: |
            [[[
              const isOn = entity.state === 'on';
              const status = isOn ? 'ON' : 'OFF';
              return `
                <div style="font-size: 12px; font-weight: 800; color: white; text-transform: uppercase; line-height: 1.1;">${status}</div>
              `;
            ]]]
      - type: custom:button-card
        entity: media_player.salon
        show_name: false
        show_icon: false
        show_state: false
        tap_action:
          action: navigate
          navigation_path: /lovelace/apple-tv
        styles:
          card:
            - padding: 0
            - border-radius: 12px
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(10px)
            - '-webkit-backdrop-filter': blur(10px)
            - transition: all 0.3s ease
            - border: |
                [[[
                  const s = entity.state;
                  const isActive = s === 'playing' || s === 'paused';
                  const isOff = s === 'off' || s === 'standby' || s === 'idle';
                  if (isActive) return "1px solid rgba(14, 82, 199, 0.6)";
                  if (isOff) return "1px solid rgba(229, 57, 53, 0.6)";
                  return "1px solid rgba(255, 255, 255, 0.1)";
                ]]]
            - box-shadow: |
                [[[
                  const s = entity.state;
                  const isActive = s === 'playing' || s === 'paused';
                  const isOff = s === 'off' || s === 'standby' || s === 'idle';
                  if (isActive) return "0 4px 15px rgba(14, 82, 199, 0.3)";
                  if (isOff) return "0 4px 15px rgba(229, 57, 53, 0.3)";
                  return "none";
                ]]]
            - height: 38px
            - overflow: hidden
          grid:
            - grid-template-areas: '"gauche droite"'
            - grid-template-columns: 1fr auto
            - grid-template-rows: 38px
            - width: 100%
          custom_fields:
            gauche:
              - justify-self: stretch
              - align-self: stretch
              - padding-left: 8px
              - display: flex
              - align-items: center
              - justify-content: flex-start
              - gap: 6px
            droite:
              - justify-self: end
              - align-self: stretch
              - padding-right: 12px
              - padding-left: 10px
              - display: flex
              - align-items: center
              - border-left: 1px solid rgba(255,255,255,0.1)
        custom_fields:
          gauche: |
            [[[
              const s = entity.state;
              const isActive = s === 'playing' || s === 'paused';
              const isOff = s === 'off' || s === 'standby' || s === 'idle';
              let color = "#FFFFFF";
              if (isActive) color = "#0E52C7";
              else if (isOff) color = "#E53935";
              return `
                <ha-icon icon="mdi:apple" style="display: flex; width: 18px; height: 18px; color: ${color}; filter: drop-shadow(0 0 8px ${color}80);"></ha-icon>
                <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; line-height: 1;">Multimédia</div>
              `;
            ]]]
          droite: |
            [[[
              const s = entity.state;
              const status = s ? s.toUpperCase() : 'OFF';
              const isOff = s === 'off' || s === 'standby' || s === 'idle';
              const color = isOff ? "#E53935" : "white";
              return `
                <div style="font-size: 12px; font-weight: 900; color: ${color}; text-transform: uppercase; line-height: 1.1;">${status}</div>
              `;
            ]]]
      - type: custom:button-card
        entity: sensor.chrisnas_etat
        show_name: false
        show_icon: false
        show_state: false
        tap_action:
          action: navigate
          navigation_path: /lovelace/nas
        styles:
          card:
            - padding: 0
            - border-radius: 12px
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(10px)
            - '-webkit-backdrop-filter': blur(10px)
            - transition: all 0.3s ease
            - border: |
                [[[
                  const s = (entity.state || '').toLowerCase();
                  return (s === 'good')
                    ? "1px solid rgba(0, 200, 83, 0.5)"
                    : "1px solid rgba(229, 57, 53, 0.5)";
                ]]]
            - box-shadow: |
                [[[
                  const s = (entity.state || '').toLowerCase();
                  return (s === 'good')
                    ? "0 4px 15px rgba(0, 200, 83, 0.2)"
                    : "0 4px 15px rgba(229, 57, 53, 0.2)";
                ]]]
            - height: 38px
            - overflow: hidden
          grid:
            - grid-template-areas: '"gauche droite"'
            - grid-template-columns: 1fr auto
            - grid-template-rows: 38px
            - width: 100%
          custom_fields:
            gauche:
              - justify-self: stretch
              - align-self: stretch
              - padding-left: 6px
              - display: flex
              - align-items: center
              - justify-content: flex-start
              - gap: 4px
            droite:
              - justify-self: end
              - align-self: stretch
              - padding-right: 10px
              - padding-left: 8px
              - display: flex
              - align-items: center
              - border-left: 1px solid rgba(255,255,255,0.1)
        custom_fields:
          gauche: |
            [[[
              const s = (entity.state || '').toLowerCase();
              const color = s === 'good' ? "#00C853" : "#E53935";
              return `
                <ha-icon icon="mdi:nas" style="display: flex; width: 16px; height: 16px; color: ${color}; filter: drop-shadow(0 0 8px ${color}80);"></ha-icon>
                <div style="font-size: 9px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1;">NAS</div>
              `;
            ]]]
          droite: |
            [[[
              const s = (entity.state || '').toLowerCase();
              const status = s === 'good' ? 'OK' : 'ERROR';
              return `
                <div style="font-size: 12px; font-weight: 800; color: white; text-transform: uppercase; line-height: 1.1;">${status}</div>
              `;
            ]]]
      - type: custom:button-card
        entity: weather.home
        show_name: false
        show_icon: false
        show_state: false
        tap_action:
          action: more-info
        styles:
          card:
            - padding: 0
            - border-radius: 12px
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(10px)
            - '-webkit-backdrop-filter': blur(10px)
            - transition: all 0.3s ease
            - border: 1px solid rgba(0, 191, 255, 0.4)
            - box-shadow: 0 4px 15px rgba(0, 191, 255, 0.2)
            - height: 38px
            - overflow: hidden
          grid:
            - grid-template-areas: '"gauche droite"'
            - grid-template-columns: 1fr auto
            - grid-template-rows: 38px
            - width: 100%
          custom_fields:
            gauche:
              - justify-self: stretch
              - align-self: stretch
              - padding-left: 8px
              - display: flex
              - align-items: center
              - justify-content: flex-start
              - gap: 6px
            droite:
              - justify-self: end
              - align-self: stretch
              - padding-right: 12px
              - padding-left: 10px
              - display: flex
              - align-items: center
              - border-left: 1px solid rgba(255,255,255,0.1)
        custom_fields:
          gauche: |
            [[[
              const state = entity.state;
              const map = {
                'sunny': 'mdi:weather-sunny', 'clear-night': 'mdi:weather-night',
                'cloudy': 'mdi:weather-cloudy', 'fog': 'mdi:weather-fog',
                'hail': 'mdi:weather-hail', 'lightning': 'mdi:weather-lightning',
                'lightning-rain': 'mdi:weather-lightning-rainy', 'partlycloudy': 'mdi:weather-partly-cloudy',
                'pouring': 'mdi:weather-pouring', 'rainy': 'mdi:weather-rainy',
                'snowy': 'mdi:weather-snowy', 'snowy-rainy': 'mdi:weather-snowy-rainy',
                'windy': 'mdi:weather-windy', 'windy-variant': 'mdi:weather-windy-variant'
              };
              const icon = map[state] || 'mdi:weather-cloudy';
              const color = "#00BFFF";
              return `
                <ha-icon icon="${icon}" style="display: flex; width: 18px; height: 18px; color: ${color}; filter: drop-shadow(0 0 8px ${color}80);"></ha-icon>
                <div style="font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 0.8px; line-height: 1;">Météo</div>
              `;
            ]]]
          droite: |
            [[[
              const temp = Math.round(entity.attributes.temperature || 0);
              return `
                <div style="font-size: 14px; font-weight: 900; color: white; text-transform: uppercase; line-height: 1.1;">${temp}°C</div>
              `;
            ]]]
    cards: []
    background:
      opacity: 100
      alignment: center
      size: cover
      repeat: repeat
      attachment: fixed
      image:
        media_content_id: media-source://image_upload/82e8e3a09e04704da00cac974571463f
        media_content_type: image/png
        metadata:
          title: dark_geometric_neon_bg_1770561686423 2.png
          thumbnail: /api/image/serve/82e8e3a09e04704da00cac974571463f/256x256
          media_class: image
          navigateIds:
            - {}
            - media_content_type: app
              media_content_id: media-source://image_upload
    visible:
      - user: 5ee57ea8e4174d67b0a97686fe4437b5
      - user: 49a98c3aa3c44399a03d32437dca04ba
      - user: ae15429d8056449699d5e3e93e21e2c9
      - user: b1c2a32f85334df2ab8e8d5b2299575c
      - user: 76dc484362274cbbb06167991e4e596b
  - type: sections
    title: Lumières
    path: lumieres
    theme: noctis
    sections:
      - type: grid
        cards:
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:button-card
                name: Accueil
                icon: mdi:home
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/dashboard
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#00FF00'
                    - filter: drop-shadow(0 0 8px rgba(0, 255, 0, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Températures
                icon: mdi:home-thermometer-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/temperatures-et-consommations
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#FA007D'
                    - filter: drop-shadow(0 0 8px rgba(250, 0, 125, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Energies
                icon: mdi:home-lightning-bolt-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/energies
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#0080ff'
                    - filter: drop-shadow(0 0 8px rgba(0, 128, 255, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
          - type: vertical-stack
            cards:
              - type: custom:mushroom-light-card
                entity: light.lumieres_maison
                name: Toute la Maison
                icon: mdi:home-lightbulb
                fill_container: true
                layout: vertical
                use_light_color: true
                card_mod:
                  style: |
                    ha-card {
                      background: rgba(20, 27, 38, 0.6) !important;
                      backdrop-filter: blur(10px);
                      -webkit-backdrop-filter: blur(10px);
                      border-radius: 20px !important;
                      border: 1px solid {{ 'rgba(255, 0, 0, 0.6)' if is_state('light.lumieres_maison', 'on') else 'rgba(255, 255, 255, 0.1)' }} !important;
                      box-shadow: {{ '0 0 20px rgba(255, 0, 0, 0.3)' if is_state('light.lumieres_maison', 'on') else '0 4px 15px rgba(0,0,0,0.2)' }} !important;
                      padding: 1px !important;
                      transition: all 0.3s ease-in-out;
                    }
              - type: conditional
                conditions:
                  - condition: state
                    entity: light.lumieres_maison
                    state: 'on'
                card:
                  type: custom:auto-entities
                  show_empty: false
                  unique: true
                  card:
                    type: grid
                    columns: 3
                    square: false
                    card_mod:
                      style: |
                        ha-card {
                          background: none;
                          box-shadow: none;
                          border: none;
                          padding: 0 !important;
                          margin-top: 10px !important;
                        }
                  card_param: cards
                  filter:
                    include:
                      - group: light.lumieres_maison
                        state: 'on'
                        options:
                          type: custom:mushroom-light-card
                          use_light_color: true
                          show_brightness_control: false
                          show_color_temp_control: false
                          show_color_control: false
                          card_mod:
                            style: |
                              ha-card {
                                background: rgba(20, 27, 38, 0.6) !important;
                                backdrop-filter: blur(10px);
                                -webkit-backdrop-filter: blur(10px);
                                border-radius: 15px !important;
                                border: 1px solid rgba(255, 0, 0, 0.4) !important;
                                box-shadow: 0 0 10px rgba(255, 0, 0, 0.2) !important;
                                transition: all 0.3s ease-in-out;
                              }
                    exclude:
                      - entity_id: light.lumieres_maison
          - type: custom:bubble-card
            card_type: button
            button_type: slider
            entity: light.bar
            min_value: 10
            max_value: 100
            step: 10
            sub_button:
              main:
                - entity: light.bar
                  show_name: false
                  show_state: true
                  show_icon: false
                  tap_action:
                    action: toggle
              bottom: []
            styles: |
              ha-card {
                --bubble-main-background-color: transparent !important;
                --bubble-button-background-color: rgba(255,255,255,0.05) !important;
                --bubble-button-border-radius: 20px;
              }
              .bubble-button-slider {
                background: rgba(255,255,255,0.1) !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important; /* On enlève la bordure standard */
                }

                /* CRÉATION DE LA BORDURE DÉGRADÉE EN PSEUDO-ÉLÉMENT */
                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px; /* Épaisseur de la bordure */
                  
                  /* LE DÉGRADÉ : Orange vers Transparent si OFF, Gris si ON */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #FFB03B 0%, rgba(255, 75, 43, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  /* MAGIE DU MASQUAGE : On ne garde que la bordure, on vide l'intérieur */
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: tile
            entity: light.smart_rgb_bulb_2402268250114452050348e1e9ed8d15
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2402266566692052050348e1e9ed79eb
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2401021328074052050248e1e9e8daa6
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2401021551861452050248e1e9e8d8fb
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2401026885944952050248e1e9e8dccb
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2401023753523452050248e1e9e8dca9
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_pro_led_strip_23122886861017560f0448e1e9e89f81
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.meross_mss710r_3de1_outlet
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
      - type: grid
        cards:
          - type: custom:bubble-card
            card_type: button
            button_type: slider
            entity: light.salon
            min_value: 10
            max_value: 100
            step: 10
            sub_button:
              main:
                - entity: light.salon
                  show_name: false
                  show_state: true
                  show_icon: false
                  tap_action:
                    action: toggle
              bottom: []
            styles: |
              ha-card {
                --bubble-main-background-color: transparent !important;
                --bubble-button-background-color: rgba(255,255,255,0.05) !important;
                --bubble-button-border-radius: 20px;
              }
              .bubble-button-slider {
                background: rgba(255,255,255,0.1) !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important; /* On enlève la bordure standard */
                }

                /* CRÉATION DE LA BORDURE DÉGRADÉE EN PSEUDO-ÉLÉMENT */
                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px; /* Épaisseur de la bordure */
                  
                  /* LE DÉGRADÉ : Orange vers Transparent si OFF, Gris si ON */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #FFB03B 0%, rgba(255, 75, 43, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  /* MAGIE DU MASQUAGE : On ne garde que la bordure, on vide l'intérieur */
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: tile
            entity: light.smart_rgb_bulb_2306298368487752050548e1e9ccae7f
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2306295441699552050548e1e9ccaa5b
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2306292288660752050548e1e9cc98ed
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2306296173098452050548e1e9ccb62d
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_light_2303300800116959010148e1e9c297f8
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: custom:bubble-card
            card_type: separator
            name: Chambre
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(255,110,0,1) 0%, rgba(255,255,255,0.5) 50%, rgba(255,110,0,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #FF6E00 !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important; /* On enlève la bordure standard */
                }

                /* CRÉATION DE LA BORDURE DÉGRADÉE EN PSEUDO-ÉLÉMENT */
                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px; /* Épaisseur de la bordure */
                  
                  /* LE DÉGRADÉ : Orange vers Transparent si OFF, Gris si ON */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #FFB03B 0%, rgba(255, 75, 43, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  /* MAGIE DU MASQUAGE : On ne garde que la bordure, on vide l'intérieur */
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: tile
            entity: light.smart_rgb_bulb_2401027557586952050248e1e9e8d7b3
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2401025627387752050248e1e9e8d373
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.smart_rgb_bulb_2401024478806852050248e1e9e8f152
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: custom:bubble-card
            card_type: separator
            name: Chambre User 5
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(255,110,0,1) 0%, rgba(255,255,255,0.5) 50%, rgba(255,110,0,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #FF6E00 !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important; /* On enlève la bordure standard */
                }

                /* CRÉATION DE LA BORDURE DÉGRADÉE EN PSEUDO-ÉLÉMENT */
                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px; /* Épaisseur de la bordure */
                  
                  /* LE DÉGRADÉ : Orange vers Transparent si OFF, Gris si ON */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #FFB03B 0%, rgba(255, 75, 43, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  /* MAGIE DU MASQUAGE : On ne garde que la bordure, on vide l'intérieur */
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: tile
            entity: light.lumieres_morgan_z
            name: User 5
            icon: mdi:led-strip-variant
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: custom:bubble-card
            card_type: separator
            name: Chambre User 3
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(255,110,0,1) 0%, rgba(255,255,255,0.5) 50%, rgba(255,110,0,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #FF6E00 !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important; /* On enlève la bordure standard */
                }

                /* CRÉATION DE LA BORDURE DÉGRADÉE EN PSEUDO-ÉLÉMENT */
                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px; /* Épaisseur de la bordure */
                  
                  /* LE DÉGRADÉ : Orange vers Transparent si OFF, Gris si ON */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #FFB03B 0%, rgba(255, 75, 43, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  /* MAGIE DU MASQUAGE : On ne garde que la bordure, on vide l'intérieur */
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: tile
            entity: light.smart_rgb_pro_led_strip_24060640872589560f01c4e7ae04b91f
            vertical: false
            features_position: inline
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: custom:bubble-card
            card_type: separator
            name: Chambre Lison
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(255,110,0,1) 0%, rgba(255,255,255,0.5) 50%, rgba(255,110,0,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #FF6E00 !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important; /* On enlève la bordure standard */
                }

                /* CRÉATION DE LA BORDURE DÉGRADÉE EN PSEUDO-ÉLÉMENT */
                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px; /* Épaisseur de la bordure */
                  
                  /* LE DÉGRADÉ : Orange vers Transparent si OFF, Gris si ON */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #FFB03B 0%, rgba(255, 75, 43, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  /* MAGIE DU MASQUAGE : On ne garde que la bordure, on vide l'intérieur */
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: tile
            entity: light.smart_rgb_bulb_2401023613738552050248e1e9e8e94e
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
      - type: grid
        cards:
          - type: custom:bubble-card
            card_type: separator
            name: Bureau
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(255,110,0,1) 0%, rgba(255,255,255,0.5) 50%, rgba(255,110,0,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #FF6E00 !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important; /* On enlève la bordure standard */
                }

                /* CRÉATION DE LA BORDURE DÉGRADÉE EN PSEUDO-ÉLÉMENT */
                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px; /* Épaisseur de la bordure */
                  
                  /* LE DÉGRADÉ : Orange vers Transparent si OFF, Gris si ON */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #FFB03B 0%, rgba(255, 75, 43, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  /* MAGIE DU MASQUAGE : On ne garde que la bordure, on vide l'intérieur */
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: tile
            entity: light.bureaux
            name: Lumière Bureau
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: custom:bubble-card
            card_type: separator
            name: Cuisine & Toilettes
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(255,110,0,1) 0%, rgba(255,255,255,0.5) 50%, rgba(255,110,0,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #FF6E00 !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important; /* On enlève la bordure standard */
                }

                /* CRÉATION DE LA BORDURE DÉGRADÉE EN PSEUDO-ÉLÉMENT */
                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px; /* Épaisseur de la bordure */
                  
                  /* LE DÉGRADÉ : Orange vers Transparent si OFF, Gris si ON */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #FFB03B 0%, rgba(255, 75, 43, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  /* MAGIE DU MASQUAGE : On ne garde que la bordure, on vide l'intérieur */
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: tile
            entity: light.interrupteur_cuisine
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: light.interrupteur_toilette
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: custom:bubble-card
            card_type: separator
            name: Salles de bain
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(255,110,0,1) 0%, rgba(255,255,255,0.5) 50%, rgba(255,110,0,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #FF6E00 !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important; /* On enlève la bordure standard */
                }

                /* CRÉATION DE LA BORDURE DÉGRADÉE EN PSEUDO-ÉLÉMENT */
                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px; /* Épaisseur de la bordure */
                  
                  /* LE DÉGRADÉ : Orange vers Transparent si OFF, Gris si ON */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #FFB03B 0%, rgba(255, 75, 43, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  /* MAGIE DU MASQUAGE : On ne garde que la bordure, on vide l'intérieur */
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: tile
            entity: light.interrupteur_sdb_parents
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: tile
            entity: switch.sonoff_a4800fcf93
            vertical: false
            features_position: bottom
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }
          - type: grid
            columns: 5
            square: true
            cards:
              - type: custom:button-card
                entity: switch.smart_switch_2210204886342554060148e1e9ac3905_outlet_1
                icon: mdi:hair-dryer-outline
                show_name: false
                styles:
                  card:
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                  icon:
                    - color: |
                        [[[
                          if (entity.state === 'on') return '#00AAFF';
                          return 'rgba(255,255,255,0.5)';
                        ]]]
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: switch.smart_switch_2210204886342554060148e1e9ac3905_outlet_2
                icon: mdi:power-socket-eu
                show_name: false
                styles:
                  card:
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                  icon:
                    - color: |
                        [[[
                          if (entity.state === 'on') return '#00AAFF';
                          return 'rgba(255,255,255,0.5)';
                        ]]]
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: switch.smart_switch_2210204886342554060148e1e9ac3905_outlet_3
                icon: mdi:power-socket-eu
                show_name: false
                styles:
                  card:
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                  icon:
                    - color: |
                        [[[
                          if (entity.state === 'on') return '#00AAFF';
                          return 'rgba(255,255,255,0.5)';
                        ]]]
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: switch.smart_switch_2210204886342554060148e1e9ac3905_outlet_4
                icon: mdi:content-cut
                show_name: false
                styles:
                  card:
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                  icon:
                    - color: |
                        [[[
                          if (entity.state === 'on') return '#00AAFF';
                          return 'rgba(255,255,255,0.5)';
                        ]]]
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: switch.smart_switch_2210204886342554060148e1e9ac3905_outlet_5
                icon: mdi:usb
                show_name: false
                styles:
                  card:
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                  icon:
                    - color: |
                        [[[
                          if (entity.state === 'on') return '#00AAFF';
                          return 'rgba(255,255,255,0.5)';
                        ]]]
                tap_action:
                  action: toggle
      - type: grid
        cards: []
      - type: grid
        cards: []
    icon: mdi:home-lightbulb-outline
    cards: []
    header: {}
    subview: true
    background:
      opacity: 100
      alignment: center
      size: cover
      repeat: repeat
      attachment: fixed
      image:
        media_content_id: media-source://image_upload/1fbd1aa7312757fd7a69e5684e41c66e
        media_content_type: image/png
        metadata:
          title: dark_geometric_light_variation_bg_1770562182951.png
          thumbnail: /api/image/serve/1fbd1aa7312757fd7a69e5684e41c66e/256x256
          media_class: image
          navigateIds:
            - {}
            - media_content_type: app
              media_content_id: media-source://image_upload
    max_columns: 3
    visible:
      - user: 5ee57ea8e4174d67b0a97686fe4437b5
      - user: 49a98c3aa3c44399a03d32437dca04ba
      - user: ae15429d8056449699d5e3e93e21e2c9
      - user: b1c2a32f85334df2ab8e8d5b2299575c
      - user: 76dc484362274cbbb06167991e4e596b
  - type: sections
    max_columns: 3
    title: Températures et consommations
    path: temperatures-et-consommations
    icon: mdi:home-thermometer-outline
    theme: noctis
    sections:
      - type: grid
        cards:
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:button-card
                name: Accueil
                icon: mdi:home
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/dashboard
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#00FF00'
                    - filter: drop-shadow(0 0 8px rgba(0, 255, 0, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Lumières
                icon: mdi:home-lightbulb-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/lumieres
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#ffd54a'
                    - filter: drop-shadow(0 0 8px rgba(255, 213, 74, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Energies
                icon: mdi:home-lightning-bolt-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/energies
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#0080ff'
                    - filter: drop-shadow(0 0 8px rgba(0, 128, 255, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
          - type: custom:bubble-card
            card_type: separator
            name: Maison
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(0,170,255,1) 0%, rgba(255,255,255,0.5) 50%, rgba(0,170,255,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #00AAFF !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important;
                }

                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px;
                  
                  /* CHANGEMENT : DE BLEU VERS TRANSPARENT */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #00AAFF 0%, rgba(0, 170, 255, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: climate.hp_actuator_thermostat
                name: Pompe à Chaleur
                show_state: true
                show_icon: false
                aspect_ratio: 16/9
                styles:
                  card:
                    - padding: 0
                    - border-radius: 24px
                    - border: |
                        [[[
                          const heating = states['binary_sensor.dhwp_actuator_energy_demand_status']?.state === 'on';
                          return heating ? '1px solid rgba(255, 165, 0, 0.5)' : '1px solid rgba(255,255,255,0.1)';
                        ]]]
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(20px)
                    - '-webkit-backdrop-filter': blur(20px)
                    - box-shadow: |
                        [[[
                          const heating = states['binary_sensor.dhwp_actuator_energy_demand_status']?.state === 'on';
                          return heating 
                            ? '0 0 20px rgba(255, 165, 0, 0.3), 0 8px 32px rgba(0,0,0,0.3)' 
                            : '0 8px 32px rgba(0,0,0,0.3)';
                        ]]]
                    - overflow: hidden
                    - min-height: 220px
                    - transition: all 0.5s ease
                  name:
                    - position: absolute
                    - z-index: 2
                    - top: 12px
                    - left: 0
                    - right: 0
                    - text-align: center
                    - font-size: 16px
                    - font-weight: 700
                    - letter-spacing: 0.5px
                    - color: white
                    - text-shadow: 0 2px 4px rgba(0,0,0,0.8)
                  state:
                    - position: absolute
                    - z-index: 2
                    - top: 34px
                    - left: 0
                    - right: 0
                    - text-align: center
                    - font-size: 13px
                    - opacity: 0.8
                    - font-weight: 500
                    - color: rgba(255,255,255,0.9)
                    - text-shadow: 0 2px 4px rgba(0,0,0,0.8)
                  custom_fields:
                    bg:
                      - position: absolute
                      - inset: 0
                      - z-index: 0
                      - opacity: 0.9
                      - pointer-events: none
                    overlay:
                      - position: absolute
                      - inset: 0
                      - z-index: 1
                      - background: >-
                          linear-gradient(to bottom, rgba(0,0,0,0.6) 0%,
                          rgba(0,0,0,0) 30%, rgba(0,0,0,0) 70%, rgba(0,0,0,0.8)
                          100%)
                      - pointer-events: none
                    gauge_pac:
                      - position: absolute
                      - z-index: 3
                      - left: 16px
                      - top: 60px
                      - bottom: 40px
                      - width: 14px
                      - border-radius: 10px
                      - background: rgba(0,0,0,0.3)
                      - border: 1px solid rgba(255,255,255,0.1)
                      - box-shadow: 0 4px 10px rgba(0,0,0,0.3)
                    gauge_ext:
                      - position: absolute
                      - z-index: 3
                      - right: 16px
                      - top: 60px
                      - bottom: 40px
                      - width: 14px
                      - border-radius: 10px
                      - background: rgba(0,0,0,0.3)
                      - border: 1px solid rgba(255,255,255,0.1)
                      - box-shadow: 0 4px 10px rgba(0,0,0,0.3)
                    ext_label:
                      - position: absolute
                      - z-index: 4
                      - right: 16px
                      - bottom: 20px
                      - font-size: 11px
                      - font-weight: 600
                      - color: rgba(255,255,255,0.8)
                      - text-shadow: 0 1px 2px rgba(0,0,0,0.8)
                      - text-align: center
                      - width: 40px
                      - margin-right: '-13px'
                    temp:
                      - position: absolute
                      - z-index: 4
                      - left: 50%
                      - bottom: 35px
                      - transform: translateX(-50%)
                      - font-size: 28px
                      - font-weight: 800
                      - color: white
                      - text-shadow: 0 4px 12px rgba(0,0,0,0.5)
                      - letter-spacing: '-0.5px'
                    consigne_inline:
                      - position: absolute
                      - z-index: 4
                      - left: 50%
                      - bottom: 15px
                      - transform: translateX(-50%)
                      - font-size: 12px
                      - font-weight: 600
                      - color: rgba(255,255,255,0.7)
                      - background: rgba(0,0,0,0.3)
                      - padding: 2px 8px
                      - border-radius: 10px
                      - border: 1px solid rgba(255,255,255,0.05)
                custom_fields:
                  overlay: ''
                  bg: |
                    [[[
                      const demand = states['binary_sensor.dhwp_actuator_energy_demand_status'];
                      const heating = demand?.state === 'on';
                      const bust = (demand?.last_changed || Date.now()).toString().replace(/\D/g,'');
                      const src = heating
                        ? `/local/pac_atlantic_heating_16_9_nostretch2.png?v=${bust}`
                        : `/local/pac_atlantic_idle_16_9_nostretch.png?v=${bust}`;
                      const zoom = heating ? 1.4 : 1.6;
                      const anim = heating ? 'animation: pulse_img_anim 1.2s infinite alternate ease-in-out;' : '';
                      return `
                        <style>
                          @keyframes pulse_img_anim {
                            0% { opacity: 0.35; filter: brightness(0.85); }
                            100% { opacity: 1; filter: brightness(1.15); }
                          }
                        </style>
                        <div style="
                          width:100%; height:100%;
                          background: url('${src}') center/contain no-repeat;
                          transform: scale(${zoom});
                          transform-origin: center;
                          transition: transform 0.5s ease;
                          ${anim}
                        "></div>
                      `;
                    ]]]
                  temp: |
                    [[[
                      var s = states['sensor.hp_actuator_io_5470820_9_temperature'];
                      var tRaw = s ? s.state : '—';
                      var t = parseFloat(tRaw.toString().replace(',', '.'));
                      return (isFinite(t) ? t.toFixed(1) : '—') + '°';
                    ]]]
                  consigne_inline: |
                    [[[
                      var sRaw = entity && entity.attributes && entity.attributes.temperature ? entity.attributes.temperature : '—';
                      var s = parseFloat(sRaw.toString().replace(',', '.'));
                      return 'Cible ' + (isFinite(s) ? s.toFixed(0) : '—') + '°';
                    ]]]
                  ext_label: |
                    [[[
                      var s = states['sensor.hp_actuator_io_5470820_3_temperature'];
                      var eRaw = s ? s.state : '—';
                      var e = parseFloat(eRaw.toString().replace(',', '.'));
                      return 'Ext\n' + (isFinite(e) ? e.toFixed(1) : '—') + '°';
                    ]]]
                  gauge_pac: |
                    [[[
                      var s = states['sensor.hp_actuator_io_5470820_9_temperature'];
                      var tRaw = s ? s.state : '—';
                      var t = parseFloat(tRaw.toString().replace(',', '.'));
                      var min = -10, max = 38;
                      var safeT = isFinite(t) ? t : min;
                      var pct = Math.max(0, Math.min(100, ((safeT - min) / (max - min)) * 100));
                      var color = 'rgba(255,255,255,0.9)';
                      if (safeT <= 7) color = '#78EBFF';
                      else if (safeT < 19) color = '#008CFF';
                      else if (safeT <= 25) color = '#46D278';
                      else if (safeT <= 31) color = '#FFDC78';
                      else color = '#DC5050';
                      return '<div style="width:100%; height:100%; position:relative; border-radius:10px; overflow:hidden;"><div style="position:absolute; bottom:0; left:0; right:0; height:' + pct + '%; background:' + color + '; transition: all 1s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 0 10px ' + color + ';"></div></div>';
                    ]]]
                  gauge_ext: |
                    [[[
                      var s = states['sensor.hp_actuator_io_5470820_3_temperature'];
                      var eRaw = s ? s.state : '—';
                      var e = parseFloat(eRaw.toString().replace(',', '.'));
                      var min = -10, max = 38;
                      var safeT = isFinite(e) ? e : min;
                      var pct = Math.max(0, Math.min(100, ((safeT - min) / (max - min)) * 100));
                      var color = '#ffffff';
                      if (safeT <= 5) color = '#78EBFF';
                      else if (safeT <= 15) color = '#008CFF';
                      else if (safeT <= 25) color = '#46D278';
                      else if (safeT <= 30) color = '#FFDC78';
                      else color = '#DC5050';
                      return '<div style="width:100%; height:100%; position:relative; border-radius:10px; overflow:hidden;"><div style="position:absolute; bottom:0; left:0; right:0; height:' + pct + '%; background:' + color + '; transition: all 1s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 0 10px ' + color + ';"></div></div>';
                    ]]]
                extra_styles: |
                  @keyframes pulse_img_anim {
                    0% { opacity: 0.4; filter: brightness(0.8); }
                    100% { opacity: 1; filter: brightness(1.2); }
                  }
              - type: custom:button-card
                entity: water_heater.temperature_ballon
                name: Ballon Thermor
                show_state: true
                show_icon: false
                styles:
                  card:
                    - padding: 0
                    - border-radius: 24px
                    - border: |
                        [[[
                          const heating = states['binary_sensor.dhwp_actuator_energy_demand_status']?.state === 'on';
                          return heating ? '1px solid rgba(255, 165, 0, 0.5)' : '1px solid rgba(255,255,255,0.1)';
                        ]]]
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(20px)
                    - '-webkit-backdrop-filter': blur(20px)
                    - box-shadow: |
                        [[[
                          const heating = states['binary_sensor.dhwp_actuator_energy_demand_status']?.state === 'on';
                          return heating 
                            ? '0 0 20px rgba(255, 165, 0, 0.3), 0 8px 32px rgba(0,0,0,0.3)' 
                            : '0 8px 32px rgba(0,0,0,0.3)';
                        ]]]
                    - overflow: hidden
                    - min-height: 220px
                    - transition: all 0.5s ease
                  name:
                    - position: absolute
                    - z-index: 2
                    - top: 12px
                    - left: 0
                    - right: 0
                    - text-align: center
                    - font-size: 16px
                    - font-weight: 700
                    - letter-spacing: 0.5px
                    - color: white
                    - text-shadow: 0 2px 4px rgba(0,0,0,0.8)
                  state:
                    - position: absolute
                    - z-index: 2
                    - top: 34px
                    - left: 0
                    - right: 0
                    - text-align: center
                    - font-size: 13px
                    - opacity: 0.8
                    - font-weight: 500
                    - color: rgba(255,255,255,0.9)
                    - text-shadow: 0 2px 4px rgba(0,0,0,0.8)
                  custom_fields:
                    bg:
                      - position: absolute
                      - inset: 0
                      - z-index: 0
                      - animation: |
                          [[[
                            return (states['binary_sensor.dhwp_actuator_energy_demand_status']?.state === 'on')
                            ? 'pulse 1.5s infinite alternate ease-in-out'
                            : 'none';
                          ]]]
                    overlay:
                      - position: absolute
                      - inset: 0
                      - z-index: 1
                      - background: >-
                          linear-gradient(to bottom, rgba(0,0,0,0.6) 0%,
                          rgba(0,0,0,0) 30%, rgba(0,0,0,0) 70%, rgba(0,0,0,0.8)
                          100%)
                    gauge_temp_ballon:
                      - position: absolute
                      - z-index: 3
                      - left: 16px
                      - top: 60px
                      - bottom: 40px
                      - width: 14px
                      - border-radius: 10px
                      - background: rgba(0,0,0,0.3)
                      - border: 1px solid rgba(255,255,255,0.1)
                      - box-shadow: 0 4px 10px rgba(0,0,0,0.3)
                    gauge:
                      - position: absolute
                      - z-index: 3
                      - right: 16px
                      - top: 60px
                      - bottom: 40px
                      - width: auto
                      - display: flex
                      - gap: 4px
                      - align-items: flex-end
                    max_label:
                      - position: absolute
                      - z-index: 4
                      - right: 6px
                      - top: 56%
                      - transform: translateY(-50%) rotate(-90deg)
                      - font-size: 12px
                      - font-weight: 600
                      - color: rgba(255,255,255,0.6)
                      - text-align: center
                      - width: 80px
                      - opacity: 0.8
                    temp:
                      - position: absolute
                      - z-index: 4
                      - left: 50%
                      - bottom: 35px
                      - transform: translateX(-50%)
                      - font-size: 28px
                      - font-weight: 800
                      - color: white
                      - text-shadow: 0 4px 12px rgba(0,0,0,0.5)
                      - letter-spacing: '-0.5px'
                    conso_inline:
                      - position: absolute
                      - z-index: 4
                      - left: 50%
                      - bottom: 15px
                      - transform: translateX(-50%)
                      - font-size: 12px
                      - font-weight: 600
                      - color: rgba(255,255,255,0.7)
                      - background: rgba(0,0,0,0.4)
                      - padding: 2px 8px
                      - border-radius: 10px
                      - border: 1px solid rgba(255,255,255,0.05)
                custom_fields:
                  overlay: ''
                  bg: |
                    [[[
                      const heating = states['binary_sensor.dhwp_actuator_energy_demand_status']?.state === 'on';
                      const bust = (states['binary_sensor.dhwp_actuator_energy_demand_status']?.last_changed || Date.now()).toString().replace(/\D/g,'');
                      const src = heating 
                        ? `/local/ballon_thermore_200l_heating.png?v=${bust}` 
                        : `/local/ballon_thermore_200l.png?v=${bust}`;
                      const anim = heating ? 'animation: pulse_ballon 1.2s infinite alternate ease-in-out;' : '';
                      return `
                        <style>
                          @keyframes pulse_ballon {
                            0% { opacity: 0.35; filter: brightness(0.85); }
                            100% { opacity: 1; filter: brightness(1.15); }
                          }
                        </style>
                        <div style="
                          width:100%; height:100%;
                          background:url('${src}') center/contain no-repeat;
                          transform: scale(0.85);
                          transform-origin: center;
                          ${anim}
                        "></div>
                      `;
                    ]]]
                  temp: |
                    [[[
                      const tRaw = (entity?.attributes?.current_temperature ?? entity?.attributes?.temperature ?? '—').toString().replace(',', '.');
                      const t = parseFloat(tRaw);
                      return `${(isFinite(t) ? t.toFixed(1) : '—')}°`;
                    ]]]
                  conso_inline: |
                    [[[
                      const raw = (states['sensor.eau_chaude_du_jour_calculee']?.state ?? '0').toString().replace(',', '.');
                      const v = parseFloat(raw) || 0;
                      return `${v.toFixed(0)} L / jour`;
                    ]]]
                  max_label: |
                    [[[
                      const raw = (states['sensor.eau_chaude_du_jour_calculee']?.state ?? '0').toString().replace(',', '.');
                      const v = parseFloat(raw) || 0;
                      let max = 200;
                      let color = 'rgba(255,255,255,0.6)';
                      if (v >= 400) {
                        max = 600;
                        color = '#DC4646'; // Red
                      } else if (v >= 200) {
                        max = 400;
                        color = '#FFA500'; // Orange
                      }
                      return `<span style="color: ${color}; transition: color 0.5s ease;">Max ${max} L</span>`;
                    ]]]
                  gauge_temp_ballon: |
                    [[[
                      const tRaw = (entity?.attributes?.current_temperature ?? entity?.attributes?.temperature ?? '—').toString().replace(',', '.');
                      const t = parseFloat(tRaw);
                      const min = 20, max = 65;
                      const safeT = isFinite(t) ? t : min;
                      const pct = Math.max(0, Math.min(100, ((safeT - min) / (max - min)) * 100));
                      
                      let color = '#ffffff';
                      if (safeT <= 35) color = '#008CFF';
                      else if (safeT <= 45) color = '#FFD700';
                      else if (safeT <= 55) color = '#FF8C00';
                      else color = '#DC4646';
                      return `
                        <div style="width:100%; height:100%; position:relative; border-radius:10px; overflow:hidden;">
                          <div style="position:absolute; bottom:0; left:0; right:0; height:${pct}%; background:${color}; box-shadow: 0 0 12px ${color}; transition: all 1s ease;"></div>
                        </div>
                      `;
                    ]]]
                  gauge: |
                    [[[
                      const raw = (states['sensor.eau_chaude_du_jour_calculee']?.state ?? '0').toString().replace(',', '.');
                      let v = parseFloat(raw) || 0;
                      
                      let color = '#00B4FF'; // Default Blue
                      if (v >= 400) color = '#DC4646'; // Red
                      else if (v >= 200) color = '#FFA500'; // Orange
                      
                      const barStyle = (height) => `
                        width: 14px; 
                        height: 100%; 
                        position: relative; 
                        border-radius: 10px; 
                        background: rgba(0,0,0,0.3); 
                        border: 1px solid rgba(255,255,255,0.1);
                        overflow: hidden;
                      `;
                      
                      const innerStyle = (pct) => `
                        position: absolute; 
                        bottom: 0; left: 0; right: 0; 
                        height: ${pct}%; 
                        background: ${color}; 
                        box-shadow: 0 0 10px ${color}; 
                        transition: height 0.8s ease;
                      `;
                      
                      let gaugeOutput = '';
                      
                      // Jauge 1 (0-200)
                      let p1 = Math.max(0, Math.min(100, (v / 200) * 100));
                      gaugeOutput += `<div style="${barStyle()}"><div style="${innerStyle(p1)}"></div></div>`;
                      
                      // Jauge 2 (200-400)
                      if (v >= 200) {
                        let p2 = Math.max(0, Math.min(100, ((v - 200) / 200) * 100));
                        gaugeOutput += `<div style="${barStyle()}"><div style="${innerStyle(p2)}"></div></div>`;
                      }
                      
                      // Jauge 3 (400-600)
                      if (v >= 400) {
                        let p3 = Math.max(0, Math.min(100, ((v - 400) / 200) * 100));
                        gaugeOutput += `<div style="${barStyle()}"><div style="${innerStyle(p3)}"></div></div>`;
                      }
                      
                      return gaugeOutput;
                    ]]]
                extra_styles: |
                  @keyframes pulse {
                    0% { opacity: 0.3; }
                    100% { opacity: 1; }
                  }
          - type: custom:bubble-card
            card_type: separator
            name: Pièces de Vie
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(0,170,255,1) 0%, rgba(255,255,255,0.5) 50%, rgba(0,170,255,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #00AAFF !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important;
                }

                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px;
                  
                  /* CHANGEMENT : DE BLEU VERS TRANSPARENT */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #00AAFF 0%, rgba(0, 170, 255, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: custom:bubble-card
            card_type: climate
            name: 'Bar '
            entity: climate.smart_thermostat_valve_03009970
            sub_button:
              main:
                - show_name: false
                  show_state: false
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  entity: climate.smart_thermostat_valve_03009970
                  show_attribute: true
                  attribute: current_temperature
                  double_tap_action:
                    action: more-info
                  sub_button_type: select
                  show_icon: true
              bottom: []
            card_layout: normal
            modules: []
            show_attribute: false
            attribute: hvac_modes
            hide_temperature: false
            state_color: false
            styles: |
              ha-card {
                --bubble-climate-main-background-color: transparent !important;
                --bubble-climate-border-radius: 20px;
              }
              .bubble-climate-container {
                background: transparent !important;
              }
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:bubble-card
            card_type: button
            name: Salon
            button_type: state
            sub_button:
              main:
                - entity: sensor.smart_temp_humidity_sensor_39000e5bec0f_temperature
                  show_background: false
                  show_state: true
                - show_name: false
                  show_state: true
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  double_tap_action:
                    action: more-info
                  entity: sensor.smart_temp_humidity_sensor_39000e5bec0f_humidity
                  sub_button_type: select
              bottom: []
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-main-background-color: transparent !important;
                --bubble-button-background-color: transparent !important;
                --bubble-button-border-radius: 20px;
              }
            entity: sensor.smart_temp_humidity_sensor_39000e5bec0f_temperature
            show_state: false
            slider_fill_orientation: left
            slider_value_position: right
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
      - type: grid
        cards:
          - type: custom:bubble-card
            card_type: separator
            name: Chambres
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(0,170,255,1) 0%, rgba(255,255,255,0.5) 50%, rgba(0,170,255,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #00AAFF !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important;
                }

                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px;
                  
                  /* CHANGEMENT : DE BLEU VERS TRANSPARENT */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #00AAFF 0%, rgba(0, 170, 255, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: custom:bubble-card
            card_type: climate
            name: Chambre Parentale
            button_type: state
            entity: climate.smart_thermostat_valve_0300460e
            sub_button:
              main:
                - show_name: false
                  show_state: false
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  attribute: current_temperature
                  double_tap_action:
                    action: more-info
                  entity: climate.smart_thermostat_valve_0300460e
                  sub_button_type: select
              bottom: []
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-climate-main-background-color: transparent !important;
                --bubble-climate-border-radius: 20px;
              }
              .bubble-climate-container {
                background: transparent !important;
              }
            scrolling_effect: false
            show_name: true
            show_state: false
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:bubble-card
            card_type: button
            name: Chambre User 4
            button_type: state
            sub_button:
              main:
                - entity: sensor.smart_temp_humidity_sensor_39000e5be749_temperature
                  show_state: true
                  show_background: false
                  show_icon: true
                - show_name: false
                  show_state: true
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  double_tap_action:
                    action: more-info
                  entity: sensor.smart_temp_humidity_sensor_39000e5be749_humidity
                  sub_button_type: select
              bottom: []
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-main-background-color: transparent !important;
                --bubble-button-background-color: transparent !important;
                --bubble-button-border-radius: 20px;
              }
            entity: sensor.smart_temp_humidity_sensor_39000e5be749_temperature
            show_state: false
            scrolling_effect: false
            slider_fill_orientation: left
            slider_value_position: right
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:bubble-card
            card_type: button
            name: Chambre User 5
            button_type: state
            sub_button:
              main:
                - entity: sensor.smart_temp_humidity_sensor_39000e4fa9fc_temperature
                  show_background: false
                  show_state: true
                - show_name: false
                  show_state: true
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  double_tap_action:
                    action: more-info
                  entity: sensor.smart_temp_humidity_sensor_39000e4fa9fc_humidity
                  sub_button_type: select
              bottom: []
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-main-background-color: transparent !important;
                --bubble-button-background-color: transparent !important;
                --bubble-button-border-radius: 20px;
              }
            entity: sensor.smart_temp_humidity_sensor_39000e4fa9fc_temperature
            show_state: false
            scrolling_effect: false
            slider_fill_orientation: left
            slider_value_position: right
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:bubble-card
            card_type: climate
            name: Chambre User 3
            button_type: switch
            entity: climate.smart_thermostat_valve_03004482
            sub_button:
              main:
                - show_name: false
                  show_state: false
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  attribute: current_temperature
                  double_tap_action:
                    action: more-info
                  entity: climate.smart_thermostat_valve_03004482
                  sub_button_type: select
              bottom: []
            card_layout: normal
            modules: []
            force_icon: false
            show_state: false
            show_attribute: false
            attribute: supported_features
            scrolling_effect: false
            styles: |
              ha-card {
                --bubble-climate-main-background-color: transparent !important;
                --bubble-climate-border-radius: 20px;
              }
              .bubble-climate-container {
                background: transparent !important;
              }
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:bubble-card
            card_type: climate
            name: Chambre Lison
            styles: |
              ha-card {
                --bubble-climate-main-background-color: transparent !important;
                --bubble-climate-border-radius: 20px;
              }
              .bubble-climate-container {
                background: transparent !important;
              }
            sub_button:
              main:
                - show_icon: true
                  show_attribute: false
                  attribute: unit_of_measurement
                  show_state: true
                  state_background: false
                  entity: binary_sensor.fenetre_lison_contact
                - show_name: false
                  show_state: false
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  entity: climate.smart_thermostat_valve_0300d436
                  show_attribute: true
                  attribute: current_temperature
                  double_tap_action:
                    action: more-info
                  sub_button_type: select
              bottom: []
            card_layout: large-2-rows
            modules: []
            show_attribute: false
            attribute: hvac_modes
            hide_temperature: false
            state_color: false
            entity: climate.smart_thermostat_valve_0300d436
            scrolling_effect: false
            show_icon: true
            rows: 1.125
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            card_mod:
              style: |
                ha-card {
                  /* Style de Base (Glassmorphism) */
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(20px) !important;
                  -webkit-backdrop-filter: blur(20px) !important;
                  border-radius: 20px !important;
                  overflow: hidden !important;
                  transition: box-shadow 0.5s ease-in-out, border 0.5s ease-in-out;
                  
                  /* LOGIQUE DYNAMIQUE DU HALO (Chauffage actif) */
                  {% if is_state_attr('climate.smart_socket_thermostat_24092307359107600802c4e7ae0be3df', 'hvac_action', 'heating') %}
                    /* Halo Orange Vif quand ca chauffe 🔥 */
                    border: 1px solid rgba(255, 69, 0, 0.6) !important;
                    box-shadow: 0 0 25px rgba(255, 69, 0, 0.4), 0 8px 32px rgba(0,0,0,0.3) !important;
                  {% else %}
                    /* Style Normal (Verre) */
                    border: 1px solid rgba(255,255,255,0.1) !important;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
                  {% endif %}
                }
            cards:
              - type: custom:button-card
                name: Chauffage d'Appoint Lison
                icon: mdi:radiator
                styles:
                  card:
                    - background: transparent
                    - border: none
                    - padding: 16px
                  grid:
                    - grid-template-areas: '"i n t" "i s t"'
                    - grid-template-columns: 50px 1fr auto
                  icon:
                    - width: 32px
                    - color: |
                        [[[ 
                          if (states['binary_sensor.fenetre_lison_contact'].state == 'on') return '#FF0000'; 
                          var action = states['climate.smart_socket_thermostat_24092307359107600802c4e7ae0be3df'].attributes.hvac_action;
                          if (action == 'heating') return '#FF4500';
                          var temp = states['climate.smart_socket_thermostat_24092307359107600802c4e7ae0be3df'].attributes.temperature;
                          return (temp == 22) ? '#00D2FF' : 'rgba(255,255,255,0.4)';
                        ]]]
                  name:
                    - justify-self: start
                    - font-size: 15px
                    - font-weight: 700
                    - color: rgba(255,255,255,0.9)
                  custom_fields:
                    s:
                      - justify-self: start
                      - font-size: 11px
                      - font-weight: 500
                      - color: |
                          [[[ 
                            if (states['binary_sensor.fenetre_lison_contact'].state == 'on') return '#FF0000';
                            var action = states['climate.smart_socket_thermostat_24092307359107600802c4e7ae0be3df'].attributes.hvac_action;
                            if (action == 'heating') return '#FF4500';
                            var temp = states['climate.smart_socket_thermostat_24092307359107600802c4e7ae0be3df'].attributes.temperature;
                            return (temp == 22) ? '#00D2FF' : 'rgba(255,255,255,0.4)';
                          ]]]
                    t:
                      - justify-self: end
                      - font-size: 24px
                      - font-weight: 900
                      - color: rgba(255,255,255,0.9)
                      - margin-top: '-4px'
                custom_fields:
                  s: |
                    [[[ 
                      if (states['binary_sensor.fenetre_lison_contact'].state == 'on') return "🪟 FENÊTRE OUVERTE (STOP)";
                      var action = states['climate.smart_socket_thermostat_24092307359107600802c4e7ae0be3df'].attributes.hvac_action;
                      var temp = states['climate.smart_socket_thermostat_24092307359107600802c4e7ae0be3df'].attributes.temperature;
                      
                      if (action == 'heating') return "🔥 CHAUFFE EN COURS";
                      if (temp == 22) return "⌛ PRÊT (Consigne 22°C)";
                      return "💤 REPOS (ECO)";
                    ]]]
                  t: |
                    [[[
                      var cur = states['climate.smart_socket_thermostat_24092307359107600802c4e7ae0be3df'].attributes.current_temperature;
                      return cur ? cur + "°" : "--°";
                    ]]]
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    entity: input_boolean.lison_heater_force_manual
                    name: Forçage Manu
                    icon: mdi:hand-back-right
                    show_state: false
                    styles:
                      card:
                        - height: 90px
                        - background: >
                            [[[ return entity.state === 'on' ? 'rgba(255, 187,
                            0, 0.15)' : 'transparent' ]]]
                        - border-radius: 0
                        - border: none
                        - border-right: 1px solid rgba(255,255,255,0.05)
                      icon:
                        - color: >
                            [[[ return entity.state === 'on' ? '#FFBB00' :
                            'rgba(255,255,255,0.3)' ]]]
                      name:
                        - font-size: 12px
                        - font-weight: 600
                        - color: rgba(255,255,255,0.6)
                  - type: custom:button-card
                    entity: input_boolean.lison_heater_force_schedule
                    name: Planning
                    icon: mdi:calendar-clock
                    show_state: false
                    styles:
                      card:
                        - height: 90px
                        - background: >
                            [[[ return entity.state === 'on' ? 'rgba(0, 210,
                            255, 0.15)' : 'transparent' ]]]
                        - border-radius: 0
                        - border: none
                      icon:
                        - color: >
                            [[[ return entity.state === 'on' ? '#00D2FF' :
                            'rgba(255,255,255,0.3)' ]]]
                      name:
                        - font-size: 12px
                        - font-weight: 600
                        - color: rgba(255,255,255,0.6)
              - type: conditional
                conditions:
                  - entity: input_boolean.lison_heater_force_schedule
                    state: 'on'
                card:
                  type: entities
                  entities:
                    - entity: input_datetime.lison_heater_force_start
                      name: Début
                      icon: mdi:clock-start
                    - entity: input_datetime.lison_heater_force_end
                      name: Fin
                      icon: mdi:clock-end
                  card_mod:
                    style: |
                      ha-card {
                        background: rgba(0,0,0,0.2) !important;
                        border-radius: 0 !important;
                        border: none !important;
                        padding: 8px 0 !important;
                        margin: 0 !important;
                      }
                      .card-content {
                        padding: 0 16px !important;
                      }
                      :host {
                        --paper-item-icon-color: rgba(255,255,255,0.4);
                        --primary-text-color: rgba(255,255,255,0.8);
                      }
      - type: grid
        cards:
          - type: custom:bubble-card
            card_type: separator
            name: Salles de Bain
            card_layout: normal
            sub_button: []
            styles: |
              .bubble-line {
                background: linear-gradient(90deg, rgba(0,170,255,1) 0%, rgba(255,255,255,0.5) 50%, rgba(0,170,255,1) 100%) !important;
                opacity: 0.8 !important;
                height: 3px !important;
                border-radius: 2px !important;
              }
              .bubble-name {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: rgba(255,255,255,0.95) !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
              }
              .bubble-icon {
                color: #00AAFF !important;
              }
            slider_fill_orientation: left
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  margin-top: 8px;
                  position: relative;
                  border: none !important;
                }

                ha-card::before {
                  content: "";
                  position: absolute;
                  top: 0; left: 0; right: 0; bottom: 0;
                  border-radius: 20px;
                  padding: 1.5px;
                  
                  /* CHANGEMENT : DE BLEU VERS TRANSPARENT */
                  background: {% if is_state('light.bar', 'off') %} 
                                linear-gradient(90deg, #00AAFF 0%, rgba(0, 170, 255, 0) 90%) 
                              {% else %} 
                                rgba(255,255,255,0.1) 
                              {% endif %};
                  
                  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                  -webkit-mask-composite: xor;
                  mask-composite: exclude;
                  pointer-events: none;
                }
            slider_value_position: right
            light_slider_type: brightness
          - type: custom:bubble-card
            card_type: button
            name: Salle de Bain Parentale
            button_type: state
            sub_button:
              main:
                - entity: sensor.sonoff_acc8000899_temperature
                  show_background: false
                  show_state: true
                - show_name: false
                  show_state: true
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  double_tap_action:
                    action: more-info
                  entity: sensor.sonoff_acc8000899_humidity
                  sub_button_type: select
              bottom: []
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-main-background-color: transparent !important;
                --bubble-button-background-color: transparent !important;
                --bubble-button-border-radius: 20px;
              }
            show_state: false
            scrolling_effect: false
            entity: sensor.sonoff_acc8000899_temperature
            slider_fill_orientation: left
            slider_value_position: right
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:bubble-card
            card_type: button
            name: Salle de Bain Lison & User 3
            button_type: state
            sub_button:
              main:
                - entity: sensor.smart_temp_humidity_sensor_39000e5be9c8_temperature
                  show_background: false
                  show_state: true
                - show_name: false
                  show_state: true
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  double_tap_action:
                    action: more-info
                  entity: sensor.smart_temp_humidity_sensor_39000e5be9c8_humidity
                  sub_button_type: select
              bottom: []
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-main-background-color: transparent !important;
                --bubble-button-background-color: transparent !important;
                --bubble-button-border-radius: 20px;
              }
            show_state: false
            scrolling_effect: false
            entity: sensor.smart_temp_humidity_sensor_39000e5be9c8_temperature
            slider_fill_orientation: left
            slider_value_position: right
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:bubble-card
            card_type: button
            name: Salle de Bain User 4 & User 5
            button_type: state
            sub_button:
              main:
                - entity: sensor.sonoff_acc8001cf0_temperature
                  show_background: false
                  show_state: true
                - show_name: false
                  show_state: true
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  double_tap_action:
                    action: more-info
                  entity: sensor.sonoff_acc8001cf0_humidity
                  sub_button_type: select
              bottom: []
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-main-background-color: transparent !important;
                --bubble-button-background-color: transparent !important;
                --bubble-button-border-radius: 20px;
              }
            show_state: false
            scrolling_effect: false
            entity: sensor.sonoff_acc8001cf0_temperature
            slider_fill_orientation: left
            slider_value_position: right
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
    badges: []
    header: {}
    cards: []
    subview: true
    dense_section_placement: true
    background:
      opacity: 100
      alignment: center
      size: cover
      repeat: repeat
      attachment: fixed
      image:
        media_content_id: media-source://image_upload/e7a3df04050746194127db6a62708a1d
        media_content_type: image/png
        metadata:
          title: dark_geometric_temp_magenta_clean_bg_1770562789453.png
          thumbnail: /api/image/serve/e7a3df04050746194127db6a62708a1d/256x256
          media_class: image
          navigateIds:
            - {}
            - media_content_type: app
              media_content_id: media-source://image_upload
    visible:
      - user: 5ee57ea8e4174d67b0a97686fe4437b5
      - user: 49a98c3aa3c44399a03d32437dca04ba
      - user: ae15429d8056449699d5e3e93e21e2c9
      - user: b1c2a32f85334df2ab8e8d5b2299575c
      - user: 76dc484362274cbbb06167991e4e596b
  - type: sections
    max_columns: 3
    title: Energies
    path: energies
    icon: mdi:home-lightning-bolt-outline
    sections:
      - type: grid
        cards:
          - type: custom:button-card
            name: Menu
            icon: mdi:menu
            styles:
              card:
                - background: none
                - border: none
                - padding: 8px 15px
              grid:
                - grid-template-areas: '"i n"'
                - grid-template-columns: min-content 1fr
                - gap: 10px
              icon:
                - width: 24px
                - color: '#00D2FF'
                - filter: drop-shadow(0 0 5px rgba(0, 210, 255, 0.4))
              name:
                - justify-self: start
                - font-weight: 900
                - font-size: 15px
                - color: '#00D2FF'
                - text-transform: uppercase
                - letter-spacing: 1px
                - text-shadow: 0 0 10px rgba(0, 210, 255, 0.3)
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:button-card
                name: Accueil
                icon: mdi:home
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/dashboard
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#00FF00'
                    - filter: drop-shadow(0 0 8px rgba(0, 255, 0, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Lumières
                icon: mdi:home-lightbulb-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/lumieres
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#ffd54a'
                    - filter: drop-shadow(0 0 8px rgba(255, 213, 74, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Températures
                icon: mdi:home-thermometer-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/temperatures-et-consommations
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#FA007D'
                    - filter: drop-shadow(0 0 8px rgba(250, 0, 125, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
          - type: custom:button-card
            name: |
              [[[ 
                const date = new Date();
                const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const mois = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
                return 'Temps Réel - ' + jours[date.getDay()] + ' ' + date.getDate() + ' ' + mois[date.getMonth()];
              ]]]
            icon: mdi:calendar-clock
            styles:
              card:
                - background: none
                - border: none
                - padding: 8px 15px
              grid:
                - grid-template-areas: '"i n"'
                - grid-template-columns: min-content 1fr
                - gap: 10px
              icon:
                - width: 24px
                - color: '#FFB03B'
                - filter: drop-shadow(0 0 5px rgba(255, 176, 59, 0.4))
              name:
                - justify-self: start
                - font-weight: 900
                - font-size: 15px
                - color: '#FFB03B'
                - text-transform: uppercase
                - letter-spacing: 1px
                - text-shadow: 0 0 10px rgba(255, 176, 59, 0.3)
          - type: sensor
            entity: sensor.ecojoko_consommation_temps_reel
            name: Conso Temps Réel
            graph: line
            detail: 1
            card_mod:
              style: >
                /* 1. On force la variable de couleur partout */

                :host {
                  --accent-color: #A2F2FF !important;
                  --sensor-color: #A2F2FF !important;
                  --primary-color: #A2F2FF !important;
                }


                /* 2. On cible l'élément de graphique lui-même */

                .graph svg polyline {
                  stroke: #FFB400 !important;
                }

                .graph svg path {
                  fill: #FFB400 !important;
                  opacity: 0.15 !important;
                }

                /* 3. Vos styles de fond et flou */

                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }

                .header { padding: 16px 16px 0 16px !important; }

                .name { font-size: 14px !important; font-weight: 600 !important;
                color: rgba(255,255,255,0.8) !important; }

                .value { font-size: 24px !important; font-weight: 700
                !important; color: #FFFFFF !important; }

                .measurement { font-size: 14px !important; opacity: 0.6
                !important; }
            grid_options:
              columns: 12
              rows: 2
          - type: sensor
            entity: sensor.prise_congelateur_z_power
            name: Congélateur
            graph: line
            detail: 1
            card_mod:
              style: >
                /* 1. On force la variable de couleur partout */

                :host {
                  --accent-color: #00F260 !important;
                  --sensor-color: #00F260 !important;
                  --primary-color: #00F260 !important;
                }


                /* 2. On cible l'élément de graphique lui-même */

                .graph svg polyline {
                  stroke: #FFB400 !important;
                }

                .graph svg path {
                  fill: #FFB400 !important;
                  opacity: 0.15 !important;
                }

                /* 3. Vos styles de fond et flou */

                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }

                .header { padding: 16px 16px 0 16px !important; }

                .name { font-size: 14px !important; font-weight: 600 !important;
                color: rgba(255,255,255,0.8) !important; }

                .value { font-size: 24px !important; font-weight: 700
                !important; color: #FFFFFF !important; }

                .measurement { font-size: 14px !important; opacity: 0.6
                !important; }
          - graph: line
            type: sensor
            entity: sensor.prise_cuisine_power
            detail: 1
            name: Cookeo
            card_mod:
              style: >
                /* 1. On force la variable de couleur partout */

                :host {
                  --accent-color: #FFB400 !important;
                  --sensor-color: #FFB400 !important;
                  --primary-color: #FFB400 !important;
                }


                /* 2. On cible l'élément de graphique lui-même */

                .graph svg polyline {
                  stroke: #FFB400 !important;
                }

                .graph svg path {
                  fill: #FFB400 !important;
                  opacity: 0.15 !important;
                }


                /* 3. Vos styles de fond et flou */

                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }

                .header { padding: 16px 16px 0 16px !important; }

                .name { font-size: 14px !important; font-weight: 600 !important;
                color: rgba(255,255,255,0.8) !important; }

                .value { font-size: 24px !important; font-weight: 700
                !important; color: #FFFFFF !important; }

                .measurement { font-size: 14px !important; opacity: 0.6
                !important; }
          - graph: line
            type: sensor
            detail: 1
            entity: sensor.prise_machine_a_laver_z_power
            name: Lave Linge
            card_mod:
              style: >
                /* 1. On force la variable de couleur partout */

                :host {
                  --accent-color: #FF0080 !important;
                  --sensor-color: #FF0080 !important;
                  --primary-color: #FF0080 !important;
                }


                /* 2. On cible l'élément de graphique lui-même */

                .graph svg polyline {
                  stroke: #FFB400 !important;
                }

                .graph svg path {
                  fill: #FFB400 !important;
                  opacity: 0.15 !important;
                }

                /* 3. Vos styles de fond et flou */

                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }

                .header { padding: 16px 16px 0 16px !important; }

                .name { font-size: 14px !important; font-weight: 600 !important;
                color: rgba(255,255,255,0.8) !important; }

                .value { font-size: 24px !important; font-weight: 700
                !important; color: #FFFFFF !important; }

                .measurement { font-size: 14px !important; opacity: 0.6
                !important; }
          - type: sensor
            entity: sensor.prise_seche_linge_z_power
            name: Sèche Linge
            graph: line
            detail: 1
            card_mod:
              style: >
                /* 1. On force la variable de couleur partout */

                :host {
                  --accent-color: #7F00FF !important;
                  --sensor-color: #7F00FF !important;
                  --primary-color: #7F00FF !important;
                }


                /* 2. On cible l'élément de graphique lui-même */

                .graph svg polyline {
                  stroke: #FFB400 !important;
                }

                .graph svg path {
                  fill: #FFB400 !important;
                  opacity: 0.15 !important;
                }

                /* 3. Vos styles de fond et flou */

                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }

                .header { padding: 16px 16px 0 16px !important; }

                .name { font-size: 14px !important; font-weight: 600 !important;
                color: rgba(255,255,255,0.8) !important; }

                .value { font-size: 24px !important; font-weight: 700
                !important; color: #FFFFFF !important; }

                .measurement { font-size: 14px !important; opacity: 0.6
                !important; }
          - graph: line
            type: sensor
            detail: 1
            name: Lave Vaisselle
            entity: sensor.lave_vaisselle_z_power
            card_mod:
              style: >
                /* 1. On force la variable de couleur partout */

                :host {
                  --accent-color: #00D2FF !important;
                  --sensor-color: #00D2FF !important;
                  --primary-color: #00D2FF !important;
                }


                /* 2. On cible l'élément de graphique lui-même */

                .graph svg polyline {
                  stroke: #FFB400 !important;
                }

                .graph svg path {
                  fill: #FFB400 !important;
                  opacity: 0.15 !important;
                }

                /* 3. Vos styles de fond et flou */

                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }

                .header { padding: 16px 16px 0 16px !important; }

                .name { font-size: 14px !important; font-weight: 600 !important;
                color: rgba(255,255,255,0.8) !important; }

                .value { font-size: 24px !important; font-weight: 700
                !important; color: #FFFFFF !important; }

                .measurement { font-size: 14px !important; opacity: 0.6
                !important; }
          - type: sensor
            entity: sensor.prise_imprimante_3d_power
            name: Imprimante 3D
            graph: line
            detail: 1
            card_mod:
              style: >
                /* 1. On force la variable de couleur partout */

                :host {
                  --accent-color: #FF8000 !important;
                  --sensor-color: #FF8000 !important;
                  --primary-color: #FF8000 !important;
                }


                /* 2. On cible l'élément de graphique lui-même */

                .graph svg polyline {
                  stroke: #FFB400 !important;
                }

                .graph svg path {
                  fill: #FFB400 !important;
                  opacity: 0.15 !important;
                }

                /* 3. Vos styles de fond et flou */

                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }

                .header { padding: 16px 16px 0 16px !important; }

                .name { font-size: 14px !important; font-weight: 600 !important;
                color: rgba(255,255,255,0.8) !important; }

                .value { font-size: 24px !important; font-weight: 700
                !important; color: #FFFFFF !important; }

                .measurement { font-size: 14px !important; opacity: 0.6
                !important; }
          - graph: line
            type: sensor
            name: Appoint Lison
            entity: >-
              sensor.smart_socket_thermostat_24092307359107600802c4e7ae0be3df_power
            detail: 2
            theme: Caule Black Aqua Glass
            unit: W
            card_mod:
              style: >
                /* 1. On force la variable de couleur partout */

                :host {
                  --accent-color: #3DDBB8 !important;
                  --sensor-color: #FF8000 !important;
                  --primary-color: #FF8000 !important;
                }


                /* 2. On cible l'élément de graphique lui-même */

                .graph svg polyline {
                  stroke: #FFB400 !important;
                }

                .graph svg path {
                  fill: #FFB400 !important;
                  opacity: 0.15 !important;
                }

                /* 3. Vos styles de fond et flou */

                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                }

                .header { padding: 16px 16px 0 16px !important; }

                .name { font-size: 14px !important; font-weight: 600 !important;
                color: rgba(255,255,255,0.8) !important; }

                .value { font-size: 24px !important; font-weight: 700
                !important; color: #FFFFFF !important; }

                .measurement { font-size: 14px !important; opacity: 0.6
                !important; }
      - type: grid
        cards:
          - type: custom:button-card
            name: |
              [[[ 
                const date = new Date();
                const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const mois = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
                return 'Conso du Jour - ' + jours[date.getDay()] + ' ' + date.getDate() + ' ' + mois[date.getMonth()];
              ]]]
            icon: mdi:lightning-bolt
            styles:
              card:
                - background: none
                - border: none
                - padding: 8px 15px
              grid:
                - grid-template-areas: '"i n"'
                - grid-template-columns: min-content 1fr
                - gap: 10px
              icon:
                - width: 24px
                - color: '#FFB03B'
                - filter: drop-shadow(0 0 5px rgba(255, 176, 59, 0.4))
              name:
                - justify-self: start
                - font-weight: 900
                - font-size: 15px
                - color: '#FFB03B'
                - text-transform: uppercase
                - letter-spacing: 1px
                - text-shadow: 0 0 10px rgba(255, 176, 59, 0.3)
          - type: custom:button-card
            name: Consommation & Énergie (Ce jour)
            styles:
              card:
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - border-radius: 24px
                - border: 1px solid rgba(255,255,255,0.1)
                - box-shadow: 0 8px 32px rgba(0,0,0,0.3)
                - padding: 20px
              grid:
                - grid-template-areas: '"n" "table"'
                - grid-template-rows: auto auto
              name:
                - font-size: 16px
                - font-weight: 700
                - color: rgba(255,255,255,0.9)
                - margin-bottom: 20px
                - text-align: left
                - justify-self: start
            custom_fields:
              table:
                card:
                  type: custom:button-card
                  styles:
                    card:
                      - background: transparent
                      - border: none
                      - box-shadow: none
                      - padding: 0
                    grid:
                      - grid-template-areas: '"header" "solaire" "reseau" "batterie"'
                      - grid-template-columns: 1fr
                  custom_fields:
                    header: |
                      [[[
                        return `
                          <div style="display: grid; grid-template-columns: 1fr 100px 100px; padding: 0 10px 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px;">
                            <div>Source</div>
                            <div style="text-align: right;">Produit</div>
                            <div style="text-align: right;">Consommé</div>
                          </div>
                        `;
                      ]]]
                    solaire: |
                      [[[
                        const p = states['sensor.production_solaire_today']?.state || '0'; 
                        const isProd = states['sensor.production_solaire_today'] !== undefined;
                        if (!isProd) return `<div style="display:none"></div>`;
                        return `
                          <div style="display: grid; grid-template-columns: 1fr 100px 100px; padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                              <div style="color: #FFD700; display: flex;"><ha-icon icon="mdi:solar-power" style="--mdc-icon-size: 20px;"></ha-icon></div>
                              <div style="font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9);">Solaire</div>
                            </div>
                            <div style="text-align: right; font-size: 14px; font-weight: 700; color: #FFD700;">${p} kWh</div>
                            <div style="text-align: right; font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.4);">—</div>
                          </div>
                        `;
                      ]]]
                    reseau: |
                      [[[
                        const c = states['sensor.ecojoko_consommation_reseau']?.state || '0';
                        const r = states['sensor.grid_return_today']?.state || '0';
                        const unit = states['sensor.ecojoko_consommation_reseau']?.attributes?.unit_of_measurement || 'kWh';
                        return `
                          <div style="display: grid; grid-template-columns: 1fr 100px 100px; padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                              <div style="color: #00B4FF; display: flex;"><ha-icon icon="mdi:transmission-tower" style="--mdc-icon-size: 20px;"></ha-icon></div>
                              <div style="font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9);">Réseau</div>
                            </div>
                            <div style="text-align: right; font-size: 14px; font-weight: 700; color: rgba(255,255,255,0.9);">${r === '0' ? '—' : r + ' kWh'}</div>
                            <div style="text-align: right; font-size: 14px; font-weight: 700; color: #00B4FF;">${c} ${unit}</div>
                          </div>
                        `;
                      ]]]
                    batterie: |
                      [[[
                        const isBat = states['sensor.battery_charge_today'] !== undefined;
                        if (!isBat) return `<div style="display:none"></div>`;
                        const ch = states['sensor.battery_charge_today']?.state || '0';
                        const dch = states['sensor.battery_discharge_today']?.state || '0';
                        return `
                          <div style="display: grid; grid-template-columns: 1fr 100px 100px; padding: 15px 10px; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                              <div style="color: #00FF00; display: flex;"><ha-icon icon="mdi:battery-high" style="--mdc-icon-size: 20px;"></ha-icon></div>
                              <div style="font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9);">Batterie</div>
                            </div>
                            <div style="text-align: right; font-size: 14px; font-weight: 700; color: rgba(255,255,255,0.9);">${ch} kWh</div>
                            <div style="text-align: right; font-size: 14px; font-weight: 700; color: #00FF00;">${dch} kWh</div>
                          </div>
                        `;
                      ]]]
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso PAC Jour
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.pac_conso_jour_kwh
                name: ' '
                type: area
                color: '#FF3D00'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px; /* Remonte le graph */
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso Ballon Jour
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.ballon_conso_jour_kwh_2
                name: ' '
                type: area
                color: '#005CB9'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso Congélateur Jour
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_congelateur_z_energy_today
                name: ' '
                type: area
                color: '#00F260'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso Cookéeo Jour
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_cuisine_energy_today
                name: ' '
                type: area
                color: '#FFB400'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso Lave Linge Jour
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_machine_a_laver_z_energy_today
                name: ' '
                type: area
                color: '#FF0080'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Sèche Linge Jour
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_seche_linge_z_energy_today
                name: ' '
                type: area
                color: '#7F00FF'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Lave Vaisselle Jour
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.lave_vaisselle_z_energy_today
                name: ' '
                type: area
                color: '#00D2FF'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Imprimante 3D Jour
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_imprimante_3d_energy_today
                name: ' '
                type: area
                color: '#FF8000'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:mini-graph-card
            grid_options:
              columns: 6
              rows: 2
            entities:
              - entity: sensor.lison_conso_jour_kwh_2
                name: Lison Appoint Jour
            unit: kWh
            decimals: 0
            hours_to_show: 24
            points_per_hour: 4
            line_width: 4
            line_color: '#3DDBB8'
            lower_bound: 0
            show:
              labels: false
              extrema: false
              average: false
              fill: fade
              icon: false
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(15px) !important;
                  -webkit-backdrop-filter: blur(15px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 110px !important;
                }
                /* ON SUPPRIME L'OEIL (Icône) DÉFINITIVEMENT */
                .header .icon, .header ha-icon, ha-icon {
                  display: none !important;
                  visibility: hidden !important;
                }
                .header {
                  padding: 1px 1px 0px 14px !important;
                }
                .name {
                  font-size: 14px !important; 
                  font-weight: 500 !important;
                  color: rgba(255, 255, 255, 1) !important;
                  text-transform: none !important;
                }
                /* Chiffre en vert mint */
                .state {
                  font-size: 14px !important; 
                  font-weight: 500 !important;
                  color: #3DDBB8 !important;
                }
                /* kWh en blanc pur (forcé) */
                .uom, .state .uom, span.uom {
                  color: #FFFFFF !important;
                  opacity: 1 !important;
                  font-size: 10px !important;
                }
                .graph {
                  margin-top: 5px !important;
                  height: 20px !important;
                }
      - type: grid
        cards:
          - type: custom:button-card
            name: |
              [[[ 
                const date = new Date();
                const mois = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
                return 'Conso du Mois - ' + mois[date.getMonth()] + ' ' + date.getFullYear();
              ]]]
            icon: mdi:calendar-month
            styles:
              card:
                - background: none
                - border: none
                - padding: 8px 15px
              grid:
                - grid-template-areas: '"i n"'
                - grid-template-columns: min-content 1fr
                - gap: 10px
              icon:
                - width: 24px
                - color: '#FFB03B'
                - filter: drop-shadow(0 0 5px rgba(255, 176, 59, 0.4))
              name:
                - justify-self: start
                - font-weight: 900
                - font-size: 15px
                - color: '#FFB03B'
                - text-transform: uppercase
                - letter-spacing: 1px
                - text-shadow: 0 0 10px rgba(255, 176, 59, 0.3)
          - type: custom:button-card
            name: Consommation & Énergie (Ce mois)
            styles:
              card:
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - border-radius: 24px
                - border: 1px solid rgba(255,255,255,0.1)
                - box-shadow: 0 8px 32px rgba(0,0,0,0.3)
                - padding: 20px
              grid:
                - grid-template-areas: '"n" "table"'
                - grid-template-rows: auto auto
              name:
                - font-size: 16px
                - font-weight: 700
                - color: rgba(255,255,255,0.9)
                - margin-bottom: 20px
                - text-align: left
                - justify-self: start
            custom_fields:
              table:
                card:
                  type: custom:button-card
                  styles:
                    card:
                      - background: transparent
                      - border: none
                      - box-shadow: none
                      - padding: 0
                    grid:
                      - grid-template-areas: '"header" "reseau" "batterie"'
                      - grid-template-columns: 1fr
                  custom_fields:
                    header: |
                      [[[
                        return `
                          <div style="display: grid; grid-template-columns: 1fr 100px 100px; padding: 0 10px 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px;">
                            <div>Source</div>
                            <div style="text-align: right;">Injecté</div>
                            <div style="text-align: right;">Consommé</div>
                          </div>
                        `;
                      ]]]
                    reseau: |
                      [[[
                        const c = parseFloat(states['sensor.ecojoko_consommation_mois']?.state) || 0;
                        const r = parseFloat(states['sensor.grid_return_mois']?.state) || 0;
                        return `
                          <div style="display: grid; grid-template-columns: 1fr 100px 100px; padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                              <div style="color: #00B4FF; display: flex;"><ha-icon icon="mdi:transmission-tower" style="--mdc-icon-size: 20px;"></ha-icon></div>
                              <div style="font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9);">Réseau</div>
                            </div>
                            <div style="text-align: right; font-size: 14px; font-weight: 700; color: rgba(255,255,255,0.9);">${r === 0 ? '—' : r.toFixed(1) + ' kWh'}</div>
                            <div style="text-align: right; font-size: 14px; font-weight: 700; color: #00B4FF;">${c.toFixed(1)} kWh</div>
                          </div>
                        `;
                      ]]]
                    batterie: |
                      [[[
                        const ch = states['sensor.battery_charge_mois']?.state;
                        if (!ch || ch === 'unavailable' || ch === 'unknown') return `<div style="display:none"></div>`;
                        const dch = parseFloat(states['sensor.battery_discharge_mois']?.state) || 0;
                        const chVal = parseFloat(ch) || 0;
                        return `
                          <div style="display: grid; grid-template-columns: 1fr 100px 100px; padding: 15px 10px; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                              <div style="color: #00FF00; display: flex;"><ha-icon icon="mdi:battery-high" style="--mdc-icon-size: 20px;"></ha-icon></div>
                              <div style="font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9);">Batterie</div>
                            </div>
                            <div style="text-align: right; font-size: 14px; font-weight: 700; color: rgba(255,255,255,0.9);">${chVal.toFixed(1)} kWh</div>
                            <div style="text-align: right; font-size: 14px; font-weight: 700; color: #00FF00;">${dch.toFixed(1)} kWh</div>
                          </div>
                        `;
                      ]]]
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso PAC Mois
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.pac_conso_mois_kwh
                name: ' '
                type: area
                color: '#FF3D00'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px; /* Remonte le graph */
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso Ballon Mois
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.ballon_conso_mois_kwh_2
                name: ' '
                type: area
                color: '#005CB9'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso Congélateur Jour Mois
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_congelateur_z_energy_month
                name: ' '
                type: area
                color: '#00F260'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso Cookéeo Mois
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_cuisine_energy_month
                name: ' '
                type: area
                color: '#FFB400'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Conso Lave Linge Mois
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_machine_a_laver_z_energy_month
                name: ' '
                type: area
                color: '#FF0080'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Sèche Linge Mois
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_seche_linge_z_energy_month
                name: ' '
                type: area
                color: '#7F00FF'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Lave Vaisselle Mois
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.lave_vaisselle_z_energy_month
                name: ' '
                type: area
                color: '#00D2FF'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:apexcharts-card
            grid_options:
              columns: 6
              rows: 2
            header:
              show: true
              title: Imprimante 3D Mois
              show_states: true
              colorize_states: true
            graph_span: 24h
            series:
              - entity: sensor.prise_imprimante_3d_energy_month
                name: ' '
                type: area
                color: '#FF8000'
                stroke_width: 3
                opacity: 0.5
                transform: return Math.round(parseFloat(x));
                group_by:
                  func: max
                  duration: 1h
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px) !important;
                  -webkit-backdrop-filter: blur(10px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 120px !important;
                  padding: 0px !important;
                  overflow: hidden !important;
                }
                .apexcharts-canvas {
                  margin-top: -30px;
                }
                .apexcharts-header {
                  padding: 12px 14px 0px 14px !important;
                  z-index: 10;
                }
                .apexcharts-header-title {
                  font-size: 11px !important; 
                  font-weight: 600 !important;
                  color: rgba(255,255,255,0.6) !important;
                }
                .apexcharts-state-value {
                  font-size: 20px !important; 
                  font-weight: 900 !important;
                  color: #FFFFFF !important;
                }
                .apexcharts-state-unit {
                  font-size: 11px !important;
                  opacity: 0.5 !important;
                }
            apex_config:
              chart:
                height: 70px
                sparkline:
                  enabled: true
                offsetY: 0
              stroke:
                curve: smooth
              fill:
                type: gradient
                gradient:
                  type: horizontal
                  shadeIntensity: 0
                  opacityFrom: 0.4
                  opacityTo: 0.1
                  stops:
                    - 0
                    - 90
                    - 100
          - type: custom:mini-graph-card
            grid_options:
              columns: 6
              rows: 2
            entities:
              - entity: sensor.lison_conso_mois_kwh_2
                name: Lison Appoint Mois
            unit: kWh
            decimals: 0
            hours_to_show: 24
            points_per_hour: 4
            line_width: 4
            line_color: '#3DDBB8'
            lower_bound: 0
            show:
              labels: false
              extrema: false
              average: false
              fill: fade
              icon: false
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(15px) !important;
                  -webkit-backdrop-filter: blur(15px) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  height: 110px !important;
                }
                /* ON SUPPRIME L'OEIL (Icône) DÉFINITIVEMENT */
                .header .icon, .header ha-icon, ha-icon {
                  display: none !important;
                  visibility: hidden !important;
                }
                .header {
                  padding: 1px 1px 0px 14px !important;
                }
                .name {
                  font-size: 14px !important; 
                  font-weight: 500 !important;
                  color: rgba(255, 255, 255, 1) !important;
                  text-transform: none !important;
                }
                /* Chiffre en vert mint */
                .state {
                  font-size: 14px !important; 
                  font-weight: 500 !important;
                  color: #3DDBB8 !important;
                }
                /* kWh en blanc pur (forcé) */
                .uom, .state .uom, span.uom {
                  color: #FFFFFF !important;
                  opacity: 1 !important;
                  font-size: 10px !important;
                }
                .graph {
                  margin-top: 5px !important;
                  height: 20px !important;
                }
    theme: noctis
    cards: []
    subview: true
    background:
      opacity: 100
      alignment: center
      size: cover
      repeat: repeat
      attachment: fixed
      image:
        media_content_id: media-source://image_upload/b148cb5f9f801b5cb67570cf0a8ad927
        media_content_type: image/png
        metadata:
          title: dark_geometric_energy_clean_bg_1770562387977.png
          thumbnail: /api/image/serve/b148cb5f9f801b5cb67570cf0a8ad927/256x256
          media_class: image
          navigateIds:
            - {}
            - media_content_type: app
              media_content_id: media-source://image_upload
    visible:
      - user: 5ee57ea8e4174d67b0a97686fe4437b5
      - user: 49a98c3aa3c44399a03d32437dca04ba
      - user: ae15429d8056449699d5e3e93e21e2c9
      - user: b1c2a32f85334df2ab8e8d5b2299575c
      - user: 76dc484362274cbbb06167991e4e596b
  - type: sections
    max_columns: 1
    title: 'User 4 '
    path: chloe
    sections:
      - type: grid
        cards:
          - type: custom:button-card
            entity: sensor.91_weather_alert
            show_name: false
            show_icon: false
            show_state: false
            styles:
              card:
                - background: transparent
                - border: none
                - box-shadow: none
                - padding: 0px
                - margin: 0px
                - display: |
                    [[[
                      if (!entity || !entity.attributes) return 'none';
                      const p_list = ['Vent violent', 'Pluie-inondation', 'Orages', 'Inondation', 'Neige-verglas', 'Canicule', 'Grand froid', 'Avalanches', 'Vagues-submersion'];
                      return p_list.some(p => ['Jaune', 'Orange', 'Rouge'].includes(entity.attributes[p])) ? 'block' : 'none';
                    ]]]
              grid:
                - grid-template-areas: '"alerts_container"'
                - grid-template-columns: 1fr
            custom_fields:
              alerts_container: |
                [[[
                  if (!entity || !entity.attributes) return "";
                  
                  const pheno_configs = [
                    { id: 'Vent violent', icon: 'mdi:weather-windy' },
                    { id: 'Pluie-inondation', icon: 'mdi:weather-pouring' },
                    { id: 'Orages', icon: 'mdi:weather-lightning' },
                    { id: 'Inondation', icon: 'mdi:home-flood' },
                    { id: 'Neige-verglas', icon: 'mdi:weather-snowy' },
                    { id: 'Canicule', icon: 'mdi:weather-sunny-alert' },
                    { id: 'Grand froid', icon: 'mdi:snowflake' },
                    { id: 'Avalanches', icon: 'mdi:image-filter-hdr' },
                    { id: 'Vagues-submersion', icon: 'mdi:waves' }
                  ];
                  
                  const p_levels = ['Rouge', 'Orange', 'Jaune'];
                  const p_colors = { 'Rouge': '#ff1111', 'Orange': '#ff9900', 'Jaune': '#ffff00' };
                  
                  let final_html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                  let has_any = false;
                  p_levels.forEach(lvl => {
                    pheno_configs.forEach(conf => {
                      if (entity.attributes[conf.id] === lvl) {
                        has_any = true;
                        const c = p_colors[lvl];
                        final_html += `
                          <div style="
                            background: rgba(20, 27, 38, 0.6);
                            backdrop-filter: blur(20px);
                            -webkit-backdrop-filter: blur(20px);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 20px;
                            height: 35px;
                            display: flex;
                            align-items: center;
                            padding: 0 15px;
                          ">
                            <div style="width: 35px; min-width: 35px; display: flex; align-items: center;">
                              <ha-icon icon="${conf.icon}" style="
                                color: ${c};
                                filter: drop-shadow(0 0 5px ${c});
                                --mdc-icon-size: 22px;
                                animation: dash_blink 2s infinite;
                              "></ha-icon>
                            </div>
                            <div style="
                              font-weight: 900;
                              font-size: 11px;
                              text-transform: uppercase;
                              letter-spacing: 1px;
                              color: ${c};
                              text-shadow: 0 0 10px rgba(0,0,0,0.5);
                              animation: dash_blink 2s infinite;
                            ">
                              VIGILANCE ${lvl} : ${conf.id}
                            </div>
                          </div>
                        `;
                      }
                    });
                  });
                  
                  final_html += '</div>';
                  return has_any ? final_html : "";
                ]]]
            card_mod:
              style: |
                ha-card {
                  background: transparent !important;
                  border: none !important;
                  box-shadow: none !important;
                }
                @keyframes dash_blink {
                  0% { opacity: 1; }
                  50% { opacity: 0.3; }
                  100% { opacity: 1; }
                }
          - type: custom:bubble-card
            card_type: button
            name: Chambre User 4
            button_type: state
            sub_button:
              - entity: sensor.smart_temp_humidity_sensor_39000e5be749_temperature
                show_state: true
                show_background: false
              - show_name: false
                show_state: true
                tap_action:
                  action: toggle
                select_attribute: hvac_modes
                show_arrow: false
                show_attribute: true
                double_tap_action:
                  action: more-info
                entity: sensor.smart_temp_humidity_sensor_39000e5be749_humidity
              - show_icon: true
                show_attribute: false
                attribute: unit_of_measurement
                show_state: true
                state_background: false
                show_last_updated: false
                show_last_changed: false
                show_name: false
                show_background: true
                entity: sensor.smart_temp_humidity_sensor_39000e5be749_battery
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-main-background-color: var(--card-background-color);
                --bubble-button-background-color: var(--card-background-color);
                --bubble-button-border-radius: 5px;
              }
            entity: sensor.smart_temp_humidity_sensor_39000e5be749_temperature
            show_state: false
            scrolling_effect: false
          - type: custom:bubble-card
            card_type: button
            name: Salle de Bain User 4 & User 5
            button_type: state
            sub_button:
              - entity: sensor.sonoff_acc8001cf0_temperature
                show_background: false
                show_state: true
              - show_name: false
                show_state: true
                tap_action:
                  action: toggle
                select_attribute: hvac_modes
                show_arrow: false
                show_attribute: true
                double_tap_action:
                  action: more-info
                entity: sensor.sonoff_acc8001cf0_humidity
              - show_icon: true
                show_attribute: false
                attribute: unit_of_measurement
                show_state: true
                state_background: false
                show_last_updated: false
                show_last_changed: false
                show_name: false
                show_background: true
                entity: sensor.sonoff_acc8001cf0_battery
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-main-background-color: var(--card-background-color);
                --bubble-button-background-color: var(--card-background-color);
                --bubble-button-border-radius: 5px;
              }
            show_state: false
            scrolling_effect: false
            entity: sensor.sonoff_acc8001cf0_temperature
    badges:
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: person.user_1
        show_entity_picture: true
        tap_action:
          action: none
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: person.user_2
        show_entity_picture: true
        tap_action:
          action: none
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: person.user_3
        show_entity_picture: true
        tap_action:
          action: none
        name:
          type: entity
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: person.user_5
        show_entity_picture: true
        tap_action:
          action: none
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: binary_sensor.sonoff_acc8001c92
    visible:
      - user: b1c2a32f85334df2ab8e8d5b2299575c
      - user: 49a98c3aa3c44399a03d32437dca04ba
      - user: 76dc484362274cbbb06167991e4e596b
    cards: []
  - type: sections
    max_columns: 4
    title: User 3
    path: marley
    sections:
      - type: grid
        cards:
          - type: custom:button-card
            entity: sensor.91_weather_alert
            show_name: false
            show_icon: false
            show_state: false
            styles:
              card:
                - background: transparent
                - border: none
                - box-shadow: none
                - padding: 0px
                - margin: 0px
                - display: |
                    [[[
                      if (!entity || !entity.attributes) return 'none';
                      const p_list = ['Vent violent', 'Pluie-inondation', 'Orages', 'Inondation', 'Neige-verglas', 'Canicule', 'Grand froid', 'Avalanches', 'Vagues-submersion'];
                      return p_list.some(p => ['Jaune', 'Orange', 'Rouge'].includes(entity.attributes[p])) ? 'block' : 'none';
                    ]]]
              grid:
                - grid-template-areas: '"alerts_container"'
                - grid-template-columns: 1fr
            custom_fields:
              alerts_container: |
                [[[
                  if (!entity || !entity.attributes) return "";
                  
                  const pheno_configs = [
                    { id: 'Vent violent', icon: 'mdi:weather-windy' },
                    { id: 'Pluie-inondation', icon: 'mdi:weather-pouring' },
                    { id: 'Orages', icon: 'mdi:weather-lightning' },
                    { id: 'Inondation', icon: 'mdi:home-flood' },
                    { id: 'Neige-verglas', icon: 'mdi:weather-snowy' },
                    { id: 'Canicule', icon: 'mdi:weather-sunny-alert' },
                    { id: 'Grand froid', icon: 'mdi:snowflake' },
                    { id: 'Avalanches', icon: 'mdi:image-filter-hdr' },
                    { id: 'Vagues-submersion', icon: 'mdi:waves' }
                  ];
                  
                  const p_levels = ['Rouge', 'Orange', 'Jaune'];
                  const p_colors = { 'Rouge': '#ff1111', 'Orange': '#ff9900', 'Jaune': '#ffff00' };
                  
                  let final_html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                  let has_any = false;
                  p_levels.forEach(lvl => {
                    pheno_configs.forEach(conf => {
                      if (entity.attributes[conf.id] === lvl) {
                        has_any = true;
                        const c = p_colors[lvl];
                        final_html += `
                          <div style="
                            background: rgba(20, 27, 38, 0.6);
                            backdrop-filter: blur(20px);
                            -webkit-backdrop-filter: blur(20px);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 20px;
                            height: 35px;
                            display: flex;
                            align-items: center;
                            padding: 0 15px;
                          ">
                            <div style="width: 35px; min-width: 35px; display: flex; align-items: center;">
                              <ha-icon icon="${conf.icon}" style="
                                color: ${c};
                                filter: drop-shadow(0 0 5px ${c});
                                --mdc-icon-size: 22px;
                                animation: dash_blink 2s infinite;
                              "></ha-icon>
                            </div>
                            <div style="
                              font-weight: 900;
                              font-size: 11px;
                              text-transform: uppercase;
                              letter-spacing: 1px;
                              color: ${c};
                              text-shadow: 0 0 10px rgba(0,0,0,0.5);
                              animation: dash_blink 2s infinite;
                            ">
                              VIGILANCE ${lvl} : ${conf.id}
                            </div>
                          </div>
                        `;
                      }
                    });
                  });
                  
                  final_html += '</div>';
                  return has_any ? final_html : "";
                ]]]
            card_mod:
              style: |
                ha-card {
                  background: transparent !important;
                  border: none !important;
                  box-shadow: none !important;
                }
                @keyframes dash_blink {
                  0% { opacity: 1; }
                  50% { opacity: 0.3; }
                  100% { opacity: 1; }
                }
          - type: custom:bubble-card
            card_type: button
            button_type: slider
            entity: light.smart_rgb_pro_led_strip_24060640872589560f01c4e7ae04b91f
            min_value: 10
            max_value: 100
            step: 10
            sub_button:
              main:
                - entity: >-
                    light.smart_rgb_pro_led_strip_24060640872589560f01c4e7ae04b91f
                  show_name: false
                  show_state: true
                  show_icon: false
                  tap_action:
                    action: toggle
              bottom: []
            slider_fill_orientation: left
            slider_value_position: right
            light_slider_type: brightness
            show_icon: true
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:bubble-card
            card_type: climate
            name: Chambre User 3
            button_type: switch
            entity: climate.smart_thermostat_valve_03004482
            sub_button:
              main:
                - show_name: false
                  show_state: false
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  attribute: current_temperature
                  double_tap_action:
                    action: more-info
                  entity: climate.smart_thermostat_valve_03004482
                  sub_button_type: select
                - show_icon: true
                  show_attribute: false
                  attribute: unit_of_measurement
                  show_state: true
                  state_background: false
                  show_last_updated: false
                  show_last_changed: false
                  show_name: false
                  show_background: true
                  entity: sensor.smart_thermostat_valve_03004482_battery
              bottom: []
            card_layout: normal
            modules: []
            force_icon: false
            show_state: true
            show_attribute: false
            attribute: supported_features
            scrolling_effect: false
            styles: |
              ha-card {
                --bubble-climate-main-background-color: transparent !important;
                --bubble-climate-border-radius: 20px;
              }
              .bubble-climate-container {
                background: transparent !important;
              }
            show_icon: true
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  margin-top: 8px;
                }
          - type: custom:bubble-card
            card_type: button
            name: Salle de Bain Lison & User 3
            button_type: state
            sub_button:
              main:
                - entity: sensor.smart_temp_humidity_sensor_39000e5be9c8_temperature
                  show_background: false
                  show_state: true
                - show_name: false
                  show_state: true
                  tap_action:
                    action: toggle
                  select_attribute: hvac_modes
                  show_arrow: false
                  show_attribute: true
                  double_tap_action:
                    action: more-info
                  entity: sensor.smart_temp_humidity_sensor_39000e5be9c8_humidity
                  sub_button_type: select
                - show_icon: true
                  show_attribute: false
                  attribute: unit_of_measurement
                  show_state: true
                  state_background: false
                  show_last_updated: false
                  show_last_changed: false
                  show_name: false
                  show_background: true
                  entity: sensor.smart_temp_humidity_sensor_39000e5be9c8_battery
              bottom: []
            card_layout: normal
            modules: []
            styles: |
              ha-card {
                --bubble-main-background-color: var(--card-background-color);
                --bubble-button-background-color: var(--card-background-color);
                --bubble-button-border-radius: 5px;
              }
            show_state: false
            scrolling_effect: false
            entity: sensor.smart_temp_humidity_sensor_39000e5be9c8_temperature
            slider_fill_orientation: left
            slider_value_position: right
    visible:
      - user: 49a98c3aa3c44399a03d32437dca04ba
      - user: 5e92ce52c21a4b2f82b99bce6718aef3
      - user: 76dc484362274cbbb06167991e4e596b
    cards: []
    badges:
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        entity: person.user_1
        show_entity_picture: true
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        entity: person.user_2
        show_entity_picture: true
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        entity: person.user_4
        show_entity_picture: true
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        entity: person.user_5
        show_entity_picture: true
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        entity: light.smart_rgb_pro_led_strip_24060640872589560f01c4e7ae04b91f
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        entity: climate.smart_thermostat_valve_03004482
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        entity: sensor.smart_thermostat_valve_03004482_battery
  - type: sections
    path: morgan
    cards: []
    title: User 5
    subview: false
    visible:
      - user: f9c990f45267407787a685d132c3b425
      - user: 49a98c3aa3c44399a03d32437dca04ba
      - user: 5ee57ea8e4174d67b0a97686fe4437b5
      - user: 76dc484362274cbbb06167991e4e596b
    badges:
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: person.user_2
        show_entity_picture: true
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: person.user_1
        show_entity_picture: true
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: person.user_3
        show_entity_picture: true
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: person.user_4
        show_entity_picture: true
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        entity: sensor.iphone_de_morgan_battery_level
    sections:
      - type: grid
        cards:
          - type: custom:button-card
            entity: sensor.91_weather_alert
            show_name: false
            show_icon: false
            show_state: false
            styles:
              card:
                - background: transparent
                - border: none
                - box-shadow: none
                - padding: 0px
                - margin: 0px
                - display: |
                    [[[
                      if (!entity || !entity.attributes) return 'none';
                      const p_list = ['Vent violent', 'Pluie-inondation', 'Orages', 'Inondation', 'Neige-verglas', 'Canicule', 'Grand froid', 'Avalanches', 'Vagues-submersion'];
                      return p_list.some(p => ['Jaune', 'Orange', 'Rouge'].includes(entity.attributes[p])) ? 'block' : 'none';
                    ]]]
              grid:
                - grid-template-areas: '"alerts_container"'
                - grid-template-columns: 1fr
            custom_fields:
              alerts_container: |
                [[[
                  if (!entity || !entity.attributes) return "";
                  
                  const pheno_configs = [
                    { id: 'Vent violent', icon: 'mdi:weather-windy' },
                    { id: 'Pluie-inondation', icon: 'mdi:weather-pouring' },
                    { id: 'Orages', icon: 'mdi:weather-lightning' },
                    { id: 'Inondation', icon: 'mdi:home-flood' },
                    { id: 'Neige-verglas', icon: 'mdi:weather-snowy' },
                    { id: 'Canicule', icon: 'mdi:weather-sunny-alert' },
                    { id: 'Grand froid', icon: 'mdi:snowflake' },
                    { id: 'Avalanches', icon: 'mdi:image-filter-hdr' },
                    { id: 'Vagues-submersion', icon: 'mdi:waves' }
                  ];
                  
                  const p_levels = ['Rouge', 'Orange', 'Jaune'];
                  const p_colors = { 'Rouge': '#ff1111', 'Orange': '#ff9900', 'Jaune': '#ffff00' };
                  
                  let final_html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                  let has_any = false;
                  p_levels.forEach(lvl => {
                    pheno_configs.forEach(conf => {
                      if (entity.attributes[conf.id] === lvl) {
                        has_any = true;
                        const c = p_colors[lvl];
                        final_html += `
                          <div style="
                            background: rgba(20, 27, 38, 0.6);
                            backdrop-filter: blur(20px);
                            -webkit-backdrop-filter: blur(20px);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 20px;
                            height: 35px;
                            display: flex;
                            align-items: center;
                            padding: 0 15px;
                          ">
                            <div style="width: 35px; min-width: 35px; display: flex; align-items: center;">
                              <ha-icon icon="${conf.icon}" style="
                                color: ${c};
                                filter: drop-shadow(0 0 5px ${c});
                                --mdc-icon-size: 22px;
                                animation: dash_blink 2s infinite;
                              "></ha-icon>
                            </div>
                            <div style="
                              font-weight: 900;
                              font-size: 11px;
                              text-transform: uppercase;
                              letter-spacing: 1px;
                              color: ${c};
                              text-shadow: 0 0 10px rgba(0,0,0,0.5);
                              animation: dash_blink 2s infinite;
                            ">
                              VIGILANCE ${lvl} : ${conf.id}
                            </div>
                          </div>
                        `;
                      }
                    });
                  });
                  
                  final_html += '</div>';
                  return has_any ? final_html : "";
                ]]]
            card_mod:
              style: |
                ha-card {
                  background: transparent !important;
                  border: none !important;
                  box-shadow: none !important;
                }
                @keyframes dash_blink {
                  0% { opacity: 1; }
                  50% { opacity: 0.3; }
                  100% { opacity: 1; }
                }
          - show_name: true
            show_icon: true
            type: button
            entity: light.lumieres_morgan_z
          - graph: line
            type: sensor
            detail: 1
            entity: sensor.smart_temp_humidity_sensor_39000e4fa9fc_temperature
          - graph: line
            type: sensor
            detail: 1
            entity: sensor.smart_temp_humidity_sensor_39000e4fa9fc_humidity
    max_columns: 4
  - type: custom:grid-layout
    path: tesla_modele_3
    cards:
      - type: custom:button-card
        icon: mdi:home-variant-outline
        name: Accueil
        show_name: true
        tap_action:
          action: navigate
          navigation_path: /lovelace/0
        styles:
          card:
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(8px)
            - '-webkit-backdrop-filter': blur(8px)
            - border-radius: 12px
            - border: 1px solid rgba(255, 255, 255, 0.1)
            - padding: 6px 12px
            - width: fit-content
            - margin: 0 auto 10px 0
          grid:
            - grid-template-areas: '"i n"'
            - grid-template-columns: auto auto
            - column-gap: 8px
          icon:
            - width: 18px
            - color: '#00bfff'
          name:
            - font-size: 12px
            - font-weight: 700
            - color: rgba(255, 255, 255, 0.9)
      - type: custom:vehicle-status-card
        name: Tesla Modèle 3
        layout_config:
          button_grid:
            rows: 2
            columns: 2
            swipe: true
          images_swipe:
            height: 150
          section_order:
            - range_info
            - images
            - indicators
            - mini_map
            - buttons
          range_info_config:
            layout: row
        mini_map:
          enable_popup: true
          device_tracker: device_tracker.tesla_model_3_location
          use_zone_name: false
          user_location: false
        range_info:
          - energy_level:
              tap_action:
                action: more-info
              value_alignment: end
              value_position: inside
              entity: sensor.tesla_model_3_niveau_de_batterie
            range_level:
              value_position: outside
              entity: sensor.tesla_model_3_autonomie_de_batterie
            charging_entity: binary_sensor.tesla_model_3_charging
            progress_color: '#d60000'
            charging_template: '{{ true }}'
            color_blocks: false
            color_thresholds:
              - value: 0
                color: '#ff0000'
              - value: 20
                color: '#ff7300'
              - value: 40
                color: '#ffbb00'
              - value: 60
                color: '#eeff00'
              - value: 80
                color: '#44ff00'
            bar_radius: 10
          - energy_level:
              tap_action:
                action: more-info
              value_alignment: end
              value_position: inside
              entity: sensor.tesla_model_3_charge_energy_added
              hide_icon: false
              max_value: 50
            range_level:
              value_position: inside
              icon: mdi:ev-station
            progress_color: '#fbff00'
            color_blocks: false
            color_thresholds:
              - value: 0
                color: '#fbff00'
              - value: 20
                color: '#aeff00'
              - value: 40
                color: '#4dff00'
              - value: 60
                color: '#00ffbf'
              - value: 80
                color: '#00bfff'
            bar_radius: 10
            charging_entity: sensor.tesla_model_3_vitesse_de_charge
          - charging_entity: binary_sensor.ci_tesla_charging
            progress_color: '#8ce73a'
            energy_level:
              entity: sensor.tesla_model_3_compteur
              max_value: 150
              value_position: inside
              hide_icon: true
              value_alignment: end
            color_thresholds:
              - value: 0
                color: '#40e762'
              - value: 30
                color: '#9ade1b'
              - value: 60
                color: '#8fba17'
              - value: 90
                color: '#968013'
              - value: 120
                color: '#b21301'
            color_blocks: false
            bar_radius: 10
        images:
          - image: /api/image/serve/2f279a2aa6f54dc602c787bdef31a69f/512x512
        button_cards:
          - show_icon: true
            show_primary: true
            show_secondary: true
            layout: horizontal
            tap_action:
              action: more-info
            card_type: custom
            icon_type: icon
            primary_info: name
            name: Climatisation
            entity: climate.tesla_model_3_climate
            button_type: default
            sub_card:
              custom_card:
                - type: vertical-stack
                  cards:
                    - type: conditional
                      conditions:
                        - entity: climate.tesla_model_3_climate
                          state_not: 'off'
                        - entity: climate.tesla_model_3_climate
                          state_not: unavailable
                        - entity: climate.tesla_model_3_climate
                          state_not: unknown
                      card:
                        type: picture-elements
                        image: /local/tesla.clim-on.png
                        aspect_ratio: '16:9'
                        elements:
                          - type: state-label
                            entity: climate.tesla_model_3_climate
                            attribute: current_temperature
                            style:
                              left: 92%
                              top: 10%
                              color: white
                              font-size: 26px
                              font-weight: 700
                              text-shadow: 0px 0px 6px rgba(0,0,0,0.85)
                          - type: icon
                            icon: mdi:temperature-celsius
                            style:
                              left: 98%
                              top: 10%
                              color: rgba(255,255,255,0.8)
                              '--mdc-icon-size': 18px
                            tap_action:
                              action: more-info
                              entity: climate.tesla_model_3_climate
                          - type: icon
                            entity: climate.tesla_model_3_climate
                            icon: mdi:power
                            style:
                              left: 5%
                              top: 10%
                              '--mdc-icon-size': 53px
                            tap_action:
                              action: call-service
                              service: climate.toggle
                              target:
                                entity_id: climate.tesla_model_3_climate
                            hold_action:
                              action: more-info
                              entity: climate.tesla_model_3_climate
                            card_mod:
                              style: |
                                ha-state-icon, ha-icon {
                                  {% set s = states('climate.tesla_model_3_climate') %}
                                  color: {% if s in ['off','unavailable','unknown'] %}
                                    rgba(255,255,255,0.35)
                                  {% else %}
                                    rgb(255, 70, 70)
                                  {% endif %} !important;
                                  filter: {% if s in ['off','unavailable','unknown'] %}
                                    none
                                  {% else %}
                                    drop-shadow(0 0 6px rgba(255,0,0,0.85))
                                    drop-shadow(0 0 14px rgba(255,0,0,0.35))
                                  {% endif %};
                                  animation: {% if s in ['off','unavailable','unknown'] %}
                                    none
                                  {% else %}
                                    teslaPulse 1.6s ease-in-out infinite
                                  {% endif %};
                                  transform-origin: center;
                                }
                                @keyframes teslaPulse {
                                  0%   { transform: scale(1);    opacity: 0.85; }
                                  50%  { transform: scale(1.10); opacity: 1;    }
                                  100% { transform: scale(1);    opacity: 0.85; }
                                }
                          - type: icon
                            entity: switch.tesla_model_3_defrost
                            icon: mdi:snowflake
                            style:
                              left: 16%
                              top: 10%
                              '--mdc-icon-size': 43px
                            tap_action:
                              action: call-service
                              service: switch.toggle
                              target:
                                entity_id: switch.tesla_model_3_defrost
                            hold_action:
                              action: more-info
                              entity: switch.tesla_model_3_defrost
                            card_mod:
                              style: |
                                ha-state-icon, ha-icon {
                                  color: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    rgb(255, 70, 70)
                                  {% else %}
                                    rgba(255,255,255,0.35)
                                  {% endif %} !important;
                                  filter: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    drop-shadow(0 0 6px rgba(255,0,0,0.85))
                                    drop-shadow(0 0 14px rgba(255,0,0,0.35))
                                  {% else %}
                                    none
                                  {% endif %};
                                  animation: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    teslaPulseDef 1.6s ease-in-out infinite
                                  {% else %}
                                    none
                                  {% endif %};
                                  transform-origin: center;
                                }
                                @keyframes teslaPulseDef {
                                  0%   { transform: scale(1);    opacity: 0.85; }
                                  50%  { transform: scale(1.10); opacity: 1;    }
                                  100% { transform: scale(1);    opacity: 0.85; }
                                }
                          - type: icon
                            icon: mdi:chevron-left
                            style:
                              left: 42%
                              top: 10%
                              color: rgba(255,255,255,0.9)
                              '--mdc-icon-size': 50px
                            tap_action:
                              action: call-service
                              service: script.tesla_temp_plus_0_5
                          - type: state-label
                            entity: climate.tesla_model_3_climate
                            attribute: temperature
                            style:
                              left: 50%
                              top: 10%
                              color: rgba(255,255,255,0.95)
                              font-size: 20px
                              font-weight: 700
                              text-shadow: 0px 0px 6px rgba(0,0,0,0.85)
                          - type: icon
                            icon: mdi:temperature-celsius
                            style:
                              left: 56%
                              top: 10%
                              color: rgba(255,255,255,0.7)
                              '--mdc-icon-size': 14px
                          - type: icon
                            icon: mdi:chevron-right
                            style:
                              left: 60%
                              top: 10%
                              color: rgba(255,255,255,0.9)
                              '--mdc-icon-size': 50px
                            tap_action:
                              action: call-service
                              service: script.tesla_temp_moins_0_5
                          - type: image
                            entity: select.tesla_model_3_seat_heater_front_left
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 37%
                              top: 77%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_conducteur
                          - type: image
                            entity: select.tesla_model_3_seat_heater_front_right
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 38%
                              top: 42%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_passager
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_left
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 67%
                              top: 75%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_gauche
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_center
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 66%
                              top: 58%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_centre
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_right
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 65%
                              top: 42%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_droit
                    - type: conditional
                      conditions:
                        - entity: climate.tesla_model_3_climate
                          state: 'off'
                      card:
                        type: picture-elements
                        image: /local/tesla.clim.png
                        aspect_ratio: '16:9'
                        elements:
                          - type: state-label
                            entity: climate.tesla_model_3_climate
                            attribute: current_temperature
                            style:
                              left: 92%
                              top: 10%
                              color: white
                              font-size: 23px
                              font-weight: 700
                              text-shadow: 0px 0px 6px rgba(0,0,0,0.85)
                          - type: icon
                            icon: mdi:temperature-celsius
                            style:
                              left: 98%
                              top: 10%
                              color: rgba(255,255,255,0.8)
                              '--mdc-icon-size': 18px
                            tap_action:
                              action: more-info
                              entity: climate.tesla_model_3_climate
                          - type: icon
                            entity: climate.tesla_model_3_climate
                            icon: mdi:power
                            style:
                              left: 5%
                              top: 10%
                              '--mdc-icon-size': 53px
                            tap_action:
                              action: call-service
                              service: climate.toggle
                              target:
                                entity_id: climate.tesla_model_3_climate
                            hold_action:
                              action: more-info
                              entity: climate.tesla_model_3_climate
                            card_mod:
                              style: |
                                ha-state-icon, ha-icon {
                                  {% set s = states('climate.tesla_model_3_climate') %}
                                  color: {% if s in ['off','unavailable','unknown'] %}
                                    rgba(255,255,255,0.35)
                                  {% else %}
                                    rgb(255, 70, 70)
                                  {% endif %} !important;
                                  filter: {% if s in ['off','unavailable','unknown'] %}
                                    none
                                  {% else %}
                                    drop-shadow(0 0 6px rgba(255,0,0,0.85))
                                    drop-shadow(0 0 14px rgba(255,0,0,0.35))
                                  {% endif %};
                                  animation: {% if s in ['off','unavailable','unknown'] %}
                                    none
                                  {% else %}
                                    teslaPulse 1.6s ease-in-out infinite
                                  {% endif %};
                                  transform-origin: center;
                                }
                                @keyframes teslaPulse {
                                  0%   { transform: scale(1);    opacity: 0.85; }
                                  50%  { transform: scale(1.10); opacity: 1;    }
                                  100% { transform: scale(1);    opacity: 0.85; }
                                }
                          - type: icon
                            entity: switch.tesla_model_3_defrost
                            icon: mdi:snowflake
                            style:
                              left: 16%
                              top: 10%
                              '--mdc-icon-size': 43px
                            tap_action:
                              action: call-service
                              service: switch.toggle
                              target:
                                entity_id: switch.tesla_model_3_defrost
                            hold_action:
                              action: more-info
                              entity: switch.tesla_model_3_defrost
                            card_mod:
                              style: |
                                ha-state-icon, ha-icon {
                                  color: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    rgb(255, 70, 70)
                                  {% else %}
                                    rgba(255,255,255,0.35)
                                  {% endif %} !important;
                                  filter: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    drop-shadow(0 0 6px rgba(255,0,0,0.85))
                                    drop-shadow(0 0 14px rgba(255,0,0,0.35))
                                  {% else %}
                                    none
                                  {% endif %};
                                  animation: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    teslaPulseDef 1.6s ease-in-out infinite
                                  {% else %}
                                    none
                                  {% endif %};
                                  transform-origin: center;
                                }
                                @keyframes teslaPulseDef {
                                  0%   { transform: scale(1);    opacity: 0.85; }
                                  50%  { transform: scale(1.10); opacity: 1;    }
                                  100% { transform: scale(1);    opacity: 0.85; }
                                }
                          - type: icon
                            icon: mdi:chevron-left
                            style:
                              left: 42%
                              top: 10%
                              color: rgba(255,255,255,0.9)
                              '--mdc-icon-size': 50px
                            tap_action:
                              action: call-service
                              service: script.tesla_temp_plus_0_5
                          - type: state-label
                            entity: climate.tesla_model_3_climate
                            attribute: temperature
                            style:
                              left: 50%
                              top: 10%
                              color: rgba(255,255,255,0.95)
                              font-size: 20px
                              font-weight: 700
                              text-shadow: 0px 0px 6px rgba(0,0,0,0.85)
                          - type: icon
                            icon: mdi:temperature-celsius
                            style:
                              left: 56%
                              top: 10%
                              color: rgba(255,255,255,0.7)
                              '--mdc-icon-size': 14px
                          - type: icon
                            icon: mdi:chevron-right
                            style:
                              left: 60%
                              top: 10%
                              color: rgba(255,255,255,0.9)
                              '--mdc-icon-size': 50px
                            tap_action:
                              action: call-service
                              service: script.tesla_temp_moins_0_5
                          - type: image
                            entity: select.tesla_model_3_seat_heater_front_left
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 37%
                              top: 77%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_conducteur
                          - type: image
                            entity: select.tesla_model_3_seat_heater_front_right
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 38%
                              top: 42%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_passager
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_left
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 67%
                              top: 75%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_gauche
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_center
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 66%
                              top: 58%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_centre
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_right
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 65%
                              top: 42%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_droit
                    - type: conditional
                      conditions:
                        - entity: climate.tesla_model_3_climate
                          state: unavailable
                      card:
                        type: picture-elements
                        image: /local/tesla.clim.png
                        aspect_ratio: '16:9'
                        elements:
                          - type: state-label
                            entity: climate.tesla_model_3_climate
                            attribute: current_temperature
                            style:
                              left: 92%
                              top: 10%
                              color: white
                              font-size: 23px
                              font-weight: 700
                              text-shadow: 0px 0px 6px rgba(0,0,0,0.85)
                          - type: icon
                            icon: mdi:temperature-celsius
                            style:
                              left: 98%
                              top: 10%
                              color: rgba(255,255,255,0.8)
                              '--mdc-icon-size': 18px
                            tap_action:
                              action: more-info
                              entity: climate.tesla_model_3_climate
                          - type: icon
                            entity: climate.tesla_model_3_climate
                            icon: mdi:power
                            style:
                              left: 5%
                              top: 10%
                              '--mdc-icon-size': 53px
                            tap_action:
                              action: call-service
                              service: climate.toggle
                              target:
                                entity_id: climate.tesla_model_3_climate
                            hold_action:
                              action: more-info
                              entity: climate.tesla_model_3_climate
                            card_mod:
                              style: |
                                ha-state-icon, ha-icon {
                                  {% set s = states('climate.tesla_model_3_climate') %}
                                  color: {% if s in ['off','unavailable','unknown'] %}
                                    rgba(255,255,255,0.35)
                                  {% else %}
                                    rgb(255, 70, 70)
                                  {% endif %} !important;
                                  filter: {% if s in ['off','unavailable','unknown'] %}
                                    none
                                  {% else %}
                                    drop-shadow(0 0 6px rgba(255,0,0,0.85))
                                    drop-shadow(0 0 14px rgba(255,0,0,0.35))
                                  {% endif %};
                                  animation: {% if s in ['off','unavailable','unknown'] %}
                                    none
                                  {% else %}
                                    teslaPulse 1.6s ease-in-out infinite
                                  {% endif %};
                                  transform-origin: center;
                                }
                                @keyframes teslaPulse {
                                  0%   { transform: scale(1);    opacity: 0.85; }
                                  50%  { transform: scale(1.10); opacity: 1;    }
                                  100% { transform: scale(1);    opacity: 0.85; }
                                }
                          - type: icon
                            entity: switch.tesla_model_3_defrost
                            icon: mdi:snowflake
                            style:
                              left: 16%
                              top: 10%
                              '--mdc-icon-size': 43px
                            tap_action:
                              action: call-service
                              service: switch.toggle
                              target:
                                entity_id: switch.tesla_model_3_defrost
                            hold_action:
                              action: more-info
                              entity: switch.tesla_model_3_defrost
                            card_mod:
                              style: |
                                ha-state-icon, ha-icon {
                                  color: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    rgb(255, 70, 70)
                                  {% else %}
                                    rgba(255,255,255,0.35)
                                  {% endif %} !important;
                                  filter: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    drop-shadow(0 0 6px rgba(255,0,0,0.85))
                                    drop-shadow(0 0 14px rgba(255,0,0,0.35))
                                  {% else %}
                                    none
                                  {% endif %};
                                  animation: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    teslaPulseDef 1.6s ease-in-out infinite
                                  {% else %}
                                    none
                                  {% endif %};
                                  transform-origin: center;
                                }
                                @keyframes teslaPulseDef {
                                  0%   { transform: scale(1);    opacity: 0.85; }
                                  50%  { transform: scale(1.10); opacity: 1;    }
                                  100% { transform: scale(1);    opacity: 0.85; }
                                }
                          - type: icon
                            icon: mdi:chevron-left
                            style:
                              left: 42%
                              top: 10%
                              color: rgba(255,255,255,0.9)
                              '--mdc-icon-size': 50px
                            tap_action:
                              action: call-service
                              service: script.tesla_temp_plus_0_5
                          - type: state-label
                            entity: climate.tesla_model_3_climate
                            attribute: temperature
                            style:
                              left: 50%
                              top: 10%
                              color: rgba(255,255,255,0.95)
                              font-size: 20px
                              font-weight: 700
                              text-shadow: 0px 0px 6px rgba(0,0,0,0.85)
                          - type: icon
                            icon: mdi:temperature-celsius
                            style:
                              left: 56%
                              top: 10%
                              color: rgba(255,255,255,0.7)
                              '--mdc-icon-size': 14px
                          - type: icon
                            icon: mdi:chevron-right
                            style:
                              left: 60%
                              top: 10%
                              color: rgba(255,255,255,0.9)
                              '--mdc-icon-size': 50px
                            tap_action:
                              action: call-service
                              service: script.tesla_temp_moins_0_5
                          - type: image
                            entity: select.tesla_model_3_seat_heater_front_left
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 37%
                              top: 77%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_conducteur
                          - type: image
                            entity: select.tesla_model_3_seat_heater_front_right
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 38%
                              top: 42%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_passager
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_left
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 67%
                              top: 75%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_gauche
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_center
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 66%
                              top: 58%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_centre
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_right
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 65%
                              top: 42%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_droit
                    - type: conditional
                      conditions:
                        - entity: climate.tesla_model_3_climate
                          state: unknown
                      card:
                        type: picture-elements
                        image: /local/tesla.clim.png
                        aspect_ratio: '16:9'
                        elements:
                          - type: state-label
                            entity: climate.tesla_model_3_climate
                            attribute: current_temperature
                            style:
                              left: 92%
                              top: 10%
                              color: white
                              font-size: 23px
                              font-weight: 700
                              text-shadow: 0px 0px 6px rgba(0,0,0,0.85)
                          - type: icon
                            icon: mdi:temperature-celsius
                            style:
                              left: 98%
                              top: 10%
                              color: rgba(255,255,255,0.8)
                              '--mdc-icon-size': 18px
                            tap_action:
                              action: more-info
                              entity: climate.tesla_model_3_climate
                          - type: icon
                            entity: climate.tesla_model_3_climate
                            icon: mdi:power
                            style:
                              left: 5%
                              top: 10%
                              '--mdc-icon-size': 53px
                            tap_action:
                              action: call-service
                              service: climate.toggle
                              target:
                                entity_id: climate.tesla_model_3_climate
                            hold_action:
                              action: more-info
                              entity: climate.tesla_model_3_climate
                            card_mod:
                              style: |
                                ha-state-icon, ha-icon {
                                  {% set s = states('climate.tesla_model_3_climate') %}
                                  color: {% if s in ['off','unavailable','unknown'] %}
                                    rgba(255,255,255,0.35)
                                  {% else %}
                                    rgb(255, 70, 70)
                                  {% endif %} !important;
                                  filter: {% if s in ['off','unavailable','unknown'] %}
                                    none
                                  {% else %}
                                    drop-shadow(0 0 6px rgba(255,0,0,0.85))
                                    drop-shadow(0 0 14px rgba(255,0,0,0.35))
                                  {% endif %};
                                  animation: {% if s in ['off','unavailable','unknown'] %}
                                    none
                                  {% else %}
                                    teslaPulse 1.6s ease-in-out infinite
                                  {% endif %};
                                  transform-origin: center;
                                }
                                @keyframes teslaPulse {
                                  0%   { transform: scale(1);    opacity: 0.85; }
                                  50%  { transform: scale(1.10); opacity: 1;    }
                                  100% { transform: scale(1);    opacity: 0.85; }
                                }
                          - type: icon
                            entity: switch.tesla_model_3_defrost
                            icon: mdi:snowflake
                            style:
                              left: 16%
                              top: 10%
                              '--mdc-icon-size': 43px
                            tap_action:
                              action: call-service
                              service: switch.toggle
                              target:
                                entity_id: switch.tesla_model_3_defrost
                            hold_action:
                              action: more-info
                              entity: switch.tesla_model_3_defrost
                            card_mod:
                              style: |
                                ha-state-icon, ha-icon {
                                  color: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    rgb(255, 70, 70)
                                  {% else %}
                                    rgba(255,255,255,0.35)
                                  {% endif %} !important;
                                  filter: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    drop-shadow(0 0 6px rgba(255,0,0,0.85))
                                    drop-shadow(0 0 14px rgba(255,0,0,0.35))
                                  {% else %}
                                    none
                                  {% endif %};
                                  animation: {% if is_state('switch.tesla_model_3_defrost','on') %}
                                    teslaPulseDef 1.6s ease-in-out infinite
                                  {% else %}
                                    none
                                  {% endif %};
                                  transform-origin: center;
                                }
                                @keyframes teslaPulseDef {
                                  0%   { transform: scale(1);    opacity: 0.85; }
                                  50%  { transform: scale(1.10); opacity: 1;    }
                                  100% { transform: scale(1);    opacity: 0.85; }
                                }
                          - type: icon
                            icon: mdi:chevron-left
                            style:
                              left: 42%
                              top: 10%
                              color: rgba(255,255,255,0.9)
                              '--mdc-icon-size': 50px
                            tap_action:
                              action: call-service
                              service: script.tesla_temp_plus_0_5
                          - type: state-label
                            entity: climate.tesla_model_3_climate
                            attribute: temperature
                            style:
                              left: 50%
                              top: 10%
                              color: rgba(255,255,255,0.95)
                              font-size: 20px
                              font-weight: 700
                              text-shadow: 0px 0px 6px rgba(0,0,0,0.85)
                          - type: icon
                            icon: mdi:temperature-celsius
                            style:
                              left: 56%
                              top: 10%
                              color: rgba(255,255,255,0.7)
                              '--mdc-icon-size': 14px
                          - type: icon
                            icon: mdi:chevron-right
                            style:
                              left: 60%
                              top: 10%
                              color: rgba(255,255,255,0.9)
                              '--mdc-icon-size': 50px
                            tap_action:
                              action: call-service
                              service: script.tesla_temp_moins_0_5
                          - type: image
                            entity: select.tesla_model_3_seat_heater_front_left
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 37%
                              top: 77%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_conducteur
                          - type: image
                            entity: select.tesla_model_3_seat_heater_front_right
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 38%
                              top: 42%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_passager
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_left
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 67%
                              top: 75%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_gauche
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_center
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 66%
                              top: 58%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_centre
                          - type: image
                            entity: select.tesla_model_3_seat_heater_rear_right
                            image: /local/icons/seat_heat_off.svg
                            state_image:
                              'off': /local/icons/seat_heat_off.svg
                              low: /local/icons/seat_heat_low.svg
                              medium: /local/icons/seat_heat_medium.svg
                              high: /local/icons/seat_heat_high.svg
                            style:
                              left: 65%
                              top: 42%
                              width: 6%
                            tap_action:
                              action: call-service
                              service: script.tesla_cycle_siege_arriere_droit
          - show_icon: true
            show_primary: true
            show_secondary: true
            layout: horizontal
            tap_action:
              action: more-info
            icon_type: icon
            primary_info: name
            name: Pression
            entity: sensor.pression
            button_type: default
            card_type: tire
            sub_card:
              tire_card:
                background:
                  media_content_id: media-source://image_upload/504d2b73a9cd503bc02999ab8a71670a
                  media_content_type: image/png
                  metadata:
                    title: pngegg (1).png
                    thumbnail: /api/image/serve/504d2b73a9cd503bc02999ab8a71670a/256x256
                    media_class: image
                    children_media_class: null
                    navigateIds:
                      - {}
                      - media_content_type: app
                        media_content_id: media-source://image_upload
                front_left:
                  entity: sensor.tesla_model_3_pression_pneu_avant_gauche
                  name: Avant gauche
                front_right:
                  entity: sensor.tesla_model_3_pression_pneu_avant_droit
                  name: avant droit
                rear_left:
                  entity: sensor.tesla_model_3_pression_pneu_arriere_gauche
                  name: arriere gauche
                rear_right:
                  entity: sensor.tesla_model_3_pression_pneu_arriere_droit
                  name: arriere droit
          - show_icon: true
            show_primary: true
            show_secondary: true
            layout: horizontal
            tap_action:
              action: more-info
            card_type: custom
            icon_type: icon
            primary_info: name
            name: Portes & Coffres
            entity: lock.tesla_model_3_lock
            button_type: default
            sub_card:
              custom_card:
                - type: picture-elements
                  image: /local/Teslatop3.png
                  aspect_ratio: '735:735'
                  elements:
                    - type: custom:button-card
                      entity: lock.tesla_model_3_lock
                      name: PORTES
                      show_name: true
                      show_state: true
                      show_icon: true
                      icon: mdi:lock
                      state:
                        - value: unlocked
                          state_display: Ouvertes
                          icon: mdi:lock-open
                          styles:
                            icon:
                              - color: red
                            name:
                              - color: red
                            state:
                              - color: red
                        - value: locked
                          state_display: Fermées
                          icon: mdi:lock
                          styles:
                            icon:
                              - color: rgba(255,255,255,0.9)
                            name:
                              - color: rgba(255,255,255,0.85)
                            state:
                              - color: rgba(255,255,255,0.75)
                      styles:
                        card:
                          - background: transparent
                          - box-shadow: none
                          - padding: 6px
                        grid:
                          - grid-template-areas: '"i" "n" "s"'
                          - grid-template-rows: 30px min-content min-content
                        name:
                          - font-size: 11px
                          - font-weight: 700
                          - letter-spacing: 0.8px
                        state:
                          - font-size: 11px
                          - font-weight: 600
                      tap_action:
                        action: call-service
                        service: lock.toggle
                        target:
                          entity_id: lock.tesla_model_3_lock
                      style:
                        left: 12%
                        top: 9%
                        width: 22%
                    - type: custom:button-card
                      entity: binary_sensor.tesla_model_3_porte_avant_conducteur
                      show_icon: false
                      show_name: false
                      show_state: true
                      state_display: |
                        [[[
                          const open = entity.state === "on";
                          return `
                            <div style="text-align:center; line-height:1.15;">
                              <div style="font-size:12px;font-weight:600;letter-spacing:0.6px;color:${open?'red':'rgba(255,255,255,0.8)'};">Porte</div>
                              <div style="font-size:12px;font-weight:700;letter-spacing:1px;color:${open?'red':'rgba(255,255,255,0.95)'};">AVANT GAUCHE</div>
                              <div style="font-size:12px;font-weight:600;letter-spacing:0.6px;color:${open?'red':'rgba(255,255,255,0.8)'};">${open?'Ouverte':'Fermée'}</div>
                            </div>`;
                        ]]]
                      styles:
                        card:
                          - background: transparent
                          - box-shadow: none
                      style:
                        left: 19%
                        top: 47%
                        width: 30%
                    - type: custom:button-card
                      entity: binary_sensor.tesla_model_3_porte_avant_passager
                      show_icon: false
                      show_name: false
                      show_state: true
                      state_display: |
                        [[[
                          const open = entity.state === "on";
                          return `
                            <div style="text-align:center; line-height:1.15;">
                              <div style="font-size:12px;font-weight:600;letter-spacing:0.6px;color:${open?'red':'rgba(255,255,255,0.8)'};">Porte</div>
                              <div style="font-size:12px;font-weight:700;letter-spacing:1px;color:${open?'red':'rgba(255,255,255,0.95)'};">AVANT DROIT</div>
                              <div style="font-size:12px;font-weight:600;letter-spacing:0.6px;color:${open?'red':'rgba(255,255,255,0.8)'};">${open?'Ouverte':'Fermée'}</div>
                            </div>`;
                        ]]]
                      styles:
                        card:
                          - background: transparent
                          - box-shadow: none
                      style:
                        left: 81%
                        top: 47%
                        width: 30%
                    - type: custom:button-card
                      entity: binary_sensor.tesla_model_3_porte_arriere_conducteur
                      show_icon: false
                      show_name: false
                      show_state: true
                      state_display: |
                        [[[
                          const open = entity.state === "on";
                          return `
                            <div style="text-align:center; line-height:1.15;">
                              <div style="font-size:12px;font-weight:600;letter-spacing:0.6px;color:${open?'red':'rgba(255,255,255,0.8)'};">Porte</div>
                              <div style="font-size:12px;font-weight:700;letter-spacing:1px;color:${open?'red':'rgba(255,255,255,0.95)'};">ARRIÈRE GAUCHE</div>
                              <div style="font-size:12px;font-weight:600;letter-spacing:0.6px;color:${open?'red':'rgba(255,255,255,0.8)'};">${open?'Ouverte':'Fermée'}</div>
                            </div>`;
                        ]]]
                      styles:
                        card:
                          - background: transparent
                          - box-shadow: none
                      style:
                        left: 19%
                        top: 66%
                        width: 34%
                    - type: custom:button-card
                      entity: binary_sensor.tesla_model_3_porte_arriere_passager
                      show_icon: false
                      show_name: false
                      show_state: true
                      state_display: |
                        [[[
                          const open = entity.state === "on";
                          return `
                            <div style="text-align:center; line-height:1.15;">
                              <div style="font-size:12px;font-weight:600;letter-spacing:0.6px;color:${open?'red':'rgba(255,255,255,0.8)'};">Porte</div>
                              <div style="font-size:12px;font-weight:700;letter-spacing:1px;color:${open?'red':'rgba(255,255,255,0.95)'};">ARRIÈRE DROIT</div>
                              <div style="font-size:12px;font-weight:600;letter-spacing:0.6px;color:${open?'red':'rgba(255,255,255,0.8)'};">${open?'Ouverte':'Fermée'}</div>
                            </div>`;
                        ]]]
                      styles:
                        card:
                          - background: transparent
                          - box-shadow: none
                      style:
                        left: 81%
                        top: 66%
                        width: 34%
                    - type: custom:button-card
                      entity: cover.tesla_model_3_trappe_de_charge
                      show_icon: true
                      show_name: false
                      show_state: true
                      icon: mdi:ev-plug-tesla
                      state_display: |
                        [[[
                          return `CHARGE<br>${entity.state === "open" ? "OUVERTE" : "FERMÉE"}`;
                        ]]]
                      styles:
                        card:
                          - background: transparent
                          - box-shadow: none
                        icon:
                          - width: 24px
                          - margin-bottom: 4px
                          - color: |
                              [[[
                                return entity.state === "open"
                                  ? "red"
                                  : "rgba(255,255,255,0.9)";
                              ]]]
                        state:
                          - font-size: 12px
                          - font-weight: 700
                          - text-align: center
                          - color: |
                              [[[
                                return entity.state === "open"
                                  ? "red"
                                  : "rgba(255,255,255,0.85)";
                              ]]]
                      style:
                        left: 20%
                        top: 86%
                        width: 22%
          - show_icon: true
            show_primary: true
            show_secondary: true
            layout: horizontal
            button_type: action
            card_type: default
            icon_type: icon
            primary_info: name
            name: WAKE
            entity: button.tesla_model_3_wake
            tap_action:
              action: toggle
        indicator_rows:
          - row_items:
              - type: entity
                show_name: true
                show_state: true
                show_icon: true
                show_entity_picture: false
                include_state_template: false
                tap_action:
                  action: more-info
                entity: binary_sensor.tesla_model_3_status
                name: Statut
                ignore_global: false
              - type: entity
                show_name: true
                show_state: true
                show_icon: true
                show_entity_picture: false
                include_state_template: false
                tap_action:
                  action: more-info
                entity: sensor.tesla_model_3_charging
              - type: entity
                show_name: true
                show_state: true
                show_icon: true
                show_entity_picture: false
                include_state_template: false
                tap_action:
                  action: more-info
                entity: switch.tesla_model_3_sentry_mode_2
        card_mod:
          style: |
            ha-card {
              background: rgba(20, 27, 38, 0.6) !important;
              backdrop-filter: blur(10px) !important;
              -webkit-backdrop-filter: blur(10px) !important;
              border-radius: 20px !important;
              border: 1px solid rgba(255,255,255,0.1) !important;
              box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
            }
            .vsc-range-info-row, .vsc-indicators-row, .vsc-buttons-grid {
              background: transparent !important;
            }
            /* Ensure internal buttons in swipes are also glass-friendly */
            .vsc-button-card {
              background: rgba(255,255,255,0.05) !important;
              border-radius: 12px !important;
            }
    title: Tesla Modele 3
    subview: true
  - type: sections
    max_columns: 3
    title: Imprimante 3D
    path: imprimante
    icon: ''
    sections:
      - type: grid
        cards:
          - type: picture-elements
            image: /local/blank.png
            elements:
              - type: image
                entity: camera.vminion
                camera_image: camera.vminion
                camera_view: live
                style:
                  left: 50%
                  top: 50%
                  width: 100%
                  height: 100%
                  transform: translate(-50%, -50%)
              - type: image
                image: /local/VMINION.png
                style:
                  left: '-4%'
                  top: 98%
                  width: 150px
                  transform: translate(-0%, -100%)
                  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.55))
                  opacity: 0.7
                  pointer-events: none
              - type: custom:button-card
                name: |
                  [[[
                    const x = Number(String(states['sensor.ratrig_vminion_toolhead_position_x']?.state ?? '0').replace(',', '.')) || 0;
                    const y = Number(String(states['sensor.ratrig_vminion_toolhead_position_y']?.state ?? '0').replace(',', '.')) || 0;
                    const z = Number(String(states['sensor.ratrig_vminion_toolhead_position_z']?.state ?? '0').replace(',', '.')) || 0;
                    return `X ${x.toFixed(1)}   Y ${y.toFixed(1)}   Z ${z.toFixed(2)} mm`;
                  ]]]
                show_icon: false
                show_name: true
                styles:
                  card:
                    - background: rgba(10,12,16,0.45)
                    - border: 1px solid rgba(255,255,255,0.12)
                    - border-radius: 12px
                    - padding: 8px 12px
                    - box-shadow: 0 10px 20px rgba(0,0,0,0.55)
                    - backdrop-filter: blur(6px)
                  name:
                    - color: white
                    - font-weight: 700
                    - font-size: 13px
                    - text-shadow: 0 2px 10px rgba(0,0,0,0.85)
                style:
                  top: 8%
                  left: 50%
                  transform: translate(-50%, -50%)
          - type: custom:button-card
            card_mod:
              style: |
                ha-card{
                  border-radius: 6px;
                  overflow: hidden;
                  padding: 12px;
                  position: relative;
                  background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%) !important;
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65) !important;
                  border: 1px solid rgba(255,255,255,0.04) !important;
                }
                ha-card:before{
                  content:"";
                  position:absolute;
                  inset:0;
                  background: radial-gradient(circle at top left,rgba(255,255,255,0.14),transparent 60%);
                  pointer-events:none;
                  z-index:0;
            entity: sensor.ratrig_vminion_printer_state
            show_state: true
            show_icon: false
            show_name: false
            styles:
              card:
                - padding: 12px
                - border-radius: 5px
                - overflow: hidden
                - min-height: 150px
                - position: relative
                - background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%)
                - box-shadow: 0 10px 22px rgba(0,0,0,0.65)
                - border: 1px solid rgba(255,255,255,0.04)
              state:
                - position: absolute
                - z-index: 4
                - top: 10px
                - left: 14px
                - font-size: 12px
                - font-weight: 800
                - opacity: 0.95
                - color: rgba(255,255,255,0.92)
                - text-shadow: 0 2px 10px rgba(0,0,0,0.65)
              custom_fields:
                lines:
                  - position: absolute
                  - left: 14px
                  - right: 14px
                  - top: 36px
                  - bottom: 12px
                  - z-index: 5
            custom_fields:
              lines: |
                [[[
                  const tHot = Number(String(states['sensor.ratrig_vminion_extruder_temperature']?.state ?? '0').replace(',', '.')) || 0;
                  const tBed = Number(String(states['sensor.ratrig_vminion_bed_temperature']?.state ?? '0').replace(',', '.')) || 0;

                  const fanRaw = states['sensor.ratrig_vminion_toolhead_cooling_fan']?.state ?? '0';
                  const fanN = Number(String(fanRaw).replace(',', '.'));
                  let fanPct = isFinite(fanN) ? fanN : 0;
                  if (fanPct > 0 && fanPct <= 1) fanPct = fanPct * 100;
                  fanPct = Math.max(0, Math.min(100, fanPct));

                  const clamp = (v) => Math.max(0, Math.min(100, v));

                  const pctHot = clamp((tHot / 350) * 100);
                  const pctBed = clamp((tBed / 130) * 100);

                  const colorHot = (temp) => {
                    let c = 'rgba(0,180,255,0.90)';
                    if (temp >= 60)  c = 'rgba(0,220,140,0.88)';
                    if (temp >= 150) c = 'rgba(255,215,0,0.84)';
                    if (temp >= 210) c = 'rgba(255,140,0,0.82)';
                    if (temp >= 240) c = 'rgba(220,80,80,0.78)';
                    return c;
                  };

                  const colorBed = (temp) => {
                    let c = 'rgba(0,180,255,0.90)';
                    if (temp >= 30) c = 'rgba(0,220,140,0.88)';
                    if (temp >= 50) c = 'rgba(255,215,0,0.84)';
                    if (temp >= 70) c = 'rgba(255,140,0,0.82)';
                    if (temp >= 85) c = 'rgba(220,80,80,0.78)';
                    return c;
                  };

                  const bar = ({icon, label, value, pct, color, thin=false}) => `
                    <div style="
                      display:grid;
                      grid-template-columns: 22px 1fr auto;
                      align-items:center;
                      gap:10px;
                    ">
                      <ha-icon icon="${icon}" style="
                        width:20px;height:20px;
                        color: rgba(255,255,255,0.92);
                        filter: drop-shadow(0 0 8px rgba(0,0,0,0.6));
                      "></ha-icon>

                      <div style="
                        position:relative;
                        height:${thin ? 8 : 12}px;
                        border-radius:999px;
                        background: rgba(255,255,255,0.14);
                        overflow:hidden;
                        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);
                      ">
                        <div style="
                          position:absolute; left:0; top:0; bottom:0;
                          width:${pct}%;
                          background:${color};
                          transition: width 0.6s ease, background 0.25s ease;
                          border-radius:999px;
                          box-shadow: 0 0 14px rgba(0,0,0,0.25);
                        "></div>
                        <div style="
                          position:absolute; inset:0;
                          background: linear-gradient(to bottom, rgba(255,255,255,0.35), rgba(255,255,255,0.05));
                          opacity:0.40;
                        "></div>
                      </div>

                      <div style="
                        font-size:12px;
                        font-weight:900;
                        color: rgba(255,255,255,0.95);
                        text-shadow: 0 2px 10px rgba(0,0,0,0.65);
                        white-space:nowrap;
                      ">${label} ${value}</div>
                    </div>
                  `;

                  return `
                    <div style="display:flex;flex-direction:column;gap:10px;">
                      ${bar({
                        icon:'mdi:printer-3d-nozzle',
                        label:'Hotend',
                        value:`${tHot.toFixed(1)}°C`,
                        pct:pctHot,
                        color:colorHot(tHot),
                        thin:false
                      })}
                      ${bar({
                        icon:'mdi:radiator',
                        label:'Bed',
                        value:`${tBed.toFixed(1)}°C`,
                        pct:pctBed,
                        color:colorBed(tBed),
                        thin:false
                      })}
                      ${bar({
                        icon:'mdi:fan',
                        label:'Fan',
                        value:`${fanPct.toFixed(0)}%`,
                        pct:fanPct,
                        color:'rgba(0,170,255,0.85)',
                        thin:true
                      })}
                    </div>
                  `;
                ]]]
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card{
                  border-radius: 6px;
                  overflow: hidden;
                  padding: 12px;
                  position: relative;
                  background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%) !important;
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65) !important;
                  border: 1px solid rgba(255,255,255,0.04) !important;
                }
                ha-card:before{
                  content:"";
                  position:absolute;
                  inset:0;
                  background: radial-gradient(circle at top left,rgba(255,255,255,0.14),transparent 60%);
                  pointer-events:none;
                  z-index:0;
                }
            card:
              type: custom:button-card
              entity: number.ratrig_vminion_fan_speed
              show_icon: false
              show_name: false
              show_state: false
              styles:
                card:
                  - background: transparent
                  - border: none
                  - box-shadow: none
                  - padding: 0
                  - height: 76px
                grid:
                  - grid-template-areas: '"top" "slider"'
                  - grid-template-columns: 1fr
                  - grid-template-rows: min-content min-content
                  - row-gap: 10px
                custom_fields:
                  top:
                    - width: 100%
                  slider:
                    - width: 100%
              custom_fields:
                top: |
                  [[[
                    const raw = states['number.ratrig_vminion_fan_speed']?.state ?? '0';
                    const n = Number(String(raw).replace(',', '.'));
                    const v = Number.isFinite(n) ? Math.round(n) : 0;

                    return `
                      <div style="width:100%;display:flex;align-items:center;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:10px;min-width:0;">
                          <ha-icon icon="mdi:fan" style="
                            width:22px;height:22px;flex:0 0 auto;
                            color: rgba(255,255,255,0.92);
                            filter: drop-shadow(0 0 8px rgba(255,255,255,0.15));
                          "></ha-icon>
                          <div style="
                            white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
                            font-size:13px;font-weight:800;
                            color: rgba(255,255,255,0.95);
                            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
                          ">Material Fan</div>
                        </div>

                        <div style="
                          font-size:13px;font-weight:900;
                          color: rgba(255,255,255,0.95);
                          text-shadow: 0 2px 10px rgba(0,0,0,0.8);
                        ">${v} %</div>
                      </div>
                    `;
                  ]]]
                slider: |
                  [[[
                    const ent = 'number.ratrig_vminion_fan_speed';
                    const raw = states[ent]?.state ?? '0';
                    const n = Number(String(raw).replace(',', '.'));
                    const v = Number.isFinite(n) ? Math.max(0, Math.min(100, Math.round(n))) : 0;

                    const bg = `linear-gradient(90deg,
                      rgba(0,170,255,0.95) 0%,
                      rgba(0,170,255,0.95) ${v}%,
                      rgba(255,255,255,0.12) ${v}%,
                      rgba(255,255,255,0.12) 100%)`;

                    return `
                      <div style="
                        width:100%;
                        padding: 10px 2px 12px;   /* + bas pour le thumb */
                        overflow: visible;        /* important */
                        box-sizing: border-box;
                      ">
                        <input
                          type="range"
                          min="0"
                          max="100"
                          step="1"
                          value="${v}"
                          style="
                            width:100%;
                            -webkit-appearance:none;
                            appearance:none;
                            height:8px;
                            border-radius:999px;
                            background:${bg};
                            outline:none;
                            margin:0;
                            overflow: visible;
                          "
                          oninput="
                            const val = Number(this.value);
                            this.style.background = 'linear-gradient(90deg, rgba(0,170,255,0.95) 0%, rgba(0,170,255,0.95) ' + val + '%, rgba(255,255,255,0.12) ' + val + '%, rgba(255,255,255,0.12) 100%)';
                          "
                          onchange="
                            const val = Number(this.value);
                            this.getRootNode().host.dispatchEvent(new CustomEvent('hass-call-service', {
                              bubbles:true, composed:true,
                              detail:{ domain:'number', service:'set_value', serviceData:{ entity_id:'${ent}', value: val } }
                            }));
                          "
                        />
                        <style>
                          input[type=range]::-webkit-slider-thumb{
                            -webkit-appearance:none; appearance:none;
                            width:18px;height:18px;border-radius:50%;
                            background: rgba(255,255,255,0.95);
                            box-shadow: 0 6px 14px rgba(0,0,0,0.45);
                            border: 1px solid rgba(255,255,255,0.25);
                            margin-top: -5px; /* centre le thumb sur la piste */
                          }
                          input[type=range]::-moz-range-thumb{
                            width:18px;height:18px;border-radius:50%;
                            background: rgba(255,255,255,0.95);
                            box-shadow: 0 6px 14px rgba(0,0,0,0.45);
                            border: 1px solid rgba(255,255,255,0.25);
                          }
                          input[type=range]::-moz-range-track{
                            height:8px;
                            border-radius:999px;
                            background: transparent;
                          }
                        </style>
                      </div>
                    `;
                  ]]]
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card {
                  border-radius: 6px;
                  overflow: hidden;
                  padding: 12px;
                  position: relative;
                  background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%) !important;
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65) !important;
                  border: 1px solid rgba(255,255,255,0.04) !important;
                }

                /* Glossy highlight Apple (comme tes autres cards) */
                ha-card:before {
                  content:"";
                  position:absolute;
                  inset:0;
                  background: radial-gradient(circle at top left,rgba(255,255,255,0.14),transparent 60%);
                  pointer-events:none;
                  z-index: 0;
                }
            card:
              type: custom:button-card
              entity: sensor.ratrig_vminion_current_print_state
              name: RatRig V-Minion
              show_icon: false
              show_state: false
              styles:
                card:
                  - position: relative
                  - height: 170px
                  - padding: 0
                  - background: transparent
                  - box-shadow: none
                  - border: none
                name:
                  - position: absolute
                  - top: 10px
                  - left: 14px
                  - z-index: 3
                  - font-size: 14px
                  - font-weight: 800
                  - color: rgba(255,255,255,0.95)
                  - text-shadow: 0 2px 10px rgba(0,0,0,0.8)
                custom_fields:
                  status:
                    - position: absolute
                    - top: 12px
                    - right: 14px
                    - z-index: 3
                    - font-size: 12px
                    - font-weight: 800
                    - padding: 4px 8px
                    - border-radius: 10px
                    - color: rgba(255,255,255,0.95)
                    - text-shadow: 0 2px 8px rgba(0,0,0,0.9)
                  controls:
                    - position: absolute
                    - left: 14px
                    - top: 36px
                    - z-index: 4
                  progress:
                    - position: absolute
                    - left: 14px
                    - right: 14px
                    - bottom: 60px
                    - z-index: 3
                  meta:
                    - position: absolute
                    - left: 14px
                    - right: 14px
                    - bottom: 6px
                    - z-index: 3
                    - font-size: 12px
                    - font-weight: 700
                    - color: rgba(255,255,255,0.92)
                    - text-shadow: 0 2px 8px rgba(0,0,0,0.85)
              custom_fields:
                status: |
                  [[[
                    const st = states['sensor.ratrig_vminion_current_print_state']?.state ?? 'unknown';
                    const map = {
                      printing:  { label:'Impression',  bg:'rgba(0,170,255,0.28)', border:'rgba(0,170,255,0.55)' },
                      paused:    { label:'Pause',      bg:'rgba(255,180,0,0.25)', border:'rgba(255,180,0,0.55)' },
                      complete:  { label:'Terminé',    bg:'rgba(70,210,120,0.22)', border:'rgba(70,210,120,0.55)' },
                      standby:   { label:'Standby',    bg:'rgba(255,255,255,0.12)', border:'rgba(255,255,255,0.22)' },
                      error:     { label:'Erreur',     bg:'rgba(220,70,70,0.22)', border:'rgba(220,70,70,0.55)' },
                      cancelled: { label:'Annulé',     bg:'rgba(220,70,70,0.18)', border:'rgba(220,70,70,0.45)' },
                    };
                    const o = map[st] || { label: st, bg:'rgba(255,255,255,0.10)', border:'rgba(255,255,255,0.18)' };
                    return `<span style="
                      display:inline-block;
                      padding:4px 8px;
                      border-radius:10px;
                      background:${o.bg};
                      border:1px solid ${o.border};
                      box-shadow:0 6px 14px rgba(0,0,0,0.35);
                    ">${o.label}</span>`;
                  ]]]
                controls: |
                  [[[
                    const st = states['sensor.ratrig_vminion_current_print_state']?.state ?? 'unknown';
                    const canPause = (st === 'printing');
                    const canResume = (st === 'paused');
                    const label = canResume ? 'Reprendre' : 'Pause';
                    const icon  = canResume ? 'mdi:play' : 'mdi:pause';
                    const action = canResume ? 'button.ratrig_vminion_resume_print' : 'button.ratrig_vminion_pause_print';
                    const disabled = !(canPause || canResume);

                    const bg = disabled ? 'rgba(255,255,255,0.10)' : 'rgba(255,255,255,0.18)';
                    const bd = disabled ? 'rgba(255,255,255,0.14)' : 'rgba(255,255,255,0.25)';

                    return `
                      <div style="display:flex;gap:10px;align-items:center;">
                        <div style="
                          display:inline-flex;align-items:center;gap:8px;
                          padding:8px 12px;border-radius:999px;
                          background:${bg};border:1px solid ${bd};
                          box-shadow:0 10px 24px rgba(0,0,0,0.35);
                          cursor:${disabled ? 'default' : 'pointer'};
                          user-select:none;
                        " onclick="
                          if(!${disabled}) {
                            this.closest('ha-card').dispatchEvent(new CustomEvent('hass-call-service', {
                              bubbles:true, composed:true,
                              detail:{ domain:'button', service:'press', serviceData:{ entity_id:'${action}' } }
                            }));
                          }
                        ">
                          <ha-icon icon="${icon}" style="
                            width:18px;height:18px;color:rgba(255,255,255,0.95);
                            filter: drop-shadow(0 0 6px rgba(0,0,0,0.8));
                          "></ha-icon>
                          <span style="font-size:12px;font-weight:800;color:rgba(255,255,255,0.95);">${label}</span>
                        </div>

                        <div style="
                          display:inline-flex;align-items:center;justify-content:center;
                          width:38px;height:38px;border-radius:12px;
                          background:rgba(220,70,70,0.20);
                          border:1px solid rgba(220,70,70,0.55);
                          box-shadow:0 10px 24px rgba(0,0,0,0.35);
                          cursor:pointer;user-select:none;
                        " onclick="
                          this.closest('ha-card').dispatchEvent(new CustomEvent('hass-call-service', {
                            bubbles:true, composed:true,
                            detail:{ domain:'button', service:'press', serviceData:{ entity_id:'button.ratrig_vminion_cancel_print' } }
                          }));
                        ">
                          <ha-icon icon="mdi:stop" style="
                            width:20px;height:20px;color:rgba(255,255,255,0.95);
                            filter: drop-shadow(0 0 6px rgba(0,0,0,0.8));
                          "></ha-icon>
                        </div>
                      </div>
                    `;
                  ]]]
                progress: |
                  [[[
                    const p = parseFloat(states['sensor.ratrig_vminion_progress']?.state ?? '0') || 0;
                    const pct = Math.max(0, Math.min(100, p));
                    const glow = pct > 0 ? `0 0 14px rgba(0,255,180,0.35)` : 'none';

                    return `
                      <div style="width:100%;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                          <div style="font-size:12px;font-weight:800;color:rgba(255,255,255,0.95);text-shadow:0 2px 8px rgba(0,0,0,0.85);">
                            Progression
                          </div>
                          <div style="font-size:12px;font-weight:900;color:rgba(255,255,255,0.95);">
                            ${pct.toFixed(1)}%
                          </div>
                        </div>

                        <div style="height:12px;border-radius:999px;background:rgba(255,255,255,0.16);overflow:hidden;box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);">
                          <div style="
                            width:${pct}%;
                            height:100%;
                            border-radius:999px;
                            background: linear-gradient(90deg, rgba(0,255,170,0.95), rgba(0,170,255,0.95));
                            box-shadow: ${glow};
                            transition: width 0.6s ease;
                            position: relative;
                          ">
                            <div style="
                              position:absolute;inset:0;
                              background: linear-gradient(to bottom, rgba(255,255,255,0.40), rgba(255,255,255,0.05));
                              opacity:0.55;
                            "></div>
                          </div>
                        </div>
                      </div>
                    `;
                  ]]]
                meta: |
                  [[[
                    const leftH = parseFloat(states['sensor.ratrig_vminion_print_time_left']?.state ?? '0') || 0;
                    const leftMin = Math.round(leftH * 60);

                    const eta = states['sensor.ratrig_vminion_print_eta']?.state ?? 'unknown';
                    const etaTxt = (eta && eta !== 'unknown')
                      ? new Date(eta).toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' })
                      : '—';

                    const fmtDur = (m) => {
                      if (!isFinite(m) || m <= 0) return '—';
                      const h = Math.floor(m/60);
                      const mm = Math.round(m%60);
                      return h > 0 ? `${h}h${String(mm).padStart(2,'0')}` : `${mm} min`;
                    };

                    // --- Filament utilisé ---
                    const fu = states['sensor.ratrig_vminion_filament_used'];
                    const raw = (fu?.state ?? '').toString().replace(',', '.');
                    const unit = (fu?.attributes?.unit_of_measurement ?? '').toString();
                    const n = Number(raw);

                    let filamentTxt = '—';
                    if (isFinite(n)) {
                      if (unit.toLowerCase() === 'mm') filamentTxt = `${(n/1000).toFixed(2)} m`;
                      else if (unit.toLowerCase() === 'm') filamentTxt = `${n.toFixed(2)} m`;
                      else if (unit) filamentTxt = `${n.toFixed(2)} ${unit}`;
                      else filamentTxt = `${n.toFixed(2)}`;
                    } else if (raw) {
                      filamentTxt = unit ? `${raw} ${unit}` : raw;
                    }

                    return `
                      <div style="display:flex;gap:14px;flex-wrap:wrap;">
                        <div>⏳ Restant <b>${fmtDur(leftMin)}</b></div>
                        <div>🕒 ETA <b>${etaTxt}</b></div>
                        <div>🧵 Filament <b>${filamentTxt}</b></div>
                      </div>
                    `;
                  ]]]
      - type: grid
        cards:
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card {
                  border-radius: 5px;
                  overflow: hidden;
                  padding: 12px;
                  position: relative;
                  background: linear-gradient(160deg,
                    #141b26 0%,
                    #111826 45%,
                    #0d121c 100%);
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65);
                  border: 1px solid rgba(255,255,255,0.04);
                }

                /* Glossy highlight Apple */
                ha-card:before {
                  content: "";
                  position: absolute;
                  inset: 0;
                  background: radial-gradient(circle at top left,
                    rgba(255,255,255,0.14),
                    transparent 60%);
                  pointer-events: none;
                }
            card:
              type: grid
              title: Contrôle impression
              columns: 4
              square: false
              cards:
                - type: custom:button-card
                  entity: button.ratrig_vminion_pause_print
                  name: Pause
                  icon: mdi:pause
                  styles:
                    card:
                      - padding: 10px
                      - border-radius: 10px
                      - background: linear-gradient(145deg,#202a38,#161d29)
                      - box-shadow: >-
                          inset 0 1px 0 rgba(255,255,255,0.08), 0 4px 12px
                          rgba(0,0,0,0.6)
                    icon:
                      - color: rgba(255,215,0,0.95)
                      - filter: drop-shadow(0 0 8px rgba(255,215,0,0.45))
                    name:
                      - color: rgba(255,215,0,0.95)
                      - font-weight: 700
                - type: custom:button-card
                  entity: button.ratrig_vminion_resume_print
                  name: Reprendre
                  icon: mdi:play
                  styles:
                    card:
                      - padding: 10px
                      - border-radius: 10px
                      - background: linear-gradient(145deg,#202a38,#161d29)
                      - box-shadow: >-
                          inset 0 1px 0 rgba(255,255,255,0.08), 0 4px 12px
                          rgba(0,0,0,0.6)
                    icon:
                      - color: rgba(70,210,120,0.95)
                      - filter: drop-shadow(0 0 8px rgba(70,210,120,0.45))
                    name:
                      - color: rgba(70,210,120,0.95)
                      - font-weight: 700
                - type: custom:button-card
                  entity: button.ratrig_vminion_cancel_print
                  name: Stop
                  icon: mdi:stop
                  styles:
                    card:
                      - padding: 10px
                      - border-radius: 10px
                      - background: linear-gradient(145deg,#202a38,#161d29)
                      - box-shadow: >-
                          inset 0 1px 0 rgba(255,255,255,0.08), 0 4px 12px
                          rgba(0,0,0,0.6)
                    icon:
                      - color: rgba(255,140,0,0.95)
                      - filter: drop-shadow(0 0 8px rgba(255,140,0,0.45))
                    name:
                      - color: rgba(255,140,0,0.95)
                      - font-weight: 700
                - type: custom:button-card
                  entity: button.ratrig_vminion_emergency_stop
                  name: URGENCE
                  icon: mdi:alert-octagon
                  styles:
                    card:
                      - padding: 10px
                      - border-radius: 10px
                      - background: linear-gradient(145deg,#2a0f14,#16060a)
                      - box-shadow: >-
                          0 0 18px rgba(255,0,0,0.35), inset 0 1px 0
                          rgba(255,255,255,0.05)
                    icon:
                      - color: rgba(255,80,80,1)
                      - filter: drop-shadow(0 0 12px rgba(255,0,0,0.75))
                    name:
                      - color: rgba(255,80,80,1)
                      - font-weight: 900
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card {
                  border-radius: 5px;
                  overflow: hidden;
                  padding: 12px;
                  position: relative;
                  background: linear-gradient(160deg,
                    #141b26 0%,
                    #111826 45%,
                    #0d121c 100%);
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65);
                  border: 1px solid rgba(255,255,255,0.04);
                }
                ha-card:before {
                  content: "";
                  position: absolute;
                  inset: 0;
                  background: radial-gradient(circle at top left,
                    rgba(255,255,255,0.14),
                    transparent 60%);
                  pointer-events: none;
                }
            card:
              type: grid
              title: Homing
              columns: 4
              square: false
              cards:
                - type: custom:button-card
                  entity: button.ratrig_vminion_home_all_axes
                  name: ALL
                  icon: mdi:axis-arrow
                  show_state: false
                  tap_action:
                    action: call-service
                    service: button.press
                    target:
                      entity_id: button.ratrig_vminion_home_all_axes
                  hold_action:
                    action: more-info
                  custom_fields:
                    pos: '&nbsp;'
                  styles:
                    grid:
                      - grid-template-areas: '"pos" "i" "n"'
                      - grid-template-rows: min-content 1fr min-content
                    custom_fields:
                      pos:
                        - font-size: 13px
                        - font-weight: 700
                        - text-align: center
                        - opacity: 0
                    card:
                      - padding: 10px
                      - border-radius: 10px
                    icon:
                      - color: rgba(255,255,255,0.85)
                      - filter: drop-shadow(0 0 6px rgba(0,0,0,0.7))
                    name:
                      - opacity: 0.9
                - type: custom:button-card
                  entity: button.ratrig_vminion_home_x_axis
                  name: X
                  icon: mdi:axis-x-arrow
                  show_state: false
                  tap_action:
                    action: call-service
                    service: button.press
                    target:
                      entity_id: button.ratrig_vminion_home_x_axis
                  hold_action:
                    action: more-info
                  custom_fields:
                    pos: |
                      [[[
                        const s = states['sensor.ratrig_vminion_toolhead_position_x'];
                        const v = Number(String(s?.state ?? '0').replace(',', '.')) || 0;
                        return `${v.toFixed(1)} mm`;
                      ]]]
                  extra_styles: |
                    [[[
                      return `
                        @keyframes axis_pulse {
                          0%   { transform: translateY(0); }
                          50%  { transform: translateY(-1px); }
                          100% { transform: translateY(0); }
                        }
                      `;
                    ]]]
                  styles:
                    grid:
                      - grid-template-areas: '"pos" "i" "n"'
                      - grid-template-rows: min-content 1fr min-content
                    custom_fields:
                      pos:
                        - font-size: 13px
                        - font-weight: 700
                        - text-align: center
                        - color: |
                            [[[
                              const base = 'rgba(70,160,255,0.95)'; // bleu
                              const s = states['sensor.ratrig_vminion_toolhead_position_x'];
                              const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                              return recent ? 'rgba(110,200,255,1)' : base;
                            ]]]
                        - text-shadow: 0 0 10px rgba(70,160,255,0.35)
                    icon:
                      - color: |
                          [[[
                            const base = 'rgba(70,160,255,0.95)';
                            const s = states['sensor.ratrig_vminion_toolhead_position_x'];
                            const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                            return recent ? 'rgba(110,200,255,1)' : base;
                          ]]]
                      - filter: |
                          [[[
                            const s = states['sensor.ratrig_vminion_toolhead_position_x'];
                            const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                            return recent
                              ? 'drop-shadow(0 0 10px rgba(70,160,255,0.55)) drop-shadow(0 0 2px rgba(0,0,0,0.8))'
                              : 'drop-shadow(0 0 6px rgba(70,160,255,0.25)) drop-shadow(0 0 2px rgba(0,0,0,0.8))';
                          ]]]
                    card:
                      - padding: 10px
                      - border-radius: 10px
                      - animation: |
                          [[[
                            const s = states['sensor.ratrig_vminion_toolhead_position_x'];
                            const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                            return recent ? 'axis_pulse 0.6s ease-in-out infinite' : 'none';
                          ]]]
                - type: custom:button-card
                  entity: button.ratrig_vminion_home_y_axis
                  name: 'Y'
                  icon: mdi:axis-y-arrow
                  show_state: false
                  tap_action:
                    action: call-service
                    service: button.press
                    target:
                      entity_id: button.ratrig_vminion_home_y_axis
                  hold_action:
                    action: more-info
                  custom_fields:
                    pos: |
                      [[[
                        const s = states['sensor.ratrig_vminion_toolhead_position_y'];
                        const v = Number(String(s?.state ?? '0').replace(',', '.')) || 0;
                        return `${v.toFixed(1)} mm`;
                      ]]]
                  extra_styles: |
                    [[[
                      return `
                        @keyframes axis_pulse {
                          0%   { transform: translateY(0); }
                          50%  { transform: translateY(-1px); }
                          100% { transform: translateY(0); }
                        }
                      `;
                    ]]]
                  styles:
                    grid:
                      - grid-template-areas: '"pos" "i" "n"'
                      - grid-template-rows: min-content 1fr min-content
                    custom_fields:
                      pos:
                        - font-size: 13px
                        - font-weight: 700
                        - text-align: center
                        - color: |
                            [[[
                              const base = 'rgba(70,210,120,0.95)'; // vert
                              const s = states['sensor.ratrig_vminion_toolhead_position_y'];
                              const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                              return recent ? 'rgba(120,255,170,1)' : base;
                            ]]]
                        - text-shadow: 0 0 10px rgba(70,210,120,0.35)
                    icon:
                      - color: |
                          [[[
                            const base = 'rgba(70,210,120,0.95)';
                            const s = states['sensor.ratrig_vminion_toolhead_position_y'];
                            const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                            return recent ? 'rgba(120,255,170,1)' : base;
                          ]]]
                      - filter: |
                          [[[
                            const s = states['sensor.ratrig_vminion_toolhead_position_y'];
                            const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                            return recent
                              ? 'drop-shadow(0 0 10px rgba(70,210,120,0.55)) drop-shadow(0 0 2px rgba(0,0,0,0.8))'
                              : 'drop-shadow(0 0 6px rgba(70,210,120,0.25)) drop-shadow(0 0 2px rgba(0,0,0,0.8))';
                          ]]]
                    card:
                      - padding: 10px
                      - border-radius: 10px
                      - animation: |
                          [[[
                            const s = states['sensor.ratrig_vminion_toolhead_position_y'];
                            const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                            return recent ? 'axis_pulse 0.6s ease-in-out infinite' : 'none';
                          ]]]
                - type: custom:button-card
                  entity: button.ratrig_vminion_home_z_axis
                  name: Z
                  icon: mdi:axis-z-arrow
                  show_state: false
                  tap_action:
                    action: call-service
                    service: button.press
                    target:
                      entity_id: button.ratrig_vminion_home_z_axis
                  hold_action:
                    action: more-info
                  custom_fields:
                    pos: |
                      [[[
                        const s = states['sensor.ratrig_vminion_toolhead_position_z'];
                        const v = Number(String(s?.state ?? '0').replace(',', '.')) || 0;
                        return `${v.toFixed(2)} mm`;
                      ]]]
                    zbar_right: |
                      [[[
                        const s = states['sensor.ratrig_vminion_toolhead_position_z'];
                        const z = Number(String(s?.state ?? '0').replace(',', '.')) || 0;

                        const Z_MAX = 180;
                        const pct = Math.max(0, Math.min(100, (z / Z_MAX) * 100)).toFixed(1);

                        return `
                          <div style="position:absolute; right:8px; top:10px; bottom:10px; width:7px;
                                      border-radius:10px; background: rgba(255,255,255,0.10); overflow:hidden;">
                            <div style="position:absolute; left:0; right:0; bottom:0; height:${pct}%;
                                        background: linear-gradient(to top, rgba(170,120,255,0.95), rgba(120,60,220,0.95));
                                        box-shadow: 0 0 10px rgba(160,110,255,0.45); transition: height 0.6s ease;">
                            </div>
                            <div style="position:absolute; top:-14px; left:50%; transform:translateX(-50%);
                                        font-size:10px; font-weight:800; color:rgba(255,255,255,0.92);
                                        text-shadow:0 2px 8px rgba(0,0,0,0.85);">
                              180
                            </div>
                          </div>
                        `;
                      ]]]
                    zbar_left: |
                      [[[
                        const hS = states['sensor.ratrig_vminion_object_height'];
                        const H_MAX = Number(String(hS?.state ?? '0').replace(',', '.')) || 0;

                        const zS = states['sensor.ratrig_vminion_toolhead_position_z'];
                        const z = Number(String(zS?.state ?? '0').replace(',', '.')) || 0;

                        const denom = (H_MAX > 0) ? H_MAX : 1;
                        const pct = Math.max(0, Math.min(100, (z / denom) * 100)).toFixed(1);

                        const label = (H_MAX > 0) ? `${H_MAX.toFixed(1)}` : `—`;

                        return `
                          <div style="position:absolute; left:8px; top:10px; bottom:10px; width:7px;
                                      border-radius:10px; background: rgba(255,255,255,0.10); overflow:hidden;">
                            <div style="position:absolute; left:0; right:0; bottom:0; height:${pct}%;
                                        background: linear-gradient(to top, rgba(0,180,255,0.95), rgba(0,90,255,0.95));
                                        box-shadow: 0 0 10px rgba(0,150,255,0.40); transition: height 0.6s ease;">
                            </div>
                            <div style="position:absolute; top:-14px; left:50%; transform:translateX(-50%);
                                        font-size:10px; font-weight:800; color:rgba(255,255,255,0.92);
                                        text-shadow:0 2px 8px rgba(0,0,0,0.85);">
                              ${label}
                            </div>
                          </div>
                        `;
                      ]]]
                  extra_styles: |
                    [[[
                      return `
                        @keyframes axis_pulse {
                          0%   { transform: translateY(0); }
                          50%  { transform: translateY(-1px); }
                          100% { transform: translateY(0); }
                        }
                      `;
                    ]]]
                  styles:
                    grid:
                      - grid-template-areas: '"pos" "i" "n"'
                      - grid-template-rows: min-content 1fr min-content
                    custom_fields:
                      pos:
                        - font-size: 13px
                        - font-weight: 700
                        - text-align: center
                        - color: |
                            [[[
                              const base = 'rgba(170,120,255,0.95)'; // violet
                              const s = states['sensor.ratrig_vminion_toolhead_position_z'];
                              const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                              return recent ? 'rgba(210,170,255,1)' : base;
                            ]]]
                        - text-shadow: 0 0 10px rgba(170,120,255,0.35)
                      zbar_right:
                        - position: absolute
                        - inset: 0
                        - pointer-events: none
                      zbar_left:
                        - position: absolute
                        - inset: 0
                        - pointer-events: none
                    icon:
                      - color: |
                          [[[
                            const base = 'rgba(170,120,255,0.95)';
                            const s = states['sensor.ratrig_vminion_toolhead_position_z'];
                            const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                            return recent ? 'rgba(210,170,255,1)' : base;
                          ]]]
                      - filter: |
                          [[[
                            const s = states['sensor.ratrig_vminion_toolhead_position_z'];
                            const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                            return recent
                              ? 'drop-shadow(0 0 10px rgba(170,120,255,0.55)) drop-shadow(0 0 2px rgba(0,0,0,0.8))'
                              : 'drop-shadow(0 0 6px rgba(170,120,255,0.25)) drop-shadow(0 0 2px rgba(0,0,0,0.8))';
                          ]]]
                    card:
                      - padding: 10px
                      - border-radius: 10px
                      - animation: |
                          [[[
                            const s = states['sensor.ratrig_vminion_toolhead_position_z'];
                            const recent = s?.last_changed ? (Date.now() - new Date(s.last_changed).getTime() < 3000) : false;
                            return recent ? 'axis_pulse 0.6s ease-in-out infinite' : 'none';
                          ]]]
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card {
                  border-radius: 5px;
                  overflow: hidden;
                  padding: 8px; 
                  position: relative;
                  background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%);
                  box-shadow: 0 8px 18px rgba(0,0,0,0.60);
                  border: 1px solid rgba(255,255,255,0.04);
                }

                ha-card:before {
                  content:"";
                  position:absolute;
                  inset:0;
                  background: radial-gradient(circle at top left,rgba(255,255,255,0.14),transparent 60%);
                  pointer-events:none;
                }

                /* ✅ TITRE flottant (ne prend aucune hauteur) */
                ha-card:after {
                  content: "Températures";
                  position: absolute;
                  left: 10px;
                  top: 6px;
                  font-size: 16px;
                  font-weight: 950;
                  line-height: 1;
                  opacity: .95;
                  pointer-events: none;
                  z-index: 2;
                }
            card:
              type: vertical-stack
              cards:
                - type: grid
                  columns: 3
                  square: false
                  cards:
                    - type: entities
                      show_header_toggle: false
                      entities:
                        - entity: number.ratrig_vminion_extruder_target
                          name: Buse
                          icon: mdi:printer-3d-nozzle-heat
                      card_mod:
                        style: >
                          ha-card{
                            border-radius: 10px;
                            background: linear-gradient(145deg,#202a38,#161d29);
                            border: 1px solid rgba(255,255,255,0.06);
                            box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 3px 8px rgba(0,0,0,0.45);
                            padding: 0 6px;
                            min-height: 40px;
                          }

                          .card-content { padding: 0 !important; }

                          #states { padding: 0 !important; margin: 0 !important;
                          }

                          hui-generic-entity-row { margin: 0 !important; }

                          hui-slider { height: 8px !important; }

                          hui-slider {
                            --paper-slider-knob-color: rgba(255,255,255,0.95);
                            --paper-slider-active-color: rgba(0,160,255,0.95);
                            --paper-slider-container-color: rgba(255,255,255,0.22);
                          }
                    - type: custom:button-card
                      entity: number.ratrig_vminion_extruder_target
                      show_icon: false
                      show_name: false
                      show_state: true
                      state_display: |
                        [[[
                          const v = Number(entity?.state ?? 0);
                          return `${Math.round(v)} °C`;
                        ]]]
                      styles:
                        card:
                          - border-radius: 10px
                          - background: linear-gradient(145deg,#202a38,#161d29)
                          - border: 1px solid rgba(255,255,255,0.06)
                          - box-shadow: >-
                              inset 0 1px 0 rgba(255,255,255,0.08), 0 3px 8px
                              rgba(0,0,0,0.45)
                          - padding: 0
                          - min-height: 40px
                        state:
                          - font-size: 16px
                          - font-weight: 900
                          - align-self: center
                          - justify-self: center
                          - line-height: 1
                    - type: custom:button-card
                      entity: sensor.ratrig_vminion_extruder_temperature
                      show_name: false
                      show_icon: true
                      icon: mdi:thermometer
                      show_state: true
                      state_display: |
                        [[[
                          const v = Number(String(entity?.state ?? '0').replace(',', '.')) || 0;
                          return `${v.toFixed(1)}°`;
                        ]]]
                      styles:
                        card:
                          - border-radius: 10px
                          - background: linear-gradient(145deg,#202a38,#161d29)
                          - border: 1px solid rgba(255,255,255,0.06)
                          - box-shadow: >-
                              inset 0 1px 0 rgba(255,255,255,0.08), 0 3px 8px
                              rgba(0,0,0,0.45)
                          - padding: 0 6px
                          - min-height: 40px
                        grid:
                          - grid-template-areas: '"i s"'
                          - grid-template-columns: 16px 1fr
                          - align-items: center
                          - column-gap: 6px
                        icon:
                          - width: 24px
                          - height: 24px
                          - color: rgba(255,255,255,0.85)
                          - justify-self: start
                        state:
                          - font-size: 16px
                          - font-weight: 950
                          - letter-spacing: 0.2px
                          - justify-self: start
                          - line-height: 1
                    - type: entities
                      show_header_toggle: false
                      entities:
                        - entity: number.ratrig_vminion_bed_target
                          name: Plateau
                          icon: mdi:radiator
                      card_mod:
                        style: >
                          ha-card{
                            border-radius: 10px;
                            background: linear-gradient(145deg,#202a38,#161d29);
                            border: 1px solid rgba(255,255,255,0.06);
                            box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 3px 8px rgba(0,0,0,0.45);
                            padding: 0 6px;
                            min-height: 40px;
                          }

                          .card-content { padding: 0 !important; }

                          #states { padding: 0 !important; margin: 0 !important;
                          }

                          hui-generic-entity-row { margin: 0 !important; }

                          hui-slider { height: 8px !important; }

                          hui-slider {
                            --paper-slider-knob-color: rgba(255,255,255,0.95);
                            --paper-slider-active-color: rgba(0,160,255,0.95);
                            --paper-slider-container-color: rgba(255,255,255,0.22);
                          }
                    - type: custom:button-card
                      entity: number.ratrig_vminion_bed_target
                      show_icon: false
                      show_name: false
                      show_state: true
                      state_display: |
                        [[[
                          const v = Number(entity?.state ?? 0);
                          return `${Math.round(v)} °C`;
                        ]]]
                      styles:
                        card:
                          - border-radius: 10px
                          - background: linear-gradient(145deg,#202a38,#161d29)
                          - border: 1px solid rgba(255,255,255,0.06)
                          - box-shadow: >-
                              inset 0 1px 0 rgba(255,255,255,0.08), 0 3px 8px
                              rgba(0,0,0,0.45)
                          - padding: 0
                          - min-height: 40px
                        state:
                          - font-size: 16px
                          - font-weight: 900
                          - align-self: center
                          - justify-self: center
                          - line-height: 1
                    - type: custom:button-card
                      entity: sensor.ratrig_vminion_bed_temperature
                      show_name: false
                      show_icon: true
                      icon: mdi:thermometer
                      show_state: true
                      state_display: |
                        [[[
                          const v = Number(String(entity?.state ?? '0').replace(',', '.')) || 0;
                          return `${v.toFixed(1)}°`;
                        ]]]
                      styles:
                        card:
                          - border-radius: 10px
                          - background: linear-gradient(145deg,#202a38,#161d29)
                          - border: 1px solid rgba(255,255,255,0.06)
                          - box-shadow: >-
                              inset 0 1px 0 rgba(255,255,255,0.08), 0 3px 8px
                              rgba(0,0,0,0.45)
                          - padding: 0 6px
                          - min-height: 40px
                        grid:
                          - grid-template-areas: '"i s"'
                          - grid-template-columns: 16px 1fr
                          - align-items: center
                          - column-gap: 6px
                        icon:
                          - width: 24px
                          - height: 24px
                          - color: rgba(255,255,255,0.85)
                          - justify-self: start
                        state:
                          - font-size: 16px
                          - font-weight: 950
                          - letter-spacing: 0.2px
                          - justify-self: start
                          - line-height: 1
                  card_mod:
                    style: >
                      ha-card { background: transparent; border: none;
                      box-shadow: none; padding: 0; }


                      /* ✅ on pousse le grid sous le titre (mais très proche) */

                      #root {
                        grid-template-columns: 2fr 1fr 1fr !important;
                        column-gap: 5px !important;
                        row-gap: 4px !important;
                        margin-top: 18px !important; /* ajuste ici si tu veux + proche : 14px / 12px */
                      }
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card{
                  border-radius: 6px;
                  overflow: hidden;
                  padding: 10px 12px;
                  position: relative;
                  background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%) !important;
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65) !important;
                  border: 1px solid rgba(255,255,255,0.04) !important;
                }
                ha-card:before{
                  content:"";
                  position:absolute;
                  inset:0;
                  background: radial-gradient(circle at top left,rgba(255,255,255,0.14),transparent 60%);
                  pointer-events:none;
                  z-index:0;
                }
            card:
              type: entities
              show_header_toggle: false
              card_mod:
                style: |
                  ha-card{
                    background: transparent !important;
                    box-shadow: none !important;
                    border: none !important;
                    padding: 0 !important;
                  }
              entities:
                - entity: number.ratrig_vminion_speed_factor
                  name: Speed Factor
      - type: grid
        cards:
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card {
                  border-radius: 5px;
                  overflow: hidden;
                  padding: 12px;
                  position: relative;
                  background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%) !important;
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65) !important;
                  border: 1px solid rgba(255,255,255,0.04) !important;
                }
                ha-card:before {
                  content:"";
                  position:absolute;
                  inset:0;
                  background: radial-gradient(circle at top left,rgba(255,255,255,0.14),transparent 60%);
                  pointer-events:none;
                  z-index:0;
                }
            card:
              type: grid
              title: Macros
              columns: 2
              square: false
              cards:
                - type: custom:button-card
                  entity: button.ratos2_macro_load_filament
                  name: Charger filament
                  icon: mdi:tray-arrow-down
                  show_state: false
                  tap_action:
                    action: call-service
                    service: button.press
                    service_data:
                      entity_id: button.ratos2_macro_load_filament
                  hold_action:
                    action: more-info
                  styles:
                    card:
                      - border-radius: 5px
                      - padding: 12px 14px
                      - background: rgba(255,255,255,0.10)
                      - border: 1px solid rgba(255,255,255,0.14)
                      - box-shadow: 0 10px 24px rgba(0,0,0,0.35)
                    grid:
                      - grid-template-areas: '"i n"'
                      - grid-template-columns: 24px 1fr
                      - column-gap: 10px
                      - align-items: center
                    icon:
                      - width: 20px
                      - color: rgba(0,170,255,0.95)
                      - filter: drop-shadow(0 0 8px rgba(0,170,255,0.35))
                    name:
                      - justify-self: start
                      - font-size: 13px
                      - font-weight: 800
                      - color: rgba(255,255,255,0.95)
                      - text-shadow: 0 2px 10px rgba(0,0,0,0.65)
                - type: custom:button-card
                  entity: button.ratos2_macro_set_filament_sensor
                  name: Capteur filament
                  icon: mdi:alarm-check
                  show_state: false
                  tap_action:
                    action: call-service
                    service: button.press
                    service_data:
                      entity_id: button.ratos2_macro_set_filament_sensor
                  hold_action:
                    action: more-info
                  styles:
                    card:
                      - border-radius: 5px
                      - padding: 12px 14px
                      - background: rgba(255,255,255,0.10)
                      - border: 1px solid rgba(255,255,255,0.14)
                      - box-shadow: 0 10px 24px rgba(0,0,0,0.35)
                    grid:
                      - grid-template-areas: '"i n"'
                      - grid-template-columns: 24px 1fr
                      - column-gap: 10px
                      - align-items: center
                    icon:
                      - width: 20px
                      - color: rgba(70,210,120,0.95)
                      - filter: drop-shadow(0 0 8px rgba(70,210,120,0.35))
                    name:
                      - justify-self: start
                      - font-size: 13px
                      - font-weight: 800
                      - color: rgba(255,255,255,0.95)
                      - text-shadow: 0 2px 10px rgba(0,0,0,0.65)
                - type: custom:button-card
                  entity: button.ratos2_restart_klipper
                  name: Restart Klipper
                  icon: mdi:restart
                  show_state: false
                  tap_action:
                    action: call-service
                    service: button.press
                    service_data:
                      entity_id: button.ratos2_restart_klipper
                  hold_action:
                    action: more-info
                  styles:
                    card:
                      - border-radius: 5px
                      - padding: 12px 14px
                      - background: rgba(255,255,255,0.10)
                      - border: 1px solid rgba(255,255,255,0.14)
                      - box-shadow: 0 10px 24px rgba(0,0,0,0.35)
                    grid:
                      - grid-template-areas: '"i n"'
                      - grid-template-columns: 24px 1fr
                      - column-gap: 10px
                      - align-items: center
                    icon:
                      - width: 20px
                      - color: rgba(255,180,0,0.95)
                      - filter: drop-shadow(0 0 8px rgba(255,180,0,0.35))
                    name:
                      - justify-self: start
                      - font-size: 13px
                      - font-weight: 800
                      - color: rgba(255,255,255,0.95)
                      - text-shadow: 0 2px 10px rgba(0,0,0,0.65)
                - type: custom:button-card
                  entity: button.ratos2_macro_restart
                  name: Restart RatOS
                  icon: mdi:power-cycle
                  show_state: false
                  tap_action:
                    action: call-service
                    service: button.press
                    service_data:
                      entity_id: button.ratos2_macro_restart
                  hold_action:
                    action: more-info
                  styles:
                    card:
                      - border-radius: 5px
                      - padding: 12px 14px
                      - background: rgba(255,255,255,0.10)
                      - border: 1px solid rgba(255,255,255,0.14)
                      - box-shadow: 0 10px 24px rgba(0,0,0,0.35)
                    grid:
                      - grid-template-areas: '"i n"'
                      - grid-template-columns: 24px 1fr
                      - column-gap: 10px
                      - align-items: center
                    icon:
                      - width: 20px
                      - color: rgba(170,120,255,0.95)
                      - filter: drop-shadow(0 0 8px rgba(170,120,255,0.35))
                    name:
                      - justify-self: start
                      - font-size: 13px
                      - font-weight: 800
                      - color: rgba(255,255,255,0.95)
                      - text-shadow: 0 2px 10px rgba(0,0,0,0.65)
                - type: custom:button-card
                  entity: button.ratos2_macro_firmware_restart
                  name: Firmware restart
                  icon: mdi:cpu-64-bit
                  show_state: false
                  tap_action:
                    action: call-service
                    service: button.press
                    service_data:
                      entity_id: button.ratos2_macro_firmware_restart
                  hold_action:
                    action: more-info
                  styles:
                    card:
                      - border-radius: 5px
                      - padding: 12px 14px
                      - background: rgba(255,255,255,0.10)
                      - border: 1px solid rgba(255,255,255,0.14)
                      - box-shadow: 0 10px 24px rgba(0,0,0,0.35)
                    grid:
                      - grid-template-areas: '"i n"'
                      - grid-template-columns: 24px 1fr
                      - column-gap: 10px
                      - align-items: center
                    icon:
                      - width: 20px
                      - color: rgba(220,70,70,0.92)
                      - filter: drop-shadow(0 0 8px rgba(220,70,70,0.35))
                    name:
                      - justify-self: start
                      - font-size: 13px
                      - font-weight: 800
                      - color: rgba(255,255,255,0.95)
                      - text-shadow: 0 2px 10px rgba(0,0,0,0.65)
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card {
                  border-radius: 6px;
                  overflow: hidden;
                  padding: 12px;
                  position: relative;
                  background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%) !important;
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65) !important;
                  border: 1px solid rgba(255,255,255,0.04) !important;
                }
                ha-card:before{
                  content:"";
                  position:absolute;
                  inset:0;
                  background: radial-gradient(circle at top left,rgba(255,255,255,0.14),transparent 60%);
                  pointer-events:none;
                  z-index:0;
                }
            card:
              type: custom:button-card
              name: RatRig — Octopus & Raspberry Pi
              show_icon: false
              show_state: false
              styles:
                card:
                  - position: relative
                  - padding: 0
                  - height: 260px
                  - background: transparent
                  - box-shadow: none
                  - border: none
                  - overflow: hidden
                name:
                  - position: absolute
                  - top: 10px
                  - left: 14px
                  - z-index: 5
                  - font-size: 14px
                  - font-weight: 800
                  - color: rgba(255,255,255,0.95)
                  - text-shadow: 0 2px 10px rgba(0,0,0,0.8)
                custom_fields:
                  left:
                    - position: absolute
                    - left: 14px
                    - top: 42px
                    - bottom: 12px
                    - width: 46%
                    - z-index: 4
                  right:
                    - position: absolute
                    - right: 14px
                    - top: 42px
                    - bottom: 12px
                    - width: 46%
                    - z-index: 4
              custom_fields:
                left: |
                  [[[
                    const num = (eid) => {
                      const raw = states[eid]?.state ?? '';
                      const n = Number(String(raw).replace(',', '.'));
                      return isFinite(n) ? n : null;
                    };
                    const fmtPctSmart = (n) => {
                      if (n === null) return '—';
                      // ratio 0..1 => %
                      if (n >= 0 && n <= 1) return `${(n*100).toFixed(0)}%`;
                      // déjà en % 1..100
                      if (n > 1 && n <= 100) return `${n.toFixed(0)}%`;
                      // au-delà : on affiche brut (ou clamp si tu préfères)
                      return `${n.toFixed(0)}%`;
                    };

                    const t = num('sensor.ratrig_vminion_octopus_temp');
                    const tempTxt = (t === null) ? '—' : `${t.toFixed(1)}°C`;

                    const awake = num('sensor.ratrig_vminion_mcu_awake');
                    const awakeTxt = fmtPctSmart(awake);

                    const fan = num('sensor.ratrig_vminion_controller_fan');
                    const fanTxt = fmtPctSmart(fan);

                    return `
                      <div style="
                        height:100%;
                        border-radius:14px;
                        overflow:hidden;
                        position:relative;
                        border:1px solid rgba(255,255,255,0.06);
                        background: rgba(255,255,255,0.04);
                      ">

                        <img src="/local/vminion_mcu_octopus_transparent.png" style="
                          position:absolute;
                          bottom:0;
                          left:50%;
                          transform:translateX(-50%);
                          width:75%;
                          opacity:0.95;
                          filter: drop-shadow(0 18px 20px rgba(0,0,0,0.55));
                          z-index:1;
                          pointer-events:none;
                        "/>

                        <div style="
                          position:absolute;
                          inset:0;
                          background: linear-gradient(
                            180deg,
                            rgba(0,0,0,0.75) 0%,
                            rgba(0,0,0,0.55) 35%,
                            rgba(0,0,0,0.15) 70%,
                            rgba(0,0,0,0.0) 100%
                          );
                          z-index:2;
                          pointer-events:none;
                        "></div>

                        <div style="position:relative; z-index:3; padding:12px;">
                          <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                            <div style="font-size:12px;font-weight:900;">Octopus</div>
                            <div style="
                              font-size:11px;font-weight:900;padding:4px 8px;border-radius:999px;
                              background:rgba(0,170,255,0.25);
                              border:1px solid rgba(0,170,255,0.55);
                            ">Awake ${awakeTxt}</div>
                          </div>

                          <div style="display:grid;gap:8px;font-size:12px;">
                            <div style="display:flex;justify-content:space-between;">
                              <span>🌡️ Temp</span><b>${tempTxt}</b>
                            </div>
                            <div style="display:flex;justify-content:space-between;">
                              <span>🌀 Fan</span><b>${fanTxt}</b>
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                  ]]]
                right: |
                  [[[
                    const num = (eid) => {
                      const raw = states[eid]?.state ?? '';
                      const n = Number(String(raw).replace(',', '.'));
                      return isFinite(n) ? n : null;
                    };

                    const fmtPctSmart = (n) => {
                      if (n === null) return '—';
                      if (n >= 0 && n <= 1) return `${(n*100).toFixed(0)}%`;
                      if (n > 1 && n <= 100) return `${n.toFixed(0)}%`;
                      return `${n.toFixed(0)}%`;
                    };

                    const t = num('sensor.ratrig_vminion_raspberry_pi_temp');
                    const tTxt = (t === null) ? '—' : `${t.toFixed(1)}°C`;

                    const mcuLoad = num('sensor.ratrig_vminion_mcu_load');
                    const mcuTxt = fmtPctSmart(mcuLoad);

                    // 👉 Mémoire RPi (déjà en % propre)
                    const mem = num('sensor.ratrig_vminion_memory_used');
                    const memTxt = (mem === null) ? '—' : `${mem.toFixed(0)}%`;

                    return `
                      <div style="
                        height:100%;
                        border-radius:14px;
                        overflow:hidden;
                        position:relative;
                        border:1px solid rgba(255,255,255,0.06);
                        background: rgba(255,255,255,0.04);
                      ">

                        <img src="/local/vminion_rpi_transparent.png" style="
                          position:absolute;
                          bottom:0;
                          left:50%;
                          transform:translateX(-50%);
                          width:65%;
                          opacity:0.95;
                          filter: drop-shadow(0 18px 20px rgba(0,0,0,0.55));
                          z-index:1;
                          pointer-events:none;
                        "/>

                        <div style="
                          position:absolute;
                          inset:0;
                          background: linear-gradient(
                            180deg,
                            rgba(0,0,0,0.75) 0%,
                            rgba(0,0,0,0.55) 35%,
                            rgba(0,0,0,0.15) 70%,
                            rgba(0,0,0,0.0) 100%
                          );
                          z-index:2;
                          pointer-events:none;
                        "></div>

                        <div style="position:relative; z-index:3; padding:12px;">
                          <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                            <div style="font-size:12px;font-weight:900;">Raspberry Pi</div>
                            <div style="
                              font-size:11px;font-weight:900;padding:4px 8px;border-radius:999px;
                              background:rgba(0,170,255,0.25);
                              border:1px solid rgba(0,170,255,0.55);
                            ">MCU Load ${mcuTxt}</div>
                          </div>

                          <div style="display:grid;gap:8px;font-size:12px;">
                            <div style="display:flex;justify-content:space-between;">
                              <span>🌡️ Temp</span><b>${tTxt}</b>
                            </div>
                            <div style="display:flex;justify-content:space-between;">
                              <span>🧠 Mémoire</span><b>${memTxt}</b>
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                  ]]]
    visible:
      - user: 49a98c3aa3c44399a03d32437dca04ba
      - user: 76dc484362274cbbb06167991e4e596b
    cards: []
    theme: noctis
    badges:
      - type: custom:button-card
        icon: mdi:home-variant-outline
        name: Accueil
        show_name: true
        tap_action:
          action: navigate
          navigation_path: /lovelace/0
        styles:
          card:
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(8px)
            - '-webkit-backdrop-filter': blur(8px)
            - border-radius: 12px
            - border: 1px solid rgba(255, 255, 255, 0.1)
            - padding: 6px 12px
            - width: fit-content
            - margin: 0 auto 10px 0
          grid:
            - grid-template-areas: '"i n"'
            - grid-template-columns: auto auto
            - column-gap: 8px
          icon:
            - width: 18px
            - color: '#00bfff'
          name:
            - font-size: 12px
            - font-weight: 700
            - color: rgba(255, 255, 255, 0.9)
      - type: custom:button-card
        entity: switch.prise_imprimante_3d
        icon: mdi:power
        show_icon: true
        show_name: false
        show_state: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        custom_fields:
          t: |
            [[[
              const s = (entity?.state || '').toLowerCase();
              const label =
                (s === 'on')  ? 'Eteindre Imprimante 3D '  :
                (s === 'off') ? 'Allume Imprimante 3D ' :
                'Imprimante 3D —';
              return `<div style="
                font-size:12px;
                font-weight:800;
                color:rgba(255,255,255,0.95);
                line-height:14px;
                white-space:nowrap;
              ">${label}</div>`;
            ]]]
        styles:
          card:
            - height: 32px
            - border-radius: 5px
            - padding: 2px 12px
            - overflow: hidden
            - cursor: pointer
            - box-shadow: 0 6px 14px rgba(0,0,0,0.35)
            - border: 1px solid rgba(255,255,255,0.18)
            - background: |
                [[[
                  const s = (entity?.state || '').toLowerCase();
                  // OFF = VERT / ON = ROUGE
                  if (s === 'off') return 'linear-gradient(145deg, rgba(40,160,40,0.95), rgba(20,110,20,0.85))';
                  if (s === 'on')  return 'linear-gradient(145deg, rgba(200,40,40,0.95), rgba(130,20,20,0.85))';
                  return 'linear-gradient(145deg, rgba(120,120,120,0.70), rgba(80,80,80,0.55))';
                ]]]
          grid:
            - grid-template-areas: '"i t"'
            - grid-template-columns: 18px 1fr
            - grid-template-rows: 1fr
            - column-gap: 10px
            - align-items: center
          icon:
            - width: 16px
            - height: 16px
            - color: rgba(255,255,255,0.95)
            - filter: drop-shadow(0 2px 6px rgba(0,0,0,0.55))
          custom_fields:
            t:
              - grid-area: t
              - justify-self: start
    subview: true
    background:
      opacity: 40
      alignment: center
      size: auto
      repeat: no-repeat
      attachment: fixed
      image:
        media_content_id: media-source://image_upload/67969bc9542ce018d62413c4ebe28965
        media_content_type: image/png
        metadata:
          title: VMINION.png
          thumbnail: /api/image/serve/67969bc9542ce018d62413c4ebe28965/256x256
          media_class: image
          navigateIds:
            - {}
            - media_content_type: app
              media_content_id: media-source://image_upload
    header:
      layout: start
      badges_position: bottom
      badges_wrap: wrap
  - type: panel
    title: Diffuseur
    path: diffuseur
    cards:
      - type: vertical-stack
        cards:
          - type: vertical-stack
            cards:
              - type: vertical-stack
                cards:
                  - type: custom:button-card
                    name: Diffuseur huile
                    show_icon: false
                    show_state: false
                    triggers_update:
                      - timer.diffuseur_huile
                      - light.smart_humidifier_24080828541213641101c4e7ae093c61
                      - >-
                        select.smart_humidifier_24080828541213641101c4e7ae093c61_spray
                    styles:
                      card:
                        - position: relative
                        - padding: 2px
                        - border-radius: 20px
                        - overflow: hidden
                        - min-height: 420px
                        - background: rgba(20, 27, 38, 0.6)
                        - backdrop-filter: blur(10px)
                        - '-webkit-backdrop-filter': blur(10px)
                        - border: 1px solid rgba(255,255,255,0.1)
                        - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                      name:
                        - position: absolute
                        - z-index: 3
                        - top: 16px
                        - left: 20px
                        - font-size: 16px
                        - font-weight: 700
                        - color: rgba(255,255,255,0.95)
                        - text-shadow: 0 2px 10px rgba(0,0,0,0.8)
                      custom_fields:
                        back:
                          - position: absolute
                          - z-index: 5
                          - top: 48px
                          - left: 20px
                        bg:
                          - position: absolute
                          - inset: 0
                          - z-index: 1
                        status:
                          - position: absolute
                          - z-index: 4
                          - top: 16px
                          - right: 20px
                          - font-size: 12px
                          - font-weight: 700
                          - padding: 6px 12px
                          - border-radius: 12px
                          - color: rgba(255,255,255,0.95)
                          - text-shadow: 0 2px 8px rgba(0,0,0,0.9)
                        legend:
                          - position: absolute
                          - z-index: 4
                          - left: 20px
                          - right: 140px
                          - bottom: 16px
                          - font-size: 12px
                          - font-weight: 600
                          - color: rgba(255,255,255,0.90)
                          - text-shadow: 0 2px 8px rgba(0,0,0,0.85)
                        timer_card:
                          - position: absolute
                          - z-index: 6
                          - right: 16px
                          - bottom: 12px
                          - width: 126px
                    custom_fields:
                      back:
                        card:
                          type: custom:button-card
                          icon: mdi:home-outline
                          name: Accueil
                          show_name: true
                          tap_action:
                            action: navigate
                            navigation_path: /lovelace/0
                          styles:
                            card:
                              - padding: 4px 10px
                              - background: rgba(255, 255, 255, 0.08)
                              - border-radius: 8px
                              - border: 1px solid rgba(255, 255, 255, 0.12)
                              - width: fit-content
                              - backdrop-filter: blur(5px)
                              - '-webkit-backdrop-filter': blur(5px)
                            grid:
                              - grid-template-areas: '"i n"'
                              - grid-template-columns: auto auto
                              - column-gap: 6px
                            icon:
                              - width: 16px
                              - color: rgba(255, 255, 255, 0.8)
                            name:
                              - font-size: 11px
                              - font-weight: 600
                              - text-transform: uppercase
                              - color: rgba(255, 255, 255, 0.8)
                      bg: |
                        [[[
                          const lightOn = (states['light.smart_humidifier_24080828541213641101c4e7ae093c61']?.state || '').toLowerCase() === 'on';
                          const spray = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off').toLowerCase();
                          const diffOn = spray !== 'off';
                          const sig = `${lightOn ? 1 : 0}${diffOn ? 1 : 0}`;
                          let baseSrc = '/local/diffuseur_eteint.png';
                          if (lightOn) baseSrc = '/local/diffuseur_lumiere.png';
                          const overlaySrc = '/local/diffuseur_overlay_diffusion.png';
                          return `
                            <!-- Glow -->
                            <div style="
                              position:absolute; inset:0;
                              background: radial-gradient(circle at top left, rgba(255,255,255,0.14), transparent 60%);
                              pointer-events:none;
                              z-index:2;
                            "></div>
                            <!-- Image BASE -->
                            <div style="
                              position:absolute; inset:0;
                              display:flex; align-items:center; justify-content:center;
                              padding: 46px 10px 46px 10px;
                              z-index:1;
                              pointer-events:none;
                            ">
                              <img src="${baseSrc}?s=${sig}" style="
                                width: 100%;
                                max-width: 520px;
                                height: auto;
                                display:block;
                                filter: drop-shadow(0 12px 18px rgba(0,0,0,0.35));
                              ">
                            </div>
                            <!-- Overlay DIFFUSION -->
                            ${diffOn ? `
                              <div style="
                                position:absolute;
                                top:0; left:0; right:0;
                                display:flex;
                                justify-content:center;
                                align-items:flex-start;
                                padding-top: 0px;
                                z-index:3;
                                pointer-events:none;
                              ">
                                <style>
                                  @keyframes pulse_smoke {
                                    0% { opacity: 0.3; filter: brightness(0.85); }
                                    100% { opacity: 1; filter: brightness(1.15); }
                                  }
                                </style>
                                <img src="${overlaySrc}?s=${sig}" style="
                                  width: 100%;
                                  max-width: 520px;
                                  height: auto;
                                  display:block;
                                  filter: brightness(1.1) contrast(1.05)
                                          drop-shadow(0 8px 14px rgba(0,0,0,0.25));
                                  mix-blend-mode: normal;
                                  opacity: 0.95;
                                  animation: pulse_smoke 1.5s infinite alternate ease-in-out;
                                ">
                              </div>
                            ` : ``}
                          `;
                        ]]]
                      status: |
                        [[[
                          const lightOn = (states['light.smart_humidifier_24080828541213641101c4e7ae093c61']?.state || '').toLowerCase() === 'on';
                          const spray = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off').toLowerCase();
                          const diffOn = spray !== 'off';
                          let label = 'Éteint';
                          let bg = 'rgba(255,255,255,0.10)';
                          let bd = 'rgba(255,255,255,0.18)';
                          if (diffOn && lightOn) { label = 'Diffusion + Lumière'; bg='rgba(0,170,255,0.22)'; bd='rgba(0,170,255,0.55)'; }
                          else if (diffOn)       { label = `Diffusion: ${spray.toUpperCase()}`; bg='rgba(255,180,0,0.20)'; bd='rgba(255,180,0,0.55)'; }
                          else if (lightOn)      { label = 'Lumière'; bg='rgba(70,210,120,0.18)'; bd='rgba(70,210,120,0.55)'; }
                          return `<span style="
                            display:inline-block;
                            background:${bg};
                            border:1px solid ${bd};
                            padding:4px 10px;
                            border-radius:12px;
                            box-shadow:0 6px 14px rgba(0,0,0,0.35);
                          ">${label}</span>`;
                        ]]]
                      legend: |
                        [[[
                          const lightOn = (states['light.smart_humidifier_24080828541213641101c4e7ae093c61']?.state || '').toLowerCase() === 'on';
                          const spray = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off').toLowerCase();
                          return `
                            <div style="display:flex;gap:14px;flex-wrap:wrap;align-items:center;">
                              <div>💡 Lumière <b>${lightOn ? 'ON' : 'OFF'}</b></div>
                              <div>🌫️ Diffusion <b>${spray.toUpperCase()}</b></div>
                            </div>
                          `;
                        ]]]
                      timer_card:
                        card:
                          type: entities
                          show_header_toggle: false
                          entities:
                            - entity: timer.diffuseur_huile
                              name: ' '
                          card_mod:
                            style: |
                              ha-card{
                                background: transparent !important;
                                border: none !important;
                                box-shadow: none !important;
                                padding: 0 !important;
                              }
                              .card-content{
                                padding: 0 !important;
                              }
                              hui-generic-entity-row{
                                margin: 0 !important;
                                min-height: 0 !important;
                              }
                              /* cache nom + icone */
                              .name, .icon{
                                display:none !important;
                              }
                              /* style du temps restant */
                              .state{
                                font-weight: 500 !important;
                                font-size: 12px !important;
                                color: rgba(255,255,255,0.92) !important;
                                text-shadow: 0 2px 8px rgba(0,0,0,0.85) !important;
                                letter-spacing: 0.3px;
                              }
              - type: custom:mod-card
                card_mod:
                  style: |
                    ha-card{
                      border-radius: 16px;
                      background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%);
                      box-shadow: 0 10px 22px rgba(0,0,0,0.65);
                      border: 1px solid rgba(255,255,255,0.04);
                      overflow: hidden;
                    }
                card:
                  type: vertical-stack
                  cards:
                    - type: markdown
                      content: |
                        ## Contrôles
                      card_mod:
                        style: |
                          ha-card{
                            background: transparent;
                            box-shadow: none;
                            border: none;
                            padding: 14px 16px 6px;
                          }
                    - type: grid
                      columns: 2
                      square: false
                      cards:
                        - type: custom:button-card
                          entity: >-
                            light.smart_humidifier_24080828541213641101c4e7ae093c61
                          name: Lumière
                          icon: mdi:lightbulb
                          show_state: false
                          tap_action:
                            action: toggle
                          custom_fields:
                            glow: |
                              [[[
                                const on = (entity?.state || 'off') === 'on';
                                if (!on) return '';

                                const eff = (entity?.attributes?.effect || '').toString();
                                const isRainbow = eff === 'Rainbow';

                                const rgb = entity?.attributes?.rgb_color;
                                const hs  = entity?.attributes?.hs_color;

                                let c = 'rgba(0,170,255,0.85)';
                                if (rgb && rgb.length === 3) c = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
                                else if (hs && hs.length === 2) c = `hsl(${hs[0]}, 100%, 60%)`;

                                if (isRainbow) {
                                  return `
                                    <div class="rainbowGlow"></div>
                                    <style>
                                      @keyframes hueSpin { from { filter: hue-rotate(0deg); } to { filter: hue-rotate(360deg); } }
                                      .rainbowGlow{
                                        position:absolute; inset:-3px;
                                        border-radius:12px;
                                        background: conic-gradient(from 0deg,
                                          rgba(255,0,0,.55),
                                          rgba(255,180,0,.55),
                                          rgba(0,255,0,.55),
                                          rgba(0,170,255,.55),
                                          rgba(170,0,255,.55),
                                          rgba(255,0,0,.55)
                                        );
                                        opacity:.60;
                                        filter: blur(10px);
                                        animation: hueSpin 2.2s linear infinite;
                                        pointer-events:none;
                                      }
                                    </style>
                                  `;
                                }

                                return `
                                  <div style="
                                    position:absolute; inset:-3px;
                                    border-radius:12px;
                                    background:${c};
                                    opacity:0.32;
                                    filter: blur(10px);
                                    pointer-events:none;
                                  "></div>
                                `;
                              ]]]
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - overflow: hidden
                              - position: relative
                              - background: |
                                  [[[
                                    const on = (entity?.state || 'off') === 'on';
                                    return on ? 'rgba(255,255,255,0.14)' : 'rgba(255,255,255,0.06)';
                                  ]]]
                              - border: |
                                  [[[
                                    const on = (entity?.state || 'off') === 'on';
                                    return on ? '1px solid rgba(255,255,255,0.28)' : '1px solid rgba(255,255,255,0.10)';
                                  ]]]
                            grid:
                              - grid-template-areas: '"i n"'
                              - grid-template-columns: auto 1fr
                              - column-gap: 8px
                              - justify-items: start
                              - align-items: center
                            icon:
                              - width: 20px
                              - color: rgba(255,255,255,0.92)
                              - z-index: 2
                            name:
                              - font-weight: 900
                              - font-size: 14px
                              - color: rgba(255,255,255,0.95)
                              - text-shadow: 0 2px 10px rgba(0,0,0,0.65)
                              - z-index: 2
                            custom_fields:
                              glow:
                                - position: absolute
                                - inset: 0
                                - z-index: 0
                        - type: custom:button-card
                          entity: >-
                            light.smart_humidifier_24080828541213641101c4e7ae093c61
                          name: Couleur
                          icon: mdi:palette
                          show_state: false
                          tap_action:
                            action: more-info
                            entity: >-
                              light.smart_humidifier_24080828541213641101c4e7ae093c61
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                            grid:
                              - grid-template-areas: '"i n"'
                              - grid-template-columns: auto 1fr
                              - column-gap: 8px
                              - justify-items: start
                              - align-items: center
                            icon:
                              - width: 20px
                              - color: rgba(255,255,255,0.92)
                            name:
                              - font-weight: 900
                              - font-size: 14px
                              - color: rgba(255,255,255,0.95)
                              - text-shadow: 0 2px 10px rgba(0,0,0,0.65)
                      card_mod:
                        style: |
                          ha-card{
                            background: transparent;
                            box-shadow: none;
                            border: none;
                            padding: 0 6px 6px;
                          }
                    - type: grid
                      columns: 3
                      square: false
                      cards:
                        - type: custom:button-card
                          name: 'OFF'
                          icon: mdi:water-off
                          show_state: false
                          tap_action:
                            action: call-service
                            service: select.select_option
                            target:
                              entity_id: >-
                                select.smart_humidifier_24080828541213641101c4e7ae093c61_spray
                            data:
                              option: 'off'
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: |
                                  [[[
                                    const v = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off');
                                    return (v === 'off') ? 'rgba(255,255,255,0.14)' : 'rgba(255,255,255,0.06)';
                                  ]]]
                              - border: |
                                  [[[
                                    const v = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off');
                                    return (v === 'off') ? '1px solid rgba(255,255,255,0.28)' : '1px solid rgba(255,255,255,0.10)';
                                  ]]]
                            name:
                              - font-weight: 900
                              - font-size: 12px
                              - color: rgba(255,255,255,0.95)
                            icon:
                              - width: 22px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          name: ECO
                          icon: mdi:leaf
                          show_state: false
                          tap_action:
                            action: call-service
                            service: select.select_option
                            target:
                              entity_id: >-
                                select.smart_humidifier_24080828541213641101c4e7ae093c61_spray
                            data:
                              option: eco
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: |
                                  [[[
                                    const v = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off');
                                    return (v === 'eco') ? 'rgba(70,210,120,0.18)' : 'rgba(255,255,255,0.06)';
                                  ]]]
                              - border: |
                                  [[[
                                    const v = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off');
                                    return (v === 'eco') ? '1px solid rgba(70,210,120,0.55)' : '1px solid rgba(255,255,255,0.10)';
                                  ]]]
                            name:
                              - font-weight: 900
                              - font-size: 12px
                              - color: rgba(255,255,255,0.95)
                            icon:
                              - width: 22px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          name: 'ON'
                          icon: mdi:water
                          show_state: false
                          tap_action:
                            action: call-service
                            service: select.select_option
                            target:
                              entity_id: >-
                                select.smart_humidifier_24080828541213641101c4e7ae093c61_spray
                            data:
                              option: 'on'
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: |
                                  [[[
                                    const v = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off');
                                    return (v === 'on') ? 'rgba(0,170,255,0.18)' : 'rgba(255,255,255,0.06)';
                                  ]]]
                              - border: |
                                  [[[
                                    const v = (states['select.smart_humidifier_24080828541213641101c4e7ae093c61_spray']?.state || 'off');
                                    return (v === 'on') ? '1px solid rgba(0,170,255,0.55)' : '1px solid rgba(255,255,255,0.10)';
                                  ]]]
                            name:
                              - font-weight: 900
                              - font-size: 12px
                              - color: rgba(255,255,255,0.95)
                            icon:
                              - width: 22px
                              - color: rgba(255,255,255,0.95)
                    - type: grid
                      columns: 5
                      square: false
                      cards:
                        - type: custom:button-card
                          name: 15m
                          icon: mdi:timer-outline
                          show_state: false
                          tap_action:
                            action: call-service
                            service: timer.start
                            target:
                              entity_id: timer.diffuseur_huile
                            data:
                              duration: '00:15:00'
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 10px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                            name:
                              - font-weight: 900
                              - font-size: 12px
                              - color: rgba(255,255,255,0.95)
                            icon:
                              - width: 18px
                              - color: rgba(255,255,255,0.92)
                        - type: custom:button-card
                          name: 30m
                          icon: mdi:timer-outline
                          show_state: false
                          tap_action:
                            action: call-service
                            service: timer.start
                            target:
                              entity_id: timer.diffuseur_huile
                            data:
                              duration: '00:30:00'
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 10px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                            name:
                              - font-weight: 900
                              - font-size: 12px
                              - color: rgba(255,255,255,0.95)
                            icon:
                              - width: 18px
                              - color: rgba(255,255,255,0.92)
                        - type: custom:button-card
                          name: 1H
                          icon: mdi:timer-outline
                          show_state: false
                          tap_action:
                            action: call-service
                            service: timer.start
                            target:
                              entity_id: timer.diffuseur_huile
                            data:
                              duration: '01:00:00'
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 10px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                            name:
                              - font-weight: 900
                              - font-size: 12px
                              - color: rgba(255,255,255,0.95)
                            icon:
                              - width: 18px
                              - color: rgba(255,255,255,0.92)
                        - type: custom:button-card
                          name: 2H
                          icon: mdi:timer-outline
                          show_state: false
                          tap_action:
                            action: call-service
                            service: timer.start
                            target:
                              entity_id: timer.diffuseur_huile
                            data:
                              duration: '02:00:00'
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 10px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                            name:
                              - font-weight: 900
                              - font-size: 12px
                              - color: rgba(255,255,255,0.95)
                            icon:
                              - width: 18px
                              - color: rgba(255,255,255,0.92)
                        - type: custom:button-card
                          name: Stop
                          icon: mdi:timer-off-outline
                          show_state: false
                          tap_action:
                            action: call-service
                            service: timer.cancel
                            target:
                              entity_id: timer.diffuseur_huile
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 10px
                              - background: rgba(220,70,70,0.12)
                              - border: 1px solid rgba(220,70,70,0.35)
                            name:
                              - font-weight: 900
                              - font-size: 12px
                              - color: rgba(255,255,255,0.95)
                            icon:
                              - width: 18px
                              - color: rgba(255,255,255,0.92)
                      card_mod:
                        style: |
                          ha-card{
                            background: transparent;
                            box-shadow: none;
                            border: none;
                            padding: 0 6px 12px;
                          }
    subview: true
  - type: sections
    max_columns: 3
    title: Apple TV
    path: apple-tv
    sections:
      - type: grid
        cards:
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card{
                  border-radius: 16px;
                  background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%);
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65);
                  border: 1px solid rgba(255,255,255,0.04);
                  overflow: hidden;
                }
            card:
              type: vertical-stack
              cards:
                - type: custom:button-card
                  entity: media_player.salon
                  name: Salon
                  icon: mdi:apple
                  show_state: false
                  tap_action:
                    action: more-info
                    entity: media_player.salon
                  styles:
                    card:
                      - background: transparent
                      - border: none
                      - box-shadow: none
                      - padding: 10px 12px 0
                    grid:
                      - grid-template-areas: '"i n app"'
                      - grid-template-columns: 18px 1fr auto
                      - column-gap: 8px
                      - align-items: center
                    icon:
                      - width: 18px
                      - color: rgba(255,255,255,0.92)
                    name:
                      - justify-self: start
                      - font-weight: 900
                      - font-size: 13px
                      - color: rgba(255,255,255,0.95)
                    custom_fields:
                      app:
                        - justify-self: end
                        - align-self: center
                  custom_fields:
                    app: |
                      [[[
                        const mp = states['media_player.salon'];
                        const a = (mp?.attributes?.app_name || mp?.attributes?.source || '').toString().toLowerCase();
                        const label = (mp?.attributes?.app_name || mp?.attributes?.source || 'App').toString();

                        let ic = 'mdi:apps';
                        if (a.includes('netflix')) ic = 'mdi:netflix';
                        else if (a.includes('youtube')) ic = 'mdi:youtube';
                        else if (a.includes('music')) ic = 'mdi:music';
                        else if (a.includes('apple tv')) ic = 'mdi:apple-tv';
                        else if (a.includes('iptv')) ic = 'mdi:television-play';

                        return `
                          <div style="
                            display:flex; align-items:center; gap:8px;
                            padding:6px 10px;
                            border-radius:999px;
                            background: rgba(255,255,255,0.07);
                            border: 1px solid rgba(255,255,255,0.10);
                          ">
                            <ha-icon icon="${ic}" style="width:18px;height:18px;color:rgba(255,255,255,0.92)"></ha-icon>
                            <span style="
                              font-weight:900;
                              font-size:12px;
                              color: rgba(255,255,255,0.90);
                              max-width:140px;
                              overflow:hidden;
                              text-overflow:ellipsis;
                              white-space:nowrap;
                            ">${label}</span>
                          </div>
                        `;
                      ]]]
                - type: media-control
                  entity: media_player.salon
                  card_mod:
                    style: |
                      ha-card{
                        background: transparent;
                        border: none;
                        box-shadow: none;
                        padding: 6px 10px 2px;
                      }
                - type: grid
                  columns: 3
                  square: false
                  cards:
                    - type: custom:button-card
                      name: POWER
                      icon: mdi:power
                      show_state: false
                      tap_action:
                        action: call-service
                        service: remote.send_command
                        target:
                          entity_id: remote.salon
                        data:
                          command: suspend
                      hold_action:
                        action: call-service
                        service: remote.send_command
                        target:
                          entity_id: remote.salon
                        data:
                          command: wakeup
                      styles:
                        card:
                          - border-radius: 12px
                          - padding: 9px
                          - background: rgba(255,255,255,0.06)
                          - border: 1px solid rgba(255,255,255,0.10)
                          - height: 52px
                        grid:
                          - grid-template-areas: '"i" "n"'
                          - grid-template-rows: 20px min-content
                          - row-gap: 4px
                          - justify-items: center
                          - align-items: center
                        icon:
                          - width: 18px
                          - color: rgba(255,255,255,0.92)
                        name:
                          - font-weight: 900
                          - font-size: 10px
                          - color: rgba(255,255,255,0.95)
                    - type: custom:button-card
                      name: HOME
                      icon: mdi:home-variant
                      show_state: false
                      tap_action:
                        action: call-service
                        service: remote.send_command
                        target:
                          entity_id: remote.salon
                        data:
                          command: home
                      styles:
                        card:
                          - border-radius: 12px
                          - padding: 9px
                          - background: rgba(255,255,255,0.06)
                          - border: 1px solid rgba(255,255,255,0.10)
                          - height: 52px
                        grid:
                          - grid-template-areas: '"i" "n"'
                          - grid-template-rows: 20px min-content
                          - row-gap: 4px
                          - justify-items: center
                          - align-items: center
                        icon:
                          - width: 18px
                          - color: rgba(255,255,255,0.92)
                        name:
                          - font-weight: 900
                          - font-size: 10px
                          - color: rgba(255,255,255,0.95)
                    - type: custom:button-card
                      name: RETOUR
                      icon: mdi:undo-variant
                      show_state: false
                      tap_action:
                        action: call-service
                        service: remote.send_command
                        target:
                          entity_id: remote.salon
                        data:
                          command: menu
                      styles:
                        card:
                          - border-radius: 12px
                          - padding: 9px
                          - background: rgba(255,255,255,0.06)
                          - border: 1px solid rgba(255,255,255,0.10)
                          - height: 52px
                        grid:
                          - grid-template-areas: '"i" "n"'
                          - grid-template-rows: 20px min-content
                          - row-gap: 4px
                          - justify-items: center
                          - align-items: center
                        icon:
                          - width: 18px
                          - color: rgba(255,255,255,0.92)
                        name:
                          - font-weight: 900
                          - font-size: 10px
                          - color: rgba(255,255,255,0.95)
                  card_mod:
                    style: |
                      ha-card{
                        background: transparent;
                        border: none;
                        box-shadow: none;
                        padding: 0 10px 8px;
                      }
                - type: custom:layout-card
                  layout_type: custom:grid-layout
                  layout:
                    grid-template-columns: 1fr 1fr 1fr 1fr 1fr
                    grid-column-gap: 10px
                    align-items: stretch
                  cards:
                    - type: grid
                      columns: 3
                      square: false
                      view_layout:
                        grid-column: 1 / span 4
                      cards:
                        - type: custom:button-card
                          color_type: blank-card
                        - type: custom:button-card
                          icon: mdi:chevron-up
                          show_name: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: up
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          color_type: blank-card
                        - type: custom:button-card
                          icon: mdi:chevron-left
                          show_name: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: left
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          name: ''
                          icon: mdi:circle-slice-8
                          show_state: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: select
                          styles:
                            card:
                              - border-radius: 12px
                              - background: rgba(255,255,255,0.10)
                              - border: 1px solid rgba(255,255,255,0.16)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 28px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          icon: mdi:chevron-right
                          show_name: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: right
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          color_type: blank-card
                        - type: custom:button-card
                          icon: mdi:chevron-down
                          show_name: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: down
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          color_type: blank-card
                    - type: vertical-stack
                      view_layout:
                        grid-column: 5 / span 1
                      cards:
                        - type: custom:button-card
                          name: ''
                          icon: mdi:volume-plus
                          show_state: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: volume_up
                          styles:
                            card:
                              - border-radius: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 172px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.92)
                        - type: custom:button-card
                          name: ''
                          icon: mdi:volume-minus
                          show_state: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: volume_down
                          styles:
                            card:
                              - border-radius: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 172px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.92)
    subview: true
    cards: []
    background:
      opacity: 100
      alignment: center
      size: cover
      repeat: repeat
      attachment: fixed
      image:
        media_content_id: media-source://image_upload/da239dc46997bb6ed69689a286c14dc2
        media_content_type: image/png
        metadata:
          title: dark_geometric_energy_blue_bg_1770562365952.png
          thumbnail: /api/image/serve/da239dc46997bb6ed69689a286c14dc2/256x256
          media_class: image
          navigateIds:
            - {}
            - media_content_type: app
              media_content_id: media-source://image_upload
    badges:
      - type: custom:button-card
        icon: mdi:home-variant-outline
        name: Accueil
        show_name: true
        tap_action:
          action: navigate
          navigation_path: /lovelace/0
        styles:
          card:
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(8px)
            - '-webkit-backdrop-filter': blur(8px)
            - border-radius: 12px
            - border: 1px solid rgba(255, 255, 255, 0.1)
            - padding: 6px 12px
            - width: fit-content
            - margin: 0 auto 10px 0
          grid:
            - grid-template-areas: '"i n"'
            - grid-template-columns: auto auto
            - column-gap: 8px
          icon:
            - width: 18px
            - color: '#00bfff'
          name:
            - font-size: 12px
            - font-weight: 700
            - color: rgba(255, 255, 255, 0.9)
    header:
      layout: start
      badges_position: bottom
      badges_wrap: wrap
  - type: custom:grid-layout
    title: Batteries
    path: batteries
    icon: mdi:battery-alert-variant-outline
    subview: false
    cards:
      - type: custom:button-card
        icon: mdi:home-variant-outline
        name: Accueil
        show_name: true
        tap_action:
          action: navigate
          navigation_path: /lovelace/0
        styles:
          card:
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(8px)
            - '-webkit-backdrop-filter': blur(8px)
            - border-radius: 12px
            - border: 1px solid rgba(255, 255, 255, 0.1)
            - padding: 6px 12px
            - width: fit-content
            - margin: 0 auto 10px 0
          grid:
            - grid-template-areas: '"i n"'
            - grid-template-columns: auto auto
            - column-gap: 8px
          icon:
            - width: 18px
            - color: '#00bfff'
          name:
            - font-size: 12px
            - font-weight: 700
            - color: rgba(255, 255, 255, 0.9)
      - type: vertical-stack
        cards:
          - type: custom:auto-entities
            card:
              type: entities
              title: 🔥 Batteries Critiques (<= 10%)
              card_mod:
                style: >
                  ha-card {
                    background: rgba(220, 20, 60, 0.2) !important;
                    backdrop-filter: blur(10px) !important;
                    border-radius: 20px !important;
                    border: 1px solid rgba(255, 50, 50, 0.4) !important;
                    margin-bottom: 20px !important;
                  }

                  .card-header { color: #ff4444 !important; font-weight: 700
                  !important; }
            filter:
              template: |
                {%- set sensors = states.sensor 
                  | selectattr('attributes.device_class', 'defined')
                  | selectattr('attributes.device_class', 'eq', 'battery')
                  | selectattr('state', 'is_number')
                  | rejectattr('entity_id', 'search', 'iphone', ignorecase=true)
                  | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')
                  | list -%}
                {%- for s in sensors if s.state | int <= 10 -%}
                  {{ {
                    'entity': s.entity_id,
                    'name': s.attributes.friendly_name,
                    'secondary_info': area_name(s.entity_id) or 'Pièce non définie',
                    'card_mod': {
                      'style': ':host { --paper-item-icon-color: #ff4444; color: white; }'
                    }
                  } }},
                {%- endfor -%}
            sort:
              method: state
              numeric: true
          - type: custom:auto-entities
            card:
              type: entities
              title: ⚠️ À surveiller (11% - 30%)
              card_mod:
                style: >
                  ha-card {
                    background: rgba(20, 27, 38, 0.6) !important;
                    backdrop-filter: blur(10px) !important;
                    border-radius: 20px !important;
                    border: 1px solid rgba(255,255,255,0.1) !important;
                    margin-bottom: 20px !important;
                  }

                  .card-header { color: #ff9800 !important; font-weight: 700
                  !important; }
            filter:
              template: >
                {%- set sensors = states.sensor 
                  | selectattr('attributes.device_class', 'defined')
                  | selectattr('attributes.device_class', 'eq', 'battery')
                  | selectattr('state', 'is_number')
                  | rejectattr('entity_id', 'search', 'iphone', ignorecase=true)
                  | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')
                  | list -%}
                {%- for s in sensors if s.state | int > 10 and s.state | int <=
                30 -%}
                  {{ {
                    'entity': s.entity_id,
                    'name': s.attributes.friendly_name,
                    'secondary_info': area_name(s.entity_id) or 'Pièce non définie',
                    'card_mod': {
                      'style': ':host { --paper-item-icon-color: #ff9800; color: white; }'
                    }
                  } }},
                {%- endfor -%}
            sort:
              method: state
              numeric: true
          - type: custom:auto-entities
            card:
              type: entities
              title: 🔋 État Moyen (31% - 50%)
              card_mod:
                style: >
                  ha-card {
                    background: rgba(20, 27, 38, 0.6) !important;
                    backdrop-filter: blur(10px) !important;
                    border-radius: 20px !important;
                    border: 1px solid rgba(255,255,255,0.1) !important;
                    margin-bottom: 20px !important;
                  }

                  .card-header { color: #ffeb3b !important; font-weight: 700
                  !important; }
            filter:
              template: >
                {%- set sensors = states.sensor 
                  | selectattr('attributes.device_class', 'defined')
                  | selectattr('attributes.device_class', 'eq', 'battery')
                  | selectattr('state', 'is_number')
                  | rejectattr('entity_id', 'search', 'iphone', ignorecase=true)
                  | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')
                  | list -%}
                {%- for s in sensors if s.state | int > 30 and s.state | int <=
                50 -%}
                  {{ {
                    'entity': s.entity_id,
                    'name': s.attributes.friendly_name,
                    'secondary_info': area_name(s.entity_id) or 'Pièce non définie',
                    'card_mod': {
                      'style': ':host { --paper-item-icon-color: #ffeb3b; color: white; }'
                    }
                  } }},
                {%- endfor -%}
            sort:
              method: state
              numeric: true
          - type: custom:auto-entities
            card:
              type: entities
              title: ✅ Bon État (51% - 100%)
              card_mod:
                style: >
                  ha-card {
                    background: rgba(20, 27, 38, 0.6) !important;
                    backdrop-filter: blur(10px) !important;
                    border-radius: 20px !important;
                    border: 1px solid rgba(255,255,255,0.1) !important;
                  }

                  .card-header { color: #4caf50 !important; font-weight: 700
                  !important; }
            filter:
              template: |
                {%- set sensors = states.sensor 
                  | selectattr('attributes.device_class', 'defined')
                  | selectattr('attributes.device_class', 'eq', 'battery')
                  | selectattr('state', 'is_number')
                  | rejectattr('entity_id', 'search', 'iphone', ignorecase=true)
                  | rejectattr('entity_id', 'eq', 'sensor.ci_tesla_battery')
                  | list -%}
                {%- for s in sensors if s.state | int > 50 -%}
                  {{ {
                    'entity': s.entity_id,
                    'name': s.attributes.friendly_name,
                    'secondary_info': area_name(s.entity_id) or 'Pièce non définie',
                    'card_mod': {
                      'style': ':host { --paper-item-icon-color: #4caf50; color: white; }'
                    }
                  } }},
                {%- endfor -%}
            sort:
              method: state
              numeric: true
  - type: custom:grid-layout
    path: livebox
    title: Livebox
    icon: mdi:web
    subview: true
    cards:
      - type: custom:button-card
        icon: mdi:home-variant-outline
        name: Accueil
        show_name: true
        tap_action:
          action: navigate
          navigation_path: /lovelace/0
        styles:
          card:
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(8px)
            - '-webkit-backdrop-filter': blur(8px)
            - border-radius: 12px
            - border: 1px solid rgba(255, 255, 255, 0.1)
            - padding: 6px 12px
            - width: fit-content
            - margin: 0 auto 10px 0
          grid:
            - grid-template-areas: '"i n"'
            - grid-template-columns: auto auto
            - column-gap: 8px
          icon:
            - width: 18px
            - color: '#00bfff'
          name:
            - font-size: 12px
            - font-weight: 700
            - color: rgba(255, 255, 255, 0.9)
      - type: vertical-stack
        cards:
          - type: custom:button-card
            entity: binary_sensor.livebox_w7_wan_status
            name: Livebox OS
            show_name: true
            show_icon: true
            icon: mdi:router-wireless
            styles:
              card:
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - border-radius: 20px
                - border: 1px solid rgba(255,255,255,0.1)
                - padding: 20px
              grid:
                - grid-template-areas: '"i n" "i info"'
                - grid-template-columns: 70px 1fr
              icon:
                - width: 50px
                - color: >
                    [[[ return entity.state === 'on' ? '#4caf50' : '#f44336';
                    ]]]
                - filter: >
                    [[[ return entity.state === 'on' ? 'drop-shadow(0 0 5px
                    #4caf5088)' : 'none'; ]]]
              name:
                - justify-self: start
                - font-weight: bold
                - font-size: 20px
                - margin-bottom: 5px
            custom_fields:
              info:
                card:
                  type: custom:button-card
                  styles:
                    card:
                      - background: none
                      - box-shadow: none
                      - border: none
                      - padding: 0
                    grid:
                      - grid-template-areas: >-
                          "ip label_ip" "link label_link" "up label_up" "remote
                          label_remote"
                      - grid-template-columns: 1fr 1fr
                    custom_fields:
                      ip:
                        - justify-self: start
                        - font-size: 11px
                        - opacity: 0.6
                      label_ip:
                        - justify-self: end
                        - font-size: 11px
                        - font-weight: bold
                      link:
                        - justify-self: start
                        - font-size: 11px
                        - opacity: 0.6
                      label_link:
                        - justify-self: end
                        - font-size: 11px
                        - font-weight: bold
                      up:
                        - justify-self: start
                        - font-size: 11px
                        - opacity: 0.6
                      label_up:
                        - justify-self: end
                        - font-size: 11px
                        - font-weight: bold
                      remote:
                        - justify-self: start
                        - font-size: 11px
                        - opacity: 0.6
                      label_remote:
                        - justify-self: end
                        - font-size: 11px
                        - font-weight: bold
                  custom_fields:
                    ip: 'Adresse IP :'
                    label_ip: >-
                      [[[ return
                      states['sensor.orange_livebox_ip_externe'].state ]]]
                    link: 'Type de lien :'
                    label_link: '[[[ return entity.attributes.link_type ]]]'
                    up: 'Uptime :'
                    label_up: |
                      [[[ 
                        let s = states['sensor.orange_livebox_temps_de_fonctionnement'].state;
                        let days = Math.floor(s / 86400);
                        let hours = Math.floor((s % 86400) / 3600);
                        return (days > 0 ? days + "j " : "") + hours + "h";
                      ]]]
                    remote: 'Accès distant :'
                    label_remote: >
                      [[[ return
                      states['binary_sensor.livebox_w7_remote_access'].state ===
                      'on' ? 'Activé' : 'Désactivé' ]]]
          - type: grid
            columns: 2
            square: false
            cards:
              - type: custom:button-card
                entity: switch.livebox_w7_wifi_switch
                name: WiFi 6E
                show_icon: true
                show_name: true
                icon: mdi:wifi
                state:
                  - value: 'on'
                    icon: mdi:wifi
                    styles:
                      card:
                        - background: rgba(76, 175, 80, 0.25)
                        - border: 1px solid rgba(76, 175, 80, 0.5)
                      icon:
                        - color: '#4caf50'
                  - value: 'off'
                    icon: mdi:wifi-off
                    styles:
                      card:
                        - background: rgba(255, 255, 255, 0.05)
                        - border: 1px solid rgba(255, 255, 255, 0.1)
                      icon:
                        - color: '#666'
                styles:
                  card:
                    - height: 100px
                    - border-radius: 15px
                  icon:
                    - width: 32px
                  name:
                    - font-size: 13px
                    - font-weight: bold
                    - margin-top: 8px
              - type: custom:button-card
                entity: switch.livebox_w7_guest_wifi_switch
                name: WiFi Invités
                show_icon: true
                show_name: true
                icon: mdi:wifi-lock-open
                state:
                  - value: 'on'
                    icon: mdi:wifi-lock-open
                    styles:
                      card:
                        - background: rgba(255, 152, 0, 0.25)
                        - border: 1px solid rgba(255, 152, 0, 0.4)
                      icon:
                        - color: '#ff9800'
                  - value: 'off'
                    icon: mdi:wifi-off
                    styles:
                      card:
                        - background: rgba(255, 255, 255, 0.05)
                        - border: 1px solid rgba(255, 255, 255, 0.1)
                      icon:
                        - color: '#666'
                styles:
                  card:
                    - height: 100px
                    - border-radius: 15px
                  icon:
                    - width: 32px
                  name:
                    - font-size: 13px
                    - font-weight: bold
                    - margin-top: 8px
          - type: grid
            columns: 2
            square: false
            cards:
              - type: custom:button-card
                entity: sensor.livebox_w7_fiber_power_rx
                name: Réception (Rx)
                show_name: true
                show_state: true
                styles:
                  card:
                    - background: rgba(255, 255, 255, 0.05)
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - padding: 15px
                    - min-height: 160px
                  grid:
                    - grid-template-areas: '"n status" "s s" "graph graph"'
                    - grid-template-columns: 1fr 30px
                    - grid-template-rows: 25px 45px 1fr
                  name:
                    - justify-self: start
                    - font-size: 13px
                    - font-weight: 600
                    - color: white
                    - opacity: 0.8
                  state:
                    - justify-self: center
                    - font-size: 22px
                    - font-weight: bold
                    - color: white
                custom_fields:
                  status:
                    card:
                      type: custom:button-card
                      styles:
                        card:
                          - width: 12px
                          - height: 12px
                          - border-radius: 50%
                          - justify-self: end
                          - background: |
                              [[[ 
                                let v = parseFloat(entity.state);
                                if (v > -22) return '#4caf50';
                                if (v > -25) return '#ff9800';
                                return '#f44336';
                              ]]]
                          - box-shadow: |
                              [[[ 
                                let v = parseFloat(entity.state);
                                let c = (v > -22) ? '#4caf50' : (v > -25) ? '#ff9800' : '#f44336';
                                return '0 0 6px ' + c;
                              ]]]
                  graph:
                    card:
                      type: custom:mini-graph-card
                      entities:
                        - sensor.livebox_w7_fiber_power_rx
                      line_color: |
                        [[[ 
                          let v = parseFloat(states['sensor.livebox_w7_fiber_power_rx'].state);
                          if (v > -22) return '#4caf50';
                          if (v > -25) return '#ff9800';
                          return '#f44336';
                        ]]]
                      line_width: 4
                      show:
                        name: false
                        icon: false
                        state: false
                      card_mod:
                        style: 'ha-card { background: none; border: none; }'
              - type: custom:button-card
                entity: sensor.livebox_w7_fiber_power_tx
                name: Émission (Tx)
                show_name: true
                show_state: true
                styles:
                  card:
                    - background: rgba(255, 255, 255, 0.05)
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - padding: 15px
                    - min-height: 160px
                  grid:
                    - grid-template-areas: '"n status" "s s" "graph graph"'
                    - grid-template-columns: 1fr 30px
                    - grid-template-rows: 25px 45px 1fr
                  name:
                    - justify-self: start
                    - font-size: 13px
                    - font-weight: 600
                    - color: white
                    - opacity: 0.8
                  state:
                    - justify-self: center
                    - font-size: 22px
                    - font-weight: bold
                    - color: white
                custom_fields:
                  status:
                    card:
                      type: custom:button-card
                      styles:
                        card:
                          - width: 12px
                          - height: 12px
                          - border-radius: 50%
                          - justify-self: end
                          - background: |
                              [[[ 
                                let v = parseFloat(entity.state);
                                if (v >= 1 && v <= 6) return '#4caf50';
                                if (v > 6 && v <= 8) return '#ff9800';
                                return '#f44336';
                              ]]]
                          - box-shadow: |
                              [[[ 
                                let v = parseFloat(entity.state);
                                let c = (v >= 1 && v <= 6) ? '#4caf50' : (v > 6 && v <= 8) ? '#ff9800' : '#f44336';
                                return '0 0 6px ' + c;
                              ]]]
                  graph:
                    card:
                      type: custom:mini-graph-card
                      entities:
                        - sensor.livebox_w7_fiber_power_tx
                      line_color: |
                        [[[ 
                          let v = parseFloat(states['sensor.livebox_w7_fiber_power_tx'].state);
                          if (v >= 1 && v <= 6) return '#4caf50';
                          if (v > 6 && v <= 8) return '#ff9800';
                          return '#f44336';
                        ]]]
                      line_width: 4
                      show:
                        name: false
                        icon: false
                        state: false
                      card_mod:
                        style: 'ha-card { background: none; border: none; }'
          - type: grid
            columns: 2
            square: false
            cards:
              - type: custom:button-card
                entity: sensor.livebox_w7_fiber_rx
                name: Total Reçu
                show_state: true
                styles:
                  card:
                    - background: rgba(255, 255, 255, 0.05)
                    - border-radius: 15px
                    - border: 1px solid rgba(255,255,255,0.05)
                    - height: 75px
                  state:
                    - font-size: 15px
                    - font-weight: bold
                    - color: '#4caf50'
                  name:
                    - font-size: 11px
                    - opacity: 0.7
              - type: custom:button-card
                entity: sensor.livebox_w7_fiber_tx
                name: Total Envoyé
                show_state: true
                styles:
                  card:
                    - background: rgba(255, 255, 255, 0.05)
                    - border-radius: 15px
                    - border: 1px solid rgba(255,255,255,0.05)
                    - height: 75px
                  state:
                    - font-size: 15px
                    - font-weight: bold
                    - color: '#ff9800'
                  name:
                    - font-size: 11px
                    - opacity: 0.7
          - type: entities
            title: Maintenance
            entities:
              - entity: update.orange_livebox_routeur_update
                name: Mise à jour Firmware
              - entity: button.livebox_w7_livebox_restart
                name: Redémarrer la Box
                icon: mdi:restart
            card_mod:
              style: |
                ha-card {
                  background: rgba(255, 255, 255, 0.05) !important;
                  border-radius: 20px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                }
  - type: sections
    title: Multimédia
    icon: mdi:multimedia
    subview: true
    cards: []
    sections:
      - type: grid
        cards:
          - type: custom:button-card
            entity: media_player.samsung_smart_tv
            name: En Direct
            aspect_ratio: 16/9
            show_name: true
            show_icon: false
            styles:
              card:
                - border-radius: 24px
                - border: 1px solid rgba(255,255,255,0.1)
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(20px)
                - box-shadow: 0 8px 32px rgba(0,0,0,0.3)
                - overflow: hidden
                - padding: 0
              grid:
                - grid-template-areas: '"n" "controls"'
                - grid-template-rows: 1fr auto
              name:
                - justify-self: start
                - align-self: start
                - padding: 16px
                - font-size: 14px
                - font-weight: 700
                - color: white
                - text-shadow: 0 2px 10px rgba(0,0,0,0.8)
                - z-index: 2
              custom_fields:
                bg:
                  - position: absolute
                  - inset: 0
                  - z-index: 0
                overlay:
                  - position: absolute
                  - inset: 0
                  - z-index: 1
                  - background: >-
                      linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0)
                      50%)
                controls:
                  - padding: 12px 16px
                  - z-index: 2
                  - background: rgba(0,0,0,0.3)
            custom_fields:
              bg: |
                [[[
                  const pic = entity?.attributes?.entity_picture;
                  const state = entity?.state;
                  if (state === 'off' || state === 'unavailable') {
                     return `<div style="width:100%; height:100%; background: #111; display:flex; align-items:center; justify-content:center; color:#444;">ÉTEINT</div>`;
                  }
                  if (pic) {
                    return `<div style="width:100%; height:100%; background: url('${pic}') center/cover no-repeat; transition: all 0.5s ease;"></div>`;
                  }
                  return `<div style="width:100%; height:100%; background: linear-gradient(45deg, #141b26, #111826);"></div>`;
                ]]]
              controls: |
                [[[
                  const vol = entity?.attributes?.volume_level ? Math.round(entity.attributes.volume_level * 100) : '--';
                  return `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                      <div style="color:white; font-size:12px; font-weight:600;">🔈 ${vol}%</div>
                      <div style="display:flex; gap:15px;">
                         <ha-icon icon="mdi:skip-previous" style="width:20px; color:white;"></ha-icon>
                         <ha-icon icon="mdi:pause" style="width:20px; color:white;"></ha-icon>
                         <ha-icon icon="mdi:skip-next" style="width:20px; color:white;"></ha-icon>
                      </div>
                    </div>
                  `;
                ]]]
          - type: custom:mod-card
            card_mod:
              style: |
                ha-card{
                  border-radius: 16px;
                  background: linear-gradient(160deg,#141b26 0%,#111826 45%,#0d121c 100%);
                  box-shadow: 0 10px 22px rgba(0,0,0,0.65);
                  border: 1px solid rgba(255,255,255,0.04);
                  overflow: hidden;
                }
            card:
              type: vertical-stack
              cards:
                - type: custom:button-card
                  entity: media_player.salon
                  name: Salon
                  icon: mdi:apple
                  show_state: false
                  tap_action:
                    action: more-info
                    entity: media_player.salon
                  styles:
                    card:
                      - background: transparent
                      - border: none
                      - box-shadow: none
                      - padding: 10px 12px 0
                    grid:
                      - grid-template-areas: '"i n app"'
                      - grid-template-columns: 18px 1fr auto
                      - column-gap: 8px
                      - align-items: center
                    icon:
                      - width: 18px
                      - color: rgba(255,255,255,0.92)
                    name:
                      - justify-self: start
                      - font-weight: 900
                      - font-size: 13px
                      - color: rgba(255,255,255,0.95)
                    custom_fields:
                      app:
                        - justify-self: end
                        - align-self: center
                  custom_fields:
                    app: |
                      [[[
                        const mp = states['media_player.salon'];
                        const a = (mp?.attributes?.app_name || mp?.attributes?.source || '').toString().toLowerCase();
                        const label = (mp?.attributes?.app_name || mp?.attributes?.source || 'App').toString();

                        let ic = 'mdi:apps';
                        if (a.includes('netflix')) ic = 'mdi:netflix';
                        else if (a.includes('youtube')) ic = 'mdi:youtube';
                        else if (a.includes('music')) ic = 'mdi:music';
                        else if (a.includes('apple tv')) ic = 'mdi:apple-tv';
                        else if (a.includes('iptv')) ic = 'mdi:television-play';

                        return `
                          <div style="
                            display:flex; align-items:center; gap:8px;
                            padding:6px 10px;
                            border-radius:999px;
                            background: rgba(255,255,255,0.07);
                            border: 1px solid rgba(255,255,255,0.10);
                          ">
                            <ha-icon icon="${ic}" style="width:18px;height:18px;color:rgba(255,255,255,0.92)"></ha-icon>
                            <span style="
                              font-weight:900;
                              font-size:12px;
                              color: rgba(255,255,255,0.90);
                              max-width:140px;
                              overflow:hidden;
                              text-overflow:ellipsis;
                              white-space:nowrap;
                            ">${label}</span>
                          </div>
                        `;
                      ]]]
                - type: media-control
                  entity: media_player.salon
                  card_mod:
                    style: |
                      ha-card{
                        background: transparent;
                        border: none;
                        box-shadow: none;
                        padding: 6px 10px 2px;
                      }
                - type: grid
                  columns: 3
                  square: false
                  cards:
                    - type: custom:button-card
                      name: POWER
                      icon: mdi:power
                      show_state: false
                      tap_action:
                        action: call-service
                        service: remote.send_command
                        target:
                          entity_id: remote.salon
                        data:
                          command: suspend
                      hold_action:
                        action: call-service
                        service: remote.send_command
                        target:
                          entity_id: remote.salon
                        data:
                          command: wakeup
                      styles:
                        card:
                          - border-radius: 12px
                          - padding: 9px
                          - background: rgba(255,255,255,0.06)
                          - border: 1px solid rgba(255,255,255,0.10)
                          - height: 52px
                        grid:
                          - grid-template-areas: '"i" "n"'
                          - grid-template-rows: 20px min-content
                          - row-gap: 4px
                          - justify-items: center
                          - align-items: center
                        icon:
                          - width: 18px
                          - color: rgba(255,255,255,0.92)
                        name:
                          - font-weight: 900
                          - font-size: 10px
                          - color: rgba(255,255,255,0.95)
                    - type: custom:button-card
                      name: HOME
                      icon: mdi:home-variant
                      show_state: false
                      tap_action:
                        action: call-service
                        service: remote.send_command
                        target:
                          entity_id: remote.salon
                        data:
                          command: home
                      styles:
                        card:
                          - border-radius: 12px
                          - padding: 9px
                          - background: rgba(255,255,255,0.06)
                          - border: 1px solid rgba(255,255,255,0.10)
                          - height: 52px
                        grid:
                          - grid-template-areas: '"i" "n"'
                          - grid-template-rows: 20px min-content
                          - row-gap: 4px
                          - justify-items: center
                          - align-items: center
                        icon:
                          - width: 18px
                          - color: rgba(255,255,255,0.92)
                        name:
                          - font-weight: 900
                          - font-size: 10px
                          - color: rgba(255,255,255,0.95)
                    - type: custom:button-card
                      name: RETOUR
                      icon: mdi:undo-variant
                      show_state: false
                      tap_action:
                        action: call-service
                        service: remote.send_command
                        target:
                          entity_id: remote.salon
                        data:
                          command: menu
                      styles:
                        card:
                          - border-radius: 12px
                          - padding: 9px
                          - background: rgba(255,255,255,0.06)
                          - border: 1px solid rgba(255,255,255,0.10)
                          - height: 52px
                        grid:
                          - grid-template-areas: '"i" "n"'
                          - grid-template-rows: 20px min-content
                          - row-gap: 4px
                          - justify-items: center
                          - align-items: center
                        icon:
                          - width: 18px
                          - color: rgba(255,255,255,0.92)
                        name:
                          - font-weight: 900
                          - font-size: 10px
                          - color: rgba(255,255,255,0.95)
                  card_mod:
                    style: |
                      ha-card{
                        background: transparent;
                        border: none;
                        box-shadow: none;
                        padding: 0 10px 8px;
                      }
                - type: custom:layout-card
                  layout_type: custom:grid-layout
                  layout:
                    grid-template-columns: 1fr 1fr 1fr 1fr 1fr
                    grid-column-gap: 10px
                    align-items: stretch
                  cards:
                    - type: grid
                      columns: 3
                      square: false
                      view_layout:
                        grid-column: 1 / span 4
                      cards:
                        - type: custom:button-card
                          color_type: blank-card
                        - type: custom:button-card
                          icon: mdi:chevron-up
                          show_name: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: up
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          color_type: blank-card
                        - type: custom:button-card
                          icon: mdi:chevron-left
                          show_name: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: left
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          name: ''
                          icon: mdi:circle-slice-8
                          show_state: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: select
                          styles:
                            card:
                              - border-radius: 12px
                              - background: rgba(255,255,255,0.10)
                              - border: 1px solid rgba(255,255,255,0.16)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 28px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          icon: mdi:chevron-right
                          show_name: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: right
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          color_type: blank-card
                        - type: custom:button-card
                          icon: mdi:chevron-down
                          show_name: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: down
                          styles:
                            card:
                              - border-radius: 12px
                              - padding: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 112px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.95)
                        - type: custom:button-card
                          color_type: blank-card
                    - type: vertical-stack
                      view_layout:
                        grid-column: 5 / span 1
                      cards:
                        - type: custom:button-card
                          name: ''
                          icon: mdi:volume-plus
                          show_state: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: volume_up
                          styles:
                            card:
                              - border-radius: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 172px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.92)
                        - type: custom:button-card
                          name: ''
                          icon: mdi:volume-minus
                          show_state: false
                          tap_action:
                            action: call-service
                            service: remote.send_command
                            target:
                              entity_id: remote.salon
                            data:
                              command: volume_down
                          styles:
                            card:
                              - border-radius: 12px
                              - background: rgba(255,255,255,0.06)
                              - border: 1px solid rgba(255,255,255,0.10)
                              - height: 172px
                              - display: flex
                              - align-items: center
                              - justify-content: center
                            icon:
                              - width: 26px
                              - color: rgba(255,255,255,0.92)
      - type: grid
        cards:
          - type: custom:button-card
            entity: media_player.samsung_tv_salon
            name: Samsung TV Salon
            show_name: true
            show_icon: false
            aspect_ratio: 16/9
            styles:
              card:
                - padding: 0
                - border-radius: 24px
                - border: 1px solid rgba(255,255,255,0.1)
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(20px)
                - '-webkit-backdrop-filter': blur(20px)
                - box-shadow: 0 8px 32px rgba(0,0,0,0.3)
                - overflow: hidden
              grid:
                - grid-template-areas: '"i" "n" "controls"'
                - grid-template-columns: 1fr
                - grid-template-rows: 1fr auto auto
              custom_fields:
                bg:
                  - position: absolute
                  - inset: 0
                  - z-index: 0
                overlay:
                  - position: absolute
                  - inset: 0
                  - z-index: 1
                  - background: >-
                      linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.1)
                      50%, rgba(0,0,0,0.2) 100%)
                controls:
                  - align-self: end
                  - padding: 16px
                  - z-index: 2
                'n':
                  - position: absolute
                  - top: 16px
                  - left: 20px
                  - z-index: 2
                  - font-size: 14px
                  - font-weight: 700
                  - color: white
                  - text-shadow: 0 2px 4px rgba(0,0,0,0.8)
            custom_fields:
              bg: |
                [[[
                  const samsung = entity;
                  const pic = samsung?.attributes?.entity_picture;
                  
                  if (samsung?.state !== 'off' && samsung?.state !== 'unavailable') {
                    if (pic) {
                      return `<div style="width:100%; height:100%; background: url('${pic}') center/cover no-repeat; transition: background 0.5s ease;"></div>`;
                    }
                    // Design minimaliste quand allumé sans artwork (ex: HDMI)
                    return `
                      <div style="width:100%; height:100%; background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%); opacity: 0.15;"></div>
                      <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
                        <ha-icon icon="mdi:television-play" style="width:40px; color:rgba(255,255,255,0.2);"></ha-icon>
                      </div>
                    `;
                  }
                  return `<div style="width:100%; height:100%; background: #050505; display:flex; align-items:center; justify-content:center; color:#333; font-weight:900; letter-spacing:2px;">STANDBY</div>`;
                ]]]
              controls: |
                [[[
                  const vRaw = entity?.attributes?.volume_level;
                  const vol = (vRaw !== undefined) ? Math.round(vRaw * 100) : '--';
                  const on = entity?.state !== 'off' && entity?.state !== 'unavailable';
                  return `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                      <div style="color:white; font-size:12px; font-weight:800; opacity:0.9;">VOL ${vol}%</div>
                      <div style="display:flex; gap:18px;">
                         <ha-icon icon="mdi:power" style="width:20px; color:${on ? '#00AAFF' : 'rgba(255,255,255,0.3)'}; cursor:pointer;"></ha-icon>
                         <ha-icon icon="mdi:volume-minus" style="width:18px; color:rgba(255,255,255,0.6);"></ha-icon>
                         <ha-icon icon="mdi:volume-plus" style="width:18px; color:rgba(255,255,255,0.6);"></ha-icon>
                      </div>
                    </div>
                  `;
                ]]]
            triggers_update:
              - media_player.samsung_tv_salon
            tap_action:
              action: more-info
            hold_action:
              action: call-service
              service: media_player.toggle
              target:
                entity_id: media_player.samsung_tv_salon
  - type: sections
    max_columns: 3
    title: NAS
    path: nas
    sections:
      - type: grid
        cards:
          - type: custom:button-card
            entity: sensor.chrisnas_etat
            name: SYSTÈME NAS
            icon: mdi:nas
            show_state: true
            styles:
              card:
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(20px)
                - '-webkit-backdrop-filter': blur(20px)
                - border-radius: 20px
                - border: 1px solid rgba(255, 255, 255, 0.1)
                - padding: 15px
              grid:
                - grid-template-areas: '"i n" "i s" "uptime uptime" "temp temp"'
                - grid-template-columns: 45px 1fr
                - align-items: center
              icon:
                - color: >
                    [[[ return entity.state === 'good' ? '#00ff88' : '#ff1111'
                    ]]]
                - width: 28px
                - filter: >
                    [[[ return entity.state === 'good' ? 'drop-shadow(0 0 5px
                    #00ff88)' : 'drop-shadow(0 0 5px #ff1111)' ]]]
              name:
                - justify-self: start
                - font-weight: 900
                - font-size: 14px
                - color: '#ffffff'
                - text-transform: uppercase
                - letter-spacing: 2px
              state:
                - justify-self: start
                - font-weight: bold
                - font-size: 12px
                - color: rgba(255, 255, 255, 0.6)
                - text-transform: uppercase
              custom_fields:
                uptime:
                  - margin-top: 15px
                  - padding-top: 10px
                  - border-top: 1px solid rgba(255, 255, 255, 0.05)
                  - font-size: 14px
                  - color: rgba(255, 255, 255, 0.6)
                temp:
                  - margin-top: 5px
                  - font-size: 16px
                  - color: rgba(255, 255, 255, 0.6)
            custom_fields:
              uptime: |
                [[[
                  const uptime = states['sensor.chrisnas_uptime'].state;
                  return `<ha-icon icon="mdi:clock-outline" style="width:14px;vertical-align:middle;margin-right:5px;"></ha-icon> Uptime: ${new Date(uptime).toLocaleString()}`;
                ]]]
              temp: |
                [[[
                  const stemp = states['sensor.chrisnas_temperature_du_systeme'].state;
                  return `<ha-icon icon="mdi:thermometer" style="width:14px;vertical-align:middle;margin-right:5px;"></ha-icon> Temp. Système: ${stemp}°C`;
                ]]]
          - type: custom:button-card
            entity: sensor.chrisnas_volume_utilise_datavol1
            name: STOCKAGE DATAVOL1
            icon: mdi:database
            show_state: true
            styles:
              card:
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(20px)
                - border-radius: 20px
                - border: 1px solid rgba(255, 255, 255, 0.1)
                - padding: 15px
              grid:
                - grid-template-areas: '"i n s" "bar bar bar" "stats stats stats"'
                - grid-template-columns: 30px 1fr auto
                - align-items: center
              icon:
                - color: '#00ff88'
                - width: 22px
              name:
                - justify-self: start
                - font-weight: 900
                - font-size: 12px
                - color: '#ffffff'
                - text-transform: uppercase
              state:
                - justify-self: end
                - font-size: 14px
                - font-weight: 900
                - color: '#ffffff'
              custom_fields:
                bar:
                  - background: rgba(255, 255, 255, 0.05)
                  - border-radius: 6px
                  - height: 8px
                  - width: 100%
                  - margin: 12px 0
                  - position: relative
                  - overflow: hidden
                stats:
                  - display: flex
                  - justify-content: space-between
                  - font-size: 14px
                  - color: rgba(255, 255, 255, 0.7)
            custom_fields:
              bar: |
                [[[
                  const val = parseFloat(entity.state);
                  const color = val > 90 ? '#ff1111' : val > 75 ? '#ff9900' : '#00ff88';
                  return `<div style="background: ${color}; width: ${val}%; height: 100%; border-radius: 6px; box-shadow: 0 0 10px ${color}; transition: width 1s;"></div>`;
                ]]]
              stats: |
                [[[
                  const free = states['sensor.chrisnas_espace_libre_datavol1'].state;
                  const total = states['sensor.chrisnas_volume_size'].state;
                  return `<span>Libre: ${Math.round(free)} GiB</span><span>Total: ${Math.round(total)} GiB</span>`;
                ]]]
          - type: vertical-stack
            cards:
              - type: custom:button-card
                name: ÉTAT DES DISQUES
                icon: mdi:harddisk
                styles:
                  card:
                    - background: rgba(30, 39, 54, 0.8)
                    - border-radius: 15px 15px 0 0
                    - border: 1px solid rgba(255, 255, 255, 0.1)
                    - height: 40px
                  grid:
                    - grid-template-areas: '"i n"'
                    - grid-template-columns: 40px 1fr
                    - align-items: center
                  icon:
                    - color: '#00ff88'
                    - width: 22px
                  name:
                    - font-weight: 900
                    - font-size: 12px
                    - justify-self: start
              - type: grid
                columns: 3
                square: false
                cards:
                  - type: custom:button-card
                    entity: sensor.chrisnas_etat_du_lecteur_0_1
                    name: HDD 1
                    show_state: false
                    custom_fields:
                      t: >
                        [[[ return
                        states['sensor.chrisnas_temperature_du_lecteur_0_1'].state
                        + '°' ]]]
                      sn: >
                        [[[ return entity.attributes['Serial #'] ?
                        entity.attributes['Serial #'].slice(-4) : '...' ]]]
                    styles:
                      card:
                        - background: rgba(20, 27, 38, 0.6)
                        - border-radius: 0
                        - border: 1px solid rgba(255, 255, 255, 0.1)
                        - border-top: none
                        - padding: 8px
                      grid:
                        - grid-template-areas: '"n" "i" "t" "sn"'
                        - align-items: center
                      name:
                        - font-size: 12px
                        - color: rgba(255, 255, 255, 0.3)
                      icon:
                        - width: 22px
                        - color: >
                            [[[ return entity.state === 'OK' ? '#00ff88' :
                            '#ff1111' ]]]
                      custom_fields:
                        t:
                          - font-size: 14px
                          - font-weight: bold
                          - color: '#ffffff'
                        sn:
                          - font-size: 10px
                          - color: rgba(255
                          - 255
                          - 255
                          - 0.2)
                          - text-transform: uppercase
                  - type: custom:button-card
                    entity: sensor.chrisnas_etat_du_lecteur_0_2
                    name: HDD 2
                    show_state: false
                    custom_fields:
                      t: >
                        [[[ return
                        states['sensor.chrisnas_temperature_du_lecteur_0_2'].state
                        + '°' ]]]
                      sn: >
                        [[[ return entity.attributes['Serial #'] ?
                        entity.attributes['Serial #'].slice(-4) : '...' ]]]
                    styles:
                      card:
                        - background: rgba(20, 27, 38, 0.6)
                        - border-radius: 0
                        - border: 1px solid rgba(255, 255, 255, 0.1)
                        - border-top: none
                        - border-left: none
                        - padding: 8px
                      grid:
                        - grid-template-areas: '"n" "i" "t" "sn"'
                        - align-items: center
                      name:
                        - font-size: 12px
                        - color: rgba(255, 255, 255, 0.3)
                      icon:
                        - width: 22px
                        - color: >
                            [[[ return entity.state === 'OK' ? '#00ff88' :
                            '#ff1111' ]]]
                      custom_fields:
                        t:
                          - font-size: 14px
                          - font-weight: bold
                          - color: '#ffffff'
                        sn:
                          - font-size: 10px
                          - color: rgba(255
                          - 255
                          - 255
                          - 0.2)
                          - text-transform: uppercase
                  - type: custom:button-card
                    entity: sensor.chrisnas_etat_du_lecteur_0_3
                    name: HDD 3
                    show_state: false
                    custom_fields:
                      t: >
                        [[[ return
                        states['sensor.chrisnas_temperature_du_lecteur_0_3'].state
                        + '°' ]]]
                      sn: >
                        [[[ return entity.attributes['Serial #'] ?
                        entity.attributes['Serial #'].slice(-4) : '...' ]]]
                    styles:
                      card:
                        - background: rgba(20, 27, 38, 0.6)
                        - border-radius: 0 0 15px 0
                        - border: 1px solid rgba(255, 255, 255, 0.1)
                        - border-top: none
                        - border-left: none
                        - padding: 8px
                      grid:
                        - grid-template-areas: '"n" "i" "t" "sn"'
                        - align-items: center
                      name:
                        - font-size: 12px
                        - color: rgba(255, 255, 255, 0.3)
                      icon:
                        - width: 22px
                        - color: >
                            [[[ return entity.state === 'OK' ? '#00ff88' :
                            '#ff1111' ]]]
                      custom_fields:
                        t:
                          - font-size: 14px
                          - font-weight: bold
                          - color: '#ffffff'
                        sn:
                          - font-size: 10px
                          - color: rgba(255
                          - 255
                          - 255
                          - 0.2)
                          - text-transform: uppercase
      - type: grid
        cards:
          - type: custom:button-card
            name: |
              [[[
                const cpu = states['sensor.chrisnas_utilisation_du_processeur'].state;
                const ram = states['sensor.chrisnas_utilisation_de_la_memoire'].state;
                return `CPU ${Math.round(cpu)}% & RAM ${Math.round(ram)}%`;
              ]]]
            triggers_update:
              - sensor.chrisnas_utilisation_du_processeur
              - sensor.chrisnas_utilisation_de_la_memoire
            icon: mdi:cpu-64-bit
            styles:
              card:
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(20px)
                - border-radius: 20px
                - border: 1px solid rgba(255, 255, 255, 0.1)
                - padding: 12px 15px
              grid:
                - grid-template-areas: '"i n" "graph graph" "footer footer"'
                - grid-template-columns: 35px 1fr
                - align-items: center
              icon:
                - color: '#ff00ff'
                - width: 22px
                - filter: drop-shadow(0 0 5px
              name:
                - font-weight: 900
                - font-size: 14px
                - color: '#ffffff'
                - text-transform: uppercase
                - letter-spacing: 1px
                - justify-self: start
              custom_fields:
                graph:
                  - margin: 5px 0
                footer:
                  - border-top: 1px solid rgba(255, 255, 255, 0.1)
                  - padding-top: 8px
                  - font-size: 11px
                  - color: rgba(255, 255, 255, 0.6)
                  - font-weight: bold
            custom_fields:
              graph:
                card:
                  type: custom:mini-graph-card
                  entities:
                    - entity: sensor.chrisnas_utilisation_du_processeur
                      name: CPU
                      color: '#00ccff'
                    - entity: sensor.chrisnas_utilisation_de_la_memoire
                      name: RAM
                      color: '#ff00ff'
                  line_width: 4
                  hours_to_show: 6
                  points_per_hour: 2
                  font_size: 60
                  show:
                    fill: fade
                    name: false
                    state: true
                    legend: true
                  style: |
                    ha-card { 
                      background: transparent !important; 
                      border: none !important; 
                      box-shadow: none !important;
                      margin-top: -10px;
                    }
              footer: |
                [[[
                  const cpu_temp = states['sensor.chrisnas_temperature_du_processeur'].state;
                  const mem_used = states['sensor.chrisnas_memoire_utilisee'].state;
                  const mem_total = states['sensor.chrisnas_memory_size'].state;
                  const t_color = cpu_temp > 55 ? '#ff1111' : '#00ff88';
                  return `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                      <span>TEMP CPU: <span style="color:${t_color}">${cpu_temp}°C</span></span>
                      <span>RAM: <span style="color:#ffffff">${Math.round(mem_used)} / ${Math.round(mem_total)} GiB</span></span>
                    </div>
                  `;
                ]]]
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                name: RÉSEAU TRAFIC
                icon: mdi:lan
                styles:
                  card:
                    - background: rgba(30, 39, 54, 0.8)
                    - border-radius: 15px 15px 0 0
                    - border: 1px solid rgba(255, 255, 255, 0.1)
                    - height: 40px
                  grid:
                    - grid-template-areas: '"i n"'
                    - grid-template-columns: 40px 1fr
                    - align-items: center
                  icon:
                    - color: '#00ccff'
                    - width: 22px
                  name:
                    - font-weight: 900
                    - font-size: 16px
                    - color: '#ffffff'
                    - justify-self: start
              - type: custom:mini-graph-card
                entities:
                  - entity: sensor.chrisnas_eth0_download
                    name: Down (0)
                    color: '#00ff88'
                  - entity: sensor.chrisnas_eth0_upload
                    name: Up (0)
                    color: '#ff9900'
                line_width: 2
                show:
                  fill: fade
                  legend: true
                style: |
                  ha-card {
                    background: rgba(20, 27, 38, 0.6) !important;
                    border-radius: 0 !important;
                    border: 1px solid rgba(255, 255, 255, 0.1) !important;
                    border-top: none !important;
                    padding-bottom: 10px !important;
                  }
              - type: custom:button-card
                name: STATS LIAISONS
                styles:
                  card:
                    - background: rgba(20, 27, 38, 0.6)
                    - border-radius: 0 0 15px 15px
                    - border: 1px solid rgba(255, 255, 255, 0.1)
                    - border-top: none
                    - padding: 10px
                  grid:
                    - grid-template-areas: '"eth0 eth1"'
                    - grid-template-columns: 1fr 1fr
                  custom_fields:
                    eth0:
                      - justify-self: start
                      - font-size: 10px
                      - line-height: 1.2
                    eth1:
                      - justify-self: end
                      - font-size: 10px
                      - line-height: 1.2
                      - text-align: right
                custom_fields:
                  eth0: |
                    [[[
                      const link = states['sensor.chrisnas_eth0_link'].state;
                      const err = states['sensor.chrisnas_eth0_packet_errors'].state;
                      return `ETH0: <span style="color:#00ff88">${link}</span><br>Err: ${err}`;
                    ]]]
                  eth1: |
                    [[[
                      const link = states['sensor.chrisnas_eth1_link'].state;
                      const err = states['sensor.chrisnas_eth1_packet_errors'].state;
                      return `ETH1: <span style="color:${link === 'Up' ? '#00ff88' : '#757575'}">${link}</span><br>Err: ${err}`;
                    ]]]
    subview: true
    cards: []
    header:
      card:
        type: custom:button-card
        entity: sensor.chrisnas_etat
        name: |
          [[[
            const date = new Date();
            const hour = date.getHours();
            const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            
            let greeting = "Bonjour";
            if (hour >= 18) greeting = "Bonsoir";
            if (hour >= 23 || hour < 5) greeting = "Douce nuit";
            
            const dayName = days[date.getDay()];
            const dayNum = date.getDate();
            const monthName = months[date.getMonth()];

            // --- LOGIQUE DE SANTÉ NAS ---
            const state = entity.state;
            const cpu = states['sensor.chrisnas_utilisation_du_processeur'].state;
            const temp = states['sensor.chrisnas_temperature_du_systeme'].state;
            
            let statusMsg = "Système Opérationnel";
            let statusColor = "#00ff88"; // Vert
            
            if (state !== 'good' || cpu > 80 || temp > 50) {
              statusMsg = "NAS en alerte";
              statusColor = "#ff1111"; // Rouge
            } else if (cpu > 50 || temp > 40) {
              statusMsg = "Activité soutenue";
              statusColor = "#ff9900"; // Orange
            }
            
            return `
              <div style="display: flex; flex-direction: column; align-items: flex-start;">
                <span style="font-size: 26px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: -1px;">
                  ${greeting} <span style="color: #00ccff;">Christophe</span>
                </span>
                <div style="display: flex; align-items: center; margin-top: 2px;">
                  <span style="font-size: 11px; font-weight: 500; color: rgba(255, 255, 255, 0.4); text-transform: uppercase; letter-spacing: 2px;">
                    ${dayName} ${dayNum} ${monthName}
                  </span>
                  <span style="margin: 0 10px; color: rgba(255, 255, 255, 0.1);">|</span>
                  <span style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: ${statusColor}; margin-right: 6px; box-shadow: 0 0 5px ${statusColor};"></span>
                  <span style="font-size: 11px; font-weight: 700; color: ${statusColor}; text-transform: uppercase; letter-spacing: 1px;">
                    ${statusMsg}
                  </span>
                </div>
              </div>
            `;
          ]]]
        triggers_update:
          - sensor.chrisnas_utilisation_du_processeur
          - sensor.chrisnas_temperature_du_systeme
        styles:
          card:
            - background: transparent
            - border: none
            - box-shadow: none
            - padding: 15px 0px
            - height: auto
          grid:
            - grid-template-areas: '"n"'
            - grid-template-columns: 1fr
      layout: start
      badges_position: bottom
      badges_wrap: wrap
    visible:
      - user: 49a98c3aa3c44399a03d32437dca04ba
      - user: 76dc484362274cbbb06167991e4e596b
      - user: 263aa18728184cf993e23e052feeaa01
    badges:
      - type: custom:button-card
        icon: mdi:home-variant-outline
        name: Accueil
        show_name: true
        tap_action:
          action: navigate
          navigation_path: /lovelace/0
        styles:
          card:
            - background: rgba(20, 27, 38, 0.6)
            - backdrop-filter: blur(8px)
            - '-webkit-backdrop-filter': blur(8px)
            - border-radius: 12px
            - border: 1px solid rgba(255, 255, 255, 0.1)
            - padding: 6px 12px
            - width: fit-content
            - margin: 0 auto 10px 0
          grid:
            - grid-template-areas: '"i n"'
            - grid-template-columns: auto auto
            - column-gap: 8px
          icon:
            - width: 18px
            - color: '#00bfff'
          name:
            - font-size: 12px
            - font-weight: 700
            - color: rgba(255, 255, 255, 0.9)
  - type: sections
    max_columns: 4
    title: Sauvegarde de card
    path: sauvegarde-de-card
    subview: true
    sections:
      - type: grid
        cards:
          - type: conditional
            conditions:
              - entity: binary_sensor.commute_workday
                state: 'on'
            card:
              type: custom:button-card
              name: |
                [[[
                  const flip = states['input_boolean.commute_card_flip']?.state === 'on';
                  const is_pm = new Date().getHours() >= 12;
                  const is_home = (is_pm && !flip) || (!is_pm && flip);
                  return is_home ? '🏠 RETOUR MAISON' : '🏢 ALLER TRAVAIL';
                ]]]
              icon: mdi:swap-horizontal
              styles:
                card:
                  - background: |
                      [[[
                        const flip = states['input_boolean.commute_card_flip']?.state === 'on';
                        const is_pm = new Date().getHours() >= 12;
                        const is_home = (is_pm && !flip) || (!is_pm && flip);
                        return is_home ? 'rgba(255, 165, 0, 0.15)' : 'rgba(61, 219, 184, 0.15)';
                      ]]]
                  - backdrop-filter: blur(25px)
                  - '-webkit-backdrop-filter': blur(25px)
                  - border-radius: 20px
                  - border: |
                      [[[
                        const flip = states['input_boolean.commute_card_flip']?.state === 'on';
                        const is_pm = new Date().getHours() >= 12;
                        const is_home = (is_pm && !flip) || (!is_pm && flip);
                        return is_home ? '1px solid rgba(255, 165, 0, 0.5)' : '1px solid rgba(61, 219, 184, 0.5)';
                      ]]]
                  - padding: 8px 15px
                  - box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4)
                  - transition: all 0.4s ease
                grid:
                  - grid-template-areas: '"i n"'
                  - grid-template-columns: 30px auto
                name:
                  - font-size: 14px
                  - font-weight: 900
                  - color: white
                  - letter-spacing: 2px
                  - opacity: 0.9
                  - justify-self: center
                icon:
                  - width: 22px
                  - color: '#FFA500'
              tap_action:
                action: call-service
                service: input_boolean.toggle
                service_data:
                  entity_id: input_boolean.commute_card_flip
          - type: conditional
            conditions:
              - entity: binary_sensor.commute_workday
                state: 'on'
            card:
              type: horizontal-stack
              cards:
                - type: custom:button-card
                  entity: |
                    [[[
                      const flip = states['input_boolean.commute_card_flip']?.state === 'on';
                      const is_pm = new Date().getHours() >= 12;
                      const is_home = (is_pm && !flip) || (!is_pm && flip);
                      return is_home ? 'sensor.aline_travail_maison' : 'sensor.trajet_maison_travail_aline';
                    ]]]
                  name: |
                    [[[
                      // --- RESPONSIVE ---
                      const isMobile = window.innerWidth < 500;
                      const carSize = isMobile ? '30px' : '38px';
                      const titleSize = isMobile ? '12px' : '14px';
                      const journeyScale = isMobile ? '1.05' : '1.2';
                      const timeSize = isMobile ? '18px' : '20px';
                      const statusSize = isMobile ? '12px' : '14px';
                      const metricSize = isMobile ? '10px' : '11px';
                      const topMargin = isMobile ? '-4px' : '-6px';
                      const titleLeftShift = isMobile ? '-10px' : '-14px'; 
                      // --- LOGIC ---
                      const t_red = 25; const t_orange = 10; const t_white = 5;
                      const flip = states['input_boolean.commute_card_flip']?.state === 'on';
                      const is_pm = new Date().getHours() >= 12;
                      const is_home = (is_pm && !flip) || (!is_pm && flip);
                      const sid = is_home ? 'sensor.aline_travail_maison' : 'sensor.trajet_maison_travail_aline';
                      const s1_sid = is_home ? 'sensor.trajet_aline_retour_semaine_derniere' : 'sensor.trajet_aline_semaine_derniere';
                      const avg_sid = is_home ? 'sensor.trajet_aline_retour_moyenne' : 'sensor.trajet_aline_moyenne';
                      const normal_sid = 'input_number.aline_commute_normal';
                      const main_entity = states[sid];
                      if (!main_entity) return 'Chargement...';
                      
                      const current = Math.round(parseFloat(main_entity.state) || 0);
                      const normal = Math.round(parseFloat(states[normal_sid]?.state) || 0);
                      const delay = current - normal;
                      
                      let status = 'Fluide'; let statusColor = '#3DDBB8';
                      if (delay > t_red) { status = 'Bouché'; statusColor = '#DC5050'; }
                      else if (delay > t_orange) { status = 'Dense'; statusColor = '#FFA500'; }
                      else if (delay > t_white) { status = 'Normal'; statusColor = 'white'; }
                      
                      const arrow = is_home ? 'mdi:arrow-left-bold' : 'mdi:arrow-right-bold';
                      const green = '#3DDBB8';
                      const homeColor = is_home ? 'white' : green;
                      const workColor = is_home ? green : 'white';
                      const delayNotice = delay > 0 ? ` (+${Math.abs(delay)} min)` : '';
                      const deadline = new Date('2026-02-23T07:20:00');
                      const isLearning = new Date() < deadline;
                      const avg7d_val = parseFloat(states[avg_sid]?.state);
                      const avg7d_display = (isLearning || isNaN(avg7d_val) || avg7d_val <= 0) ? 'Appre.' : `${Math.round(avg7d_val)} min`;
                      const s1_val = parseFloat(states[s1_sid]?.state);
                      const s1_display = (isLearning || isNaN(s1_val) || s1_val <= 0) ? 'Appre.' : `${Math.round(s1_val)} min`;
                      return `
                        <div style="display: flex; flex-direction: column; align-items: flex-start; width: 100%; overflow: visible;">
                          <div style="display: flex; align-items: center; justify-content: flex-start; gap: 0px; margin-bottom: 2px; margin-top: ${topMargin}; margin-left: ${titleLeftShift}; width: 100%; overflow: visible;">
                            <ha-icon icon="mdi:car" style="width: ${carSize}; height: ${carSize}; color: ${statusColor}; flex-shrink: 0;"></ha-icon>
                            <span style="font-weight: 900; font-size: ${titleSize}; color: white; flex-shrink: 0; margin-left: -2px;">Trajet User 2</span>
                            <div style="display: flex; align-items: center; gap: 2px; transform: scale(${journeyScale}); transform-origin: left center; margin-left: 6px; flex-shrink: 0; overflow: visible;">
                              <ha-icon icon="mdi:home-variant" style="width: 14px; height: 14px; color: ${homeColor};"></ha-icon>
                              <ha-icon icon="${arrow}" style="width: 16px; height: 16px; color: #FFA500;"></ha-icon>
                              <ha-icon icon="mdi:office-building" style="width: 14px; height: 14px; color: ${workColor};"></ha-icon>
                            </div>
                          </div>
                          <div style="line-height: 0.85em; text-align: left; width: 100%; margin-top: 4px; overflow: visible;">
                            <div style="font-weight: 800; color: white; font-size: ${statusSize}; margin-bottom: 3px; white-space: nowrap;">
                              <span style="font-size: ${timeSize};">${current} min</span> • <span style="color: ${statusColor}">${status}</span>${delayNotice}
                            </div>
                            <div style="font-weight: 700; color: white; font-size: ${metricSize}; opacity: 0.9;">Même heure (S-1) : ${s1_display}</div>
                            <div style="font-weight: 700; color: white; font-size: ${metricSize}; opacity: 0.9; margin-top: 1px;">Moyenne 7j : ${avg7d_display}</div>
                            <div style="font-weight: 800; color: white; font-size: ${metricSize}; opacity: 0.9; margin-top: 4px;">Sans bouchon : ${normal} min</div>
                          </div>
                        </div>
                      `;
                    ]]]
                  show_state: false
                  show_label: false
                  show_icon: false
                  styles:
                    card:
                      - padding: >
                          [[[ return window.innerWidth < 500 ? '8px 6px' : '10px
                          10px'; ]]]
                      - border-radius: 20px
                      - border: 1px solid rgba(255,255,255,0.1)
                      - background: |
                          [[[
                            const t_red = 25; const t_orange = 10; const t_white = 5;
                            const flip = states['input_boolean.commute_card_flip']?.state === 'on';
                            const is_pm = new Date().getHours() >= 12;
                            const is_home = (is_pm && !flip) || (!is_pm && flip);
                            const sid = is_home ? 'sensor.aline_travail_maison' : 'sensor.trajet_maison_travail_aline';
                            const duration = Math.round(parseFloat(states[sid]?.state) || 0);
                            const normal = Math.round(parseFloat(states['input_number.aline_commute_normal']?.state) || duration);
                            const delay = duration - normal;
                            if (delay > t_red) return 'linear-gradient(145deg, rgba(220, 80, 80, 0.45), rgba(0, 0, 0, 0.8))';
                            if (delay > t_orange) return 'linear-gradient(145deg, rgba(255, 165, 0, 0.4), rgba(0, 0, 0, 0.8))';
                            if (delay > t_white) return 'linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(0, 0, 0, 0.8))';
                            return 'linear-gradient(145deg, rgba(61, 219, 184, 0.25), rgba(0, 0, 0, 0.8))';
                          ]]]
                      - backdrop-filter: blur(20px)
                      - '-webkit-backdrop-filter': blur(20px)
                    grid:
                      - grid-template-areas: '"n"'
                      - grid-template-columns: 100%
                    name:
                      - justify-self: start
                      - width: 100%
                      - overflow: visible
                  tap_action:
                    action: more-info
                - type: custom:button-card
                  entity: |
                    [[[
                      const flip = states['input_boolean.commute_card_flip']?.state === 'on';
                      const is_pm = new Date().getHours() >= 12;
                      const is_home = (is_pm && !flip) || (!is_pm && flip);
                      return is_home ? 'sensor.chris_travail_maison' : 'sensor.trajet_maison_travail_chris';
                    ]]]
                  name: |
                    [[[
                      // --- RESPONSIVE ---
                      const isMobile = window.innerWidth < 500;
                      const carSize = isMobile ? '30px' : '38px';
                      const titleSize = isMobile ? '12px' : '14px';
                      const journeyScale = isMobile ? '1.05' : '1.2';
                      const timeSize = isMobile ? '18px' : '20px';
                      const statusSize = isMobile ? '12px' : '14px';
                      const metricSize = isMobile ? '10px' : '11px';
                      const topMargin = isMobile ? '-4px' : '-6px';
                      const titleLeftShift = isMobile ? '-10px' : '-14px'; 
                      // --- LOGIC ---
                      const t_red = 25; const t_orange = 10; const t_white = 5;
                      const flip = states['input_boolean.commute_card_flip']?.state === 'on';
                      const is_pm = new Date().getHours() >= 12;
                      const is_home = (is_pm && !flip) || (!is_pm && flip);
                      const sid = is_home ? 'sensor.chris_travail_maison' : 'sensor.trajet_maison_travail_chris';
                      const s1_sid = is_home ? 'sensor.trajet_chris_retour_semaine_derniere' : 'sensor.trajet_chris_semaine_derniere';
                      const avg_sid = is_home ? 'sensor.trajet_chris_retour_moyenne' : 'sensor.trajet_chris_moyenne';
                      const normal_sid = 'input_number.chris_commute_normal';
                      const main_entity = states[sid];
                      if (!main_entity) return 'Chargement...';
                      
                      const current = Math.round(parseFloat(main_entity.state) || 0);
                      const normal = Math.round(parseFloat(states[normal_sid]?.state) || 0);
                      const delay = current - normal;
                      
                      let status = 'Fluide'; let statusColor = '#3DDBB8';
                      if (delay > t_red) { status = 'Bouché'; statusColor = '#DC5050'; }
                      else if (delay > t_orange) { status = 'Dense'; statusColor = '#FFA500'; }
                      else if (delay > t_white) { status = 'Normal'; statusColor = 'white'; }
                      
                      const arrow = is_home ? 'mdi:arrow-left-bold' : 'mdi:arrow-right-bold';
                      const green = '#3DDBB8';
                      const homeColor = is_home ? 'white' : green;
                      const workColor = is_home ? green : 'white';
                      const delayNotice = delay > 0 ? ` (+${Math.abs(delay)} min)` : '';
                      const deadline = new Date('2026-02-23T07:20:00');
                      const isLearning = new Date() < deadline;
                      const avg7d_val = parseFloat(states[avg_sid]?.state);
                      const avg7d_display = (isLearning || isNaN(avg7d_val) || avg7d_val <= 0) ? 'Appre.' : `${Math.round(avg7d_val)} min`;
                      const s1_val = parseFloat(states[s1_sid]?.state);
                      const s1_display = (isLearning || isNaN(s1_val) || s1_val <= 0) ? 'Appre.' : `${Math.round(s1_val)} min`;
                      return `
                        <div style="display: flex; flex-direction: column; align-items: flex-start; width: 100%; overflow: visible;">
                          <div style="display: flex; align-items: center; justify-content: flex-start; gap: 0px; margin-bottom: 2px; margin-top: ${topMargin}; margin-left: ${titleLeftShift}; width: 100%; overflow: visible;">
                            <ha-icon icon="mdi:car" style="width: ${carSize}; height: ${carSize}; color: ${statusColor}; flex-shrink: 0;"></ha-icon>
                            <span style="font-weight: 900; font-size: ${titleSize}; color: white; flex-shrink: 0; margin-left: -2px;">Trajet User 1</span>
                            <div style="display: flex; align-items: center; gap: 2px; transform: scale(${journeyScale}); transform-origin: left center; margin-left: 6px; flex-shrink: 0; overflow: visible;">
                              <ha-icon icon="mdi:home-variant" style="width: 14px; height: 14px; color: ${homeColor};"></ha-icon>
                              <ha-icon icon="${arrow}" style="width: 16px; height: 16px; color: #FFA500;"></ha-icon>
                              <ha-icon icon="mdi:office-building" style="width: 14px; height: 14px; color: ${workColor};"></ha-icon>
                            </div>
                          </div>
                          <div style="line-height: 0.85em; text-align: left; width: 100%; margin-top: 4px; overflow: visible;">
                            <div style="font-weight: 800; color: white; font-size: ${statusSize}; margin-bottom: 3px; white-space: nowrap;">
                              <span style="font-size: ${timeSize};">${current} min</span> • <span style="color: ${statusColor}">${status}</span>${delayNotice}
                            </div>
                            <div style="font-weight: 700; color: white; font-size: ${metricSize}; opacity: 0.9;">Même heure (S-1) : ${s1_display}</div>
                            <div style="font-weight: 700; color: white; font-size: ${metricSize}; opacity: 0.9; margin-top: 1px;">Moyenne 7j : ${avg7d_display}</div>
                            <div style="font-weight: 800; color: white; font-size: ${metricSize}; opacity: 0.9; margin-top: 4px;">Sans bouchon : ${normal} min</div>
                          </div>
                        </div>
                      `;
                    ]]]
                  show_state: false
                  show_label: false
                  show_icon: false
                  styles:
                    card:
                      - padding: >
                          [[[ return window.innerWidth < 500 ? '8px 6px' : '10px
                          10px'; ]]]
                      - border-radius: 20px
                      - border: 1px solid rgba(255,255,255,0.1)
                      - background: |
                          [[[
                            const t_red = 25; const t_orange = 10; const t_white = 5;
                            const flip = states['input_boolean.commute_card_flip']?.state === 'on';
                            const is_pm = new Date().getHours() >= 12;
                            const is_home = (is_pm && !flip) || (!is_pm && flip);
                            const sid = is_home ? 'sensor.chris_travail_maison' : 'sensor.trajet_maison_travail_chris';
                            const duration = Math.round(parseFloat(states[sid]?.state) || 0);
                            const normal = Math.round(parseFloat(states['input_number.chris_commute_normal']?.state) || duration);
                            const delay = duration - normal;
                            if (delay > t_red) return 'linear-gradient(145deg, rgba(220, 80, 80, 0.45), rgba(0, 0, 0, 0.8))';
                            if (delay > t_orange) return 'linear-gradient(145deg, rgba(255, 165, 0, 0.4), rgba(0, 0, 0, 0.8))';
                            if (delay > t_white) return 'linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(0, 0, 0, 0.8))';
                            return 'linear-gradient(145deg, rgba(61, 219, 184, 0.25), rgba(0, 0, 0, 0.8))';
                          ]]]
                      - backdrop-filter: blur(20px)
                      - '-webkit-backdrop-filter': blur(20px)
                    grid:
                      - grid-template-areas: '"n"'
                      - grid-template-columns: 100%
                    name:
                      - justify-self: start
                      - width: 100%
                      - overflow: visible
                  tap_action:
                    action: more-info
          - type: vertical-stack
            cards:
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    icon: mdi:medical-bag
                    name: Suivi Post-Greffe
                    label: 'À faire aujourd''hui :'
                    show_name: true
                    show_icon: true
                    show_label: true
                    styles:
                      card:
                        - padding: 16px
                        - height: 100px
                        - border-radius: 20px
                        - border: 1px solid rgba(255,255,255,0.1) !important
                        - background: rgba(20, 27, 38, 0.6) !important
                        - backdrop-filter: blur(10px) !important
                        - '-webkit-backdrop-filter': blur(10px) !important
                        - box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important
                      grid:
                        - grid-template-areas: '"i n" "i l"'
                        - grid-template-columns: min-content 1fr
                        - column-gap: 16px
                      icon:
                        - width: 32px
                        - height: 32px
                        - color: '#4fc3f7'
                        - filter: drop-shadow(0 0 8px rgba(79, 195, 247, 0.4))
                      name:
                        - justify-self: start
                        - font-size: 16px
                        - font-weight: 700
                        - color: white
                      label:
                        - justify-self: start
                        - font-size: 13px
                        - opacity: 0.7
                        - font-weight: 500
                    tap_action:
                      action: none
                  - type: custom:button-card
                    entity: sensor.suivi_greffe_jour
                    show_name: false
                    show_icon: false
                    show_state: true
                    show_label: true
                    label: |
                      [[[
                        const start = new Date('2025-10-24T00:00:00');
                        const now = new Date();
                        let months = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
                        let days = now.getDate() - start.getDate();
                        if (days < 0) {
                          months--;
                          const prevMonthLastDay = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
                          days += prevMonthLastDay;
                        }
                        return months + " mois et " + days + (days > 1 ? " jours" : " jour");
                      ]]]
                    custom_fields:
                      celebration: |
                        [[[
                          var now = new Date();
                          if (now.getDate() !== 24) return "";
                          var confettiHtml = '<div class="confetti-wrapper">';
                          for (var i = 0; i < 15; i++) {
                            var color = ["#FFD700", "#FF4500", "#ADFF2F", "#00BFFF", "#FF1493"][i % 5];
                            var left = Math.floor(Math.random() * 100);
                            var delay = (Math.random() * 2).toFixed(1);
                            confettiHtml += '<div class="confetti" style="left: ' + left + '%; background: ' + color + '; animation-delay: ' + delay + 's;"></div>';
                          }
                          return confettiHtml + '</div>';
                        ]]]
                    styles:
                      card:
                        - padding: 16px 0
                        - height: 100px
                        - border-radius: 20px
                        - border: 1px solid rgba(255,255,255,0.1) !important
                        - background: rgba(20, 27, 38, 0.6) !important
                        - backdrop-filter: blur(10px) !important
                        - '-webkit-backdrop-filter': blur(10px) !important
                        - box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important
                        - display: flex
                        - flex-direction: column
                        - justify-content: start
                        - align-items: center
                        - text-align: center
                        - overflow: hidden
                      state:
                        - font-size: 34px
                        - font-weight: 900
                        - color: white
                        - text-shadow: 0 0 10px rgba(255,255,255,0.3)
                        - line-height: 0.8
                        - margin: 0
                        - margin-top: '-2px'
                        - z-index: 2
                      label:
                        - font-size: 16px
                        - font-weight: 600
                        - color: rgba(255,255,255,0.6)
                        - margin-top: 15px
                        - margin-bottom: 0
                        - z-index: 2
                      custom_fields:
                        celebration:
                          - position: absolute
                          - inset: 0
                          - z-index: 1
                          - pointer-events: none
                    tap_action:
                      action: none
              - type: custom:button-card
                entity: sensor.suivi_greffe_jour
                show_name: false
                show_icon: false
                styles:
                  card:
                    - background: none
                    - box-shadow: none
                    - border: none
                    - padding: 0
                  grid:
                    - grid-template-areas: '"tasks"'
                    - grid-template-columns: 1fr
                    - grid-template-rows: auto
                  custom_fields:
                    tasks:
                      - width: 100%
                custom_fields:
                  tasks: |
                    [[[
                      if (!entity || !entity.attributes) return `<div style="padding:20px;color:rgba(255,255,255,0.5);">Chargement...</div>`;
                      var tasks = [
                        { key: 'shampoing_aujourdhui', name: 'Shampoing', icon: 'mdi:shower', color: '#1e88e5' },
                        { key: 'vitamine_aujourdhui', name: 'Vitamines', icon: 'mdi:pill-multiple', color: '#2e7d32' },
                        { key: 'serum_ozone_aujourdhui', name: 'Sérum ozonée', icon: 'mdi:beaker-outline', color: '#8e24aa' },
                        { key: 'dermaroller_serum_aujourdhui', name: 'Dermaroller', icon: 'mdi:needle', color: '#fb8c00' },
                        { key: 'huile_capillaire_aujourdhui', name: 'Huile', icon: 'mdi:eyedropper-variant', color: '#6d4c41' },
                        { key: 'massage_cuir_chevelu_aujourdhui', name: 'Massage', icon: 'mdi:hand-back-right', color: '#00897b' },
                        { key: 'prp_aujourdhui', name: 'PRP', icon: 'mdi:hospital-marker', color: '#e91e63' }
                      ];
                      var html = '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
                      var count = 0;
                      for (var i = 0; i < tasks.length; i++) {
                        var t = tasks[i];
                        var val = entity.attributes[t.key];
                        if (val) {
                          count++;
                          var displayVal = (val === true) ? 'À faire' : val;
                          html += '<div style="flex: 1 1 30%; min-width: 100px; height: 100px; box-sizing: border-box; padding: 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); background: rgba(20, 27, 38, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center;">'
                              + '<ha-icon icon="' + t.icon + '" style="--mdc-icon-size: 32px; color: ' + t.color + '; filter: drop-shadow(0 0 8px ' + t.color + 'aa); margin-bottom: 8px;"></ha-icon>'
                              + '<div style="font-size: 13px; font-weight: 600; color: white;">' + t.name + '</div>'
                              + '<div style="font-size: 11px; opacity: 0.7; margin-top: 4px; color: white;">' + displayVal + '</div>'
                            + '</div>';
                        }
                      }
                      html += '</div>';
                      if (count === 0) return '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">Rien à faire aujourd\'hui !</div>';
                      return html;
                    ]]]
            extra_styles: |
              .confetti-wrapper {
                position: absolute;
                width: 100%;
                height: 100%;
                overflow: hidden;
              }
              .confetti {
                position: absolute;
                width: 6px;
                height: 12px;
                opacity: 0.8;
                top: -20px;
                border-radius: 2px;
                animation: confetti-fall 3s linear infinite;
              }
              @keyframes confetti-fall {
                0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                100% { transform: translateY(120px) rotate(360deg); opacity: 0; }
              }
          - type: custom:button-card
            entity: sensor.brother_mfc_l3750cdw_series
            name: Brother
            show_name: false
            color: green
            show_state: false
            show_icon: false
            show_entity_picture: false
            styles:
              card:
                - padding: 12px
                - border-radius: 20px
                - border: 1px solid rgba(255,255,255,0.1)
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
              grid:
                - grid-template-areas: |
                    "printer caps  caps  caps  caps"
                    "printer c     m     y     k"
                    "printer ref   ref   ref   ref"
                    "printer lc2   lm2   ly2   lk2"
                    "printer dr    dr    dr    dr"
                    "s       s     s     s     s"
                - grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr
                - grid-template-rows: auto auto 1.3em 1.8em 1.0em 0em
                - row-gap: 4px
              custom_fields:
                printer:
                  - justify-self: center
                  - align-self: center
                  - width: 100%
                caps:
                  - justify-self: stretch
                  - align-self: end
                  - padding: 0 6px 8px 6px
                k:
                  - width: 90%
                  - margin: auto
                c:
                  - width: 90%
                  - margin: auto
                m:
                  - width: 90%
                  - margin: auto
                'y':
                  - width: 90%
                  - margin: auto
                ref:
                  - justify-self: center
                  - font-size: 0.70em
                  - color: rgba(255,255,255,0.6)
                  - margin-top: 4px
                  - font-weight: 500
                lc2:
                  - width: 90%
                  - justify-self: center
                lm2:
                  - width: 90%
                  - justify-self: center
                ly2:
                  - width: 90%
                  - justify-self: center
                lk2:
                  - width: 90%
                  - justify-self: center
                dr:
                  - justify-self: center
                  - font-size: 0.70em
                  - color: rgba(255,255,255,0.6)
                  - margin-top: 2px
                  - font-weight: 500
            custom_fields:
              printer: |
                [[[
                  return `
                    <div style="
                      display:flex;
                      flex-direction:column;
                      align-items:center;
                      justify-content:center;
                      height:100%;
                    ">
                      <img src="/local/brother.png"
                           style="width:72px;height:auto;margin-bottom:8px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));" />
                      <div style="font-size:0.85em;font-weight:700;color:white;letter-spacing:0.5px;">
                        BROTHER
                      </div>
                      <div style="font-size:0.6em;color:rgba(255,255,255,0.6);">
                        MFC-L3750CDW
                      </div>
                    </div>
                  `;
                ]]]
              k: |
                [[[
                  const s = states['sensor.mfc_l3750cdw_toner_noir_restant'];
                  let v = parseFloat(s?.state ?? '0');
                  if (isNaN(v)) v = 0;
                  v = Math.max(0, Math.min(100, v));
                  const color = '#000000'; 
                  return `
                    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
                       <div style="width:100%;height:32px;border-radius:4px;
                                  background:rgba(255,255,255,0.1);position:relative;overflow:hidden;
                                  border:1px solid rgba(255,255,255,0.1); box-shadow:inset 0 0 4px rgba(0,0,0,0.2);">
                        <div style="position:absolute;bottom:0;left:0;width:100%;height:${v}%;background:${color};transition:height 0.5s ease;"></div>
                        <div style="position:absolute;bottom:2px;left:0;width:100%;text-align:center;
                                    font-size:0.7em;color:${v > 40 ? 'white' : 'rgba(255,255,255,0.8)'};font-weight:700;text-shadow:0 0 2px rgba(0,0,0,0.5);">
                          ${v}%
                        </div>
                      </div>
                    </div>`;
                ]]]
              c: |
                [[[
                  const s = states['sensor.mfc_l3750cdw_toner_cyan_restant'];
                  let v = parseFloat(s?.state ?? '0');
                  if (isNaN(v)) v = 0;
                  v = Math.max(0, Math.min(100, v));
                  const color = '#00FFFF';
                  return `
                    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
                       <div style="width:100%;height:32px;border-radius:4px;
                                  background:rgba(255,255,255,0.1);position:relative;overflow:hidden;
                                  border:1px solid rgba(255,255,255,0.1); box-shadow:inset 0 0 4px rgba(0,0,0,0.2);">
                        <div style="position:absolute;bottom:0;left:0;width:100%;height:${v}%;background:${color};transition:height 0.5s ease;"></div>
                        <div style="position:absolute;bottom:2px;left:0;width:100%;text-align:center;
                                    font-size:0.7em;color:rgba(0,0,0,0.7);font-weight:700;">
                          ${v}%
                        </div>
                      </div>
                    </div>`;
                ]]]
              m: |
                [[[
                  const s = states['sensor.mfc_l3750cdw_toner_magenta_restant'];
                  let v = parseFloat(s?.state ?? '0');
                  if (isNaN(v)) v = 0;
                  v = Math.max(0, Math.min(100, v));
                  const color = '#FF00FF';
                  return `
                    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
                       <div style="width:100%;height:32px;border-radius:4px;
                                  background:rgba(255,255,255,0.1);position:relative;overflow:hidden;
                                  border:1px solid rgba(255,255,255,0.1); box-shadow:inset 0 0 4px rgba(0,0,0,0.2);">
                        <div style="position:absolute;bottom:0;left:0;width:100%;height:${v}%;background:${color};transition:height 0.5s ease;"></div>
                        <div style="position:absolute;bottom:2px;left:0;width:100%;text-align:center;
                                    font-size:0.7em;color:white;font-weight:700;text-shadow:0 0 2px rgba(0,0,0,0.5);">
                          ${v}%
                        </div>
                      </div>
                    </div>`;
                ]]]
              'y': |
                [[[
                  const s = states['sensor.mfc_l3750cdw_toner_jaune_restant'];
                  let v = parseFloat(s?.state ?? '0');
                  if (isNaN(v)) v = 0;
                  v = Math.max(0, Math.min(100, v));
                  const color = '#FFFF00';
                  return `
                    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
                       <div style="width:100%;height:32px;border-radius:4px;
                                  background:rgba(255,255,255,0.1);position:relative;overflow:hidden;
                                  border:1px solid rgba(255,255,255,0.1); box-shadow:inset 0 0 4px rgba(0,0,0,0.2);">
                        <div style="position:absolute;bottom:0;left:0;width:100%;height:${v}%;background:${color};transition:height 0.5s ease;"></div>
                        <div style="position:absolute;bottom:2px;left:0;width:100%;text-align:center;
                                    font-size:0.7em;color:rgba(0,0,0,0.7);font-weight:700;">
                          ${v}%
                        </div>
                      </div>
                    </div>`;
                ]]]
              ref: Toners TN243 CMYK
              dr: Tambours DR243CL
              caps: |
                [[[
                  function clamp(v) {
                    v = parseFloat(v);
                    if (isNaN(v)) v = 0;
                    return Math.max(0, Math.min(100, v));
                  }
                  function colorFor(value) {
                    const h = (value / 100) * 120;
                    return `hsla(${h}, 80%, 50%, 0.7)`; 
                  }
                  const f  = clamp(states['sensor.mfc_l3750cdw_duree_de_vie_restante_de_l_unite_de_fusion']?.state);
                  const c  = clamp(states['sensor.mfc_l3750cdw_duree_de_vie_restante_de_l_unite_de_courroie']?.state);
                  const pf = clamp(states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_kit_pf_1']?.state);
                  function block(label, value) {
                    const col = colorFor(value);
                    return `
                      <div style="flex:1; text-align:center; font-size:0.75em; color:rgba(255,255,255,0.8);">
                        <div style="margin-bottom:3px;">${label}</div>
                        <div style="
                          width:100%;
                          height:6px;
                          border-radius:3px;
                          background:rgba(255,255,255,0.1);
                          position:relative;
                          overflow:hidden;
                        ">
                          <div style="width:${value}%; height:100%; background:${col}; border-radius:3px;"></div>
                        </div>
                      </div>`;
                  }
                  return `
                    <div style="display:flex; gap:12px; width:100%;">
                      ${block('Fusion', f)}
                      ${block('Courroie', c)}
                      ${block('Kit PF', pf)}
                    </div>
                  `;
                ]]]
              lc2: |
                [[[
                  const s = states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_tambour_cyan'];
                  let v = parseFloat(s?.state ?? '0');
                  if (isNaN(v)) v = 0;
                  v = Math.max(0, Math.min(100, v));
                  const color = '#00FFFF';
                  return `
                    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
                      <ha-icon icon="mdi:record-circle-outline"
                        style="width:16px;height:16px;color:${color}; opacity:0.8; margin-bottom:4px; filter:drop-shadow(0 0 4px ${color});">
                      </ha-icon>
                      <div style="width:100%;height:4px;border-radius:2px;background:rgba(255,255,255,0.1);overflow:hidden;">
                        <div style="width:${v}%;height:100%;background:${color};opacity:0.6;"></div>
                      </div>
                    </div>`;
                ]]]
              lm2: |
                [[[
                  const s = states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_tambour_magenta'];
                  let v = parseFloat(s?.state ?? '0');
                  if (isNaN(v)) v = 0;
                  v = Math.max(0, Math.min(100, v));
                  const color = '#FF00FF';
                  return `
                    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
                      <ha-icon icon="mdi:record-circle-outline"
                        style="width:16px;height:16px;color:${color}; opacity:0.8; margin-bottom:4px; filter:drop-shadow(0 0 4px ${color});">
                      </ha-icon>
                      <div style="width:100%;height:4px;border-radius:2px;background:rgba(255,255,255,0.1);overflow:hidden;">
                        <div style="width:${v}%;height:100%;background:${color};opacity:0.6;"></div>
                      </div>
                    </div>`;
                ]]]
              ly2: |
                [[[
                  const s = states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_tambour_jaune'];
                  let v = parseFloat(s?.state ?? '0');
                  if (isNaN(v)) v = 0;
                  v = Math.max(0, Math.min(100, v));
                  const color = '#FFFF00';
                  return `
                    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
                      <ha-icon icon="mdi:record-circle-outline"
                        style="width:16px;height:16px;color:${color}; opacity:0.8; margin-bottom:4px; filter:drop-shadow(0 0 4px ${color});">
                      </ha-icon>
                      <div style="width:100%;height:4px;border-radius:2px;background:rgba(255,255,255,0.1);overflow:hidden;">
                        <div style="width:${v}%;height:100%;background:${color};opacity:0.6;"></div>
                      </div>
                    </div>`;
                ]]]
              lk2: |
                [[[
                  const s = states['sensor.mfc_l3750cdw_duree_de_vie_restante_du_tambour_noir'];
                  let v = parseFloat(s?.state ?? '0');
                  if (isNaN(v)) v = 0;
                  v = Math.max(0, Math.min(100, v));
                  const color = '#888888';
                  return `
                    <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
                      <ha-icon icon="mdi:record-circle-outline"
                        style="width:16px;height:16px;color:${color}; opacity:0.8; margin-bottom:4px; filter:drop-shadow(0 0 4px ${color});">
                      </ha-icon>
                      <div style="width:100%;height:4px;border-radius:2px;background:rgba(255,255,255,0.1);overflow:hidden;">
                        <div style="width:${v}%;height:100%;background:${color};opacity:0.6;"></div>
                      </div>
                    </div>`;
                ]]]
          - type: custom:mod-card
            card:
              type: custom:atomic-calendar-revive
              name: ''
              language: fr
              firstDayOfWeek: 1
              dateFormat: DD/MM/YYYY
              dateFormatShort: DD/MM
              entities:
                - calendar.chris_billet_gmail_com
                - calendar.icloud
                - calendar.paris_saint_germain
                - calendar.jours_feries_et_autres_fetes_en_france
                - calendar.anniversaires
              maxDaysToShow: 3
              maxEventCount: 10
              showMonth: false
              showWeekDay: true
              showDate: true
              sortByStartTime: true
              showLocation: true
              showDescription: false
              showNoEventsForToday: true
              card_mod:
                style: |
                  ha-card {
                    background: rgba(20, 27, 38, 0.6) !important;
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    border-radius: 20px !important;
                    border: 1px solid rgba(255,255,255,0.1) !important;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                    --primary-text-color: white;
                    --secondary-text-color: rgba(255,255,255,0.7);
                  }
                  /* Cible les titres des jours/dates */
                  .day-header {
                     color: rgba(255,255,255,0.9) !important;
                     font-weight: 700 !important;
                  }
                  /* Cible les événements */
                  .event-title {
                    color: white !important;
                  }
                  .event-location {
                    color: rgba(255,255,255,0.6) !important;
                  }
                  /* Masque les lignes de séparation si trop visibles */
                  .event-leftCurrentDay {
                    border-color: rgba(255,255,255,0.1) !important; 
                  }
          - type: custom:button-card
            entity: binary_sensor.tesla_model_3_status
            show_icon: false
            show_name: false
            show_state: false
            tap_action:
              action: navigate
              navigation_path: /lovelace/tesla_modele_3
            styles:
              card:
                - padding: 16px
                - border-radius: 20px
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - overflow: hidden
                - position: relative
                - transition: box-shadow 0.5s ease-in-out, border 0.5s ease-in-out
                - border: |
                    [[[
                      // 1. Récupération des états (avec sécurité si indisponible)
                      var chargeState = states['binary_sensor.tesla_model_3_charging'] ? states['binary_sensor.tesla_model_3_charging'].state : 'off';
                      // Si tu as un sensor.tesla_charging_state à la place, décommente ci-dessous:
                      // var chargeState = states['sensor.tesla_model_3_charging_state']?.state === 'Charging' ? 'on' : 'off';
                      
                      var batteryState = states['sensor.tesla_model_3_niveau_de_batterie'] ? parseFloat(states['sensor.tesla_model_3_niveau_de_batterie'].state) : 0;
                      // 2. Logique Halo
                      if (chargeState == 'on') return '1px solid rgba(0, 210, 255, 0.6)'; // BLEU CLAIR (Charge)
                      if (!isNaN(batteryState)) {
                         if (batteryState <= 20) return '1px solid rgba(255, 0, 0, 0.6)';   // ROUGE (0-20%)
                         if (batteryState <= 30) return '1px solid rgba(255, 140, 0, 0.6)'; // ORANGE (20-30%)
                      }
                      // Sinon (Normal)
                      return '1px solid rgba(255,255,255,0.1)';
                    ]]]
                - box-shadow: |
                    [[[
                      var chargeState = states['binary_sensor.tesla_model_3_charging'] ? states['binary_sensor.tesla_model_3_charging'].state : 'off';
                      var batteryState = states['sensor.tesla_model_3_niveau_de_batterie'] ? parseFloat(states['sensor.tesla_model_3_niveau_de_batterie'].state) : 0;
                      if (chargeState == 'on') 
                        return '0 0 25px rgba(0, 210, 255, 0.4), 0 8px 32px rgba(0,0,0,0.3)'; // Glow BLEU
                      
                      if (!isNaN(batteryState)) {
                         if (batteryState <= 20) 
                           return '0 0 25px rgba(255, 0, 0, 0.4), 0 8px 32px rgba(0,0,0,0.3)';   // Glow ROUGE
                         if (batteryState <= 30) 
                           return '0 0 25px rgba(255, 140, 0, 0.4), 0 8px 32px rgba(0,0,0,0.3)'; // Glow ORANGE
                      }
                      return '0 8px 32px rgba(0,0,0,0.3)';
                    ]]]
              grid:
                - grid-template-areas: '"img info"'
                - grid-template-columns: 140px 1fr
                - column-gap: 16px
              custom_fields:
                img:
                  - align-self: center
                info:
                  - align-self: center
                wake:
                  - position: absolute
                  - right: 12px
                  - bottom: 12px
                  - z-index: 2
            custom_fields:
              img: |
                [[[
                  return `<img src="/local/tesla-car-image.png"
                    style="width:145px; height:auto; border-radius:12px; display:block; box-shadow: 0 4px 8px rgba(0,0,0,0.3);" />`;
                ]]]
              info: |
                [[[
                  // --- LOGIQUE "MÉMOIRE" (Simplifiée pour l'affichage) ---
                  // Si l'état est "unavailable", on essaie de ne pas afficher "NaN" ou on garde le style précédent si possible
                  
                  const isOn = states['binary_sensor.tesla_model_3_status']?.state === 'on';
                  const isCharging = states['binary_sensor.tesla_model_3_charging']?.state === 'on';
                  
                  const rawBattery = states['sensor.tesla_model_3_niveau_de_batterie']?.state;
                  const rawRange   = states['sensor.tesla_model_3_autonomie_de_batterie']?.state;
                  // Gestion des valeurs non-numériques (veille)
                  let batterie = Math.round(Number(rawBattery));
                  let autonomie = Math.round(Number(rawRange));
                  
                  // Textes d'état
                  let statusText = isOn ? 'Connectée' : 'Endormie (Veille)';
                  if (isCharging) statusText = 'En Charge ⚡';
                  
                  // Barre de progression (Reste visible même si NaN, à 0%)
                  const pct = Number.isFinite(batterie) ? Math.max(0, Math.min(100, batterie)) : 0;
                  
                  // Couleur Barre (Logique demandée incluse)
                  let fillColor = '#28a745'; // Vert par défaut
                  if (isCharging) fillColor = '#00D2FF'; // Bleu Charge
                  else if (pct <= 20) fillColor = '#dc3545'; // Rouge
                  else if (pct <= 30) fillColor = '#ffc107'; // Orange
                  const glow = `0 0 8px ${fillColor}80`; // 50% opacity
                  
                  const bar = `
                    <div style="height:10px; border-radius:999px;
                                background: rgba(255,255,255,0.1);
                                overflow:hidden; box-shadow: inset 0 0 2px rgba(0,0,0,0.3);">
                      <div style="
                        height:100%;
                        width:${pct}%;
                        background:${fillColor};
                        box-shadow: ${glow};
                        border-radius:999px;
                        transition: width 300ms ease, background 300ms ease;">
                      </div>
                    </div>
                  `;
                  
                  // Affichage Conditionnel "NiN" -> "--"
                  const displayBat = Number.isFinite(batterie) ? batterie + " %" : "-- %";
                  const displayRange = Number.isFinite(autonomie) ? autonomie + " km" : "-- km";
                  return `
                    <div style="padding-right:52px;">
                      <div style="display:flex; align-items:center; gap:8px;">
                        <ha-icon icon="${isCharging ? 'mdi:ev-station' : (isOn ? 'mdi:car-connected' : 'mdi:sleep')}"
                          style="--mdc-icon-size:22px; color: ${isOn ? '#4caf50' : 'rgba(255,255,255,0.7)'};"></ha-icon>
                        <div style="font-size:15px; font-weight:700; color: white;">
                          Tesla Model 3
                        </div>
                      </div>
                      <div style="font-size:12px; color: rgba(255,255,255,0.7); margin-top:2px;">
                        ${statusText}
                      </div>
                      <div style="margin-top:14px;">
                        <div style="display:flex; justify-content:space-between;
                                    font-size:12px; color: rgba(255,255,255,0.9); margin-bottom:6px;">
                          <span>Batterie</span>
                          <span>${displayBat} <span style="opacity:0.6">|</span> ${displayRange}</span>
                        </div>
                        ${bar}
                      </div>
                    </div>
                  `;
                ]]]
              wake:
                card:
                  type: custom:button-card
                  entity: button.tesla_model_3_wake
                  icon: mdi:power
                  show_name: false
                  show_state: false
                  size: 18px
                  styles:
                    card:
                      - width: 36px
                      - height: 36px
                      - border-radius: 12px
                      - padding: 0
                      - background: rgba(255,255,255,0.1)
                      - border: 1px solid rgba(255,255,255,0.1)
                      - backdrop-filter: blur(6px)
                      - box-shadow: 0 4px 8px rgba(0,0,0,0.2)
                    icon:
                      - color: white
                      - opacity: 0.9
                  tap_action:
                    action: call-service
                    service: button.press
                    service_data:
                      entity_id: button.tesla_model_3_wake
          - type: conditional
            conditions:
              - entity: sensor.poubelle_a_sortir
                state_not: none
            card:
              type: custom:button-card
              entity: sensor.poubelle_a_sortir
              name: |
                [[[ return entity.attributes.original_title; ]]]
              show_name: true
              show_label: false
              show_entity_picture: true
              show_icon: false
              entity_picture: |
                [[[
                  const type = entity.state.trim().toLowerCase();
                  const v = new Date().getTime();
                  if (type === 'jaune') return `/local/garbage/yellow_bin.png?v=${v}`;
                  if (type === 'verte') return `/local/green_bin.png?v=${v}`;
                  if (type === 'verre') return `/local/glass_bin.png?v=${v}`;
                  return `/local/green_bin.png?v=${v}`; 
                ]]]
              variables:
                color: |
                  [[[
                    const type = entity.state.trim().toLowerCase();
                    if (type === 'jaune') return '#FFEB3B';   // Jaune
                    if (type === 'verre') return '#00BCD4';   // Bleu/Cyan (Verre)
                    return '#4CAF50';                         // Vert (Défaut/Verte)
                  ]]]
              styles:
                card:
                  - background: rgba(20, 27, 38, 0.75)
                  - backdrop-filter: blur(15px)
                  - '-webkit-backdrop-filter': blur(15px)
                  - border-radius: 20px
                  - padding: 12px
                  - height: 80px
                  - box-shadow: >
                      [[[ return `0 0 20px ${variables.color}60, 0 8px 32px
                      rgba(0,0,0,0.4)`; ]]]
                  - border: |
                      [[[ return `1px solid ${variables.color}60`; ]]]
                  - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                grid:
                  - grid-template-areas: '"i n"'
                  - grid-template-columns: 80px 1fr
                  - grid-template-rows: 1fr
                entity_picture:
                  - width: 60px
                  - height: 60px
                  - object-fit: contain
                  - filter: >-
                      [[[ return `drop-shadow(0 0 10px ${variables.color}44)`;
                      ]]]
                name:
                  - font-size: 12px
                  - font-weight: 700
                  - color: '[[[ return variables.color; ]]]'
                  - justify-self: start
                  - text-align: left
                  - margin-left: 5px
                  - animation: blink 2s ease infinite
              extra_styles: |
                @keyframes blink {
                  0% { opacity: 1; }
                  50% { opacity: 0.35; } 
                  100% { opacity: 1; }
                }
          - type: conditional
            conditions:
              - entity: sensor.batteries_faibles_count
                state_not: '0'
            card:
              type: custom:button-card
              entity: sensor.batteries_faibles_count
              name: Batteries Faibles
              icon: mdi:battery-alert
              label: Appareils à changer
              show_name: true
              show_icon: true
              show_label: true
              tap_action:
                action: navigate
                navigation_path: /lovelace/batteries
              custom_fields:
                s: |
                  [[[ return entity.state; ]]]
              variables:
                color: '#ff4444'
              styles:
                card:
                  - background: rgba(20, 27, 38, 0.6)
                  - backdrop-filter: blur(20px)
                  - '-webkit-backdrop-filter': blur(20px)
                  - border-radius: 20px
                  - padding: 8px
                  - height: 65px
                  - box-shadow: >
                      [[[ return `0 0 20px ${variables.color}80, 0 8px 32px
                      rgba(0,0,0,0.3)`; ]]]
                  - border: |
                      [[[ return `1px solid ${variables.color}80`; ]]]
                  - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
                grid:
                  - grid-template-areas: '"i n s" "i l s"'
                  - grid-template-columns: 50px 1fr auto
                  - grid-template-rows: 1fr 1fr
                icon:
                  - color: '[[[ return variables.color; ]]]'
                  - width: 30px
                  - height: 30px
                  - filter: >-
                      [[[ return `drop-shadow(0 0 5px ${variables.color}66)`;
                      ]]]
                name:
                  - font-size: 14px
                  - font-weight: 700
                  - color: white
                  - justify-self: start
                  - align-self: end
                label:
                  - font-size: 11px
                  - color: rgba(255,255,255,0.7)
                  - justify-self: start
                  - align-self: start
                custom_fields:
                  s:
                    - font-size: 32px
                    - font-weight: 900
                    - color: '[[[ return variables.color; ]]]'
                    - align-self: center
                    - margin-right: 16px
                    - text-shadow: '[[[ return `0 0 10px ${variables.color}4d`; ]]]'
              card_mod:
                style: >
                  /* Force le clignotement synchronisé sur l'icône et tout le
                  texte */

                  ha-icon, #name, #label, #s {
                    animation: blink 2s infinite !important;
                  }

                  @keyframes blink {
                    0% { opacity: 1; }
                    50% { opacity: 0.3; }
                    100% { opacity: 1; }
                  }
          - type: conditional
            conditions:
              - entity: binary_sensor.ll_ou_sl_actif_ou_termine
                state: 'on'
            card:
              type: markdown
              content: |
                ### État Lave-linge & Sèche-linge
              card_mod:
                style: |
                  ha-card {
                    background: rgba(20, 27, 38, 0.6) !important;
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    border-radius: 20px !important;
                    border: 1px solid rgba(255,255,255,0.1) !important;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                  }
                  ha-markdown {
                    padding: 16px !important;
                    display: block !important;
                  }
                  h3 {
                    color: white !important;
                    font-weight: 700 !important;
                    margin: 0 !important;
                    font-size: 16px !important;
                    text-align: center;
                    letter-spacing: 0.5px;
                  }
          - type: grid
            columns: 4
            square: false
            cards:
              - type: conditional
                conditions:
                  - entity: binary_sensor.machine_a_laver_en_cours
                    state: 'on'
                card:
                  type: custom:button-card
                  entity: binary_sensor.machine_a_laver_en_cours
                  name: Lave-linge
                  label: En cours
                  icon: mdi:washing-machine
                  variables:
                    color: '#fb8c00'
                  show_state: false
                  show_name: true
                  show_icon: true
                  show_label: true
                  styles:
                    card:
                      - padding: 10px 4px
                      - height: 110px
                      - border-radius: 20px
                      - background: rgba(20, 27, 38, 0.6)
                      - backdrop-filter: blur(10px)
                      - '-webkit-backdrop-filter': blur(10px)
                      - transition: transform 0.1s ease
                      - animation: blink 2s ease infinite
                      - box-shadow: >
                          [[[ return `0 0 20px ${variables.color}80, 0 4px 15px
                          rgba(0,0,0,0.2)`; ]]]
                      - border: |
                          [[[ return `1px solid ${variables.color}80`; ]]]
                    grid:
                      - grid-template-areas: '"n" "i" "l"'
                      - grid-template-columns: 1fr
                      - grid-template-rows: min-content 1fr min-content
                      - row-gap: 8px
                    icon:
                      - width: 32px
                      - height: 32px
                      - color: |
                          [[[ return variables.color; ]]]
                      - filter: >
                          [[[ return `drop-shadow(0 0 8px
                          ${variables.color}aa)`; ]]]
                    name:
                      - font-size: 13px
                      - font-weight: 600
                      - color: white
                      - text-align: center
                    label:
                      - font-size: 12px
                      - opacity: 0.8
                      - color: white
                      - text-align: center
                      - font-weight: 500
              - type: conditional
                conditions:
                  - entity: input_boolean.machine_a_laver_terminee
                    state: 'on'
                card:
                  type: custom:button-card
                  entity: input_boolean.machine_a_laver_terminee
                  name: Lave-linge
                  label: Terminé
                  icon: mdi:washing-machine-alert
                  variables:
                    color: '#00897b'
                  show_state: false
                  show_name: true
                  show_icon: true
                  show_label: true
                  styles:
                    card:
                      - padding: 10px 4px
                      - height: 110px
                      - border-radius: 20px
                      - background: rgba(20, 27, 38, 0.6)
                      - backdrop-filter: blur(10px)
                      - '-webkit-backdrop-filter': blur(10px)
                      - transition: transform 0.1s ease
                      - box-shadow: >
                          [[[ return `0 0 20px ${variables.color}80, 0 4px 15px
                          rgba(0,0,0,0.2)`; ]]]
                      - border: |
                          [[[ return `1px solid ${variables.color}80`; ]]]
                    grid:
                      - grid-template-areas: '"n" "i" "l"'
                      - grid-template-columns: 1fr
                      - grid-template-rows: min-content 1fr min-content
                      - row-gap: 8px
                    icon:
                      - width: 32px
                      - height: 32px
                      - color: |
                          [[[ return variables.color; ]]]
                      - filter: >
                          [[[ return `drop-shadow(0 0 8px
                          ${variables.color}aa)`; ]]]
                    name:
                      - font-size: 13px
                      - font-weight: 600
                      - color: white
                      - text-align: center
                    label:
                      - font-size: 12px
                      - opacity: 0.8
                      - color: white
                      - text-align: center
                      - font-weight: 500
              - type: conditional
                conditions:
                  - entity: binary_sensor.seche_linge_en_cours
                    state: 'on'
                card:
                  type: custom:button-card
                  entity: binary_sensor.seche_linge_en_cours
                  name: Sèche-linge
                  label: En cours
                  icon: mdi:tumble-dryer
                  variables:
                    color: '#fb8c00'
                  show_state: false
                  show_name: true
                  show_icon: true
                  show_label: true
                  styles:
                    card:
                      - padding: 10px 4px
                      - height: 110px
                      - border-radius: 20px
                      - background: rgba(20, 27, 38, 0.6)
                      - backdrop-filter: blur(10px)
                      - '-webkit-backdrop-filter': blur(10px)
                      - transition: transform 0.1s ease
                      - animation: blink 2s ease infinite
                      - box-shadow: >
                          [[[ return `0 0 20px ${variables.color}80, 0 4px 15px
                          rgba(0,0,0,0.2)`; ]]]
                      - border: |
                          [[[ return `1px solid ${variables.color}80`; ]]]
                    grid:
                      - grid-template-areas: '"n" "i" "l"'
                      - grid-template-columns: 1fr
                      - grid-template-rows: min-content 1fr min-content
                      - row-gap: 8px
                    icon:
                      - width: 32px
                      - height: 32px
                      - color: |
                          [[[ return variables.color; ]]]
                      - filter: >
                          [[[ return `drop-shadow(0 0 8px
                          ${variables.color}aa)`; ]]]
                    name:
                      - font-size: 13px
                      - font-weight: 600
                      - color: white
                      - text-align: center
                    label:
                      - font-size: 12px
                      - opacity: 0.8
                      - color: white
                      - text-align: center
                      - font-weight: 500
              - type: conditional
                conditions:
                  - entity: input_boolean.seche_linge_termine
                    state: 'on'
                  - entity: binary_sensor.seche_linge_door_status
                    state: 'off'
                card:
                  type: custom:button-card
                  entity: input_boolean.seche_linge_termine
                  name: Sèche-linge
                  label: Terminé
                  icon: mdi:tumble-dryer-alert
                  variables:
                    color: '#00897b'
                  show_state: false
                  show_name: true
                  show_icon: true
                  show_label: true
                  styles:
                    card:
                      - padding: 10px 4px
                      - height: 110px
                      - border-radius: 20px
                      - background: rgba(20, 27, 38, 0.6)
                      - backdrop-filter: blur(10px)
                      - '-webkit-backdrop-filter': blur(10px)
                      - transition: transform 0.1s ease
                      - box-shadow: >
                          [[[ return `0 0 20px ${variables.color}80, 0 4px 15px
                          rgba(0,0,0,0.2)`; ]]]
                      - border: |
                          [[[ return `1px solid ${variables.color}80`; ]]]
                    grid:
                      - grid-template-areas: '"n" "i" "l"'
                      - grid-template-columns: 1fr
                      - grid-template-rows: min-content 1fr min-content
                      - row-gap: 8px
                    icon:
                      - width: 32px
                      - height: 32px
                      - color: |
                          [[[ return variables.color; ]]]
                      - filter: >
                          [[[ return `drop-shadow(0 0 8px
                          ${variables.color}aa)`; ]]]
                    name:
                      - font-size: 13px
                      - font-weight: 600
                      - color: white
                      - text-align: center
                    label:
                      - font-size: 12px
                      - opacity: 0.8
                      - color: white
                      - text-align: center
                      - font-weight: 500
          - type: conditional
            conditions:
              - condition: numeric_state
                entity: sensor.colis_17track_actifs
                above: 0
            card:
              type: markdown
              title: 📦 Suivi des colis
              content: >
                {% set packages = state_attr('sensor.colis_17track_actifs',
                'packages') or [] %} {# Traduction des statuts #} {% set
                trad_status = {
                  "In Transit": "En transit",
                  "Not Found": "Introuvable",
                  "Expired": "Expiré",
                  "Ready to be picked up": "À retirer",
                  "Undelivered": "Non distribué",
                  "Alert": "Alerte",
                  "Delivered": "Livré",
                  "Pending": "En attente"
                } %} {# Fragments de texte à traduire #} {% set trad_phrases = {
                  "Departed from departure country/region": "Départ du pays d’origine",
                  "Left from departure country/region": "Colis parti du pays d’origine",
                  "Destination country/region arrived": "Arrivé dans le pays de destination",
                  "Arrived at sorting center": "Arrivé au centre de tri",
                  "Item dispatched": "Colis expédié",
                  "Out for delivery": "En cours de livraison",
                  "Shipment information received": "Informations d’expédition reçues",
                  "Handed over from linehaul office": "Pris en charge par le hub principal",
                  "At destination country/region": "dans le pays de destination"
                } %} {% for package in packages %}
                  {% set name = package.friendly_name or package.tracking_number %}
                  {% set status_en = package.status or "" %}
                  {% set status_fr = trad_status.get(status_en, status_en) %}
                  {# Texte brut : on enlève sauts de ligne + "Carrier note:" #}
                  {% set base_text = (package.info_text or "") | replace('\n',' ') %}
                  {% set base_text = base_text.replace('Carrier note:', '') | trim %}
                  {# On applique les traductions avec un namespace pour conserver les changements #}
                  {% set ns = namespace(txt=base_text) %}
                  {% for eng, fr in trad_phrases.items() %}
                    {% set ns.txt = ns.txt.replace(eng, fr) %}
                  {% endfor %}
                  📦 **{{ name }}**  
                  ✈️ {{ ns.txt }}  
                  📍 Statut : {{ status_fr }}
                {% endfor %}
              card_mod:
                style: |
                  ha-card {
                    background: rgba(20, 27, 38, 0.6) !important;
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    border-radius: 20px !important;
                    border: 1px solid rgba(255,255,255,0.1) !important;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
                    --primary-text-color: rgba(255,255,255,0.9);
                  }
                  ha-markdown {
                    padding: 16px !important;
                  }
                  h1.card-header {
                    color: white !important;
                    font-weight: 700 !important;
                    padding-bottom: 0 !important;
                    font-size: 18px !important;
                  }
      - type: grid
        cards:
          - type: heading
            heading: Nouvelle section
          - type: conditional
            conditions:
              - condition: state
                entity: light.lumieres_maison
                state: 'on'
            card:
              type: vertical-stack
              cards:
                - type: custom:mushroom-light-card
                  entity: light.lumieres_maison
                  name: Toute la Maison
                  icon: mdi:home-lightbulb
                  fill_container: true
                  layout: vertical
                  use_light_color: true
                  card_mod:
                    style: |
                      ha-card {
                        background: rgba(20, 27, 38, 0.6) !important;
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                        border-radius: 20px !important;
                        border: 1px solid {{ 'rgba(255, 0, 0, 0.6)' if is_state('light.lumieres_maison', 'on') else 'rgba(255, 255, 255, 0.1)' }} !important;
                        box-shadow: {{ '0 0 20px rgba(255, 0, 0, 0.3)' if is_state('light.lumieres_maison', 'on') else '0 4px 15px rgba(0,0,0,0.2)' }} !important;
                        padding: 1px !important;
                        transition: all 0.3s ease-in-out;
                      }
                - type: custom:auto-entities
                  show_empty: false
                  unique: true
                  card:
                    type: grid
                    columns: 3
                    square: false
                    card_mod:
                      style: |
                        ha-card {
                          background: none;
                          box-shadow: none;
                          border: none;
                          padding: 0 !important;
                          margin-top: 10px !important;
                        }
                  card_param: cards
                  filter:
                    include:
                      - group: light.lumieres_maison
                        state: 'on'
                        options:
                          type: custom:mushroom-light-card
                          use_light_color: true
                          show_brightness_control: false
                          show_color_temp_control: false
                          show_color_control: false
                          card_mod:
                            style: |
                              ha-card {
                                background: rgba(20, 27, 38, 0.6) !important;
                                backdrop-filter: blur(10px);
                                -webkit-backdrop-filter: blur(10px);
                                border-radius: 15px !important;
                                border: 1px solid rgba(255, 0, 0, 0.4) !important;
                                box-shadow: 0 0 10px rgba(255, 0, 0, 0.2) !important;
                                transition: all 0.3s ease-in-out;
                              }
                    exclude:
                      - entity_id: light.lumieres_maison
          - type: custom:clock-weather-card
            entity: weather.home
            title: null
            sun_entity: sun.sun
            temperature_sensor: sensor.outdoor_temp
            humidity_sensor: sensor.outdoor_humidity
            weather_icon_type: line
            animated_icon: true
            forecast_rows: 5
            hide_today_section: true
            hide_forecast_section: false
            show_humidity: true
            hide_clock: true
            hide_date: true
            hourly_forecast: false
            use_browser_time: false
            show_decimal: false
            apparent_sensor: sensor.real_feel_temperature
            aqi_sensor: sensor.air_quality_index
            card_mod:
              style: |
                ha-card {
                  background: rgba(20, 27, 38, 0.6) !important;
                  backdrop-filter: blur(20px);
                  -webkit-backdrop-filter: blur(20px);
                  border-radius: 24px !important;
                  border: 1px solid rgba(255,255,255,0.1) !important;
                  box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
                  
                  --primary-text-color: #ffffff;
                  --secondary-text-color: rgba(255,255,255,0.7);
                }
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:button-card
                name: Lumières
                icon: mdi:home-lightbulb-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/lumieres
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#ffd54a'
                    - filter: drop-shadow(0 0 8px rgba(255, 213, 74, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Températures
                icon: mdi:home-thermometer-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/temperatures-et-consommations
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#FA007D'
                    - filter: drop-shadow(0 0 8px rgba(250, 0, 125, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Energies
                icon: mdi:home-lightning-bolt-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/energies
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#0080ff'
                    - filter: drop-shadow(0 0 8px rgba(0, 128, 255, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:button-card
                name: Accueil
                icon: mdi:home
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/dashboard
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#00FF00'
                    - filter: drop-shadow(0 0 8px rgba(0, 255, 0, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Températures
                icon: mdi:home-thermometer-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/temperatures-et-consommations
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#FA007D'
                    - filter: drop-shadow(0 0 8px rgba(250, 0, 125, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Energies
                icon: mdi:home-lightning-bolt-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/energies
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#0080ff'
                    - filter: drop-shadow(0 0 8px rgba(0, 128, 255, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:button-card
                name: Accueil
                icon: mdi:home
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/dashboard
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#00FF00'
                    - filter: drop-shadow(0 0 8px rgba(0, 255, 0, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Lumières
                icon: mdi:home-lightbulb-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/lumieres
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#ffd54a'
                    - filter: drop-shadow(0 0 8px rgba(255, 213, 74, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
              - type: custom:button-card
                name: Températures
                icon: mdi:home-thermometer-outline
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/temperatures-et-consommations
                styles:
                  card:
                    - padding: 12px
                    - height: 85px
                    - border-radius: 20px
                    - border: 1px solid rgba(255,255,255,0.1)
                    - background: rgba(20, 27, 38, 0.6)
                    - backdrop-filter: blur(10px)
                    - '-webkit-backdrop-filter': blur(10px)
                    - box-shadow: 0 4px 15px rgba(0,0,0,0.2)
                    - transition: transform 0.1s ease
                  icon:
                    - width: 28px
                    - height: 28px
                    - color: '#FA007D'
                    - filter: drop-shadow(0 0 8px rgba(250, 0, 125, 0.4))
                    - margin-bottom: 8px
                  name:
                    - font-size: 13px
                    - font-weight: 600
                    - color: rgba(255,255,255,0.9)
                  grid:
                    - grid-template-areas: '"i" "n"'
                    - grid-template-rows: 1fr min-content
          - type: custom:button-card
            entity: weather.home
            show_name: false
            show_icon: false
            show_state: false
            tap_action:
              action: more-info
            styles:
              card:
                - padding: 0
                - border-radius: 20px
                - background: rgba(0, 0, 0, 0.2)
                - backdrop-filter: blur(20px)
                - '-webkit-backdrop-filter': blur(20px)
                - box-shadow: 0 8px 32px rgba(0,0,0,0.3)
                - border: |
                    [[[
                      const alert = states['sensor.91_weather_alert'];
                      if (!alert || !alert.attributes) return '1px solid rgba(255,255,255,0.1)';
                      const p = ['Vent violent', 'Pluie-inondation', 'Orages', 'Inondation', 'Neige-verglas', 'Canicule', 'Grand froid', 'Avalanches', 'Vagues-submersion'];
                      let lvl = 'Vert';
                      for (let x of p) {
                        let v = alert.attributes[x];
                        if (v === 'Rouge') { lvl = 'Rouge'; break; }
                        if (v === 'Orange' && lvl !== 'Rouge') lvl = 'Orange';
                        if (v === 'Jaune' && lvl !== 'Rouge' && lvl !== 'Orange') lvl = 'Jaune';
                      }
                      if (lvl === 'Rouge') return '1px solid rgba(244, 67, 54, 0.6)';
                      if (lvl === 'Orange') return '1px solid rgba(255, 152, 0, 0.6)';
                      if (lvl === 'Jaune') return '1px solid rgba(255, 235, 59, 0.4)';
                      return '1px solid rgba(255,255,255,0.1)';
                    ]]]
                - transition: all 0.5s ease
                - height: 56px
                - overflow: hidden
              grid:
                - grid-template-areas: '"icon details"'
                - grid-template-columns: 130px 1fr
                - grid-template-rows: 56px
                - gap: 0px
                - width: 100%
                - margin: 0
              custom_fields:
                icon:
                  - justify-self: stretch
                  - align-self: stretch
                  - border-right: 2px solid rgba(255,255,255,0.6)
                  - border-top-left-radius: 20px
                  - border-bottom-left-radius: 20px
                  - display: flex
                  - align-items: center
                  - justify-content: center
                  - padding: 0
                details:
                  - justify-self: stretch
                  - align-self: stretch
                  - display: flex
                  - flex-direction: column
                  - justify-content: center
                  - align-items: stretch
                  - padding: 0 10px
                  - overflow: hidden
                  - position: relative
                  - pointer-events: none
            custom_fields:
              icon: |
                [[[
                  const weatherState = states['weather.home'];
                  if (!weatherState) return "";
                  const state = weatherState.state;
                  let color = '#B0BEC5';
                  let svg = '';
                  
                  if (state === 'sunny' || state === 'clear') { 
                    color = '#FFA500'; 
                    svg = `
                      <svg viewBox="0 0 64 64" style="width: 30px; height: 30px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transform: translateY(3px);">
                        <g style="animation: spin_sun 12s linear infinite; transform-origin: 32px 32px;">
                          <circle cx="32" cy="32" r="14" fill="#FFD700"/>
                          <g stroke="#FFD700" stroke-width="4" stroke-linecap="round">
                            <line x1="32" y1="6" x2="32" y2="12"/><line x1="32" y1="52" x2="32" y2="58"/>
                            <line x1="6" y1="32" x2="12" y2="32"/><line x1="52" y1="32" x2="58" y2="32"/>
                            <line x1="13.6" y1="13.6" x2="17.8" y2="17.8"/><line x1="46.2" y1="46.2" x2="50.4" y2="50.4"/>
                            <line x1="13.6" y1="50.4" x2="17.8" y2="46.2"/><line x1="46.2" y1="17.8" x2="50.4" y2="13.6"/>
                          </g>
                        </g>
                      </svg>
                    `;
                  }
                  else if (state === 'partlycloudy') {
                    color = '#46D278'; 
                    svg = `
                      <svg viewBox="0 0 64 64" style="width: 30px; height: 30px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transform: translateY(3px);">
                        <g style="animation: spin_sun 12s linear infinite; transform-origin: 22px 22px;">
                          <circle cx="22" cy="22" r="10" fill="#FFD700"/>
                          <g stroke="#FFD700" stroke-width="3" stroke-linecap="round">
                            <line x1="22" y1="4" x2="22" y2="8"/><line x1="22" y1="36" x2="22" y2="40"/>
                            <line x1="4" y1="22" x2="8" y2="22"/><line x1="36" y1="22" x2="40" y2="22"/>
                            <line x1="9.3" y1="9.3" x2="12.1" y2="12.1"/><line x1="31.9" y1="31.9" x2="34.7" y2="34.7"/>
                            <line x1="9.3" y1="34.7" x2="12.1" y2="31.9"/><line x1="31.9" y1="12.1" x2="34.7" y2="9.3"/>
                          </g>
                        </g>
                        <path d="M48 44a10 10 0 0 0-4-19 14 14 0 0 0-26 2 8 8 0 0 0-2 15h32z" fill="#E0E0E0" />
                      </svg>
                    `;
                  }
                  else if (state === 'rainy' || state === 'pouring') { 
                    color = '#008CFF'; 
                    svg = `
                      <svg viewBox="0 0 64 64" style="width: 30px; height: 30px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transform: translateY(3px);">
                        <path d="M46 38a10 10 0 0 0-4-19 14 14 0 0 0-26 2 8 8 0 0 0-2 15h32z" fill="#90A4AE" />
                        <g stroke="#4FC3F7" stroke-width="3" stroke-linecap="round">
                          <line x1="22" y1="42" x2="18" y2="50" style="animation: rain_drop 1s linear infinite;" />
                          <line x1="32" y1="42" x2="28" y2="50" style="animation: rain_drop 1s linear infinite 0.33s;" />
                          <line x1="42" y1="42" x2="38" y2="50" style="animation: rain_drop 1s linear infinite 0.66s;" />
                        </g>
                      </svg>
                    `;
                  }
                  else if (state === 'lightning' || state === 'lightning-rainy') { 
                    color = '#BA55D3'; 
                    svg = `
                      <svg viewBox="0 0 64 64" style="width: 30px; height: 30px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transform: translateY(3px);">
                        <path d="M46 38a10 10 0 0 0-4-19 14 14 0 0 0-26 2 8 8 0 0 0-2 15h32z" fill="#78909C" />
                        <path d="M30 38l-6 12h8l-4 10 10-14h-6l4-8z" fill="#FFEA00" style="animation: zap_flash 2s infinite;" />
                      </svg>
                    `;
                  }
                  else if (state === 'snowy' || state === 'snowy-rainy') { 
                    color = '#78EBFF'; 
                    svg = `
                      <svg viewBox="0 0 64 64" style="width: 30px; height: 30px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transform: translateY(3px);">
                        <path d="M46 38a10 10 0 0 0-4-19 14 14 0 0 0-26 2 8 8 0 0 0-2 15h32z" fill="#B0BEC5" />
                        <circle cx="22" cy="46" r="2.5" fill="#FFFFFF" style="animation: snow_fall 3s infinite;" />
                        <circle cx="32" cy="44" r="2.5" fill="#FFFFFF" style="animation: snow_fall 3s infinite 1s;" />
                        <circle cx="42" cy="48" r="2.5" fill="#FFFFFF" style="animation: snow_fall 3s infinite 2s;" />
                      </svg>
                    `;
                  }
                  else if (state === 'windy' || state === 'windy-variant' || state === 'fog') {
                    color = '#B0BEC5';
                    svg = `
                      <svg viewBox="0 0 64 64" style="width: 30px; height: 30px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transform: translateY(3px);">
                        <path d="M46 34a10 10 0 0 0-4-19 14 14 0 0 0-26 2 8 8 0 0 0-2 15h32z" fill="#CFD8DC" />
                        <g stroke="#90A4AE" stroke-width="3" stroke-linecap="round">
                          <line x1="16" y1="44" x2="48" y2="44" style="animation: wind_drift 2s infinite;" />
                          <line x1="20" y1="50" x2="44" y2="50" style="animation: wind_drift 2s infinite 1s;" />
                        </g>
                      </svg>
                    `;
                  }
                  else {
                    // cloudy
                    color = '#9E9E9E';
                    svg = `
                      <svg viewBox="0 0 64 64" style="width: 30px; height: 30px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transform: translateY(3px);">
                        <path d="M46 44a10 10 0 0 0-4-19 14 14 0 0 0-26 2 8 8 0 0 0-2 15h32z" fill="#E0E0E0" />
                        <path d="M40 46a8 8 0 0 0-2-12 10 10 0 0 0-18 2 6 6 0 0 0-2 10h22z" fill="#CFD8DC" opacity="0.8" />
                      </svg>
                    `;
                  }
                  
                  return `
                    <div style="width: 100%; height: 100%; min-height: 56px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding-bottom: 6px; padding-top: 4px; box-sizing: border-box; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px; border-bottom-left-radius: 20px;">
                      <div style="flex-grow: 1; display: flex; align-items: center; justify-content: center; animation: weather_bob_svg 3s ease-in-out infinite;">${svg}</div>
                      <span style="font-size: 10px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); margin-top: -2px;">MÉTÉO</span>
                    </div>
                    <style> 
                      @keyframes weather_bob_svg { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }
                      @keyframes spin_sun { 100% { transform: rotate(360deg); } }
                      @keyframes rain_drop { 0% { transform: translate(0,0); opacity:1; } 100% { transform: translate(-4px,8px); opacity:0; } }
                      @keyframes zap_flash { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
                      @keyframes snow_fall { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(10px); opacity: 0; } }
                      @keyframes wind_drift { 0% { transform: translateX(0); opacity: 0.5; } 50% { transform: translateX(4px); opacity: 1; } 100% { transform: translateX(0); opacity: 0.5; } }
                    </style>
                  `;
                ]]]
              details:
                card:
                  type: custom:clock-weather-card
                  entity: weather.home
                  title: null
                  sun_entity: sun.sun
                  temperature_sensor: sensor.outdoor_temp
                  humidity_sensor: sensor.outdoor_humidity
                  weather_icon_type: line
                  animated_icon: true
                  forecast_rows: 1
                  hide_today_section: true
                  hide_forecast_section: false
                  show_humidity: true
                  hide_clock: true
                  hide_date: true
                  hourly_forecast: false
                  use_browser_time: false
                  show_decimal: false
                  apparent_sensor: sensor.real_feel_temperature
                  aqi_sensor: sensor.air_quality_index
                  card_mod:
                    style: |
                      ha-card {
                        background: transparent !important;
                        border: none !important;
                        box-shadow: none !important;
                        padding: 0 !important;
                        margin: -15px 0 !important;
                        pointer-events: none !important;
                      }
                      .card-content {
                        padding: 0 !important;
                        pointer-events: none !important;
                      }
                      .forecast_temp, .today_temp, span.temperature {
                        font-size: 13px !important;
                        font-weight: 600 !important;
                      }
                      .forecast {
                        font-size: 11px !important;
                      }
          - type: custom:fold-entity-row
            padding: 0
            clickable: true
            card_mod:
              style: |
                {% set st = states('sensor.91_weather_alert') %}
                {% if st == 'Vert' or st == 'unknown' or st == 'unavailable' %}
                  :host {
                    display: none !important;
                  }
                {% endif %}

                div#head {
                  display: block !important;
                  width: 100% !important;
                  padding: 0 !important;
                  margin: 0 !important;
                  --toggle-icon-width: 0px !important;
                }
                #head {
                  padding: 0 !important;
                  margin: 0 !important;
                  width: 100% !important;
                  cursor: pointer !important;
                  pointer-events: auto !important;
                }
                #head ha-icon {
                  display: none !important;
                  width: 0px !important;
                }
                div#items {
                  padding: 0 !important;
                  margin: 0 !important;
                }
            head:
              type: custom:button-card
              entity: sensor.91_weather_alert
              show_name: false
              show_icon: false
              show_state: false
              tap_action:
                action: none
              styles:
                card:
                  - padding: 0
                  - border-radius: 20px
                  - background: rgba(20, 27, 38, 0.6)
                  - backdrop-filter: blur(20px)
                  - '-webkit-backdrop-filter': blur(20px)
                  - box-shadow: |
                      [[[
                        if (!entity || !entity.attributes) return '0 8px 32px rgba(0,0,0,0.3)';
                        const p_list = ['Vent violent', 'Pluie-inondation', 'Orages', 'Inondation', 'Neige-verglas', 'Canicule', 'Grand froid', 'Avalanches', 'Vagues-submersion'];
                        let max_lvl = 'Jaune';
                        let found = false;
                        for (const p of p_list) {
                          if (entity.attributes[p] === 'Rouge') { max_lvl = 'Rouge'; found=true; break; }
                          if (entity.attributes[p] === 'Orange') { max_lvl = 'Orange'; found=true; }
                          if (entity.attributes[p] === 'Jaune' && !found) { found=true; }
                        }
                        if (max_lvl === 'Rouge') return '0 0 20px rgba(244, 67, 54, 0.4), 0 8px 32px rgba(0,0,0,0.3)';
                        if (max_lvl === 'Orange') return '0 0 20px rgba(255, 152, 0, 0.4), 0 8px 32px rgba(0,0,0,0.3)';
                        return '0 0 15px rgba(255, 235, 59, 0.3), 0 8px 32px rgba(0,0,0,0.3)';
                      ]]]
                  - border: |
                      [[[
                        if (!entity || !entity.attributes) return '1px solid rgba(255,255,255,0.1)';
                        const p_list = ['Vent violent', 'Pluie-inondation', 'Orages', 'Inondation', 'Neige-verglas', 'Canicule', 'Grand froid', 'Avalanches', 'Vagues-submersion'];
                        let max_lvl = 'Jaune';
                        let found = false;
                        for (const p of p_list) {
                          if (entity.attributes[p] === 'Rouge') { max_lvl = 'Rouge'; found=true; break; }
                          if (entity.attributes[p] === 'Orange') { max_lvl = 'Orange'; found=true; }
                          if (entity.attributes[p] === 'Jaune' && !found) { found=true; }
                        }
                        if (max_lvl === 'Rouge') return '1px solid rgba(244, 67, 54, 0.5)';
                        if (max_lvl === 'Orange') return '1px solid rgba(255, 152, 0, 0.5)';
                        return '1px solid rgba(255, 235, 59, 0.4)';
                      ]]]
                  - transition: all 0.5s ease
                grid:
                  - grid-template-areas: '"icon details" "footer footer"'
                  - grid-template-columns: 130px 1fr
                  - grid-template-rows: 60px 30px
                  - gap: 0px
                  - width: 100%
                  - margin: 0
                custom_fields:
                  icon:
                    - justify-self: stretch
                    - align-self: stretch
                    - border-right: 2px solid rgba(255,255,255,0.6)
                    - border-top-left-radius: 20px
                    - display: flex
                    - align-items: center
                    - justify-content: center
                    - padding: 0
                  details:
                    - justify-self: stretch
                    - align-self: stretch
                    - display: flex
                    - flex-direction: column
                    - justify-content: center
                    - align-items: stretch
                    - padding: 0 0 0 20px
                    - overflow: hidden
                    - position: relative
                  footer:
                    - justify-self: stretch
                    - align-self: stretch
                    - background: rgba(0,0,0,0.2)
                    - border-top: 1px solid rgba(255,255,255,0.05)
                    - display: flex
                    - align-items: center
                    - justify-content: center
                    - border-radius: 0 0 20px 20px
              custom_fields:
                icon: |
                  [[[
                    if (!entity || !entity.attributes) return "";
                    const p_list = ['Vent violent', 'Pluie-inondation', 'Orages', 'Inondation', 'Neige-verglas', 'Canicule', 'Grand froid', 'Avalanches', 'Vagues-submersion'];
                    let max_lvl = 'Jaune';
                    let found = false;
                    
                    for (const p of p_list) {
                      if (entity.attributes[p] === 'Rouge') { max_lvl = 'Rouge'; found=true; break; }
                      if (entity.attributes[p] === 'Orange') { max_lvl = 'Orange'; found=true; }
                      if (entity.attributes[p] === 'Jaune' && !found) { found=true; }
                    }
                    
                    let color = '#ffeb3b'; // Jaune
                    if (max_lvl === 'Orange') color = '#ff9800';
                    if (max_lvl === 'Rouge') color = '#f44336';
                    
                    return `
                      <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%); border-top-left-radius: 20px;">
                        <svg viewBox="0 0 24 24" style="width: 38px; height: 38px; filter: drop-shadow(0 0 8px ${color}80);">
                          <g style="animation: pulse_alert 2s infinite;">
                            <circle cx="12" cy="12" r="10" fill="none" stroke="${color}" stroke-width="1.5" stroke-dasharray="4 6" stroke-linecap="round" style="transform-origin: 50% 50%; animation: spin_radar 12s linear infinite;" />
                            <circle cx="12" cy="12" r="7" fill="${color}33" stroke="${color}" stroke-width="1" opacity="0.6"/>
                            <path d="M12 7V13" stroke="${color}" stroke-width="2.5" stroke-linecap="round" />
                            <circle cx="12" cy="16.5" r="1.5" fill="${color}" />
                          </g>
                        </svg>
                      </div>
                      <style> @keyframes spin_radar { 100% { transform: rotate(360deg); } } </style>
                    `;
                  ]]]
                details: |
                  [[[
                    if (!entity || !entity.attributes) return "";
                    
                    const pheno_configs = [
                      { id: 'Vent violent', icon: 'mdi:weather-windy' },
                      { id: 'Pluie-inondation', icon: 'mdi:weather-pouring' },
                      { id: 'Orages', icon: 'mdi:weather-lightning' },
                      { id: 'Inondation', icon: 'mdi:home-flood' },
                      { id: 'Neige-verglas', icon: 'mdi:weather-snowy' },
                      { id: 'Canicule', icon: 'mdi:weather-sunny-alert' },
                      { id: 'Grand froid', icon: 'mdi:snowflake' },
                      { id: 'Avalanches', icon: 'mdi:image-filter-hdr' },
                      { id: 'Vagues-submersion', icon: 'mdi:waves' }
                    ];
                    
                    const p_colors = { 'Rouge': '#f44336', 'Orange': '#ff9800', 'Jaune': '#ffeb3b', 'Vert': 'rgba(255,255,255,0.2)' };
                    
                    let icons_html = '<div style="display: flex; gap: 4px; align-items: center; justify-content: flex-start; width: 100%;">';
                    
                    pheno_configs.forEach(conf => {
                      let lvl = entity.attributes[conf.id];
                      if (!lvl || lvl === 'Vert') {
                         icons_html += `<ha-icon icon="${conf.icon}" style="color: rgba(255,255,255,0.15); width: 22px; height: 22px;"></ha-icon>`;
                      } else {
                         const c = p_colors[lvl] || p_colors['Jaune'];
                         icons_html += `<ha-icon icon="${conf.icon}" style="color: ${c}; filter: drop-shadow(0 0 5px ${c}80); width: 22px; height: 22px; animation: dash_blink_text 1.5s infinite;"></ha-icon>`;
                      }
                    });
                    
                    icons_html += '</div>';

                    return `
                      <div style="display: flex; flex-direction: column; justify-content: center; align-items: flex-start; gap: 4px;">
                        <div style="font-size: 15px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 10px rgba(255,255,255,0.2);">Alertes Météo</div>
                        ${icons_html}
                      </div>
                    `;
                  ]]]
                footer: |
                  [[[
                     setTimeout(() => {
                       const isEditMode = window.location.search.includes('edit=1') || window.location.pathname.includes('edit');
                       if (isEditMode) {
                          const el = document.querySelector("hui-conditional-card"); 
                          if (el) el.style.display = 'block';
                       }
                     }, 1000);

                     return (function() {
                       return `
                         <div style="display:flex; width:100%; justify-content:center; align-items:center;">
                           <ha-icon icon="mdi:chevron-down" style="color: rgba(255,255,255,0.7); width: 18px; height: 18px;"></ha-icon>
                         </div>
                       `;
                     })();
                  ]]]
              extra_styles: |
                @keyframes dash_blink_text {
                  0% { opacity: 1; transform: scale(1); }
                  50% { opacity: 0.6; transform: scale(1.1); }
                  100% { opacity: 1; transform: scale(1); }
                }
                @keyframes pulse_alert {
                  0% { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2)) drop-shadow(0 0 5px inherit); transform: scale(1); }
                  50% { filter: drop-shadow(0 0 20px inherit) drop-shadow(0 0 10px inherit); transform: scale(1.1); }
                  100% { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2)) drop-shadow(0 0 5px inherit); transform: scale(1); }
                }
            entities:
              - type: custom:button-card
                entity: sensor.91_weather_alert
                show_name: false
                show_icon: false
                show_state: false
                styles:
                  card:
                    - background: transparent
                    - border: none
                    - box-shadow: none
                    - padding: 0px
                    - margin-top: 10px
                  grid:
                    - grid-template-areas: '"alerts_text"'
                    - grid-template-columns: 1fr
                custom_fields:
                  alerts_text: |
                    [[[
                      if (!entity || !entity.attributes) return "";
                      
                      const pheno_configs = [
                        { id: 'Vent violent', icon: 'mdi:weather-windy' },
                        { id: 'Pluie-inondation', icon: 'mdi:weather-pouring' },
                        { id: 'Orages', icon: 'mdi:weather-lightning' },
                        { id: 'Inondation', display: 'Innondation', icon: 'mdi:home-flood' },
                        { id: 'Neige-verglas', icon: 'mdi:weather-snowy' },
                        { id: 'Canicule', icon: 'mdi:weather-sunny-alert' },
                        { id: 'Grand froid', icon: 'mdi:snowflake' },
                        { id: 'Avalanches', icon: 'mdi:image-filter-hdr' },
                        { id: 'Vagues-submersion', icon: 'mdi:waves' }
                      ];
                      
                      const p_levels = ['Rouge', 'Orange', 'Jaune'];
                      const p_colors = { 'Rouge': '#f44336', 'Orange': '#ff9800', 'Jaune': '#ffeb3b' };
                      
                      let final_html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                      let has_any = false;
                      
                      p_levels.forEach(lvl => {
                        pheno_configs.forEach(conf => {
                          if (entity.attributes[conf.id] === lvl) {
                            has_any = true;
                            const c = p_colors[lvl];
                            const displayName = conf.display || conf.id;
                            final_html += `
                              <div style="
                                background: rgba(20, 27, 38, 0.6);
                                backdrop-filter: blur(20px);
                                -webkit-backdrop-filter: blur(20px);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                border-radius: 16px;
                                padding: 12px 20px;
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                              ">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                  <ha-icon icon="${conf.icon}" style="color: ${c}; filter: drop-shadow(0 0 5px ${c}80); width: 22px; height: 22px;"></ha-icon>
                                  <div style="font-weight: 800; font-size: 14px; color: white; letter-spacing: 0.5px; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                                    ${displayName}
                                  </div>
                                </div>
                                <div style="font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: ${c}; text-shadow: 0 0 10px rgba(0,0,0,0.5); animation: dash_blink_pulse 2s infinite;">
                                  Vigilance ${lvl}
                                </div>
                              </div>
                            `;
                          }
                        });
                      });
                      
                      final_html += '</div>';
                      return has_any ? final_html : "";
                    ]]]
                extra_styles: |
                  @keyframes dash_blink_pulse {
                    0% { opacity: 1; }
                    50% { opacity: 0.6; }
                    100% { opacity: 1; }
                  }
          - type: custom:button-card
            entity: sensor.openuv_maison_indice_uv_actuel
            show_name: false
            show_icon: false
            show_state: false
            styles:
              card:
                - padding: 0
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - border-radius: 20px
                - border: |
                    [[[
                       var uv = (entity && entity.state !== 'unknown' && entity.state !== 'unavailable') ? parseFloat(entity.state) : 0;
                       if (states['sun.sun'] && states['sun.sun'].state === 'below_horizon') uv = 0;
                       if (uv >= 11) return '1px solid rgba(186, 85, 211, 0.5)';
                       if (uv >= 8) return '1px solid rgba(255, 69, 0, 0.5)';
                       if (uv >= 6) return '1px solid rgba(255, 140, 0, 0.5)';
                       if (uv >= 3) return '1px solid rgba(255, 215, 0, 0.3)';
                       return '1px solid rgba(0, 230, 118, 0.3)';
                    ]]]
                - box-shadow: |
                    [[[
                      var uv = (entity && entity.state !== 'unknown' && entity.state !== 'unavailable') ? parseFloat(entity.state) : 0;
                      if (states['sun.sun'] && states['sun.sun'].state === 'below_horizon') uv = 0;
                      if (uv >= 11) return '0 0 20px rgba(186, 85, 211, 0.3), 0 8px 32px rgba(0,0,0,0.4)';
                      if (uv >= 8) return '0 0 20px rgba(255, 69, 0, 0.3), 0 8px 32px rgba(0,0,0,0.4)';
                      if (uv >= 6) return '0 0 20px rgba(255, 140, 0, 0.3), 0 8px 32px rgba(0,0,0,0.4)';
                      return '0 8px 32px rgba(0,0,0,0.4)';
                    ]]]
                - overflow: hidden
                - margin: 0px
                - position: relative
                - transition: box-shadow 0.8s ease-in-out, border 0.8s ease-in-out
              grid:
                - grid-template-areas: '"icon details"'
                - grid-template-columns: 130px 1fr
                - grid-template-rows: 60px
                - gap: 0px
                - width: 100%
                - margin: 0
              custom_fields:
                icon:
                  - justify-self: stretch
                  - align-self: stretch
                  - border-right: 2px solid rgba(255, 255, 255, 0.6)
                  - border-top-left-radius: 20px
                  - border-bottom-left-radius: 20px
                  - display: flex
                  - align-items: center
                  - justify-content: center
                  - padding: 0
                details:
                  - justify-self: stretch
                  - align-self: stretch
                  - display: flex
                  - flex-direction: column
                  - justify-content: center
                  - align-items: stretch
                  - padding: 0 20px
                  - overflow: hidden
                  - position: relative
            custom_fields:
              icon: |
                [[[
                  var uv = (entity && entity.state !== 'unknown' && entity.state !== 'unavailable') ? parseFloat(entity.state) : 0;
                  if (states['sun.sun'] && states['sun.sun'].state === 'below_horizon') uv = 0;
                  
                  var color = '#00E676'; // Vert
                  if (uv >= 3) color = '#FFD700'; // Jaune
                  if (uv >= 6) color = '#FF8C00'; // Orange
                  if (uv >= 8) color = '#FF4500'; // Rouge
                  if (uv >= 11) color = '#BA55D3'; // Violet
                  
                  var anim = uv > 0 ? 'animation: spin 12s linear infinite;' : '';

                  return `
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, ${color}33 0%, ${color}0D 100%);">
                      <div style="width: 32px; height: 32px; filter: drop-shadow(0 0 10px ${color}80);">
                        <svg viewBox="0 0 24 24" style="fill: ${color}; ${anim} width: 100%; height: 100%;">
                          <path d="M12,7A5,5 0 1,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 1,1 9,12A3,3 0 0,1 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,5.29C7.24,6.03 7.09,6.84 7.09,7.68C7.09,8.52 7.24,9.33 7.5,10.07L3.34,8.36V7M3.34,17L7.5,18.71C7.24,17.97 7.09,17.16 7.09,16.32C7.09,15.48 7.24,14.67 7.5,13.93L3.34,15.64V17M20.66,17L16.5,18.71C16.76,17.97 16.91,17.16 16.91,16.32C16.91,15.48 16.76,14.67 16.5,13.93L20.66,15.64V17M20.66,7L16.5,5.29C16.76,6.03 16.91,6.84 16.91,7.68C16.91,8.52 16.76,9.33 16.5,10.07L20.66,8.36V7M12,22L9.61,18.58C10.35,18.85 11.16,19 12,19C12.84,19 13.65,18.85 14.39,18.58L12,22Z" />
                        </svg>
                      </div>
                    </div>
                    <style> @keyframes spin { 100% { transform: rotate(360deg); } } </style>
                  `;
                ]]]
              details: |
                [[[
                  var uv = (entity && entity.state !== 'unknown' && entity.state !== 'unavailable') ? parseFloat(entity.state) : 0;
                  var levelState = states['sensor.openuv_maison_niveau_uv_actuel'] ? states['sensor.openuv_maison_niveau_uv_actuel'].state.toLowerCase() : 'low';
                  
                  if (states['sun.sun'] && states['sun.sun'].state === 'below_horizon') {
                    uv = 0;
                    levelState = 'low';
                  }
                  
                  var label = 'Inconnu';
                  if (levelState.includes('low')) label = 'Faible';
                  else if (levelState.includes('moderate')) label = 'Modéré';
                  else if (levelState.includes('high') && !levelState.includes('very')) label = 'Élevé';
                  else if (levelState.includes('very_high')) label = 'Très Élevé';
                  else if (levelState.includes('extreme')) label = 'Extrême';
                  else label = levelState; 

                  var pct = (uv / 11) * 100;
                  if (pct > 100) pct = 100;
                  
                  var color = '#00E676';
                  if (uv >= 3) color = '#FFD700';
                  if (uv >= 6) color = '#FF8C00';
                  if (uv >= 8) color = '#FF4500';
                  if (uv >= 11) color = '#BA55D3';

                  return `
                    <div style="display:flex; flex-direction:column; justify-content:center; width: 100%;">
                       <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px;">
                          <span style="font-size:16px; font-weight:900; color:white; text-shadow: 0 0 10px rgba(255,255,255,0.2);">UV ${uv.toFixed(1)}</span>
                          <span style="font-size:13px; color:${color}; text-transform:uppercase; font-weight:800; letter-spacing: 1px; filter: drop-shadow(0 0 5px ${color}80);">${label}</span>
                       </div>
                       <div style="width:100%; height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden;">
                          <div style="width:${pct}%; height:100%; background:${color}; box-shadow: 0 0 10px ${color}; transition:width 1s ease;"></div>
                       </div>
                    </div>
                  `;
                ]]]
          - type: custom:button-card
            entity: weather.home
            show_name: false
            show_icon: false
            show_state: false
            tap_action:
              action: more-info
            styles:
              card:
                - padding: 0
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - border-radius: 20px
                - overflow: hidden
                - transition: all 0.5s ease-in-out
                - border: |
                    [[[
                      const alert = states['sensor.91_weather_alert'];
                      if (alert && alert.state !== 'Vert' && alert.state !== 'unknown') {
                        const s = String(alert.state).toLowerCase();
                        if (s === 'rouge' || s === '4' || s === 'red') return '1px solid rgba(244, 67, 54, 0.8)';
                        if (s === 'orange' || s === '3') return '1px solid rgba(255, 152, 0, 0.8)';
                        if (s === 'jaune' || s === '2' || s === 'yellow') return '1px solid rgba(255, 235, 59, 0.6)';
                      }
                      return '1px solid rgba(255,255,255,0.1)';
                    ]]]
                - box-shadow: 0 8px 32px rgba(0,0,0,0.4)
              grid:
                - grid-template-areas: '"img details"'
                - grid-template-columns: 130px 1fr
                - grid-template-rows: auto
                - align-items: stretch
              custom_fields:
                img:
                  - justify-self: stretch
                  - align-self: stretch
                  - border-right: 2px solid rgba(255,255,255,0.6)
                details:
                  - justify-self: stretch
                  - align-self: stretch
                  - padding: 15px 18px
                  - display: flex
                  - flex-direction: column
                  - justify-content: center
                  - gap: 12px
            custom_fields:
              img: |
                [[[
                  if (!entity) return '...';
                  const state = entity.state;
                  const trans = {
                    'sunny': 'Ensoleillé', 'clear-night': 'Nuit claire', 'cloudy': 'Nuageux',
                    'fog': 'Brouillard', 'hail': 'Grêle', 'lightning': 'Orages',
                    'lightning-rain': 'Pluie orageuse', 'partlycloudy': 'Éclaircies',
                    'pouring': 'Pluie forte', 'rainy': 'Pluvieux', 'snowy': 'Neige',
                    'snowy-rainy': 'Pluie et neige', 'windy': 'Venteux', 'windy-variant': 'Venteux'
                  };
                  const map = {
                    'sunny': { icon: '☀️', color: '#FFD600' }, 'clear-night': { icon: '🌙', color: '#7E57C2' },
                    'cloudy': { icon: '☁️', color: '#90A4AE' }, 'fog': { icon: '🌫️', color: '#B0BEC5' },
                    'hail': { icon: '🌨️', color: '#4FC3F7' }, 'lightning': { icon: '⚡', color: '#FFEB3B' },
                    'lightning-rain': { icon: '⛈️', color: '#FFD600' }, 'partlycloudy': { icon: '⛅', color: '#FFB74D' },
                    'pouring': { icon: '🌧️', color: '#448AFF' }, 'rainy': { icon: '🌦️', color: '#29B6F6' },
                    'snowy': { icon: '❄️', color: '#E1F5FE' }, 'snowy-rainy': { icon: '🌨️', color: '#B3E5FC' },
                    'windy': { icon: '💨', color: '#81C784' }, 'windy-variant': { icon: '🍃', color: '#A5D6A7' }
                  };
                  const theme = map[state] || { icon: '🌡️', color: '#00BFFF' };
                  return `
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, ${theme.color}33 0%, ${theme.color}0D 100%);">
                      <div style="font-size: 50px; filter: drop-shadow(0 4px 10px ${theme.color}80);">${theme.icon}</div>
                      <div style="font-size: 11px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${trans[state] || state}</div>
                    </div>
                  `;
                ]]]
              details: |
                [[[
                  if (!entity || !entity.attributes) return '...';
                  
                  // --- TEMPÉRATURES ---
                  const cur = parseFloat(entity.attributes.temperature || 0);
                  const low = parseFloat(entity.attributes.forecast?.[0]?.templow || cur - 3);
                  const high = parseFloat(entity.attributes.forecast?.[0]?.temperature || cur + 4);
                  const range = Math.max(high - low, 1);
                  const pos = Math.min(Math.max(((cur - low) / range) * 100, 0), 100);
                  
                  let temp_html = `
                    <div style="display: flex; align-items: center; gap: 10px; width: 100%; margin-bottom: 2px;">
                      <span style="font-size: 12px; font-weight: 900; color: white; min-width: 25px;">${Math.round(low)}°</span>
                      <div style="flex: 1; height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; position: relative;">
                        <div style="position: absolute; width: 100%; height: 100%; background: linear-gradient(90deg, #4FC3F7, #FFA726); border-radius: 6px; opacity: 0.8;"></div>
                        <div style="position: absolute; left: ${pos}%; top: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.5); z-index: 2; border: 2px solid #29B6F6; display: flex; align-items: center; justify-content: center;">
                          <span style="color: #141B26; font-size: 11px; font-weight: 900;">${Math.round(cur)}°</span>
                        </div>
                      </div>
                      <span style="font-size: 12px; font-weight: 900; color: white; min-width: 25px; text-align: right;">${Math.round(high)}°</span>
                    </div>
                  `;

                  // --- ALERTES MULTIPLES (MÉTÉO FRANCE) ---
                  const alert_ent = states['sensor.91_weather_alert'];
                  let alerts_html = '';
                  if (alert_ent && alert_ent.state !== 'Vert' && alert_ent.state !== 'unknown') {
                    const risks_map = {
                      'inondation': 'mdi:home-flood', 'vent': 'mdi:weather-windy',
                      'pluie': 'mdi:weather-pouring', 'orage': 'mdi:weather-lightning',
                      'neige': 'mdi:weather-snowy-heavy', 'verglas': 'mdi:weather-snowy-heavy', 
                      'canicule': 'mdi:weather-sunny-alert', 'froid': 'mdi:snowflake-alert', 
                      'avalanche': 'mdi:terrain', 'vague': 'mdi:waves'
                    };
                    
                    const severity_labels = {
                      '1': 'Vert', '2': 'Jaune', '3': 'Orange', '4': 'Rouge',
                      'vert': 'Vert', 'jaune': 'Jaune', 'orange': 'Orange', 'rouge': 'Rouge',
                      'yellow': 'Jaune', 'red': 'Rouge'
                    };

                    let active_alerts = [];
                    const risk_levels = ['2', '3', '4', 'jaune', 'orange', 'rouge', 'yellow', 'red'];
                    
                    for (const [key, val] of Object.entries(alert_ent.attributes)) {
                      const vs = String(val).toLowerCase();
                      if (risk_levels.includes(vs)) {
                         let icon = 'mdi:alert-decagram';
                         const klow = key.toLowerCase();
                         for (const [kw, ic] of Object.entries(risks_map)) {
                           if (klow.includes(kw)) { icon = ic; break; }
                         }
                         
                         active_alerts.push({
                           name: key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                           level: severity_labels[vs] || vs.toUpperCase(),
                           icon: icon
                         });
                      }
                    }
                    
                    const order = { 'Rouge': 1, 'Orange': 2, 'Jaune': 3 };
                    active_alerts.sort((a, b) => (order[a.level] || 99) - (order[b.level] || 99));

                    if (active_alerts.length === 0) {
                       active_alerts.push({ name: 'Alerte', level: alert_ent.state, icon: 'mdi:alert-decagram' });
                    }

                    alerts_html = '<div style="display: flex; flex-direction: column; gap: 8px;">' + active_alerts.map(a => {
                      const l = a.level.toLowerCase();
                      const color = l.includes('rouge') || l.includes('red') ? '#F44336' : (l.includes('orange') ? '#FF9800' : '#FFEB3B');
                      return `
                        <div style="display: flex; justify-content: space-between; align-items: center; background: ${color}20; padding: 10px 15px; border-radius: 12px; border: 1px solid ${color}40;">
                          <div style="display: flex; align-items: center; gap: 10px;">
                            <ha-icon icon="${a.icon}" style="width: 20px; height: 20px; color: ${color}; filter: drop-shadow(0 0 5px ${color}80);"></ha-icon>
                            <span style="font-size: 13px; font-weight: 800; color: white;">${a.name}</span>
                          </div>
                          <span style="font-size: 10px; font-weight: 900; color: ${color}; text-transform: uppercase;">Vigilance ${a.level}</span>
                        </div>
                      `;
                    }).join('') + '</div>';
                  }

                  // --- INDICE UV PREMIUM ---
                  const uv_ent = states['sensor.openuv_maison_indice_uv_actuel'];
                  const sun = states['sun.sun'];
                  const isNight = sun?.state === 'below_horizon' || entity.state === 'clear-night';
                  let uv_val = parseFloat(uv_ent?.state || 0);
                  if (isNight) uv_val = 0;

                  const uv_pct = Math.min((uv_val / 12) * 100, 100);
                  let uv_color = '#4CAF50';
                  if (uv_val >= 3) uv_color = '#FDD835';
                  if (uv_val >= 6) uv_color = '#FB8C00';
                  if (uv_val >= 8) uv_color = '#F44336';
                  if (uv_val >= 11) uv_color = '#9C27B0';

                  let uv_html = `
                    <div style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                         <span style="font-size: 11px; font-weight: 950; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px;">Indice UV</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                        <span style="font-size: 12px; font-weight: 900; color: white; min-width: 25px;">0</span>
                        <div style="flex: 1; height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; position: relative; border: 1px solid rgba(255,255,255,0.05);">
                          <div style="position: absolute; width: 100%; height: 100%; background: linear-gradient(90deg, #4CAF50 0%, #FDD835 25%, #FB8C00 50%, #F44336 75%, #9C27B0 100%); border-radius: 6px; opacity: 0.8;"></div>
                          <div style="position: absolute; left: ${uv_pct}%; top: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.5); z-index: 2; border: 2px solid ${uv_color}; display: flex; align-items: center; justify-content: center;">
                            <span style="color: #141B26; font-size: 11px; font-weight: 900;">${uv_val.toFixed(1)}</span>
                          </div>
                        </div>
                        <span style="font-size: 12px; font-weight: 900; color: white; min-width: 30px; text-align: right;">12</span>
                      </div>
                    </div>
                  `;
                  
                  return temp_html + alerts_html + uv_html;
                ]]]
          - type: custom:button-card
            show_name: false
            show_icon: false
            show_state: false
            styles:
              card:
                - padding: 0
                - background: rgba(20, 27, 38, 0.6)
                - backdrop-filter: blur(10px)
                - '-webkit-backdrop-filter': blur(10px)
                - border-radius: 20px
                - border: 1px solid rgba(126, 87, 194, 0.4)
                - box-shadow: 0 8px 32px rgba(0,0,0,0.4)
                - height: 110px
              grid:
                - grid-template-areas: '"icon details"'
                - grid-template-columns: 130px minmax(0, 1fr)
                - grid-template-rows: 110px
              custom_fields:
                icon:
                  - justify-self: stretch
                  - align-self: stretch
                  - border-right: 2px solid rgba(255,255,255,0.6)
                  - border-top-left-radius: 20px
                  - border-bottom-left-radius: 20px
                  - display: flex
                  - align-items: center
                  - justify-content: center
                details:
                  - justify-self: stretch
                  - align-self: stretch
                  - display: flex
                  - flex-direction: column
                  - justify-content: center
                  - align-items: center
                  - padding: 0 10px
            custom_fields:
              icon: |
                [[[
                  const purple = "#7E57C2";
                  return `
                    <div style="width:100%;height:100%;display:flex;flex-direction:column;
                    align-items:center;justify-content:center;
                    background:linear-gradient(135deg,${purple}33 0%,${purple}0D 100%);
                    border-top-left-radius:20px;border-bottom-left-radius:20px;">

                      <ha-icon icon="mdi:white-balance-sunny"
                      style="width:42px;height:42px;color:#FFD54F;
                      filter:drop-shadow(0 4px 8px rgba(0,0,0,0.5));"></ha-icon>

                      <div style="font-size:10px;font-weight:900;color:white;
                      text-transform:uppercase;letter-spacing:1px;margin-top:-4px;">
                      UV
                      </div>

                    </div>
                  `;
                ]]]
              details: |
                [[[
                  const sunState = states['sun.sun']?.state;

                  const uvReal =
                    parseFloat(states['sensor.openuv_maison_indice_uv_actuel']?.state ?? 'NaN');

                  // ✅ FORÇAGE À 0 APRÈS COUCHER
                  const uv = (sunState === 'below_horizon') ? 0.0 : uvReal;
                  const uvTxt = Number.isFinite(uv) ? uv.toFixed(1) : '?';

                  const count =
                    parseInt(states['counter.openuv_updates_today']?.state ?? '0');

                  const intervalS =
                    parseInt(states['input_number.openuv_interval_seconds']?.state ?? '0');

                  const intervalMin = intervalS ? Math.round(intervalS / 60) : 0;

                  const remaining = Math.max(0, 50 - count);

                  // ✅ jauge visible dès la 1ère MAJ
                  const pctRaw = Math.round((count / 50) * 100);
                  const pct = (count > 0 && pctRaw < 8) ? 8 : pctRaw;

                  // ✅ Format FR: DD/MM/YYYY HH:MM
                  const pad2 = (n) => String(n).padStart(2, '0');
                  const fmtFR = (d) =>
                    `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

                  // Dernière MAJ (depuis input_datetime si présent, sinon depuis ts)
                  const lastDtStr = states['input_datetime.openuv_last_update']?.state || '';
                  let lastFR = '—';

                  // Timestamp fiable
                  const lastTs = parseInt(states['input_number.openuv_last_update_ts']?.state ?? '0');

                  if (lastTs > 0) {
                    lastFR = fmtFR(new Date(lastTs * 1000));
                  } else if (lastDtStr) {
                    // fallback si jamais le ts n'est pas encore renseigné
                    const d = new Date(lastDtStr.replace(' ', 'T'));
                    if (!isNaN(d.getTime())) lastFR = fmtFR(d);
                  }

                  // Prochaine MAJ (uniquement le jour)
                  let nextFR = '—';
                  if (sunState === 'above_horizon' && lastTs > 0 && intervalS > 0) {
                    nextFR = fmtFR(new Date((lastTs + intervalS) * 1000));
                  }

                  const uvColor = (v) => {
                    if (v < 3) return "#00C853";
                    if (v < 6) return "#FFEB3B";
                    if (v < 8) return "#FF9800";
                    if (v < 11) return "#F44336";
                    return "#9C27B0";
                  };

                  return `
                  <div style="display:flex;flex-direction:column;width:100%;
                  align-items:center;justify-content:center;text-align:center;">

                    <div style="display:flex;align-items:baseline;gap:10px;margin-bottom:6px;">
                      <div style="font-size:12px;font-weight:800;
                      color:rgba(255,255,255,0.65);
                      text-transform:uppercase;">Indice UV</div>

                      <div style="font-size:28px;font-weight:900;
                      color:${uvColor(uv)};
                      text-shadow:0 6px 16px rgba(0,0,0,0.45);">
                      ${uvTxt}
                      </div>
                    </div>

                    <div style="display:flex;gap:14px;flex-wrap:wrap;
                    justify-content:center;margin-bottom:8px;">

                      <div style="font-size:10px;color:rgba(255,255,255,0.6);
                      font-weight:700;">
                      DERNIÈRE MAJ:
                      <span style="color:white;font-weight:800;">
                      ${lastFR}
                      </span>
                      </div>

                      <div style="font-size:10px;color:rgba(255,255,255,0.6);
                      font-weight:700;">
                      PROCHAINE:
                      <span style="color:white;font-weight:800;">
                      ${nextFR}
                      </span>
                      </div>

                      <div style="font-size:10px;color:rgba(255,255,255,0.6);
                      font-weight:700;">
                      INTERVALLE:
                      <span style="color:white;font-weight:800;">
                      ${intervalS}s (~${intervalMin}m)
                      </span>
                      </div>

                    </div>

                    <!-- ✅ bloc jauge remonté + marge bas -->
                    <div style="width:92%; margin-top:-6px; padding-bottom:6px;">
                      <div style="display:flex;justify-content:space-between;
                      font-size:10px;color:rgba(255,255,255,0.6);
                      font-weight:800;margin-bottom:4px;">
                        <div>MAJ ${count}/50</div>
                        <div>RESTE ${remaining}</div>
                      </div>

                      <div style="width:100%;height:8px;
                      background:rgba(255,255,255,0.1);
                      border-radius:999px;overflow:hidden;">

                        <div style="height:100%;
                        width:${pct}%;
                        background:rgba(126,87,194,0.9);
                        box-shadow:0 0 16px rgba(126,87,194,0.5);">
                        </div>

                      </div>
                    </div>

                  </div>
                  `;
                ]]]
            tap_action:
              action: more-info
              entity: sensor.openuv_maison_indice_uv_actuel
            card_mod:
              style: |
                ha-card {
                  margin: 0 !important;
                }
    visible:
      - user: 49a98c3aa3c44399a03d32437dca04ba
    cards: []
